<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"><!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion D√©partementale - 36 Services</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f9fafb; }
        .header { background-color: #2563eb; color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; }
        .header-right { display: flex; gap: 16px; align-items: center; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-success { background-color: #059669; color: white; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .nav { background-color: white; padding: 0 16px; display: flex; gap: 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav button { padding: 16px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 16px; }
        .nav button.active { border-bottom-color: #2563eb; color: #2563eb; }
        .main { max-width: 1280px; margin: 0 auto; padding: 32px 16px; }
        .cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; margin-top: 32px; }
        .card { padding: 24px; border-radius: 8px; border-left: 4px solid; }
        .card-blue { background-color: #dbeafe; border-color: #2563eb; }
        .card-yellow { background-color: #fef3c7; border-color: #d97706; }
        .card-green { background-color: #d1fae5; border-color: #059669; }
        .card-orange { background-color: #fed7aa; border-color: #ea580c; }
        .card-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        .card-value { font-size: 32px; font-weight: bold; }
        .table-container { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; margin-top: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 16px; border: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; text-align: left; }
        thead.blue th { background-color: #2563eb; color: white; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        tbody tr:hover { background-color: #f3f4f6; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block; }
        .badge-blue { background-color: #dbeafe; }
        .badge-green { background-color: #d1fae5; }
        .badge-purple { background-color: #e9d5ff; }
        .badge-taux { padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: bold; }
        .badge-taux-green { background-color: #d1fae5; color: #065f46; }
        .badge-taux-yellow { background-color: #fef3c7; color: #92400e; }
        .badge-taux-red { background-color: #fee2e2; color: #991b1b; }
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; border-radius: 8px; padding: 32px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .form-control { width: 100%; padding: 8px 16px; border: 1px solid #ccc; border-radius: 8px; }
        .btn-group { display: flex; gap: 8px; justify-content: center; }
        .check-icon { color: #059669; font-size: 20px; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        input[type="checkbox"]:disabled { cursor: not-allowed; opacity: 0.5; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        h2 { font-size: 24px; font-weight: bold; }
        .empty-state { padding: 32px; text-align: center; color: #6b7280; font-size: 18px; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; }
        .alert-info { background-color: #dbeafe; color: #1e40af; }
        .alert-warning { background-color: #fef3c7; color: #92400e; border-left: 4px solid #d97706; }
        .service-badge { display: inline-block; padding: 6px 12px; background-color: #7c3aed; color: white; border-radius: 6px; font-weight: bold; margin-left: 10px; }
        .notif-button { position: relative; padding: 8px 16px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background-color: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
        .notif-panel { position: absolute; top: 60px; right: 16px; width: 450px; max-height: 600px; background-color: white; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); z-index: 100; overflow: hidden; }
        .notif-header { background-color: #7c3aed; color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
        .notif-body { max-height: 500px; overflow-y: auto; }
        .notif-item { padding: 16px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background-color 0.2s; }
        .notif-item:hover { background-color: #f9fafb; }
        .notif-item.unread { background-color: #eff6ff; border-left: 4px solid #2563eb; }
        .notif-type { font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .notif-type.ajout { color: #059669; }
        .notif-type.modification { color: #d97706; }
        .notif-type.rapport { color: #7c3aed; }
        .notif-type.preuve { color: #2563eb; }
        .notif-message { font-size: 14px; margin-bottom: 8px; }
        .notif-meta { font-size: 12px; color: #6b7280; display: flex; justify-content: space-between; align-items: center; }
        .notif-delete { padding: 4px 8px; background-color: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .fichier-item { padding: 8px; background-color: #f3f4f6; border-radius: 4px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .fichier-item:hover { background-color: #e5e7eb; }
    </style>
    <!-- ========== CONNEXION SUPABASE ========== -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://kosqzeueikyehkblqosq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtvc3F6ZXVlaWt5ZWhrYmxxb3NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDU0MTUsImV4cCI6MjA3ODYyMTQxNX0.oGGDuOSb4M-NkJILVSDKfjXyTVqBvnJmWuR46YEEVyQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // ================================================
// SYST√àME DE PERMISSIONS FLEXIBLE
// ================================================

// Cache des permissions (√©vite de recharger √† chaque fois)
var permissionsCache = {};

// Charger les permissions depuis Supabase
async function loadPermissions() {
    try {
        const { data, error } = await supabase
            .from('permissions_config')
            .select('*')
            .eq('enabled', true);
        
        if (error) throw error;
        
        // Organiser par r√¥le/resource/action
        permissionsCache = {};
        for (var i = 0; i < data.length; i++) {
            var perm = data[i];
            var key = perm.role + ':' + perm.resource + ':' + perm.action;
            permissionsCache[key] = {
                enabled: perm.enabled,
                condition: perm.condition ? JSON.parse(perm.condition) : null
            };
        }
        
        console.log('‚úÖ Permissions charg√©es:', Object.keys(permissionsCache).length);
        
    } catch (error) {
        console.error('‚ùå Erreur chargement permissions:', error);
    }
}

// V√©rifier si l'utilisateur a une permission
function hasPermission(resource, action, context) {
    if (!currentUser) return false;
    
    var key = currentUser.role + ':' + resource + ':' + action;
    var perm = permissionsCache[key];
    
    if (!perm || !perm.enabled) {
        return false;
    }
    
    // V√©rifier les conditions suppl√©mentaires
    if (perm.condition && context) {
        if (perm.condition.service === 'own' && context.service !== currentUser.service) {
            return false;
        }
        if (perm.condition.valide === false && context.valide === true) {
            return false;
        }
    }
    
    return true;
}

// Obtenir un message d'erreur personnalis√©
function getPermissionErrorMessage(resource, action) {
    var messages = {
        'activites:create': 'Vous n\'avez pas le droit d\'ajouter des activit√©s',
        'activites:update': 'Vous ne pouvez pas modifier cette activit√©',
        'activites:delete': 'Vous ne pouvez pas supprimer cette activit√©',
        'commentaires:create': 'Vous ne pouvez pas ajouter de commentaires',
        'commentaires:update': 'Vous ne pouvez pas modifier ce commentaire',
        'commentaires:delete': 'Vous ne pouvez pas supprimer ce commentaire'
    };
    
    return messages[resource + ':' + action] || 'Action non autoris√©e';
}

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
</head>
<body>
    <div id="app">Chargement...</div>

    <script>
// ========== DONN√âES DES 36 SERVICES ==========
        

        function generateServices() {
            return [
                'SNEAA', 'SNPUP', 'DRH', 'PRMP', 'DNEP', 'DNCaS', 'SG-E', 'DNAEFP-LN', 
                'SNFCPE', 'DNEF', 'ANAFE', 'DNESGT', 'SNEC', 'SNIES', 'INRAP', 'SMSI', 
                'SNSS', 'CRD', 'IGE', 'SNESU', 'SC', 'DAF', 'BSD', 'DGECS', 'ICESCO', 
                'IRE_CONAKRY', 'IRE_BOKE', 'IRE_KINDIA', 'IRE_MAMOU', 'IRE_LABE', 
                'IRE_FARANAH', 'IRE_KANKAN', 'IRE_NZEREKORE', 'SCRP', 'SLT', 'SA'
            ];
        }

        // ========== VARIABLES GLOBALES ==========
var users = [];
        var services = generateServices();
        var currentUser = null;
        var data = [];
        var commentairesEtPreuves = [];
        var notifications = [];
        var activeTab = 'dashboard';
        var selectedServiceFilter = 'TOUS';
        var activeAnalyseTab = 'acces'; // 'acces' | 'qualite' | 'alphabetisation' | 'decisions'
        var selectedStatusFilter = 'TOUS';
        var selectedObjectifFilter = 'TOUS';
        var selectedTrimestreFilter = 'TOUS';
        var suiviObjectifFilter = 'TOUS';
        var suiviTrimestreFilter = 'TOUS';
        var commentairesServiceFilter = 'TOUS';
        var commentairesObjectifFilter = 'TOUS';
        var showNotifications = false;
        var connectedUsers = [];
        var rapportTextes = {};
        var initialData = [];
        var statistiquesData = [];
        var reussiteExamensData = [];
        var alphabetisationData = [];
        var regionsData = [];
        var prefecturesData = [];
        function calcTaux(item) {
            var checks = 0;
            if (item.tdr) checks++;
            if (item.eng) checks++;
            if (item.mand) checks++;
            if (item.ordo) checks++;
            if (item.liq) checks++;
            if (item.exec) checks++;
            return Math.round((checks / 6) * 100);
        }
async function toggle(activityId, field) {
    var activity = null;
    for (var i = 0; i < data.length; i++) {
        if (data[i].id === activityId) {
            activity = data[i];
            break;
        }
    }
    
    if (!activity) {
        alert('Activit√© introuvable');
        return;
    }
    
    // üî• V√âRIFICATION SIMPLIFI√âE
    if (!canModify(activity)) {
        alert('‚ùå Vous ne pouvez pas modifier cette activit√©');
        return;
    }

    // Inverser la valeur
    var newValue = !activity[field];
    
    console.log('üîÑ Sauvegarde:', field, '=', newValue, 'pour activit√©', activityId);
    
    try {
        // üî• SAUVEGARDER DANS SUPABASE
        var updateObj = {};
        updateObj[field] = newValue;
        updateObj.derniere_maj = new Date().toISOString();
        updateObj.maj_par = currentUser.nom;
        
        const { error } = await supabase
            .from('activites')
            .update(updateObj)
            .eq('id', activityId);
        
        if (error) {
            console.error('‚ùå Erreur Supabase:', error);
            throw error;
        }
        
        console.log('‚úÖ Sauvegarde r√©ussie dans Supabase');
        
        // Mettre √† jour localement
        activity[field] = newValue;
        activity.derniere_maj = new Date().toISOString();
        activity.maj_par = currentUser.nom;
        
        render();
        
    } catch (error) {
        console.error('‚ùå Erreur toggle:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}
        // ========== FONCTIONS DE STOCKAGE SUPABASE ==========
        async function loadData() {
            try {
                // Charger les utilisateurs
                const { data: usersData, error: usersError } = await supabase
                    .from('users')
                    .select('*');
                
                if (usersError) throw usersError;
                
                if (usersData && usersData.length > 0) {
                    users = usersData.map(u => ({
                        id: u.id,
                        user: u.username,
                        pass: u.password,
                        role: u.role,
                        nom: u.nom,
                        service: u.service,
                        actif: u.actif !== false
                    }));
                }
                
                // Charger les activit√©s
                const { data: DataTemp, error: activitesError } = await supabase
                    .from('activites')
                    .select('*');
                
                if (activitesError) throw activitesError;
                
if (DataTemp && DataTemp.length > 0) {
    data = DataTemp;
                } else {
                    data = initialData;
                    await saveData();
                }
                
                // Charger commentaires et preuves
                const { data: commentairesData, error: commentairesError } = await supabase
                    .from('commentaires_preuves')
                    .select('*');
                
                if (commentairesError) throw commentairesError;
                
   if (commentairesData) {
    commentairesEtPreuves = commentairesData.map(c => ({
        id: c.id,
        type: c.type,
        objectif: c.objectif,
        activite: c.activite,
        service: c.service,
        commentaire: c.commentaire,
        nomFichier: c.nom_fichier,
        nomFichierStorage: c.nom_fichier_storage,
        fileUrl: c.file_url,
        // ...
    }));
}

             // Charger les r√©gions
                const { data: regionsDataRaw, error: regionsError } = await supabase
                    .from('regions')
                    .select('*')
                    .order('nom');
                
                if (regionsError) throw regionsError;
                if (regionsDataRaw) regionsData = regionsDataRaw;
                
                // Charger les pr√©fectures
                const { data: prefecturesDataRaw, error: prefecturesError } = await supabase
                    .from('prefectures')
                    .select('*, regions(nom)')
                    .order('nom');
                
                if (prefecturesError) throw prefecturesError;
                if (prefecturesDataRaw) prefecturesData = prefecturesDataRaw;
                
                // Charger les statistiques
                const { data: statistiquesDataRaw, error: statistiquesError } = await supabase
                    .from('statistiques_educatives')
                    .select('*')
                    .order('date_saisie', { ascending: false });
                
                if (statistiquesError) throw statistiquesError;
                if (statistiquesDataRaw) statistiquesData = statistiquesDataRaw;

// üî• NOUVEAU : Charger R√âUSSITE EXAMENS
const { data: examensDataRaw, error: examensError } = await supabase
.from('reussite_examens')
.select('*')
.order('date_saisie', { ascending: false });
if (examensError) throw examensError;
if (examensDataRaw) reussiteExamensData = examensDataRaw;
// üî• NOUVEAU : Charger ALPHAB√âTISATION
const { data: alphaDataRaw, error: alphaError } = await supabase
.from('alphabetisation')
.select('*')
.order('date_saisie', { ascending: false });
if (alphaError) throw alphaError;
if (alphaDataRaw) alphabetisationData = alphaDataRaw;

            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                alert('Erreur de connexion √† la base de donn√©es');
            }
        }

        async function saveData() {
    // CETTE FONCTION NE DEVRAIT PLUS √äTRE UTILIS√âE
    // Les mises √† jour se font directement dans toggle(), validateActivity(), etc.
    console.warn('‚ö†Ô∏è saveData() appel√©e - cette fonction est obsol√®te');
}


        async function saveCommentairesEtPreuves() {
            try {
                // Supprimer tous les commentaires existants
                await supabase.from('commentaires_preuves').delete().neq('id', 0);
                
                // Ins√©rer les nouveaux
const toSave = commentairesEtPreuves.map(c => ({
    id: c.id,
    type: c.type,
    objectif: c.objectif,
    activite: c.activite,
    service: c.service,
    commentaire: c.commentaire || null,
    nom_fichier: c.nomFichier || null,
    nom_fichier_storage: c.nomFichierStorage || null,
    file_url: c.fileUrl || null,
    taille_fichier: c.tailleFichier || null,
    cree_par: c.creePar,
    date_creation: c.dateCreation || new Date().toISOString(),
    depose_par: c.deposePar || null,
    date_depot: c.dateDepot || null,
    modifie_par: c.modifiePar || null,
    date_modification: c.dateModification || null
}));
                if (toSave.length > 0) {
                    const { error } = await supabase.from('commentaires_preuves').insert(toSave);
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur saveCommentaires:', error);
            }
        }

        async function saveUsers() {
            try {
                // Supprimer tous les utilisateurs existants
                await supabase.from('users').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                
                // Ins√©rer les nouveaux utilisateurs
                const usersToSave = users.map(u => ({
                    username: u.user,
                    password: u.pass,
                    role: u.role,
                    nom: u.nom,
                    service: u.service,
                    actif: u.actif !== false
                }));
                
                if (usersToSave.length > 0) {
                    const { error } = await supabase.from('users').insert(usersToSave);
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur saveUsers:', error);
            }
        }

        async function saveRapportTextes() {
            try {
                if (!currentUser) return;
                
                // Pour chaque cl√© dans rapportTextes, faire un upsert
                for (var key in rapportTextes) {
                    const { error } = await supabase
                        .from('rapport_textes')
                        .upsert({
                            user_key: currentUser.user,
                            cle: key,
                            valeur: rapportTextes[key],
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_key,cle'
                        });
                    
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur saveRapportTextes:', error);
            }
        }

        async function loadRapportTextes() {
            try {
                if (!currentUser) return;
                
                const { data: textes, error } = await supabase
                    .from('rapport_textes')
                    .select('*')
                    .eq('user_key', currentUser.user);
                
                if (error) throw error;
                
                rapportTextes = {};
                if (textes) {
                    for (var i = 0; i < textes.length; i++) {
                        rapportTextes[textes[i].cle] = textes[i].valeur;
                    }
                }
            } catch (error) {
                console.error('Erreur loadRapportTextes:', error);
            }
        }
// ========== FONCTIONS UTILITAIRES ==========
        function canModify(activity) {
            if (!currentUser) return false;
            if (currentUser.role === 'chefdept') return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.role === 'chef' && activity.service === currentUser.service) return true;
            return false;
        }

        function canValidate(activity) {
            return currentUser && currentUser.role === 'admin';
        }

        function canDeleteInPlanning(activity) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.role === 'chef' && activity.service === currentUser.service) return !activity.valide;
            return false;
        }

        // ========== FONCTIONS DE NAVIGATION ==========
async function login(username, password) {
    try {
        // Rechercher l'utilisateur dans Supabase
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .eq('password', password)
            .single();
        
        if (error || !user) {
            alert('Identifiants incorrects');
            return;
        }
        
        if (user.actif === false) {
            alert('Ce compte est d√©sactiv√©');
            return;
        }
        
        // Connexion r√©ussie
        currentUser = {
            id: user.id,
            user: user.username,
            pass: user.password,
            role: user.role,
            nom: user.nom,
            service: user.service,
            actif: user.actif
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        await loadRapportTextes();
        
        var alreadyConnected = false;
        for (var i = 0; i < connectedUsers.length; i++) {
            if (connectedUsers[i].user === currentUser.user) {
                alreadyConnected = true;
                connectedUsers[i].connectedAt = new Date().toLocaleString('fr-FR');
                break;
            }
        }
        if (!alreadyConnected) {
            connectedUsers.push({
                user: currentUser.user,
                nom: currentUser.nom,
                service: currentUser.service,
                connectedAt: new Date().toLocaleString('fr-FR')
            });
        }
        localStorage.setItem('connectedUsers', JSON.stringify(connectedUsers));
        
        // V√©rifier si c'est un mot de passe provisoire
        if (!user.password_changed && user.password === 'TempMepua@2024!') {
            render();
            setTimeout(function() {
                showChangePasswordModal();
            }, 500);
        } else {
            render();
        }
    } catch (error) {
        console.error('Erreur login:', error);
        alert('Erreur de connexion');
    }
}
function showChangePasswordModal() {
    var modalContainer = document.getElementById('modal-container');
    var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">üîí Changement de mot de passe</h2>';
    
    html += '<div class="alert alert-warning">Vous utilisez un mot de passe provisoire. Veuillez le changer maintenant.</div>';
    
    html += '<div class="form-group"><label>Ancien mot de passe</label><input type="password" id="old-password" class="form-control"></div>';
    html += '<div class="form-group"><label>Nouveau mot de passe</label><input type="password" id="new-password" class="form-control"></div>';
    html += '<div class="form-group"><label>Confirmer le nouveau mot de passe</label><input type="password" id="confirm-password" class="form-control"></div>';
    
    html += '<div class="btn-group"><button class="btn btn-primary" onclick="submitChangePassword()">Changer le mot de passe</button></div>';
    html += '</div></div>';
    
    modalContainer.innerHTML = html;
}

async function submitChangePassword() {
    var oldPassword = document.getElementById('old-password').value;
    var newPassword = document.getElementById('new-password').value;
    var confirmPassword = document.getElementById('confirm-password').value;
    
    if (!oldPassword || !newPassword || !confirmPassword) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    if (oldPassword !== currentUser.pass) {
        alert('Ancien mot de passe incorrect');
        return;
    }
    
    if (newPassword.length < 8) {
        alert('Le nouveau mot de passe doit contenir au moins 8 caract√®res');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('Les mots de passe ne correspondent pas');
        return;
    }
    
    try {
        // Mettre √† jour le mot de passe dans Supabase
        const { error } = await supabase
            .from('users')
            .update({ password: newPassword, password_changed: true })
            .eq('id', currentUser.id);
        
        if (error) throw error;
        
        currentUser.pass = newPassword;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        alert('Mot de passe chang√© avec succ√®s !');
        closeModal();
    } catch (error) {
        console.error('Erreur changement mot de passe:', error);
        alert('Erreur lors du changement de mot de passe');
    }
}
        function logout() {
            if (currentUser) {
                var newConnectedUsers = [];
                for (var i = 0; i < connectedUsers.length; i++) {
                    if (connectedUsers[i].user !== currentUser.user) {
                        newConnectedUsers.push(connectedUsers[i]);
                    }
                }
                connectedUsers = newConnectedUsers;
                localStorage.setItem('connectedUsers', JSON.stringify(connectedUsers));
            }
            
            localStorage.removeItem('currentUser');
            currentUser = null;
            render();
        }

        function changeTab(tab) {
            activeTab = tab;
            render();
        }
        function changeAnalyseTab(subTab) {
    activeAnalyseTab = subTab;
    render();
}
        async function attemptLogin() {
            var username = document.getElementById('username').value.trim();
            var password = document.getElementById('password').value;
            await login(username, password);
        }

        function changeServiceFilter(service) {
            selectedServiceFilter = service;
            render();
        }
// ========== INSCRIPTION PAR INVITATION ==========
async function submitSignupWithInvitation() {
    var email = document.getElementById('signup-email').value.trim();
    var password = document.getElementById('signup-password').value;
    var confirmPassword = document.getElementById('signup-confirm-password').value;
    
    if (!email || !password || !confirmPassword) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    if (password.length < 8) {
        alert('Le mot de passe doit contenir au moins 8 caract√®res');
        return;
    }
    
    if (password !== confirmPassword) {
        alert('Les mots de passe ne correspondent pas');
        return;
    }
    
    // V√©rifier si l'email existe d√©j√†
    const { data: existingUsers, error: checkError } = await supabase
        .from('users')
        .select('*')
        .eq('username', invitationData.username);
    
    if (checkError) {
        alert('Erreur lors de la v√©rification');
        return;
    }
    
    if (existingUsers && existingUsers.length > 0) {
        alert('Ce nom d\'utilisateur existe d√©j√†');
        return;
    }
    
    try {
        // Cr√©er le compte dans la table users
        const { error: insertError } = await supabase
            .from('users')
            .insert({
                username: invitationData.username,
                password: password,
                role: 'chef',
                nom: invitationData.username,
                service: invitationData.username.split('.')[0],
                actif: true,
                email: email,
            });
        
        if (insertError) throw insertError;
        
        // Marquer l'invitation comme accept√©e
        const { error: updateError } = await supabase
            .from('invitations')
            .update({
                status: 'accepted',
                email: email,
                used_at: new Date().toISOString()
            })
            .eq('id', invitationData.id);
        
        if (updateError) throw updateError;
        
        alert('‚úÖ Compte cr√©√© avec succ√®s ! Vous pouvez maintenant vous connecter.');
        
        // Rediriger vers la page de connexion
        window.location.href = window.location.pathname;
        
    } catch (error) {
        console.error('Erreur cr√©ation compte:', error);
        alert('Erreur lors de la cr√©ation du compte');
    }
}

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // ========== FONCTIONS DE FILTRAGE ==========
        function changeStatusFilter(status) {
            selectedStatusFilter = status;
            render();
        }

        function changeDashboardObjectifFilter(objectif) {
            selectedObjectifFilter = objectif;
            render();
        }

        function changeDashboardTrimestreFilter(trimestre) {
            selectedTrimestreFilter = trimestre;
            render();
        }

        function getFilteredDataForDashboard() {
            if (!currentUser) return [];
            
            var baseData = [];
            for (var i = 0; i < data.length; i++) {
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    if (data[i].valide) baseData.push(data[i]);
                } else {
                    if (data[i].service === currentUser.service && data[i].valide) {
                        baseData.push(data[i]);
                    }
                }
            }
            
            if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && selectedServiceFilter !== 'TOUS') {
                var filtered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].service === selectedServiceFilter) filtered.push(baseData[i]);
                }
                baseData = filtered;
            }
            
            if (selectedStatusFilter !== 'TOUS') {
                var statusFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    var taux = calcTaux(baseData[i]);
                    var status = taux === 100 ? 'Ex√©cut√©e' : taux > 0 ? 'En cours' : 'Non commenc√©e';
                    if (status === selectedStatusFilter) {
                        statusFiltered.push(baseData[i]);
                    }
                }
                baseData = statusFiltered;
            }
            
            if (selectedObjectifFilter !== 'TOUS') {
                var objectifFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].categorie === selectedObjectifFilter) {
                        objectifFiltered.push(baseData[i]);
                    }
                }
                baseData = objectifFiltered;
            }
            
            if (selectedTrimestreFilter !== 'TOUS') {
                var trimestreFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    var programmee = false;
                    if (selectedTrimestreFilter === 'T1' && baseData[i].t1) programmee = true;
                    else if (selectedTrimestreFilter === 'T2' && (baseData[i].t1 || baseData[i].t2)) programmee = true;
                    else if (selectedTrimestreFilter === 'T3' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3)) programmee = true;
                    else if (selectedTrimestreFilter === 'T4' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3 || baseData[i].t4)) programmee = true;
                    if (programmee) trimestreFiltered.push(baseData[i]);
                }
                baseData = trimestreFiltered;
            }
            
            return baseData;
        }

        function getFilteredDataForPlanning() {
            if (!currentUser) return [];
            
            var baseData = [];
            if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                baseData = data;
            } else {
                for (var i = 0; i < data.length; i++) {
                    if (data[i].service === currentUser.service && !data[i].valide) {
                        baseData.push(data[i]);
                    }
                }
            }
            
            if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && selectedServiceFilter !== 'TOUS') {
                var filtered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].service === selectedServiceFilter) filtered.push(baseData[i]);
                }
                return filtered;
            }
            
            return baseData;
        }
       async function validateActivity(activityId) {
    if (!canValidate()) {
        alert('Seul l\'administrateur peut valider');
        return;
    }
    
    if (confirm('Valider cette activit√©?')) {
        try {
            const { error } = await supabase
                .from('activites')
                .update({
                    valide: true,
                    valide_par: currentUser.nom,
                    date_validation: new Date().toISOString()
                })
                .eq('id', activityId);
            
            if (error) throw error;
            
            // Mettre √† jour localement
            for (var i = 0; i < data.length; i++) {
                if (data[i].id === activityId) {
                    data[i].valide = true;
                    data[i].valide_par = currentUser.nom;
                    data[i].date_validation = new Date().toISOString();
                    break;
                }
            }
            
            render();
        } catch (error) {
            console.error('Erreur validation:', error);
            alert('‚ùå Erreur lors de la validation');
        }
    }
}
async function deleteActivity(activityId) {
    var activity = null;
    for (var i = 0; i < data.length; i++) {
        if (data[i].id === activityId) {
            activity = data[i];
            break;
        }
    }
    
    if (!activity) {
        alert('Activit√© introuvable');
        return;
    }
    
    // üî• V√âRIFICATION SIMPLIFI√âE
    if (!canDeleteInPlanning(activity)) {
        alert('‚ùå Vous ne pouvez pas supprimer cette activit√©');
        return;
    }

    if (confirm('Supprimer cette activit√©?')) {
        try {
            const { error } = await supabase
                .from('activites')
                .delete()
                .eq('id', activityId);
            
            if (error) throw error;
            
            // Mettre √† jour localement
            var newData = [];
            for (var i = 0; i < data.length; i++) {
                if (data[i].id !== activityId) newData.push(data[i]);
            }
            data = newData;
            
            render();
        } catch (error) {
            console.error('Erreur suppression:', error);
            alert('‚ùå Erreur lors de la suppression');
        }
    }
}
        function showAddModal() {
            var modalContainer = document.getElementById('modal-container');
            var defaultService = currentUser.role === 'chef' ? currentUser.service : services[0];
            
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">Ajouter une activit√©</h2>';
            
            if (currentUser.role === 'chef') {
                html += '<div class="alert alert-warning">Vous ne pouvez ajouter que pour votre service: <strong>' + currentUser.service + '</strong></div>';
            }
            
            html += '<div class="form-group"><label>Objectif</label><select id="new-categorie" class="form-control"><option>Objectifs G√©n√©raux</option><option>Objectifs de R√©forme</option><option>Objectifs Sp√©cifiques</option><option>D√©cisions du CM</option><option>D√©cisions du PR</option></select></div>';
            html += '<div class="form-group"><label>Activit√©</label><textarea id="new-activite" class="form-control" rows="3"></textarea></div>';
            html += '<div class="form-group"><label>Service</label>';
            
            if (currentUser.role === 'chef') {
                html += '<input type="text" class="form-control" value="' + currentUser.service + '" disabled><input type="hidden" id="new-service" value="' + currentUser.service + '">';
            } else {
                html += '<select id="new-service" class="form-control">';
                for (var i = 0; i < services.length; i++) {
                    var selected = services[i] === defaultService ? ' selected' : '';
                    html += '<option value="' + services[i] + '"' + selected + '>' + services[i] + '</option>';
                }
                html += '</select>';
            }
            
            html += '</div><div class="btn-group"><button class="btn btn-primary" onclick="submitNewActivity()">Ajouter</button><button class="btn btn-secondary" onclick="closeModal()">Annuler</button></div></div></div>';
            
            modalContainer.innerHTML = html;
        }

        async function submitNewActivity() {
    var activite = document.getElementById('new-activite').value.trim();
    var service = document.getElementById('new-service').value; // üî• D√âPLACER ICI
    
    // üî• V√âRIFICATION SIMPLIFI√âE
    if (currentUser.role === 'chef' && service !== currentUser.service) {
        alert('‚ùå Vous ne pouvez ajouter que pour votre service');
        return;
    }
 
    if (!activite) {
        alert('Veuillez remplir l\'activit√©');
        return;
    }

    var newActivity = {
        categorie: document.getElementById('new-categorie').value,
        activite: activite,
        service: service,
        t1: false, t2: false, t3: false, t4: false,
        tdr: false, eng: false, mand: false, ordo: false, liq: false, exec: false,
        valide: false,
        valide_par: null,
        date_validation: null,
        derniere_maj: new Date().toISOString(),
        maj_par: currentUser.nom
    };
    
    // Ins√©rer DIRECTEMENT dans Supabase
    try {
        const { data: insertedData, error } = await supabase
            .from('activites')
            .insert([newActivity])
            .select();
        
        if (error) throw error;
        
        // Ajouter l'activit√© avec son ID g√©n√©r√© au tableau local
        if (insertedData && insertedData.length > 0) {
            data.push(insertedData[0]);
        }
        
        alert('‚úÖ Activit√© ajout√©e avec succ√®s !');
        closeModal();
        render();
    } catch (error) {
        console.error('Erreur ajout activit√©:', error);
        alert('‚ùå Erreur lors de l\'ajout de l\'activit√©');
    }
}
        function getFilteredDataForSuivi() {
            if (!currentUser) return [];
            
            var baseData = [];
            for (var i = 0; i < data.length; i++) {
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    if (data[i].valide) baseData.push(data[i]);
                } else {
                    if (data[i].service === currentUser.service && data[i].valide) {
                        baseData.push(data[i]);
                    }
                }
            }
            
            if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && selectedServiceFilter !== 'TOUS') {
                var filtered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].service === selectedServiceFilter) filtered.push(baseData[i]);
                }
                baseData = filtered;
            }
            
            if (suiviObjectifFilter !== 'TOUS') {
                var objectifFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].categorie === suiviObjectifFilter) {
                        objectifFiltered.push(baseData[i]);
                    }
                }
                baseData = objectifFiltered;
            }
            
            if (suiviTrimestreFilter !== 'TOUS') {
                var trimestreFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    var programmee = false;
                    if (suiviTrimestreFilter === 'T1' && baseData[i].t1) programmee = true;
                    else if (suiviTrimestreFilter === 'T2' && (baseData[i].t1 || baseData[i].t2)) programmee = true;
                    else if (suiviTrimestreFilter === 'T3' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3)) programmee = true;
                    else if (suiviTrimestreFilter === 'T4' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3 || baseData[i].t4)) programmee = true;
                    if (programmee) trimestreFiltered.push(baseData[i]);
                }
                baseData = trimestreFiltered;
            }
            
            return baseData;
        }

        function changeCommentairesServiceFilter(service) {
            commentairesServiceFilter = service;
            render();
        }

        function changeCommentairesObjectifFilter(objectif) {
            commentairesObjectifFilter = objectif;
            render();
        }

        function updateActiviteSelection() {
            var activiteSelect = document.getElementById('combined-activite');
            var objectifDisplay = document.getElementById('objectif-display');
            var serviceSelect = document.getElementById('combined-service');
            var serviceHidden = document.getElementById('combined-service-hidden');
            
            if (!activiteSelect || !objectifDisplay) return;
            
            var selectedOption = activiteSelect.options[activiteSelect.selectedIndex];
            var objectif = selectedOption.getAttribute('data-objectif');
            var service = selectedOption.getAttribute('data-service');
            
            if (objectif) {
                objectifDisplay.textContent = objectif;
                objectifDisplay.style.color = '#2563eb';
                objectifDisplay.style.fontWeight = 'bold';
            } else {
                objectifDisplay.textContent = '-';
            }
            
            if (service) {
                if (serviceSelect) serviceSelect.value = service;
                if (serviceHidden) serviceHidden.value = service;
            }
        }

        function showCommentaireEtPreuveModal() {
    var modalContainer = document.getElementById('modal-container');
    
    var html = '<div class="modal"><div class="modal-content" style="max-width: 700px;">';
    html += '<h2 style="margin-bottom: 24px;">üìã D√©poser une preuve et/ou commenter</h2>';
    
    html += '<div class="form-group"><label>Objectif *</label><select id="preuve-objectif" class="form-control" onchange="updatePreuveActivites()"><option value="">S√©lectionnez...</option>';
    
    var objectifs = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques', 'D√©cisions du CM', 'D√©cisions du PR'];
    for (var i = 0; i < objectifs.length; i++) {
        html += '<option>' + objectifs[i] + '</option>';
    }
    html += '</select></div>';
    
    html += '<div class="form-group"><label>Activit√© *</label><select id="preuve-activite" class="form-control"><option value="">S√©lectionnez d\'abord un objectif</option></select></div>';
    
    html += '<div class="form-group"><label>Commentaire (optionnel)</label><textarea id="preuve-commentaire" class="form-control" rows="4" placeholder="Ajoutez un commentaire..."></textarea></div>';
    
    html += '<div class="form-group"><label>Document de preuve (optionnel)</label>';
    html += '<input type="file" id="preuve-fichier" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.txt">';
    html += '<small style="color: #6b7280; display: block; margin-top: 4px;">Formats accept√©s : PDF, Word, Excel, PowerPoint, Images, Texte</small>';
    html += '</div>';
    
    html += '<div style="display: flex; gap: 10px; margin-top: 24px;">';
    html += '<button class="btn btn-primary" onclick="submitCommentaireEtPreuve()">üíæ Enregistrer</button>';
    html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
    html += '</div>';
    
    html += '</div></div>';
    
    modalContainer.innerHTML = html;
}

       async function submitCommentaireEtPreuve() {
    var objectif = document.getElementById('preuve-objectif').value;
    var activiteSelect = document.getElementById('preuve-activite');
    var activite = activiteSelect.value;
    var commentaire = document.getElementById('preuve-commentaire').value.trim();
    var fichierInput = document.getElementById('preuve-fichier');
    var fichier = fichierInput && fichierInput.files.length > 0 ? fichierInput.files[0] : null;
    
    if (!objectif || !activite) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner un objectif et une activit√©');
        return;
    }
    
    if (!commentaire && !fichier) {
        alert('‚ö†Ô∏è Veuillez ajouter au moins un commentaire OU un document');
        return;
    }
    
    var selectedOption = activiteSelect.options[activiteSelect.selectedIndex];
    var service = selectedOption.getAttribute('data-service') || currentUser.service;
    
    try {
        var dataToInsert = [];
        
        // üî• COMMENTAIRE
        if (commentaire) {
            dataToInsert.push({
                type: 'commentaire',
                objectif: objectif,
                activite: activite,
                service: service,
                commentaire: commentaire,
                cree_par: currentUser.nom,
                date_creation: new Date().toISOString(),
                depose_par: currentUser.nom,
                date_depot: new Date().toISOString()
            });
        }
        
        // üî• FICHIER
        if (fichier) {
            console.log('üì§ Upload du fichier:', fichier.name);
            
            var timestamp = Date.now();
            var extension = fichier.name.split('.').pop();
            var nomUnique = 'preuve_' + timestamp + '_' + service.replace(/\s+/g, '_') + '.' + extension;
            
            // Upload dans Supabase Storage
            const { data: uploadData, error: uploadError } = await supabase
                .storage
                .from('preuves_documents')
                .upload(nomUnique, fichier, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (uploadError) {
                console.error('‚ùå Erreur upload:', uploadError);
                throw uploadError;
            }
            
            // R√©cup√©rer l'URL publique
            const { data: urlData } = await supabase
                .storage
                .from('preuves_documents')
                .getPublicUrl(nomUnique);
            
            var fileUrl = urlData ? urlData.publicUrl : null;
            
            if (!fileUrl) {
                throw new Error('Impossible de g√©n√©rer l\'URL du fichier');
            }
            
            console.log('‚úÖ Fichier upload√©, URL:', fileUrl);
            
            dataToInsert.push({
                type: 'preuve',
                objectif: objectif,
                activite: activite,
                service: service,
                nom_fichier: fichier.name,
                nom_fichier_storage: nomUnique,
                file_url: fileUrl,
                taille_fichier: Math.round(fichier.size / 1024) + ' Ko',
                cree_par: currentUser.nom,
                date_creation: new Date().toISOString(),
                depose_par: currentUser.nom,
                date_depot: new Date().toISOString()
            });
        }
        
        // üî• INS√âRER DANS SUPABASE
        if (dataToInsert.length > 0) {
            const { data: insertData, error: insertError } = await supabase
                .from('commentaires_preuves')
                .insert(dataToInsert)
                .select();
            
            if (insertError) {
                console.error('‚ùå Erreur insertion:', insertError);
                throw insertError;
            }
            
            console.log('‚úÖ Donn√©es ins√©r√©es:', insertData);
            
            // Ajouter aux donn√©es locales
            if (insertData) {
                for (var i = 0; i < insertData.length; i++) {
                    commentairesEtPreuves.push(insertData[i]);
                }
            }
        }
        
        alert('‚úÖ Enregistrement r√©ussi !');
        closeModal();
        render();
        
    } catch (error) {
        console.error('‚ùå Erreur compl√®te:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}

        function showEditCommentaireModal(id) {
            var item = null;
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id === id) {
                    item = commentairesEtPreuves[i];
                    break;
                }
            }
            
            if (!item || item.type !== 'commentaire') return;
            
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">‚úèÔ∏è Modifier le commentaire</h2>';
            
            html += '<div class="form-group"><label>Objectif</label><div style="padding: 8px 16px; background-color: #f3f4f6; border-radius: 8px;">' + item.objectif + '</div></div>';
            html += '<div class="form-group"><label>Activit√©</label><div style="padding: 8px 16px; background-color: #f3f4f6; border-radius: 8px;">' + item.activite + '</div></div>';
            html += '<div class="form-group"><label>Commentaire *</label><textarea id="edit-commentaire" class="form-control" rows="4">' + item.commentaire + '</textarea></div>';
            
            html += '<div class="btn-group"><button class="btn btn-primary" onclick="submitEditCommentaire(' + id + ')">Enregistrer</button><button class="btn btn-secondary" onclick="closeModal()">Annuler</button></div></div></div>';
            
            modalContainer.innerHTML = html;
        }

        async function submitEditCommentaire(id) {
            var newCommentaire = document.getElementById('edit-commentaire').value.trim();
            
            if (!newCommentaire) {
                alert('Le commentaire ne peut pas √™tre vide');
                return;
            }
            
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id === id) {
                    commentairesEtPreuves[i].commentaire = newCommentaire;
                    commentairesEtPreuves[i].modifiePar = currentUser.nom;
                    commentairesEtPreuves[i].dateModification = new Date().toLocaleString('fr-FR');
                    break;
                }
            }
            
            await saveCommentairesEtPreuves();
            closeModal();
            render();
        }

        function showManagePreuvesModal(activite, service) {
            var modalContainer = document.getElementById('modal-container');
            
            var preuvesActivite = [];
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                var item = commentairesEtPreuves[i];
                if (item.type === 'preuve' && item.activite === activite && item.service === service) {
                    preuvesActivite.push(item);
                }
            }
            
                            var html = '<div class="modal"><div class="modal-content" style="max-width: 900px;"><h2 style="margin-bottom: 16px;">üìé G√©rer les preuves</h2>';
            
            html += '<div style="background-color: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 16px;"><strong>Activit√©:</strong> ' + activite + '<br/><strong>Service:</strong> ' + service + '</div>';
            
            html += '<h3 style="margin-bottom: 12px;">Documents d√©pos√©s</h3>';
            
            if (preuvesActivite.length > 0) {
                for (var i = 0; i < preuvesActivite.length; i++) {
                    var p = preuvesActivite[i];
                    html += '<div class="fichier-item"><div><strong>üìÑ ' + p.nomFichier + '</strong><br/><small style="color: #6b7280;">D√©pos√© par ' + p.deposePar + ' le ' + p.dateDepot + '</small></div><button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deletePreuve(' + p.id + ')">Supprimer</button></div>';
                }
            } else {
                html += '<p style="text-align: center; padding: 16px; color: #6b7280;">Aucune preuve</p>';
            }
            
            html += '<h3 style="margin-top: 24px; margin-bottom: 12px;">Ajouter nouvelles preuves</h3>';
            html += '<div class="form-group"><input type="file" id="new-preuves-fichiers" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple style="padding: 4px 8px;"></div>';
            
            html += '<div class="btn-group"><button class="btn btn-success" onclick="ajouterNouvellesPreuves(\'' + activite.replace(/'/g, "\\'") + '\', \'' + service + '\')">Ajouter</button><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div></div></div>';
            
            modalContainer.innerHTML = html;
        }

        async function ajouterNouvellesPreuves(activite, service) {
            var fichiersInput = document.getElementById('new-preuves-fichiers');
            
            if (!fichiersInput.files || fichiersInput.files.length === 0) {
                alert('Veuillez s√©lectionner au moins un fichier');
                return;
            }
            
            var maxId = 0;
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id > maxId) maxId = commentairesEtPreuves[i].id;
            }
            
            var activiteData = null;
            for (var i = 0; i < data.length; i++) {
                if (data[i].activite === activite && data[i].service === service) {
                    activiteData = data[i];
                    break;
                }
            }
            
            var objectif = activiteData ? activiteData.categorie : '';
            
            for (var i = 0; i < fichiersInput.files.length; i++) {
                var fichier = fichiersInput.files[i];
                commentairesEtPreuves.push({
                    id: maxId + 1 + i,
                    type: 'preuve',
                    objectif: objectif,
                    activite: activite,
                    service: service,
                    nomFichier: fichier.name,
                    tailleFichier: Math.round(fichier.size / 1024) + ' Ko',
                    deposePar: currentUser.nom,
                    dateDepot: new Date().toLocaleString('fr-FR')
                });
            }
            
            await saveCommentairesEtPreuves();
            alert('Fichiers ajout√©s');
            showManagePreuvesModal(activite, service);
        }

        async function deletePreuve(id) {
            if (!confirm('Supprimer cette preuve ?')) return;
            
            var newItems = [];
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id !== id) newItems.push(commentairesEtPreuves[i]);
            }
            commentairesEtPreuves = newItems;
            await saveCommentairesEtPreuves();
            closeModal();
            render();
        }

        async function deleteCommentaireOuPreuve(id) {
            if (confirm('Supprimer cet √©l√©ment?')) {
                var newItems = [];
                for (var i = 0; i < commentairesEtPreuves.length; i++) {
                    if (commentairesEtPreuves[i].id !== id) newItems.push(commentairesEtPreuves[i]);
                }
                commentairesEtPreuves = newItems;
                await saveCommentairesEtPreuves();
                render();
            }
        }
function exporterRapportWord() {
            var isGlobal = currentUser.role === 'chefdept' || (currentUser.role === 'admin' && selectedServiceFilter === 'TOUS');
            var serviceRapport = currentUser.role === 'chef' ? currentUser.service : (isGlobal ? null : selectedServiceFilter);
            
            var statsObjectifs = calculerStatsObjectifs(serviceRapport);
            var statsDecisions = calculerStatsDecisions(serviceRapport);
            
            var totalPlanifieesObj = 0, totalRealiseesObj = 0;
            for (var i = 0; i < statsObjectifs.length; i++) {
                totalPlanifieesObj += statsObjectifs[i].planifiees;
                totalRealiseesObj += statsObjectifs[i].realisees;
            }
            var tauxTotalObj = totalPlanifieesObj > 0 ? Math.round((totalRealiseesObj / totalPlanifieesObj) * 100) : 0;
            
            var totalPlanifieesDec = 0, totalRealiseesDec = 0;
            for (var i = 0; i < statsDecisions.length; i++) {
                totalPlanifieesDec += statsDecisions[i].planifiees;
                totalRealiseesDec += statsDecisions[i].realisees;
            }
            var tauxTotalDec = totalPlanifieesDec > 0 ? Math.round((totalRealiseesDec / totalPlanifieesDec) * 100) : 0;
            
            var tauxGlobalTotal = (totalPlanifieesObj + totalPlanifieesDec) > 0 ? Math.round(((totalRealiseesObj + totalRealiseesDec) / (totalPlanifieesObj + totalPlanifieesDec)) * 100) : 0;
            
            // R√©cup√©rer les textes
            var contexteKey = 'contexte_' + (serviceRapport || 'global');
            var contexteValue = rapportTextes[contexteKey] || 'Non renseign√©';
            var rappelKey = 'rappel_' + (serviceRapport || 'global');
            var rappelValue = rapportTextes[rappelKey] || 'Non renseign√©';
            var rappelDecKey = 'rappelDec_' + (serviceRapport || 'global');
            var rappelDecValue = rapportTextes[rappelDecKey] || 'Non renseign√©';
            var diffKey = 'difficultes_' + (serviceRapport || 'global');
            var diffValue = rapportTextes[diffKey] || 'Non renseign√©';
            var pistesKey = 'pistes_' + (serviceRapport || 'global');
            var pistesValue = rapportTextes[pistesKey] || 'Non renseign√©';
            
            var html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/1999/xhtml">';
            html += '<head><meta charset="utf-8"><title>Rapport de Performance</title>';
            html += '<style>';
            html += 'body { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; line-height: 1.6; margin: 1cm; }';
            html += 'h1 { color: #2563eb; text-align: center; font-size: 20pt; font-weight: bold; margin-bottom: 20px; }';
            html += 'h2 { color: #2563eb; font-size: 14pt; font-weight: bold; margin-top: 30px; margin-bottom: 15px; }';
            html += 'h3 { color: #4b5563; font-size: 14pt; margin-top: 20px; margin-bottom: 12px; font-weight: bold; }';
            html += 'p { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; margin: 10px 0; text-align: justify; line-height: 1.6; }';
            html += 'table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12pt; }';
            html += 'th, td { border: 1px solid #000; padding: 4px 8px; height: 18px; }';
            html += 'th { background-color: #2563eb; color: white; font-weight: bold; text-align: center; }';
            html += 'td { text-align: center; }';
            html += 'td:first-child { text-align: left; font-weight: bold; }';
            html += 'tr.total { background-color: #e5e7eb; font-weight: bold; }';
            html += '.graph-space { margin: 30px 0; padding: 60px 20px; text-align: center; }';
            html += '.graph-title { font-family: "Century Gothic", Arial, sans-serif; font-size: 14pt; font-weight: bold; color: #4b5563; margin-bottom: 10px; }';
            html += '.graph-instruction { font-family: "Century Gothic", Arial, sans-serif; font-size: 11pt; color: #6b7280; font-style: italic; }';
            html += 'ul { margin: 15px 0; padding: 0; list-style-type: none !important; }';
            html += 'li { margin-bottom: 12px; padding: 0; list-style-type: none !important; list-style: none !important; }';
            html += 'li .activite-titre { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; font-weight: bold; display: block; margin-bottom: 4px; }';
            html += 'li .commentaire { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; display: block; text-align: justify; font-style: italic; color: #000; margin-left: 0; line-height: 1.6; }';
            html += '</style></head><body>';
            
            var titreRapport = isGlobal ? 'RAPPORT DE PERFORMANCE GLOBAL' : 'RAPPORT DE PERFORMANCE - ' + (serviceRapport || 'SERVICE');
            html += '<h1>' + titreRapport + '</h1>';
            html += '<p style="text-align: center; color: #6b7280; margin-bottom: 30px;">Ann√©e 2026 - G√©n√©r√© le ' + new Date().toLocaleString('fr-FR') + '</p>';
            
            // SECTION 1
            html += '<h2>1. √âl√©ments de contexte</h2>';
            html += '<p>' + contexteValue.replace(/\n/g, '<br/>') + '</p>';
            
            // SECTION 2
            html += '<h2>2. Bilan des r√©alisations des objectifs</h2>';
            html += '<h3>Rappel des actions programm√©es</h3>';
            html += '<p>' + rappelValue.replace(/\n/g, '<br/>') + '</p>';
            
            // TABLEAU 1 - COMPLET
            html += '<h3>Tableau 1 : Taux par objectif</h3>';
            html += '<table><thead><tr><th>Objectifs</th><th>Planifi√©es</th><th>R√©alis√©es</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.planifiees + '</td><td>' + stat.realisees + '</td><td><strong>' + stat.taux + '</strong></td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + totalPlanifieesObj + '</td><td>' + totalRealiseesObj + '</td><td><strong>' + tauxTotalObj + '</strong></td></tr>';
            html += '</tbody></table>';
            
            // ESPACE GRAPHIQUE 1
            html += '<div class="graph-space">';
            html += '<div class="graph-title">Graphique 1 : Taux par objectif</div>';
            html += '<div class="graph-instruction">[Ins√©rer ici le graphique]</div>';
            html += '</div>';
            
            // LISTES DES ACTIVIT√âS
            var objectifsList = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques'];
            for (var j = 0; j < objectifsList.length; j++) {
                var objNom = objectifsList[j];
                var activitesObj = getActivitesRealisees(serviceRapport, objNom);
                html += '<h3>' + objNom + '</h3>';
                if (activitesObj.length > 0) {
                    html += '<ul>';
                    for (var k = 0; k < activitesObj.length; k++) {
                        var act = activitesObj[k];
                        html += '<li>';
                        html += '<div class="activite-titre">' + act.activite + ' :</div>';
                        var commentaire = getCommentaireForActivite(act.activite, act.service);
                        if (commentaire) {
                            html += '<div class="commentaire">' + commentaire + '</div>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p style="color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e √† 100%.</p>';
                }
            }
            
            // SECTION 3
            html += '<h2>3. Bilan d\'ex√©cution des D√©cisions du PR et des CM</h2>';
            html += '<h3>Rappel des d√©cisions</h3>';
            html += '<p>' + rappelDecValue.replace(/\n/g, '<br/>') + '</p>';
            
            // TABLEAU 2 - COMPLET
            html += '<h3>Tableau 2 : Taux par d√©cision</h3>';
            html += '<table><thead><tr><th>D√©cisions</th><th>Planifi√©es</th><th>R√©alis√©es</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsDecisions.length; i++) {
                var stat = statsDecisions[i];
                html += '<tr><td>' + stat.decision + '</td><td>' + stat.planifiees + '</td><td>' + stat.realisees + '</td><td><strong>' + stat.taux + '</strong></td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + totalPlanifieesDec + '</td><td>' + totalRealiseesDec + '</td><td><strong>' + tauxTotalDec + '</strong></td></tr>';
            html += '</tbody></table>';
            
            // ESPACE GRAPHIQUE 2
            html += '<div class="graph-space">';
            html += '<div class="graph-title">Graphique 2 : Taux par d√©cision</div>';
            html += '<div class="graph-instruction">[Ins√©rer ici le graphique]</div>';
            html += '</div>';
            
            // LISTES DES D√âCISIONS
            var decisionsPR = getActivitesRealisees(serviceRapport, 'D√©cisions du PR');
            var decisionsCM = getActivitesRealisees(serviceRapport, 'D√©cisions du CM');
            
            html += '<h3>D√©cisions du PR</h3>';
            if (decisionsPR.length > 0) {
                html += '<ul>';
                for (var k = 0; k < decisionsPR.length; k++) {
                    var act = decisionsPR[k];
                    html += '<li>';
                    html += '<div class="activite-titre">' + act.activite + ' :</div>';
                    var commentaire = getCommentaireForActivite(act.activite, act.service);
                    if (commentaire) {
                        html += '<div class="commentaire">' + commentaire + '</div>';
                    }
                    html += '</li>';
                }
                html += '</ul>';
            } else {
                html += '<p style="color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
            }
            
            html += '<h3>D√©cisions du CM</h3>';
            if (decisionsCM.length > 0) {
                html += '<ul>';
                for (var k = 0; k < decisionsCM.length; k++) {
                    var act = decisionsCM[k];
                    html += '<li>';
                    html += '<div class="activite-titre">' + act.activite + ' :</div>';
                    var commentaire = getCommentaireForActivite(act.activite, act.service);
                    if (commentaire) {
                        html += '<div class="commentaire">' + commentaire + '</div>';
                    }
                    html += '</li>';
                }
                html += '</ul>';
            } else {
                html += '<p style="color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
            }
            
            // TABLEAU 3 - COMPLET
            html += '<h3>Tableau 3 : Vue globale</h3>';
            html += '<table><thead><tr><th>Cat√©gories</th><th>Planifi√©es</th><th>R√©alis√©es</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.planifiees + '</td><td>' + stat.realisees + '</td><td><strong>' + stat.taux + '</strong></td></tr>';
            }
            html += '<tr><td>D√©cisions du PR</td><td>' + statsDecisions[0].planifiees + '</td><td>' + statsDecisions[0].realisees + '</td><td><strong>' + statsDecisions[0].taux + '</strong></td></tr>';
            html += '<tr><td>D√©cisions du CM</td><td>' + statsDecisions[1].planifiees + '</td><td>' + statsDecisions[1].realisees + '</td><td><strong>' + statsDecisions[1].taux + '</strong></td></tr>';
            html += '<tr class="total"><td>TOTAL GLOBAL</td><td>' + (totalPlanifieesObj + totalPlanifieesDec) + '</td><td>' + (totalRealiseesObj + totalRealiseesDec) + '</td><td><strong>' + tauxGlobalTotal + '</strong></td></tr>';
            html += '</tbody></table>';
            
            // ESPACE GRAPHIQUE 3
            html += '<div class="graph-space">';
            html += '<div class="graph-title">Graphique 3 : Vue globale</div>';
            html += '<div class="graph-instruction">[Ins√©rer ici le graphique]</div>';
            html += '</div>';
            
            // SECTION 4
            html += '<h2>4. Difficult√©s et Solutions</h2>';
            html += '<h3>4.1 Difficult√©s</h3>';
            html += '<p>' + diffValue.replace(/\n/g, '<br/>') + '</p>';
            html += '<h3>4.2 Pistes de Solutions</h3>';
            html += '<p>' + pistesValue.replace(/\n/g, '<br/>') + '</p>';
            
            html += '</body></html>';
            
            var blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'Rapport_Performance_2026_' + new Date().getTime() + '.doc';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exporterDonneesExcel() {
            var isGlobal = currentUser.role === 'chefdept' || (currentUser.role === 'admin' && selectedServiceFilter === 'TOUS');
            var serviceRapport = currentUser.role === 'chef' ? currentUser.service : (isGlobal ? null : selectedServiceFilter);
            
            var statsObjectifs = calculerStatsObjectifs(serviceRapport);
            var statsDecisions = calculerStatsDecisions(serviceRapport);
            
            // Calculer totaux
            var totalPlanifieesObj = 0, totalRealiseesObj = 0;
            for (var i = 0; i < statsObjectifs.length; i++) {
                totalPlanifieesObj += statsObjectifs[i].planifiees;
                totalRealiseesObj += statsObjectifs[i].realisees;
            }
            var tauxTotalObj = totalPlanifieesObj > 0 ? Math.round((totalRealiseesObj / totalPlanifieesObj) * 100) : 0;
            
            var totalPlanifieesDec = 0, totalRealiseesDec = 0;
            for (var i = 0; i < statsDecisions.length; i++) {
                totalPlanifieesDec += statsDecisions[i].planifiees;
                totalRealiseesDec += statsDecisions[i].realisees;
            }
            var tauxTotalDec = totalPlanifieesDec > 0 ? Math.round((totalRealiseesDec / totalPlanifieesDec) * 100) : 0;
            
            var tauxGlobalTotal = (totalPlanifieesObj + totalPlanifieesDec) > 0 ? Math.round(((totalRealiseesObj + totalRealiseesDec) / (totalPlanifieesObj + totalPlanifieesDec)) * 100) : 0;
            
            var html = '<html xmlns:x="urn:schemas-microsoft-com:office:excel">';
            html += '<head><meta charset="utf-8"><style>';
            html += 'table { border-collapse: collapse; width: 100%; margin-bottom: 40px; }';
            html += 'th, td { border: 1px solid #000; padding: 8px; text-align: left; }';
            html += 'th { background-color: #2563eb; color: white; font-weight: bold; }';
            html += 'tr.total { background-color: #e5e7eb; font-weight: bold; }';
            html += 'h2 { color: #2563eb; margin-top: 30px; }';
            html += '</style></head><body>';
            
            var titreRapport = isGlobal ? 'DONN√âES RAPPORT GLOBAL' : 'DONN√âES RAPPORT - ' + (serviceRapport || 'SERVICE');
            html += '<h1>' + titreRapport + '</h1>';
            html += '<p>Ann√©e 2026 - G√©n√©r√© le ' + new Date().toLocaleString('fr-FR') + '</p>';
            
            // TABLEAU 1 : Objectifs
            html += '<h2>Tableau 1 : Taux par objectif</h2>';
            html += '<table><thead><tr><th>Objectifs</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.taux + '</td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + tauxTotalObj + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<p style="font-style: italic; color: #666; margin-bottom: 40px;">‚Üí S√©lectionnez ce tableau et cr√©ez un graphique en barres horizontales</p>';
            
            // TABLEAU 2 : D√©cisions
            html += '<h2>Tableau 2 : Taux par d√©cision</h2>';
            html += '<table><thead><tr><th>D√©cisions</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsDecisions.length; i++) {
                var stat = statsDecisions[i];
                html += '<tr><td>' + stat.decision + '</td><td>' + stat.taux + '</td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + tauxTotalDec + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<p style="font-style: italic; color: #666; margin-bottom: 40px;">‚Üí S√©lectionnez ce tableau et cr√©ez un graphique en barres horizontales</p>';
            
            // TABLEAU 3 : Vue globale
            html += '<h2>Tableau 3 : Vue globale</h2>';
            html += '<table><thead><tr><th>Cat√©gories</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.taux + '</td></tr>';
            }
            html += '<tr><td>D√©cisions du PR</td><td>' + statsDecisions[0].taux + '</td></tr>';
            html += '<tr><td>D√©cisions du CM</td><td>' + statsDecisions[1].taux + '</td></tr>';
            html += '<tr class="total"><td>TOTAL GLOBAL</td><td>' + tauxGlobalTotal + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<p style="font-style: italic; color: #666;">‚Üí S√©lectionnez ce tableau et cr√©ez un histogramme vertical</p>';
            
            html += '</body></html>';
            
            var blob = new Blob(['\ufeff' + html], { type: 'application/vnd.ms-excel' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'Donnees_Rapport_2026_' + new Date().getTime() + '.xls';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function sauvegarderTexteRapport(key, value) {
            rapportTextes[key] = value;
            saveRapportTextes();
        }

        function getActivitesRealisees(service, objectif) {
            var activites = [];
            for (var i = 0; i < data.length; i++) {
                var d = data[i];
                if (d.valide && calcTaux(d) === 100) {
                    if (service && d.service !== service) continue;
                    if (objectif && d.categorie !== objectif) continue;
                    activites.push(d);
                }
            }
            return activites;
        }

        function getCommentaireForActivite(activite, service) {
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                var item = commentairesEtPreuves[i];
                if (item.type === 'commentaire' && item.activite === activite && item.service === service) {
                    return item.commentaire;
                }
            }
            return '';
        }

        function calculerStatsObjectifs(service) {
            var objectifs = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques'];
            var stats = [];
            
            for (var j = 0; j < objectifs.length; j++) {
                var obj = objectifs[j];
                var planifiees = 0;
                var realisees = 0;
                
                for (var i = 0; i < data.length; i++) {
                    var d = data[i];
                    if (!d.valide) continue;
                    if (service && d.service !== service) continue;
                    if (d.categorie === obj) {
                        planifiees++;
                        if (calcTaux(d) === 100) realisees++;
                    }
                }
                
                var taux = planifiees > 0 ? Math.round((realisees / planifiees) * 100) : 0;
                stats.push({
                    objectif: obj,
                    planifiees: planifiees,
                    realisees: realisees,
                    taux: taux
                });
            }
            
            return stats;
        }

        function calculerStatsDecisions(service) {
            var decisions = ['D√©cisions du PR', 'D√©cisions du CM'];
            var stats = [];
            
            for (var j = 0; j < decisions.length; j++) {
                var dec = decisions[j];
                var planifiees = 0;
                var realisees = 0;
                
                for (var i = 0; i < data.length; i++) {
                    var d = data[i];
                    if (!d.valide) continue;
                    if (service && d.service !== service) continue;
                    if (d.categorie === dec) {
                        planifiees++;
                        if (calcTaux(d) === 100) realisees++;
                    }
                }
                
                var taux = planifiees > 0 ? Math.round((realisees / planifiees) * 100) : 0;
                stats.push({
                    decision: dec,
                    planifiees: planifiees,
                    realisees: realisees,
                    taux: taux
                });
            }
            
            return stats;
        }
function showUserList() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content" style="max-width: 1000px;"><h2 style="margin-bottom: 24px;">Gestion des Comptes</h2>';
            
            html += '<div style="margin-bottom: 16px;"><button class="btn btn-success" onclick="showCreateUserForm()">+ Cr√©er un compte</button></div>';
            
            html += '<div class="table-container"><table><thead class="blue"><tr><th>Utilisateur</th><th>Nom</th><th>Service</th><th>R√¥le</th><th>Statut</th><th style="text-align: center;">Actions</th></tr></thead><tbody>';
            
            for (var i = 0; i < users.length; i++) {
                var u = users[i];
                if (typeof u.actif === 'undefined') u.actif = true;
                
                html += '<tr><td>' + u.user + '</td><td>' + u.nom + '</td><td>' + u.service + '</td><td>';
                
                if (u.role === 'admin') html += '<span class="badge" style="background-color: #dc2626; color: white;">Admin</span>';
                else if (u.role === 'chef') html += '<span class="badge" style="background-color: #059669; color: white;">Chef</span>';
                else html += '<span class="badge" style="background-color: #d97706; color: white;">Chef D√©p.</span>';
                
                html += '</td><td>';
                
                if (u.actif) {
                    html += '<span class="badge badge-green" style="color: #065f46;">Actif</span>';
                } else {
                    html += '<span class="badge" style="background-color: #fee2e2; color: #991b1b;">D√©sactiv√©</span>';
                }
                
                html += '</td><td style="text-align: center;">';
                
                if (u.role !== 'admin') {
                    html += '<div style="display: flex; gap: 4px; justify-content: center;">';
                    html += '<button class="btn btn-primary" style="font-size: 11px; padding: 4px 8px;" onclick="showEditUserForm(' + u.id + ')">Modifier</button>';
                    
                    if (u.actif) {
                        html += '<button class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;" onclick="toggleUserStatus(' + u.id + ')">D√©sactiver</button>';
                    } else {
                        html += '<button class="btn btn-success" style="font-size: 11px; padding: 4px 8px;" onclick="toggleUserStatus(' + u.id + ')">Activer</button>';
                    }
                    
                    html += '<button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="confirmDeleteUser(' + u.id + ')">Supprimer</button>';
                    html += '</div>';
                } else {
                    html += '<span style="color: #6b7280; font-size: 12px;">Compte prot√©g√©</span>';
                }
                
                html += '</td></tr>';
            }
            
            html += '</tbody></table></div>';
            html += '<div style="margin-top: 16px; text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        function showConnectedUsers() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2>Utilisateurs Connect√©s</h2>';
            
            if (connectedUsers.length > 0) {
                html += '<div class="table-container" style="margin-top: 16px;"><table><thead class="blue"><tr><th>Nom</th><th>Service</th><th>Connect√© √†</th></tr></thead><tbody>';
                for (var i = 0; i < connectedUsers.length; i++) {
                    var u = connectedUsers[i];
                    html += '<tr><td>' + u.nom + '</td><td>' + u.service + '</td><td>' + u.connectedAt + '</td></tr>';
                }
                html += '</tbody></table></div>';
            } else {
                html += '<p style="text-align: center; padding: 32px; color: #6b7280;">Aucun utilisateur connect√©</p>';
            }
            
            html += '<div style="margin-top: 16px; text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        function showCreateUserForm() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">Cr√©er un compte</h2>';
            
            html += '<div class="form-group"><label>Nom d\'utilisateur *</label><input type="text" id="new-username" class="form-control" placeholder="ex: chef.nouveauservice"></div>';
            html += '<div class="form-group"><label>Mot de passe *</label><input type="password" id="new-password" class="form-control"></div>';
            html += '<div class="form-group"><label>Nom complet *</label><input type="text" id="new-fullname" class="form-control" placeholder="ex: Chef Nouveau Service"></div>';
            html += '<div class="form-group"><label>R√¥le *</label><select id="new-role" class="form-control"><option value="chef">Chef</option><option value="chefdept">Chef D√©partement</option></select></div>';
            html += '<div class="form-group"><label>Service *</label><select id="new-service" class="form-control">';
            for (var i = 0; i < services.length; i++) {
                html += '<option value="' + services[i] + '">' + services[i] + '</option>';
            }
            html += '<option value="TOUS">TOUS</option></select></div>';
            
            html += '<div class="btn-group"><button class="btn btn-success" onclick="createNewUser()">Cr√©er</button><button class="btn btn-secondary" onclick="showUserList()">Annuler</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        async function createNewUser() {
            var username = document.getElementById('new-username').value.trim();
            var password = document.getElementById('new-password').value;
            var fullname = document.getElementById('new-fullname').value.trim();
            var role = document.getElementById('new-role').value;
            var service = document.getElementById('new-service').value;
            
            if (!username || !password || !fullname) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            for (var i = 0; i < users.length; i++) {
                if (users[i].user === username) {
                    alert('Ce nom d\'utilisateur existe d√©j√†');
                    return;
                }
            }
            
            var maxId = 0;
            for (var i = 0; i < users.length; i++) {
                if (users[i].id > maxId) maxId = users[i].id;
            }
            
            users.push({
                id: maxId + 1,
                user: username,
                pass: password,
                role: role,
                nom: fullname,
                service: service,
                actif: true
            });
            
            await saveUsers();
            alert('Compte cr√©√© avec succ√®s');
            showUserList();
        }

        async function showEditUserForm(userId) {
            var user = null;
            for (var i = 0; i < users.length; i++) {
                if (users[i].id === userId) {
                    user = users[i];
                    break;
                }
            }
            
            if (!user) return;
            
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">Modifier: ' + user.user + '</h2>';
            
            html += '<div class="form-group"><label>Nom d\'utilisateur</label><input type="text" value="' + user.user + '" class="form-control" disabled></div>';
            html += '<div class="form-group"><label>Nouveau mot de passe (laisser vide si inchang√©)</label><input type="password" id="edit-password" class="form-control"></div>';
            html += '<div class="form-group"><label>Nom complet *</label><input type="text" id="edit-fullname" class="form-control" value="' + user.nom + '"></div>';
            
            html += '<div class="form-group"><label>Service *</label><select id="edit-service" class="form-control">';
            for (var i = 0; i < services.length; i++) {
                html += '<option value="' + services[i] + '"' + (user.service === services[i] ? ' selected' : '') + '>' + services[i] + '</option>';
            }
            html += '<option value="TOUS"' + (user.service === 'TOUS' ? ' selected' : '') + '>TOUS</option></select></div>';
            
            html += '<div class="btn-group"><button class="btn btn-primary" onclick="updateUser(' + userId + ')">Enregistrer</button><button class="btn btn-secondary" onclick="showUserList()">Annuler</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        async function updateUser(userId) {
            var password = document.getElementById('edit-password').value;
            var fullname = document.getElementById('edit-fullname').value.trim();
            var service = document.getElementById('edit-service').value;
            
            if (!fullname) {
                alert('Veuillez remplir le nom complet');
                return;
            }
            
            for (var i = 0; i < users.length; i++) {
                if (users[i].id === userId) {
                    if (password) users[i].pass = password;
                    users[i].nom = fullname;
                    users[i].service = service;
                    break;
                }
            }
            
            await saveUsers();
            alert('Compte modifi√© avec succ√®s');
            showUserList();
        }

        async function toggleUserStatus(userId) {
            for (var i = 0; i < users.length; i++) {
                if (users[i].id === userId) {
                    if (typeof users[i].actif === 'undefined') users[i].actif = true;
                    users[i].actif = !users[i].actif;
                    await saveUsers();
                    showUserList();
                    return;
                }
            }
        }

        async function confirmDeleteUser(userId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce compte ?')) return;
            
            var newUsers = [];
            for (var i = 0; i < users.length; i++) {
                if (users[i].id !== userId) newUsers.push(users[i]);
            }
            users = newUsers;
            await saveUsers();
            alert('Compte supprim√©');
            showUserList();
        }

        function showPermissions() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content" style="max-width: 900px;"><h2 style="margin-bottom: 24px;">üîí Gestion des Permissions</h2>';
            
            html += '<div class="alert alert-info" style="margin-bottom: 24px;">‚ÑπÔ∏è <strong>Information:</strong> Les permissions sont d√©finies par r√¥le. Chaque utilisateur h√©rite automatiquement des permissions de son r√¥le.</div>';
            
            html += '<div class="table-container"><table><thead class="blue"><tr><th style="width: 30%;">Fonctionnalit√©</th><th style="text-align: center;">Admin</th><th style="text-align: center;">Chef D√©partement</th><th style="text-align: center;">Chef de Service</th></tr></thead><tbody>';
            
            var permissions = [
                {nom: 'Voir Tableau de Bord', admin: true, chefdept: true, chef: true},
                {nom: 'Ajouter des activit√©s', admin: true, chefdept: false, chef: true},
                {nom: 'Modifier les activit√©s', admin: true, chefdept: false, chef: true},
                {nom: 'Valider les activit√©s', admin: true, chefdept: false, chef: false},
                {nom: 'Supprimer les activit√©s', admin: true, chefdept: false, chef: true},
                {nom: 'Cocher les √©tapes d\'ex√©cution', admin: true, chefdept: false, chef: true},
                {nom: 'D√©poser des commentaires', admin: true, chefdept: false, chef: true},
                {nom: 'D√©poser des preuves', admin: true, chefdept: false, chef: true},
                {nom: 'Voir les commentaires/preuves', admin: true, chefdept: true, chef: true},
                {nom: 'Modifier/Supprimer commentaires', admin: true, chefdept: false, chef: true},
                {nom: 'Voir Performance', admin: true, chefdept: true, chef: true},
                {nom: 'G√©n√©rer Rapport', admin: true, chefdept: true, chef: true},
                {nom: 'Filtrer tous les services', admin: true, chefdept: true, chef: false},
                {nom: 'G√©rer les utilisateurs', admin: true, chefdept: false, chef: false},
                {nom: 'Voir utilisateurs connect√©s', admin: true, chefdept: false, chef: false}
            ];
            
            for (var i = 0; i < permissions.length; i++) {
                var p = permissions[i];
                html += '<tr>';
                html += '<td><strong>' + p.nom + '</strong></td>';
                html += '<td style="text-align: center;">' + (p.admin ? '<span style="color: #059669; font-size: 20px;">‚úì</span>' : '<span style="color: #dc2626;">‚úó</span>') + '</td>';
                html += '<td style="text-align: center;">' + (p.chefdept ? '<span style="color: #059669; font-size: 20px;">‚úì</span>' : '<span style="color: #dc2626;">‚úó</span>') + '</td>';
                html += '<td style="text-align: center;">' + (p.chef ? '<span style="color: #059669; font-size: 20px;">‚úì</span>' : '<span style="color: #dc2626;">‚úó</span>') + '</td>';
                html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            
            html += '<h3 style="margin-top: 32px; margin-bottom: 16px;">Description des R√¥les</h3>';
            
            html += '<div style="background-color: #fee2e2; padding: 16px; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 16px;">';
            html += '<h4 style="color: #dc2626; margin-bottom: 8px;">üë§ Administrateur</h4>';
            html += '<p style="font-size: 14px; color: #991b1b;">Acc√®s complet au syst√®me. Peut g√©rer tous les services, valider les activit√©s, g√©rer les utilisateurs et acc√©der √† toutes les fonctionnalit√©s.</p>';
            html += '</div>';
            
            html += '<div style="background-color: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #d97706; margin-bottom: 16px;">';
            html += '<h4 style="color: #d97706; margin-bottom: 8px;">üë§ Chef de D√©partement</h4>';
            html += '<p style="font-size: 14px; color: #92400e;">Vue globale en lecture seule. Peut consulter toutes les donn√©es, g√©n√©rer des rapports globaux, mais ne peut pas modifier les activit√©s.</p>';
            html += '</div>';
            
            html += '<div style="background-color: #d1fae5; padding: 16px; border-radius: 8px; border-left: 4px solid #059669;">';
            html += '<h4 style="color: #059669; margin-bottom: 8px;">üë§ Chef de Service</h4>';
            html += '<p style="font-size: 14px; color: #065f46;">Gestion compl√®te de son service uniquement. Peut ajouter, modifier, supprimer des activit√©s, d√©poser commentaires et preuves pour son service.</p>';
            html += '</div>';
            
            html += '<div style="margin-top: 16px; text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div>';
            html += '</div></div>';
            
            modalContainer.innerHTML = html;
        }
// ========== D√âTECTION TOKEN D'INVITATION ==========
function getInvitationToken() {
    const params = new URLSearchParams(window.location.search);
    return params.get('token');
}

var invitationToken = null;
var invitationData = null;

async function checkInvitationToken() {
    invitationToken = getInvitationToken();
    
    if (invitationToken) {
        try {
            const { data, error } = await supabase
                .from('invitations')
                .select('*')
                .eq('token', invitationToken)
                .eq('status', 'pending')
                .single();
            
            if (error || !data) {
                alert('Invitation invalide ou d√©j√† utilis√©e');
                window.location.href = window.location.pathname;
                return;
            }
            
            if (new Date(data.expires_at) < new Date()) {
                alert('Cette invitation a expir√©. Contactez l\'administrateur.');
                window.location.href = window.location.pathname;
                return;
            }
            
            invitationData = data;
        } catch (error) {
            console.error('Erreur v√©rification invitation:', error);
        }
    }
}
// ========== FONCTIONS STATISTIQUES ==========
function calculerMoyenne(data, field) {
    if (data.length === 0) return 0;
    var total = 0;
    var count = 0;
    for (var i = 0; i < data.length; i++) {
        if (data[i][field] !== null && data[i][field] !== undefined) {
            total += parseFloat(data[i][field]);
            count++;
        }
    }
    return count > 0 ? Math.round(total / count * 10) / 10 : 0;
}
function updateFormFilters() {
    var regionId = document.getElementById('filter-region') ? document.getElementById('filter-region').value : '';
    var prefectureSelect = document.getElementById('filter-prefecture');
    
    console.log('=== UPDATE FILTERS ===');
    console.log('R√©gion s√©lectionn√©e:', regionId);
    
    if (!prefectureSelect) {
        console.log('ERROR: prefectureSelect not found');
        return;
    }
    
    // Vider et reconstruire les options
    prefectureSelect.innerHTML = '<option value="">Toutes les pr√©fectures</option>';
    
    if (regionId) {
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
        console.log('Pr√©fectures ajout√©es pour r√©gion', regionId);
    }
    
    // IMPORTANT : R√©attacher l'√©v√©nement onchange
    prefectureSelect.onchange = function() {
        console.log('Prefecture changed!');
        filterTableRows();
    };
    
    // Appliquer le filtrage
    filterTableRows();
}

function filterTableRows() {
    var regionId = document.getElementById('filter-region') ? document.getElementById('filter-region').value : '';
    var prefectureNom = document.getElementById('filter-prefecture') ? document.getElementById('filter-prefecture').value : '';
    
    console.log('=== FILTRAGE ===');
    console.log('R√©gion ID s√©lectionn√©e:', regionId);
    console.log('Pr√©fecture s√©lectionn√©e:', prefectureNom);
    
    var rows = document.querySelectorAll('.stat-row');
    console.log('Nombre de lignes trouv√©es:', rows.length);
    
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var rowRegion = row.getAttribute('data-region');
        var rowPrefecture = row.getAttribute('data-prefecture');
        
        var showRow = true;
        
        // Filtre par r√©gion
        if (regionId && regionId !== '' && rowRegion != regionId) {
            showRow = false;
        }
        
        // Filtre par pr√©fecture
        if (prefectureNom && prefectureNom !== '' && rowPrefecture != prefectureNom) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
        
        if (showRow) {
            visibleCount++;
        }
    }
    
    console.log('Lignes visibles:', visibleCount);
    console.log('================');
}

function showStatistiquesModal() {
    var modalContainer = document.getElementById('modal-container');
   var html = '<div class="modal"><div class="modal-content" style="max-width: 98vw; max-height: 98vh; overflow: hidden; display: flex; flex-direction: column;"><h2 style="margin-bottom: 16px;">üìä Saisir les statistiques nationales</h2>';
    
    // En-t√™te avec p√©riode et genre
   html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; background-color: #f9fafb; padding: 16px; border-radius: 8px;">';
html += '<div class="form-group"><label>Ann√©e scolaire *</label><input type="text" id="global-annee" class="form-control" value="2025-2026" onchange="rechargerFormulaireStatistiques()"></div>';
html += '<div class="form-group"><label>P√©riode *</label><select id="global-periode" class="form-control" onchange="rechargerFormulaireStatistiques()"><option>T1</option><option>T2</option><option>T3</option><option>T4</option><option>Annuel</option></select></div>';
    
    html += '<div class="form-group"><label>Filtre R√©gion</label><select id="filter-region" class="form-control" onchange="updateFormFilters()"><option value="">Toutes les r√©gions</option>';
    for (var i = 0; i < regionsData.length; i++) {
        html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
    }
    html += '</select></div>';
    
    html += '<div class="form-group"><label>Filtre Pr√©fecture</label><select id="filter-prefecture" class="form-control" onchange="updateFormFilters()"><option value="">Toutes les pr√©fectures</option></select></div>';
    html += '</div>';

    
    // Tableau de saisie
   html += '<div style="flex: 1; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">';
   html += '<table id="stats-table" style="width: 100%; font-size: 11px; border-collapse: collapse;"><thead style="position: sticky; top: 0; background-color: #2563eb; color: white; z-index: 10;"><tr>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">R√©gion</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">Pr√©fecture</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">Zone</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">Niveau</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #059669; color: white; font-weight: bold;">Abandon T (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #db2777; color: white; font-weight: bold;">Abandon F (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #059669; color: white; font-weight: bold;">R√©ussite T (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #db2777; color: white; font-weight: bold;">R√©ussite F (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #059669; color: white; font-weight: bold;">Scolarisa. T (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #db2777; color: white; font-weight: bold;">Scolarisa. F (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #059669; color: white; font-weight: bold;">Alphab√©t. T (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #db2777; color: white; font-weight: bold;">Alphab√©t. F (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #2563eb; color: white; font-weight: bold;">Ratio E/Ens</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #2563eb; color: white; font-weight: bold;">Ratio E/Classe</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #2563eb; color: white; font-weight: bold;">Distance (km)</th>';
html += '</tr></thead><tbody>';
    
    var rowIndex = 0;
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Pr√©scolaire', 'Primaire', 'Secondaire'];
    
    // G√©n√©rer toutes les lignes
    var rowIndex = 0;
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Pr√©scolaire', 'Primaire', 'Secondaire'];
    
    // G√©n√©rer toutes les lignes
   for (var r = 0; r < regionsData.length; r++) {
    var region = regionsData[r];
    
    var prefecturesRegion = [];
    for (var p = 0; p < prefecturesData.length; p++) {
        if (prefecturesData[p].region_id == region.id) {
            prefecturesRegion.push(prefecturesData[p]);
        }
    }
    
    for (var p = 0; p < prefecturesRegion.length; p++) {
        var prefecture = prefecturesRegion[p];
        
        for (var z = 0; z < zones.length; z++) {
            var zone = zones[z];
            
            // ========== LIGNES PAR NIVEAU (abandon, r√©ussite, scolarisation) ==========
            for (var n = 0; n < niveaux.length; n++) {
                var niveau = niveaux[n];
                var bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
                
                html += '<tr class="stat-row" data-region="' + region.id + '" data-prefecture="' + prefecture.nom + '" data-zone="' + zone + '" data-niveau="' + niveau + '" style="background-color: ' + bgColor + ';">';
                html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + region.nom + '</td>';
                html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + prefecture.nom + '</td>';
                html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + zone + '</td>';
                html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + niveau + '</td>';
                
                // Taux abandon (T/F)
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="abandon_total" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="abandon_filles" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                
                // Taux r√©ussite (T/F)
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="reussite_total" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="reussite_filles" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                
                // Taux scolarisation (T/F)
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="scolarisation_total" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="scolarisation_filles" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                
                // Alphab√©tisation (d√©sactiv√© pour les lignes par niveau)
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
                
                // Ratios et distance
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="ratio_ens" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="ratio_classe" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="distance" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
                
                html += '</tr>';
                rowIndex++;
            }
            
            // ========== LIGNE PAR ZONE (alphab√©tisation uniquement) ==========
            var bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
            
            html += '<tr class="stat-row stat-row-zone" data-region="' + region.id + '" data-prefecture="' + prefecture.nom + '" data-zone="' + zone + '" data-niveau="zone-entiere" style="background-color: #fff3cd; border-left: 4px solid #ffc107;">';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + region.nom + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + prefecture.nom + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + zone + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; text-align: center; font-style: italic; color: #6b7280;">Zone enti√®re</td>';
            
            // D√©sactiver abandon, r√©ussite, scolarisation
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            
            // Alphab√©tisation (ACTIF pour les lignes par zone)
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #fffbeb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="alphabetisation_total" data-type="zone" style="width: 100%; font-size: 11px; padding: 4px; font-weight: bold;" min="0" max="100" placeholder="T"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #fffbeb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="alphabetisation_filles" data-type="zone" style="width: 100%; font-size: 11px; padding: 4px; font-weight: bold;" min="0" max="100" placeholder="F"></td>';
            
            // Ratios d√©sactiv√©s
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            
            html += '</tr>';
            rowIndex++;
        }
    }
}

    html += '</tbody></table></div>';
    
  html += '<div style="margin-top: 16px; display: flex; gap: 10px; justify-content: space-between; align-items: center;">';
html += '<span id="progression-saisie" style="color: #666; font-size: 0.9em; font-weight: bold;"></span>';
html += '<div style="display: flex; gap: 10px;">';
html += '<button class="btn btn-primary" onclick="submitStatistiquesTableau(false)">üíæ Enregistrer nouvelles</button>';
html += '<button class="btn btn-warning" onclick="submitStatistiquesTableau(true)" style="background-color: #f59e0b; color: white;">üîÑ Mettre √† jour</button>';
html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
html += '</div>';
html += '</div>';

    html += '</div></div>';
    modalContainer.innerHTML = html;
  // ========== CHARGER LES DONN√âES EXISTANTES ==========
setTimeout(async function() {
    var annee = document.getElementById('global-annee').value.trim();
    var periode = document.getElementById('global-periode').value;
    
    if (!annee || !periode) return;
    
    try {
        const { data: existingData, error } = await supabase
            .from('statistiques_educatives')
            .select('*')
            .eq('annee_scolaire', annee)
            .eq('periode', periode);
        
        if (error) throw error;
        
        if (existingData && existingData.length > 0) {
            console.log('üì• Chargement de ' + existingData.length + ' donn√©es existantes...');
            
            var loaded = 0;
            
            // Pour chaque donn√©e existante
            for (var i = 0; i < existingData.length; i++) {
                var stat = existingData[i];
                
                // Trouver l'index de ligne correspondant
                var rowIndex = 0;
                var found = false;
                
                for (var r = 0; r < regionsData.length && !found; r++) {
                    var region = regionsData[r];
                    
                    var prefecturesRegion = [];
                    for (var p = 0; p < prefecturesData.length; p++) {
                        if (prefecturesData[p].region_id == region.id) {
                            prefecturesRegion.push(prefecturesData[p]);
                        }
                    }
                    
                    for (var p = 0; p < prefecturesRegion.length && !found; p++) {
                        var prefecture = prefecturesRegion[p];
                        
                        if (prefecture.nom !== stat.prefecture) {
                            rowIndex += 8; // 6 lignes par niveau (3 niveaux x 2 zones) + 2 lignes zone
                            continue;
                        }
                        
                        var zones = ['Urbaine', 'Rurale'];
                        for (var z = 0; z < zones.length && !found; z++) {
                            var zone = zones[z];
                            
                            if (zone !== stat.zone) {
                                rowIndex += 4; // 3 lignes niveau + 1 ligne zone
                                continue;
                            }
                            
                            if (stat.niveau && stat.niveau !== 'Alphab√©tisation') {
                                // Donn√©es par niveau
                                var niveaux = ['Pr√©scolaire', 'Primaire', 'Secondaire'];
                                for (var n = 0; n < niveaux.length; n++) {
                                    if (niveaux[n] === stat.niveau) {
                                        var suffix = stat.genre === 'Total' ? 'total' : 'filles';
                                        
                                        // Taux abandon
                                        if (stat.taux_abandon !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_' + suffix + '"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.taux_abandon;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Taux r√©ussite
                                        if (stat.taux_reussite_examens !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="reussite_' + suffix + '"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.taux_reussite_examens;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Taux scolarisation
                                        if (stat.taux_scolarisation !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_' + suffix + '"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.taux_scolarisation;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Ratio enseignant (seulement pour Total)
                                        if (stat.genre === 'Total' && stat.ratio_eleves_enseignant !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_ens"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.ratio_eleves_enseignant;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Ratio classe (seulement pour Total)
                                        if (stat.genre === 'Total' && stat.ratio_eleves_classe !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_classe"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.ratio_eleves_classe;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Distance (seulement pour Total)
                                        if (stat.genre === 'Total' && stat.distance_moyenne_ecole_domicile !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="distance"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.distance_moyenne_ecole_domicile;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        found = true;
                                        break;
                                    }
                                    rowIndex++;
                                }
                            } else {
                                // Donn√©es par zone (alphab√©tisation)
                                rowIndex += 3; // Sauter les 3 niveaux
                                
                                var suffix = stat.genre === 'Total' ? 'total' : 'filles';
                                if (stat.taux_alphabetisation !== null) {
                                    var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alphabetisation_' + suffix + '"][data-type="zone"]');
                                    if (input) {
                                        input.value = stat.taux_alphabetisation;
                                        input.style.background = '#e8f5e9';
                                        input.style.borderColor = '#4caf50';
                                        input.disabled = true;
                                        input.setAttribute('data-saved', 'true');
                                        input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                        loaded++;
                                    }
                                }
                                
                                found = true;
                                rowIndex++;
                            }
                        }
                    }
                }
            }
            
            // Mettre √† jour la progression
            updateProgression();
            
            if (loaded > 0) {
                alert('üì• ' + loaded + ' champs d√©j√† enregistr√©s ont √©t√© charg√©s (en vert).\n\nVous pouvez continuer la saisie des autres lignes.');
            }
        }
    } catch (error) {
        console.error('Erreur chargement:', error);
    }
}, 500);
  
    modalContainer.innerHTML = html;
  // Initialiser les cartes avec toutes les donn√©es
    setTimeout(function() {
        updateCartesIndicateurs(['T1', 'T2', 'T3', 'T4', 'Annuel']);
    }, 100);
}
  
    // ========== D√âTECTER LES MODIFICATIONS POUR R√âACTIVER L'ENREGISTREMENT ==========
    setTimeout(function() {
        var allInputs = document.querySelectorAll('input[data-field]:not([disabled])');
        for (var i = 0; i < allInputs.length; i++) {
            allInputs[i].addEventListener('input', function() {
                // Retirer le statut "sauvegard√©" quand l'utilisateur modifie
                if (this.getAttribute('data-saved') === 'true') {
                    this.removeAttribute('data-saved');
                    this.style.background = '';
                    this.style.borderColor = '';
                    this.disabled = false;
                }
            });
        }
    }, 600);
function rechargerFormulaireStatistiques() {
    console.log('üîÑ Rechargement du formulaire...');
    
    // R√©cup√©rer les valeurs actuelles
    var annee = document.getElementById('global-annee') ? document.getElementById('global-annee').value : '2025-2026';
    var periode = document.getElementById('global-periode') ? document.getElementById('global-periode').value : 'T1';
    var filterRegion = document.getElementById('filter-region') ? document.getElementById('filter-region').value : '';
    var filterPrefecture = document.getElementById('filter-prefecture') ? document.getElementById('filter-prefecture').value : '';
    
    console.log('P√©riode s√©lectionn√©e:', periode);
    
    // Fermer et rouvrir le modal avec les m√™mes param√®tres
    showStatistiquesModal();
    
    // Restaurer les valeurs apr√®s rechargement
    setTimeout(function() {
        if (document.getElementById('global-annee')) {
            document.getElementById('global-annee').value = annee;
        }
        if (document.getElementById('global-periode')) {
            document.getElementById('global-periode').value = periode;
        }
        if (document.getElementById('filter-region')) {
            document.getElementById('filter-region').value = filterRegion;
            updateFormFilters(); // Mettre √† jour les pr√©fectures
        }
        if (document.getElementById('filter-prefecture')) {
            document.getElementById('filter-prefecture').value = filterPrefecture;
            filterTableRows();
        }
    }, 100);
}

function updatePrefecturesDropdown() {
    var regionId = document.getElementById('stat-region').value;
    var prefectureSelect = document.getElementById('stat-prefecture');
    
    prefectureSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
    
    if (regionId) {
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
    }
}
function updatePreuveActivites() {
    var objectif = document.getElementById('preuve-objectif').value;
    var activiteSelect = document.getElementById('preuve-activite');
    
    activiteSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
    
    if (!objectif) return;
    
    var activitesFiltrees = [];
    for (var i = 0; i < data.length; i++) {
    var act = data[i];        
        // V√©rifier si l'activit√© est valid√©e ET termin√©e √† 100%
        var taux = calcTaux(act);
        var estTerminee = taux === 100;
        
        if (act.valide && estTerminee && act.categorie === objectif) {
            if (currentUser.role === 'admin' || currentUser.role === 'chefdept' || act.service === currentUser.service) {
                activitesFiltrees.push(act);
            }
        }
    }
    
    if (activitesFiltrees.length === 0) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Aucune activit√© termin√©e √† 100%';
        option.disabled = true;
        activiteSelect.appendChild(option);
        return;
    }
    
    for (var i = 0; i < activitesFiltrees.length; i++) {
        var option = document.createElement('option');
        option.value = activitesFiltrees[i].activite;
        option.textContent = activitesFiltrees[i].activite + ' (' + activitesFiltrees[i].service + ')';
        option.setAttribute('data-service', activitesFiltrees[i].service);
        activiteSelect.appendChild(option);
    }
}


async function submitStatistiquesTableau(forcerMiseAJour) {
    forcerMiseAJour = forcerMiseAJour || false;
    
    var annee = document.getElementById('global-annee').value.trim();
    var periode = document.getElementById('global-periode').value;
    
    if (!annee || !periode) {
        alert('‚ö†Ô∏è Veuillez remplir ann√©e et p√©riode');
        return;
    }
    
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Pr√©scolaire', 'Primaire', 'Secondaire'];
    var dataToInsert = [];
    var rowIndex = 0;
    
    // Parcourir toutes les lignes
    for (var r = 0; r < regionsData.length; r++) {
        var region = regionsData[r];
        var prefecturesRegion = [];
        
        for (var p = 0; p < prefecturesData.length; p++) {
            if (prefecturesData[p].region_id == region.id) {
                prefecturesRegion.push(prefecturesData[p]);
            }
        }
        
        for (var p = 0; p < prefecturesRegion.length; p++) {
            var prefecture = prefecturesRegion[p];
            
            for (var z = 0; z < zones.length; z++) {
                var zone = zones[z];
                
                // ========== LIGNES PAR NIVEAU (3 lignes) ==========
                for (var n = 0; n < niveaux.length; n++) {
                    var niveau = niveaux[n];
                    
                    // R√©cup√©rer les valeurs des inputs PAR NIVEAU
                    var inputAbandonT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_total"][data-type="niveau"]');
                    var inputAbandonF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_filles"][data-type="niveau"]');
                    var inputReussiteT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="reussite_total"][data-type="niveau"]');
                    var inputReussiteF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="reussite_filles"][data-type="niveau"]');
                    var inputScolarisationT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_total"][data-type="niveau"]');
                    var inputScolarisationF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_filles"][data-type="niveau"]');
                    var inputRatioEns = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_ens"][data-type="niveau"]');
                    var inputRatioClasse = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_classe"][data-type="niveau"]');
                    var inputDistance = document.querySelector('input[data-row="' + rowIndex + '"][data-field="distance"][data-type="niveau"]');
                    
                    // V√©rifier si d√©j√† enregistr√©
                    var alreadySavedT = inputAbandonT && inputAbandonT.getAttribute('data-saved') === 'true';
                    var alreadySavedF = inputAbandonF && inputAbandonF.getAttribute('data-saved') === 'true';
                    
                    // Si forcerMiseAJour, on collecte m√™me si d√©j√† saved
                    var abandonT = inputAbandonT && inputAbandonT.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputAbandonT.value) : null;
                    var abandonF = inputAbandonF && inputAbandonF.value && (!alreadySavedF || forcerMiseAJour) ? parseFloat(inputAbandonF.value) : null;
                    var reussiteT = inputReussiteT && inputReussiteT.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputReussiteT.value) : null;
                    var reussiteF = inputReussiteF && inputReussiteF.value && (!alreadySavedF || forcerMiseAJour) ? parseFloat(inputReussiteF.value) : null;
                    var scolarisationT = inputScolarisationT && inputScolarisationT.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputScolarisationT.value) : null;
                    var scolarisationF = inputScolarisationF && inputScolarisationF.value && (!alreadySavedF || forcerMiseAJour) ? parseFloat(inputScolarisationF.value) : null;
                    var ratioEns = inputRatioEns && inputRatioEns.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputRatioEns.value) : null;
                    var ratioClasse = inputRatioClasse && inputRatioClasse.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputRatioClasse.value) : null;
                    var distance = inputDistance && inputDistance.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputDistance.value) : null;
                    
                    // Cr√©er enregistrement Total
                    if ((!alreadySavedT || forcerMiseAJour) && (abandonT !== null || reussiteT !== null || scolarisationT !== null || ratioEns !== null || ratioClasse !== null || distance !== null)) {
                        dataToInsert.push({
                            annee_scolaire: annee,
                            periode: periode,
                            region: region.nom,
                            prefecture: prefecture.nom,
                            zone: zone,
                            niveau: niveau,
                            genre: 'Total',
                            taux_abandon: abandonT,
                            taux_reussite_examens: reussiteT,
                            taux_scolarisation: scolarisationT,
                            taux_alphabetisation: null,
                            ratio_eleves_enseignant: ratioEns,
                            ratio_eleves_classe: ratioClasse,
                            distance_moyenne_ecole_domicile: distance,
                            saisi_par: currentUser.nom
                        });
                        
                        // Marquer comme enregistr√©
                        if (inputAbandonT) { inputAbandonT.setAttribute('data-saved', 'true'); }
                        if (inputReussiteT) { inputReussiteT.setAttribute('data-saved', 'true'); }
                        if (inputScolarisationT) { inputScolarisationT.setAttribute('data-saved', 'true'); }
                        if (inputRatioEns) { inputRatioEns.setAttribute('data-saved', 'true'); }
                        if (inputRatioClasse) { inputRatioClasse.setAttribute('data-saved', 'true'); }
                        if (inputDistance) { inputDistance.setAttribute('data-saved', 'true'); }
                    }
                    
                    // Cr√©er enregistrement Filles
                    if ((!alreadySavedF || forcerMiseAJour) && (abandonF !== null || reussiteF !== null || scolarisationF !== null)) {
                        dataToInsert.push({
                            annee_scolaire: annee,
                            periode: periode,
                            region: region.nom,
                            prefecture: prefecture.nom,
                            zone: zone,
                            niveau: niveau,
                            genre: 'Filles',
                            taux_abandon: abandonF,
                            taux_reussite_examens: reussiteF,
                            taux_scolarisation: scolarisationF,
                            taux_alphabetisation: null,
                            ratio_eleves_enseignant: null,
                            ratio_eleves_classe: null,
                            distance_moyenne_ecole_domicile: null,
                            saisi_par: currentUser.nom
                        });
                        
                        // Marquer comme enregistr√©
                        if (inputAbandonF) { inputAbandonF.setAttribute('data-saved', 'true'); }
                        if (inputReussiteF) { inputReussiteF.setAttribute('data-saved', 'true'); }
                        if (inputScolarisationF) { inputScolarisationF.setAttribute('data-saved', 'true'); }
                    }
                    
                    rowIndex++;
                }
                
                // ========== LIGNE PAR ZONE (alphab√©tisation) ==========
                var inputAlphabetisationT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alphabetisation_total"][data-type="zone"]');
                var inputAlphabetisationF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alphabetisation_filles"][data-type="zone"]');
                
                var alreadySavedAlphaT = inputAlphabetisationT && inputAlphabetisationT.getAttribute('data-saved') === 'true';
                var alreadySavedAlphaF = inputAlphabetisationF && inputAlphabetisationF.getAttribute('data-saved') === 'true';
                
                var alphabetisationT = inputAlphabetisationT && inputAlphabetisationT.value && (!alreadySavedAlphaT || forcerMiseAJour) ? parseFloat(inputAlphabetisationT.value) : null;
                var alphabetisationF = inputAlphabetisationF && inputAlphabetisationF.value && (!alreadySavedAlphaF || forcerMiseAJour) ? parseFloat(inputAlphabetisationF.value) : null;
                
                // Cr√©er enregistrement alphab√©tisation Total
                if ((!alreadySavedAlphaT || forcerMiseAJour) && alphabetisationT !== null) {
                    dataToInsert.push({
                        annee_scolaire: annee,
                        periode: periode,
                        region: region.nom,
                        prefecture: prefecture.nom,
                        zone: zone,
                        niveau: 'Alphab√©tisation',
                        genre: 'Total',
                        taux_abandon: null,
                        taux_reussite_examens: null,
                        taux_scolarisation: null,
                        taux_alphabetisation: alphabetisationT,
                        ratio_eleves_enseignant: null,
                        ratio_eleves_classe: null,
                        distance_moyenne_ecole_domicile: null,
                        saisi_par: currentUser.nom
                    });
                    
                    if (inputAlphabetisationT) { inputAlphabetisationT.setAttribute('data-saved', 'true'); }
                }
                
                // Cr√©er enregistrement alphab√©tisation Filles
                if ((!alreadySavedAlphaF || forcerMiseAJour) && alphabetisationF !== null) {
                    dataToInsert.push({
                        annee_scolaire: annee,
                        periode: periode,
                        region: region.nom,
                        prefecture: prefecture.nom,
                        zone: zone,
                        niveau: 'Alphab√©tisation',
                        genre: 'Filles',
                        taux_abandon: null,
                        taux_reussite_examens: null,
                        taux_scolarisation: null,
                        taux_alphabetisation: alphabetisationF,
                        ratio_eleves_enseignant: null,
                        ratio_eleves_classe: null,
                        distance_moyenne_ecole_domicile: null,
                        saisi_par: currentUser.nom
                    });
                    
                    if (inputAlphabetisationF) { inputAlphabetisationF.setAttribute('data-saved', 'true'); }
                }
                
                rowIndex++;
            }
        }
    }
    
    if (dataToInsert.length === 0) {
        if (forcerMiseAJour) {
            alert('‚ö†Ô∏è Aucune donn√©e √† mettre √† jour.\n\nModifiez au moins un champ avant de mettre √† jour.');
        } else {
            alert('‚ö†Ô∏è Aucune nouvelle donn√©e √† enregistrer.\n\nUtilisez le bouton "Mettre √† jour" pour modifier des donn√©es existantes.');
        }
        return;
    }
    
    var message = forcerMiseAJour 
        ? 'üîÑ Vous allez mettre √† jour ' + dataToInsert.length + ' lignes.\n\nContinuer ?' 
        : 'üíæ Vous allez enregistrer ' + dataToInsert.length + ' nouvelles lignes.\n\nContinuer ?';
    
    if (!confirm(message)) {
        return;
    }
    
    try {
        // Ins√©rer/Mettre √† jour par lots de 50
        var batchSize = 50;
        var totalProcessed = 0;
        
        for (var i = 0; i < dataToInsert.length; i += batchSize) {
            var batch = dataToInsert.slice(i, i + batchSize);
            
            const { data: processedData, error } = await supabase
                .from('statistiques_educatives')
                .upsert(batch, { 
                    onConflict: 'annee_scolaire,periode,region,prefecture,zone,niveau,genre',
                    ignoreDuplicates: false 
                })
                .select();
            
            if (error) throw error;
            
            if (processedData) {
                totalProcessed += processedData.length;
                
                // Mettre √† jour le tableau local
                for (var j = 0; j < processedData.length; j++) {
                    var found = false;
                    for (var k = 0; k < statistiquesData.length; k++) {
                        if (statistiquesData[k].id === processedData[j].id) {
                            statistiquesData[k] = processedData[j];
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        statistiquesData.unshift(processedData[j]);
                    }
                }
            }
        }
        
        var successMessage = forcerMiseAJour 
            ? '‚úÖ ' + totalProcessed + ' statistiques mises √† jour avec succ√®s !'
            : '‚úÖ ' + totalProcessed + ' statistiques enregistr√©es avec succ√®s !';
        
        alert(successMessage);
        closeModal();
        render();
        
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}

function updateProgression() {
    var totalInputs = document.querySelectorAll('input[data-field]:not([disabled])').length;
    var savedInputs = document.querySelectorAll('input[data-saved="true"]').length;
    var pourcentage = totalInputs > 0 ? Math.round((savedInputs / totalInputs) * 100) : 0;
    
    var progressElement = document.getElementById('progression-saisie');
    if (progressElement) {
        progressElement.textContent = 'üìä Progression : ' + savedInputs + '/' + totalInputs + ' champs (' + pourcentage + '%)';
        progressElement.style.color = pourcentage === 100 ? '#4caf50' : '#ff9800';
        progressElement.style.fontWeight = 'bold';
    }
}
function filterStatistiquesByPeriode() {
    var periodeFilter = document.getElementById('filter-periode-cumulative') ? document.getElementById('filter-periode-cumulative').value : 'TOUS';
    
    console.log('=== FILTRAGE P√âRIODE CUMULATIF ===');
    console.log('P√©riode s√©lectionn√©e:', periodeFilter);
    
    // D√©finir les p√©riodes incluses
    var periodesIncluses = [];
    if (periodeFilter === 'TOUS') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    } else if (periodeFilter === 'T1') {
        periodesIncluses = ['T1'];
    } else if (periodeFilter === 'T2') {
        periodesIncluses = ['T1', 'T2'];
    } else if (periodeFilter === 'T3') {
        periodesIncluses = ['T1', 'T2', 'T3'];
    } else if (periodeFilter === 'T4') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4'];
    } else if (periodeFilter === 'Annuel') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    }
    
    console.log('P√©riodes incluses:', periodesIncluses);
    
    // Filtrer les inputs par p√©riode
    var allInputs = document.querySelectorAll('input[data-field][data-periode]');
    var inputsAffichesCount = 0;
    
    for (var i = 0; i < allInputs.length; i++) {
        var input = allInputs[i];
        var inputPeriode = input.getAttribute('data-periode');
        
        if (periodesIncluses.indexOf(inputPeriode) !== -1) {
            input.style.display = '';
            inputsAffichesCount++;
        } else {
            input.style.display = 'none';
        }
    }
    
    // Filtrer aussi les lignes
    var rows = document.querySelectorAll('.stat-row');
    var rowsVisibles = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var rowPeriode = row.getAttribute('data-periode');
        
        if (rowPeriode && periodesIncluses.indexOf(rowPeriode) !== -1) {
            row.style.display = '';
            rowsVisibles++;
        } else if (!rowPeriode) {
            // Si pas de p√©riode d√©finie, afficher la ligne (donn√©es non encore saisies)
            row.style.display = '';
            rowsVisibles++;
        }
    }
    
    console.log('Inputs affich√©s:', inputsAffichesCount);
    console.log('Lignes visibles:', rowsVisibles);
    
    // Mettre √† jour les cartes d'indicateurs
    updateCartesIndicateurs(periodesIncluses);
}
function updateCartesIndicateurs(periodesIncluses) {
    console.log('=== MISE √Ä JOUR DES CARTES ===');
    
    // Filtrer statistiquesData selon les p√©riodes incluses
    var dataFiltree = [];
    for (var i = 0; i < statistiquesData.length; i++) {
        if (periodesIncluses.indexOf(statistiquesData[i].periode) !== -1) {
            dataFiltree.push(statistiquesData[i]);
        }
    }
    
    console.log('Donn√©es filtr√©es:', dataFiltree.length, 'sur', statistiquesData.length);
    
    // Recalculer les moyennes
    var moyenneAbandon = calculerMoyenne(dataFiltree, 'taux_abandon');
    var moyenneReussite = calculerMoyenne(dataFiltree, 'taux_reussite_examens');
    var moyenneScolarisation = calculerMoyenne(dataFiltree, 'taux_scolarisation');
    var moyenneAlphabetisation = calculerMoyenne(dataFiltree, 'taux_alphabetisation');
    var moyenneRatioEnseignant = calculerMoyenne(dataFiltree, 'ratio_eleves_enseignant');
    var moyenneRatioClasse = calculerMoyenne(dataFiltree, 'ratio_eleves_classe');
    var moyenneDistance = calculerMoyenne(dataFiltree, 'distance_moyenne_ecole_domicile');
    
    // Mettre √† jour les valeurs affich√©es dans les cartes
    var cartes = document.querySelectorAll('.card-value');
    if (cartes.length >= 7) {
        cartes[0].textContent = moyenneAbandon + '%';
        cartes[1].textContent = moyenneReussite + '%';
        cartes[2].textContent = moyenneScolarisation + '%';
        cartes[3].textContent = moyenneAlphabetisation + '%';
        cartes[4].textContent = moyenneRatioEnseignant;
        cartes[5].textContent = moyenneRatioClasse;
        cartes[6].textContent = moyenneDistance;
    }
    
    console.log('Cartes mises √† jour');
}

async function deleteStatistique(id) {
    if (!confirm('Supprimer cette statistique ?')) return;
    
    try {
        const { error } = await supabase
            .from('statistiques_educatives')
            .delete()
            .eq('id', id);
        
        if (error) throw error;
        
        statistiquesData = statistiquesData.filter(s => s.id !== id);
        render();
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur lors de la suppression');
    }
}
function updateStatsPrefectureDropdown() {
    var regionId = document.getElementById('filter-stats-region') ? document.getElementById('filter-stats-region').value : '';
    var prefectureSelect = document.getElementById('filter-stats-prefecture');
    
    if (!prefectureSelect) return;
    
    // Vider et reconstruire les options
    prefectureSelect.innerHTML = '<option value="">Toutes les pr√©fectures</option>';
    
    if (regionId) {
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
    }
}
       
function appliquerFiltresStatistiques() {
    console.log('=== APPLICATION DES FILTRES STATISTIQUES ===');
    
    // R√©cup√©rer tous les filtres
    var periodeFilter = document.getElementById('filter-stats-periode') ? document.getElementById('filter-stats-periode').value : 'TOUS';
    var regionId = document.getElementById('filter-stats-region') ? document.getElementById('filter-stats-region').value : '';
    var prefecture = document.getElementById('filter-stats-prefecture') ? document.getElementById('filter-stats-prefecture').value : '';
    var zone = document.getElementById('filter-stats-zone') ? document.getElementById('filter-stats-zone').value : '';
    var niveau = document.getElementById('filter-stats-niveau') ? document.getElementById('filter-stats-niveau').value : '';
    var genre = document.getElementById('filter-stats-genre') ? document.getElementById('filter-stats-genre').value : '';
    
    console.log('Filtres:', {periodeFilter, regionId, prefecture, zone, niveau, genre});
    
    // D√©finir les p√©riodes incluses (cumulatif)
    var periodesIncluses = [];
    if (periodeFilter === 'TOUS') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    } else if (periodeFilter === 'T1') {
        periodesIncluses = ['T1'];
    } else if (periodeFilter === 'T2') {
        periodesIncluses = ['T1', 'T2'];
    } else if (periodeFilter === 'T3') {
        periodesIncluses = ['T1', 'T2', 'T3'];
    } else if (periodeFilter === 'T4') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4'];
    } else if (periodeFilter === 'Annuel') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    }
    
    // Trouver le nom de la r√©gion si un ID est s√©lectionn√©
    var regionNom = '';
    if (regionId) {
        for (var i = 0; i < regionsData.length; i++) {
            if (regionsData[i].id == regionId) {
                regionNom = regionsData[i].nom;
                break;
            }
        }
    }
    
    // Filtrer les donn√©es POUR LES TAUX (Genre inclus)
    var dataFiltreeTaux = [];
    for (var i = 0; i < statistiquesData.length; i++) {
        var stat = statistiquesData[i];
        
        // Filtre p√©riode
        if (periodesIncluses.indexOf(stat.periode) === -1) continue;
        
        // Filtre r√©gion
        if (regionNom && stat.region !== regionNom) continue;
        
        // Filtre pr√©fecture
        if (prefecture && stat.prefecture !== prefecture) continue;
        
        // Filtre zone
        if (zone && stat.zone !== zone) continue;
        
        // Filtre niveau
        if (niveau && stat.niveau !== niveau) continue;
        
        // Filtre genre (pour les taux)
        if (genre && stat.genre !== genre) continue;
        
        dataFiltreeTaux.push(stat);
    }
    
    // Filtrer les donn√©es POUR LES RATIOS/DISTANCE (Genre ignor√©, seulement Total)
    var dataFiltreeRatios = [];
    for (var i = 0; i < statistiquesData.length; i++) {
        var stat = statistiquesData[i];
        
        // Filtre p√©riode
        if (periodesIncluses.indexOf(stat.periode) === -1) continue;
        
        // Filtre r√©gion
        if (regionNom && stat.region !== regionNom) continue;
        
        // Filtre pr√©fecture
        if (prefecture && stat.prefecture !== prefecture) continue;
        
        // Filtre zone
        if (zone && stat.zone !== zone) continue;
        
        // Filtre niveau
        if (niveau && stat.niveau !== niveau) continue;
        
        // SEULEMENT Total pour les ratios
        if (stat.genre !== 'Total') continue;
        
        dataFiltreeRatios.push(stat);
    }
    
    console.log('Donn√©es filtr√©es - Taux:', dataFiltreeTaux.length);
    console.log('Donn√©es filtr√©es - Ratios:', dataFiltreeRatios.length);
    
    // Calculer les moyennes POUR LES TAUX
    var moyenneAbandon = calculerMoyenne(dataFiltreeTaux, 'taux_abandon');
    var moyenneReussite = calculerMoyenne(dataFiltreeTaux, 'taux_reussite_examens');
    var moyenneScolarisation = calculerMoyenne(dataFiltreeTaux, 'taux_scolarisation');
    var moyenneAlphabetisation = calculerMoyenne(dataFiltreeTaux, 'taux_alphabetisation');
    
    // Calculer les moyennes POUR LES RATIOS/DISTANCE
    var moyenneRatioEnseignant = calculerMoyenne(dataFiltreeRatios, 'ratio_eleves_enseignant');
    var moyenneRatioClasse = calculerMoyenne(dataFiltreeRatios, 'ratio_eleves_classe');
    var moyenneDistance = calculerMoyenne(dataFiltreeRatios, 'distance_moyenne_ecole_domicile');
    
    // Mettre √† jour l'affichage des cartes
    var cards = document.querySelectorAll('.card');
    if (cards.length >= 7) {
        // Carte 1 : Taux abandon
        var value = cards[0].querySelector('.card-value');
        if (value) value.textContent = moyenneAbandon + '%';
        
        // Carte 2 : Taux r√©ussite
        value = cards[1].querySelector('.card-value');
        if (value) value.textContent = moyenneReussite + '%';
        
        // Carte 3 : Taux scolarisation
        value = cards[2].querySelector('.card-value');
        if (value) value.textContent = moyenneScolarisation + '%';
        
        // Carte 4 : Taux alphab√©tisation
        value = cards[3].querySelector('.card-value');
        if (value) value.textContent = moyenneAlphabetisation + '%';
        
        // Carte 5 : Ratio enseignant (Genre ignor√©)
        value = cards[4].querySelector('.card-value');
        if (value) value.textContent = moyenneRatioEnseignant;
        
        // Carte 6 : Ratio classe (Genre ignor√©)
        value = cards[5].querySelector('.card-value');
        if (value) value.textContent = moyenneRatioClasse;
        
        // Carte 7 : Distance (Genre ignor√©)
        value = cards[6].querySelector('.card-value');
        if (value) value.textContent = moyenneDistance;
    }
    
    console.log('Cartes mises √† jour');
    console.log('========================================');
}

        // ========== FONCTION RENDER PRINCIPALE 
function render() {
            var app = document.getElementById('app');
            
if (!currentUser) {
    // SI TOKEN D'INVITATION : Afficher formulaire d'inscription
    if (invitationData) {
        app.innerHTML = '<div class="modal"><div class="modal-content" style="max-width: 550px;"><h2 style="text-align: center; margin-bottom: 24px;">üèõÔ∏è Cr√©er votre compte</h2><div class="alert alert-info" style="text-align: center;">Bienvenue ! Compl√©tez votre inscription</div><div class="username-display"><label>Nom d\'utilisateur attribu√©</label><div class="username" id="usernameDisplay">' + invitationData.username + '</div></div><div class="form-group"><label>Adresse email *</label><input type="email" id="signup-email" class="form-control" placeholder="votre.email@example.com"></div><div class="form-group"><label>Mot de passe *</label><input type="password" id="signup-password" class="form-control" placeholder="Minimum 8 caract√®res"></div><div class="form-group"><label>Confirmer le mot de passe *</label><input type="password" id="signup-confirm-password" class="form-control" placeholder="Confirmez votre mot de passe"></div><button class="btn btn-primary" style="width: 100%;" onclick="submitSignupWithInvitation()">Cr√©er mon compte</button></div></div>';
    } else {
        // SINON : Afficher formulaire de connexion normal
        app.innerHTML = '<div class="modal"><div class="modal-content" style="max-width: 550px;"><h2 style="text-align: center; margin-bottom: 24px;">üèõÔ∏è Gestion MEPUA</h2><div class="alert alert-info" style="text-align: center;">Bienvenue sur le syst√®me de gestion d√©partementale</div><div class="form-group"><label>Nom d\'utilisateur</label><input type="text" id="username" class="form-control" placeholder="Entrez votre nom d\'utilisateur"></div><div class="form-group"><label>Mot de passe</label><input type="password" id="password" class="form-control" placeholder="Entrez votre mot de passe"></div><button class="btn btn-primary" style="width: 100%;" onclick="attemptLogin()">Se connecter</button><div style="margin-top: 16px; padding: 12px; background-color: #fef3c7; border-radius: 8px; font-size: 12px; text-align: center; color: #92400e;"><strong>‚ö†Ô∏è Premi√®re connexion ?</strong><br/>Utilisez votre mot de passe provisoire et changez-le apr√®s connexion.</div></div></div>';
    }
                
                var passwordInput = document.getElementById('password');
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') attemptLogin();
                    });
                }
                return;
            }

            var html = '<div class="header"><h1>Gestion D√©partementale</h1><div class="header-right"><span>' + currentUser.nom;
            if (currentUser.service !== 'TOUS') {
                html += '<span class="service-badge">' + currentUser.service + '</span>';
            }
            html += '</span><button class="btn btn-secondary" onclick="logout()">D√©connexion</button></div></div>';

            html += '<div class="nav">';
            html += '<button class="' + (activeTab === 'dashboard' ? 'active' : '') + '" onclick="changeTab(\'dashboard\')">Tableau de Bord</button>';
            html += '<button class="' + (activeTab === 'planning' ? 'active' : '') + '" onclick="changeTab(\'planning\')">Planification</button>';
            html += '<button class="' + (activeTab === 'suivi' ? 'active' : '') + '" onclick="changeTab(\'suivi\')">Suivi-√âvaluation</button>';
            html += '<button class="' + (activeTab === 'commentaires' ? 'active' : '') + '" onclick="changeTab(\'commentaires\')">Commentaires et Preuves</button>';
            html += '<button class="' + (activeTab === 'rapport' ? 'active' : '') + '" onclick="changeTab(\'rapport\')">Rapport de performance</button>';

// Onglet Statistiques (visible pour DG du BSD, Chef D√©p, Admin)
if (currentUser.role === 'admin' || currentUser.role === 'chefdept' || currentUser.service === 'BSD') {
    html += '<button class="' + (activeTab === 'statistiques' ? 'active' : '') + '" onclick="changeTab(\'statistiques\')">üìä Statistiques</button>';
}

// Onglet Analyse (visible pour Admin, Chef D√©p, et chefs de service)
if (currentUser.role === 'admin' || currentUser.role === 'chefdept' || currentUser.role === 'chef') {
    html += '<button class="' + (activeTab === 'analyse' ? 'active' : '') + '" onclick="changeTab(\'analyse\')">üîç Analyse</button>';
}

            if (currentUser.role === 'admin') {
                html += '<button class="' + (activeTab === 'admin' ? 'active' : '') + '" onclick="changeTab(\'admin\')">Administration</button>';
            }
            html += '</div>';
// Afficher le filtre service SAUF dans l'onglet statistiques
if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && activeTab !== 'statistiques') {
    html += '<div style="background-color: white; padding: 12px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="max-width: 1280px; margin: 0 auto; display: flex; align-items: center; gap: 16px;"><label style="font-weight: bold; font-size: 14px;">Filtrer:</label><select onchange="changeServiceFilter(this.value)" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px;"><option value="TOUS"' + (selectedServiceFilter === 'TOUS' ? ' selected' : '') + '>Tous les services</option>';
    
    for (var i = 0; i < services.length; i++) {
        html += '<option value="' + services[i] + '"' + (selectedServiceFilter === services[i] ? ' selected' : '') + '>' + services[i] + '</option>';
    }
    
    html += '</select>';
    if (selectedServiceFilter !== 'TOUS') {
        html += '<button onclick="changeServiceFilter(\'TOUS\')" style="padding: 6px 12px; background-color: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">R√©initialiser</button>';
    }
    html += '</div></div>';
}
            html += '<div class="main">';
// ========== ONGLET 1 : TABLEAU DE BORD ==========
            if (activeTab === 'dashboard') {
                html += '<h2 style="margin-bottom: 16px;">Tableau de Bord</h2>';
                
                html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">';
                
                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üìä Statut</label><select onchange="changeStatusFilter(this.value)" class="form-control"><option value="TOUS"' + (selectedStatusFilter === 'TOUS' ? ' selected' : '') + '>Tous les statuts</option><option value="Non commenc√©e"' + (selectedStatusFilter === 'Non commenc√©e' ? ' selected' : '') + '>Non commenc√©e</option><option value="En cours"' + (selectedStatusFilter === 'En cours' ? ' selected' : '') + '>En cours</option><option value="Ex√©cut√©e"' + (selectedStatusFilter === 'Ex√©cut√©e' ? ' selected' : '') + '>Ex√©cut√©e</option></select></div>';
                
                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Objectif</label><select onchange="changeDashboardObjectifFilter(this.value)" class="form-control"><option value="TOUS"' + (selectedObjectifFilter === 'TOUS' ? ' selected' : '') + '>Tous les objectifs</option><option value="Objectifs G√©n√©raux"' + (selectedObjectifFilter === 'Objectifs G√©n√©raux' ? ' selected' : '') + '>Objectifs G√©n√©raux</option><option value="Objectifs de R√©forme"' + (selectedObjectifFilter === 'Objectifs de R√©forme' ? ' selected' : '') + '>Objectifs de R√©forme</option><option value="Objectifs Sp√©cifiques"' + (selectedObjectifFilter === 'Objectifs Sp√©cifiques' ? ' selected' : '') + '>Objectifs Sp√©cifiques</option><option value="D√©cisions du CM"' + (selectedObjectifFilter === 'D√©cisions du CM' ? ' selected' : '') + '>D√©cisions du CM</option><option value="D√©cisions du PR"' + (selectedObjectifFilter === 'D√©cisions du PR' ? ' selected' : '') + '>D√©cisions du PR</option></select></div>';
                
                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üìÖ Trimestre (cumul√©)</label><select onchange="changeDashboardTrimestreFilter(this.value)" class="form-control"><option value="TOUS"' + (selectedTrimestreFilter === 'TOUS' ? ' selected' : '') + '>Toute l\'ann√©e</option><option value="T1"' + (selectedTrimestreFilter === 'T1' ? ' selected' : '') + '>Jusqu\'√† T1</option><option value="T2"' + (selectedTrimestreFilter === 'T2' ? ' selected' : '') + '>Jusqu\'√† T2</option><option value="T3"' + (selectedTrimestreFilter === 'T3' ? ' selected' : '') + '>Jusqu\'√† T3</option><option value="T4"' + (selectedTrimestreFilter === 'T4' ? ' selected' : '') + '>Jusqu\'√† T4</option></select></div>';
                
                html += '</div></div>';
                
                var dashboardData = getFilteredDataForDashboard();
                
                var enCours = 0, terminees = 0, nonCommencees = 0;
                for (var i = 0; i < dashboardData.length; i++) {
                    var taux = calcTaux(dashboardData[i]);
                    if (taux === 100) terminees++;
                    else if (taux > 0) enCours++;
                    else nonCommencees++;
                }
                
                var tauxExecution = dashboardData.length > 0 ? Math.round((terminees / dashboardData.length) * 100) : 0;
                
                html += '<div class="cards">';
                html += '<div class="card card-blue"><div class="card-title" style="color: #2563eb;">Planifi√©es</div><div class="card-value">' + dashboardData.length + '</div></div>';
                html += '<div class="card card-orange"><div class="card-title" style="color: #ea580c;">Non Commenc√©es</div><div class="card-value">' + nonCommencees + '</div></div>';
                html += '<div class="card card-yellow"><div class="card-title" style="color: #d97706;">En Cours</div><div class="card-value">' + enCours + '</div></div>';
                html += '<div class="card card-green"><div class="card-title" style="color: #059669;">Ex√©cut√©es</div><div class="card-value">' + terminees + '</div></div>';
                html += '<div class="card card-rose pastel"><div class="card-title" style="color: #7c3aed;">üìà Taux d\'Ex√©cution</div><div class="card-value">' + tauxExecution + '%</div></div>';
                html += '</div>';
                
                html += '<div class="table-container"><table><thead class="blue"><tr><th>Objectif</th><th>Activit√©</th><th>Service</th><th style="text-align: center; background-color: #1e40af;">T1</th><th style="text-align: center; background-color: #1e40af;">T2</th><th style="text-align: center; background-color: #1e40af;">T3</th><th style="text-align: center; background-color: #1e40af;">T4</th><th style="text-align: center;">TDR</th><th style="text-align: center;">ENGAG√â</th><th style="text-align: center;">MANDAT√â</th><th style="text-align: center;">ORDONNANC√â</th><th style="text-align: center;">LIQUID√â</th><th style="text-align: center;">EX√âCUT√â</th><th style="text-align: center;">TAUX</th></tr></thead><tbody>';
                
                if (dashboardData.length > 0) {
                    for (var i = 0; i < dashboardData.length; i++) {
                        var d = dashboardData[i];
                        var taux = calcTaux(d);
                        var tauxClass = taux === 100 ? 'badge-taux-green' : taux >= 50 ? 'badge-taux-yellow' : 'badge-taux-red';
                        
                        html += '<tr><td><span class="badge badge-blue">' + d.categorie + '</span></td><td>' + d.activite + '</td><td><span class="badge badge-purple">' + d.service + '</span></td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t1 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t2 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t3 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t4 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.tdr ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.eng ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.mand ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.ordo ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.liq ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.exec ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;"><span class="badge-taux ' + tauxClass + '">' + taux + '%</span></td></tr>';
                    }
                } else {
                    html += '<tr><td colspan="14" class="empty-state">Aucune activit√© valid√©e</td></tr>';
                }
                html += '</tbody></table></div>';
            }
// ========== ONGLET 2 : PLANIFICATION ==========
            if (activeTab === 'planning') {
                html += '<div class="flex-between"><h2>Planification 2026</h2>';
                if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                    html += '<button class="btn btn-success" onclick="showAddModal()">+ Ajouter</button>';
                }
                html += '</div>';
                
                var planningData = getFilteredDataForPlanning();
                
                html += '<div class="table-container"><table><thead class="blue"><tr><th>Objectif</th><th>Activit√©</th><th>Service</th><th style="text-align: center;">T1</th><th style="text-align: center;">T2</th><th style="text-align: center;">T3</th><th style="text-align: center;">T4</th><th style="text-align: center;">Statut</th>';
                if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                    html += '<th style="text-align: center;">Actions</th>';
                }
                html += '</tr></thead><tbody>';
                
                if (planningData.length > 0) {
                    for (var i = 0; i < planningData.length; i++) {
                        var d = planningData[i];
                        html += '<tr><td><span class="badge badge-blue">' + d.categorie + '</span></td><td>' + d.activite + '</td><td><span class="badge badge-purple">' + d.service + '</span></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t1 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t1\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t2 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t2\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t3 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t3\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t4 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t4\')"></td>';
                        html += '<td style="text-align: center;">';
                        if (d.valide) html += '<span class="badge" style="background-color: #d1fae5; color: #065f46;">Valid√©e</span>';
                        else html += '<span class="badge" style="background-color: #fef3c7; color: #92400e;">En attente</span>';
                        html += '</td>';
                        
                        if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                            html += '<td style="text-align: center;"><div style="display: flex; gap: 4px; justify-content: center;">';
                            if (canValidate() && !d.valide) {
                                html += '<button class="btn btn-success" style="font-size: 11px; padding: 4px 8px;" onclick="validateActivity(' + d.id + ')">Valider</button>';
                            }
                            if (canDeleteInPlanning(d)) {
                                html += '<button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteActivity(' + d.id + ')">Supprimer</button>';
                            }
                            html += '</div></td>';
                        }
                        html += '</tr>';
                    }
                } else {
                    var colspan = (currentUser.role === 'admin' || currentUser.role === 'chef') ? '9' : '8';
                    html += '<tr><td colspan="' + colspan + '" class="empty-state">Aucune activit√© en planification</td></tr>';
                }
                html += '</tbody></table></div>';
            }

            // ========== ONGLET 3 : SUIVI-√âVALUATION ==========
            if (activeTab === 'suivi') {
                html += '<h2 style="margin-bottom: 16px;">Suivi-√âvaluation 2026</h2>';
                html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">';

                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Objectif</label><select onchange="changeSuiviObjectifFilter(this.value)" class="form-control"><option value="TOUS"' + (suiviObjectifFilter === 'TOUS' ? ' selected' : '') + '>Tous les objectifs</option><option value="Objectifs G√©n√©raux"' + (suiviObjectifFilter === 'Objectifs G√©n√©raux' ? ' selected' : '') + '>Objectifs G√©n√©raux</option><option value="Objectifs de R√©forme"' + (suiviObjectifFilter === 'Objectifs de R√©forme' ? ' selected' : '') + '>Objectifs de R√©forme</option><option value="Objectifs Sp√©cifiques"' + (suiviObjectifFilter === 'Objectifs Sp√©cifiques' ? ' selected' : '') + '>Objectifs Sp√©cifiques</option><option value="D√©cisions du CM"' + (suiviObjectifFilter === 'D√©cisions du CM' ? ' selected' : '') + '>D√©cisions du CM</option><option value="D√©cisions du PR"' + (suiviObjectifFilter === 'D√©cisions du PR' ? ' selected' : '') + '>D√©cisions du PR</option></select></div>';

                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üìÖ Trimestre (cumul√©)</label><select onchange="changeSuiviTrimestreFilter(this.value)" class="form-control"><option value="TOUS"' + (suiviTrimestreFilter === 'TOUS' ? ' selected' : '') + '>Toute l\'ann√©e</option><option value="T1"' + (suiviTrimestreFilter === 'T1' ? ' selected' : '') + '>Jusqu\'√† T1</option><option value="T2"' + (suiviTrimestreFilter === 'T2' ? ' selected' : '') + '>Jusqu\'√† T2</option><option value="T3"' + (suiviTrimestreFilter === 'T3' ? ' selected' : '') + '>Jusqu\'√† T3</option><option value="T4"' + (suiviTrimestreFilter === 'T4' ? ' selected' : '') + '>Jusqu\'√† T4</option></select></div>';

                html += '</div></div>';

                var suiviData = getFilteredDataForSuivi();

                html += '<div class="table-container"><table><thead class="blue"><tr><th>Objectif</th><th>Activit√©</th><th>Service</th><th style="text-align: center; background-color: #1e40af;">T1</th><th style="text-align: center; background-color: #1e40af;">T2</th><th style="text-align: center; background-color: #1e40af;">T3</th><th style="text-align: center; background-color: #1e40af;">T4</th><th style="text-align: center;">TDR</th><th style="text-align: center;">ENGAG√â</th><th style="text-align: center;">MANDAT√â</th><th style="text-align: center;">ORDONNANC√â</th><th style="text-align: center;">LIQUID√â</th><th style="text-align: center;">EX√âCUT√â</th><th style="text-align: center;">TAUX</th></tr></thead><tbody>';

                if (suiviData.length > 0) {
                    for (var i = 0; i < suiviData.length; i++) {
                        var d = suiviData[i];
                        var taux = calcTaux(d);
                        var tauxClass = taux === 100 ? 'badge-taux-green' : taux >= 50 ? 'badge-taux-yellow' : 'badge-taux-red';
                        
                        html += '<tr><td><span class="badge badge-blue">' + d.categorie + '</span></td><td>' + d.activite + '</td><td><span class="badge badge-purple">' + d.service + '</span></td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t1 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t2 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t3 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t4 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.tdr ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'tdr\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.eng ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'eng\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.mand ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'mand\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.ordo ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'ordo\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.liq ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'liq\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.exec ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'exec\')"></td>';
                        html += '<td style="text-align: center;"><span class="badge-taux ' + tauxClass + '">' + taux + '%</span></td></tr>';
                    }
                } else {
                    html += '<tr><td colspan="14" class="empty-state">Aucune activit√© valid√©e</td></tr>';
                }
                html += '</tbody></table></div>';
            }
// ========== ONGLET 4 : COMMENTAIRES ET PREUVES ==========
            if (activeTab === 'commentaires') {
                html += '<div class="flex-between"><h2>üìã Commentaires et Preuves 2026</h2>';
                if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                    html += '<button class="btn btn-primary" onclick="showCommentaireEtPreuveModal()">üìã D√©poser une preuve et Commenter</button>';
                }
                html += '</div>';
                
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;"><div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üè¢ Service</label><select onchange="changeCommentairesServiceFilter(this.value)" class="form-control"><option value="TOUS"' + (commentairesServiceFilter === 'TOUS' ? ' selected' : '') + '>Tous les services</option>';              
                    for (var i = 0; i < services.length; i++) {
                        html += '<option value="' + services[i] + '"' + (commentairesServiceFilter === services[i] ? ' selected' : '') + '>' + services[i] + '</option>';
                    }
                    
                    html += '</select></div><div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Objectif</label><select onchange="changeCommentairesObjectifFilter(this.value)" class="form-control"><option value="TOUS"' + (commentairesObjectifFilter === 'TOUS' ? ' selected' : '') + '>Tous les objectifs</option><option value="Objectifs G√©n√©raux"' + (commentairesObjectifFilter === 'Objectifs G√©n√©raux' ? ' selected' : '') + '>Objectifs G√©n√©raux</option><option value="Objectifs de R√©forme"' + (commentairesObjectifFilter === 'Objectifs de R√©forme' ? ' selected' : '') + '>Objectifs de R√©forme</option><option value="Objectifs Sp√©cifiques"' + (commentairesObjectifFilter === 'Objectifs Sp√©cifiques' ? ' selected' : '') + '>Objectifs Sp√©cifiques</option><option value="D√©cisions du CM"' + (commentairesObjectifFilter === 'D√©cisions du CM' ? ' selected' : '') + '>D√©cisions du CM</option><option value="D√©cisions du PR"' + (commentairesObjectifFilter === 'D√©cisions du PR' ? ' selected' : '') + '>D√©cisions du PR</option></select></div></div></div>';
                }
                
                html += '<div class="table-container"><table><thead class="blue"><tr><th style="width: 15%;">Objectif</th><th style="width: 30%;">Activit√©</th><th style="width: 10%;">Service</th><th style="width: 20%;">Commentaire</th><th style="width: 15%;">Document</th><th style="width: 10%;">Date</th>';
                if (currentUser.role !== 'chefdept') {
                    html += '<th style="text-align: center; width: 4%;">Actions</th>';
                }
                html += '</tr></thead><tbody>';
                
                var commentairesData = [];
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    commentairesData = commentairesEtPreuves;
                } else {
                    for (var i = 0; i < commentairesEtPreuves.length; i++) {
                        if (commentairesEtPreuves[i].service === currentUser.service) {
                            commentairesData.push(commentairesEtPreuves[i]);
                        }
                    }
                }
                
                if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && commentairesServiceFilter !== 'TOUS') {
                    var filtered = [];
                    for (var i = 0; i < commentairesData.length; i++) {
                        if (commentairesData[i].service === commentairesServiceFilter) {
                            filtered.push(commentairesData[i]);
                        }
                    }
                    commentairesData = filtered;
                }
                
                if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && commentairesObjectifFilter !== 'TOUS') {
                    var filtered = [];
                    for (var i = 0; i < commentairesData.length; i++) {
                        if (commentairesData[i].objectif === commentairesObjectifFilter) {
                            filtered.push(commentairesData[i]);
                        }
                    }
                    commentairesData = filtered;
                }
                
                var activitesWithData = {};
                for (var i = 0; i < commentairesData.length; i++) {
                    var key = commentairesData[i].activite + '|' + commentairesData[i].service;
                    if (!activitesWithData[key]) {
                        activitesWithData[key] = {
                            objectif: commentairesData[i].objectif,
                            activite: commentairesData[i].activite,
                            service: commentairesData[i].service,
                            commentaires: [],
                            preuves: []
                        };
                    }
                    
                    if (commentairesData[i].type === 'commentaire') {
                        activitesWithData[key].commentaires.push(commentairesData[i]);
                    } else {
                        activitesWithData[key].preuves.push(commentairesData[i]);
                    }
                }
                
                var hasData = false;
                for (var key in activitesWithData) {
                    hasData = true;
                    var item = activitesWithData[key];
                    
                    html += '<tr>';
                    html += '<td><span class="badge badge-blue">' + item.objectif + '</span></td>';
                    html += '<td>' + item.activite + '</td>';
                    html += '<td><span class="badge badge-purple">' + item.service + '</span></td>';
                    
                    html += '<td>';
                    if (item.commentaires.length > 0) {
                        for (var j = 0; j < item.commentaires.length; j++) {
                            var c = item.commentaires[j];
                            if (j > 0) html += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #e5e7eb;">';
                            html += '<div style="text-align: left; text-align: justify;">' + c.commentaire + '</div>';
                        }
                    } else {
                        html += '-';
                    }
                    html += '</td>';
                    
              html += '<td>';
                if (item.preuves.length > 0) {
                    for (var j = 0; j < item.preuves.length; j++) {
                        var p = item.preuves[j];
                        if (j > 0) html += '<br/>';
                        
                        // üî• CORRECTION - V√©rifier que les propri√©t√©s existent
                        var fileUrl = p.file_url || p.fileUrl || '';
                        var nomFichier = p.nom_fichier || p.nomFichier || 'Fichier';
                        
                        if (fileUrl && nomFichier) {
                            html += '<span style="color: #2563eb; cursor: pointer; text-decoration: underline;" onclick="ouvrirPreuve(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">üìé ' + nomFichier + '</span>';
                        } else {
                            html += '<span style="color: #dc2626;">‚ùå Fichier invalide</span>';
                        }
                    }
                } else {
                    html += '-';
                }
                html += '</td>';

                    html += '</td>';
                    
                    html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    
                    if (currentUser.role !== 'chefdept') {
                        html += '<td style="text-align: center;">';
                        var canManage = currentUser.role === 'admin' || (currentUser.role === 'chef' && item.service === currentUser.service);
                        if (canManage) {
                            html += '<div style="display: flex; flex-direction: column; gap: 4px;">';
                            
                            if (item.commentaires.length > 0) {
                                html += '<button class="btn btn-warning" style="font-size: 11px; padding: 4px 8px;" onclick="showEditCommentaireModal(' + item.commentaires[0].id + ')">‚úèÔ∏è Modifier</button>';
                                html += '<button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteCommentaireOuPreuve(' + item.commentaires[0].id + ')">üóëÔ∏è Suppr. comm.</button>';
                            }
                            
                            if (item.preuves.length > 0) {
                                html += '<button class="btn btn-primary" style="font-size: 11px; padding: 4px 8px;" onclick="showManagePreuvesModal(\'' + item.activite.replace(/'/g, "\\'") + '\', \'' + item.service + '\')">üìé G√©rer (' + item.preuves.length + ')</button>';
                            }
                            
                            html += '</div>';
                        }
                        html += '</td>';
                    }
                    html += '</tr>';
                }
                
                if (!hasData) {
                    var colspan = (currentUser.role !== 'chefdept') ? '7' : '6';
                    html += '<tr><td colspan="' + colspan + '" class="empty-state">Aucun commentaire ou preuve</td></tr>';
                }
                html += '</tbody></table></div>';
            }
// ========== ONGLET 5 : RAPPORT DE PERFORMANCE ==========
            if (activeTab === 'rapport') {
                var isGlobal = currentUser.role === 'chefdept' || (currentUser.role === 'admin' && selectedServiceFilter === 'TOUS');
                var serviceRapport = currentUser.role === 'chef' ? currentUser.service : (isGlobal ? null : selectedServiceFilter);
                
                html += '<div class="flex-between"><h2>üìÑ Rapport de Performance 2026</h2>';
                html += '<div style="display: flex; gap: 8px;">';
                
                html += '<button class="btn btn-primary" onclick="exporterRapportWord()">üì• Export Word</button>';
                html += '<button class="btn btn-success" onclick="exporterDonneesExcel()" style="margin-left: 8px;">üìä Export Excel (Donn√©es)</button>';
                
                if (currentUser.role === 'admin' && !isGlobal) {
                    html += '<button class="btn btn-secondary" onclick="selectedServiceFilter=\'TOUS\'; render();">üìä Rapport global</button>';
                }
                
                html += '</div></div>';
                
                html += '<div id="rapport-content" style="background-color: white; padding: 32px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 16px;">';
                
                var titreRapport = isGlobal ? 'RAPPORT DE PERFORMANCE GLOBAL' : 'RAPPORT DE PERFORMANCE - ' + (serviceRapport || 'SERVICE');
                html += '<h1 style="text-align: center; color: #2563eb; margin-bottom: 24px;">' + titreRapport + '</h1>';
                html += '<p style="text-align: center; color: #6b7280; margin-bottom: 32px;">Ann√©e 2026</p>';
                
                // SECTION 1 : CONTEXTE
                html += '<h2 style="color: #2563eb; margin-top: 32px;">1. √âl√©ments de contexte</h2>';
                var contexteKey = 'contexte_' + (serviceRapport || 'global');
                var contexteValue = rapportTextes[contexteKey] || '';
                
                html += '<textarea id="contexte-text" class="form-control" rows="4" style="margin-top: 16px;" placeholder="Saisissez les √©l√©ments de contexte..." onchange="sauvegarderTexteRapport(\'' + contexteKey + '\', this.value)">' + contexteValue + '</textarea>';
                
                // SECTION 2 : BILAN DES R√âALISATIONS DES OBJECTIFS
                html += '<h2 style="color: #2563eb; margin-top: 32px;">2. Bilan des r√©alisations des objectifs</h2>';
                
                var rappelKey = 'rappel_' + (serviceRapport || 'global');
                var rappelValue = rapportTextes[rappelKey] || '';
                
                html += '<h3 style="margin-top: 16px; color: #4b5563;">Rappel des actions programm√©es</h3>';
                html += '<textarea id="rappel-text" class="form-control" rows="3" style="margin-top: 8px;" placeholder="Rappel..." onchange="sauvegarderTexteRapport(\'' + rappelKey + '\', this.value)">' + rappelValue + '</textarea>';
                
                // TABLEAU 1
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Tableau 1 : Taux par objectif</h3>';
                
                var statsObjectifs = calculerStatsObjectifs(serviceRapport);
                var totalPlanifieesObj = 0;
                var totalRealiseesObj = 0;
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;"><thead class="blue"><tr>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px;">Objectifs</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Planifi√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">R√©alis√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Taux</th>';
                html += '</tr></thead><tbody>';
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    totalPlanifieesObj += stat.planifiees;
                    totalRealiseesObj += stat.realisees;
                    
                    html += '<tr>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">' + stat.objectif + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.planifiees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.realisees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + stat.taux + '%</td>';
                    html += '</tr>';
                }
                
                var tauxTotalObj = totalPlanifieesObj > 0 ? Math.round((totalRealiseesObj / totalPlanifieesObj) * 100) : 0;
                html += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">Total</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalPlanifieesObj + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalRealiseesObj + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + tauxTotalObj + '%</td>';
                html += '</tr>';
                html += '</tbody></table>';
                
                // GRAPHIQUE 1
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Graphique 1 : Taux par objectif</h3>';
                html += '<div style="margin-top: 16px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">';
                
                var couleursGraph1 = ['#87CEEB', '#C6F4D6', '#F7DC6F'];
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    var barColor = couleursGraph1[i];
                    html += '<div style="margin-bottom: 16px;">';
                    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 13px; font-weight: 600;">' + stat.objectif + '</span><span style="font-size: 13px; font-weight: bold; color: ' + barColor + ';">' + stat.taux + '%</span></div>';
                    html += '<div style="width: 100%; height: 24px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                    html += '<div style="width: ' + stat.taux + '%; height: 100%; background-color: ' + barColor + ';"></div>';
                    html += '</div></div>';
                }
                
                var barColorTotalGraph1 = '#f59e0b';
                html += '<div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #cbd5e1;">';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 14px; font-weight: bold;">TOTAL</span><span style="font-size: 14px; font-weight: bold; color: ' + barColorTotalGraph1 + ';">' + tauxTotalObj + '%</span></div>';
                html += '<div style="width: 100%; height: 28px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                html += '<div style="width: ' + tauxTotalObj + '%; height: 100%; background-color: ' + barColorTotalGraph1 + ';"></div>';
                html += '</div></div>';
                
                html += '</div>';
// LISTES DES ACTIVIT√âS PAR OBJECTIF
                var objectifsList = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques'];
                
                for (var j = 0; j < objectifsList.length; j++) {
                    var objNom = objectifsList[j];
                    var activitesObj = getActivitesRealisees(serviceRapport, objNom);
                    
                    html += '<h3 style="margin-top: 32px; color: #2563eb; font-size: 18px;">' + objNom + '</h3>';
                    
                    if (activitesObj.length > 0) {
                        html += '<ul style="list-style-type: disc; margin-left: 24px; margin-top: 12px;">';
                        
                        for (var k = 0; k < activitesObj.length; k++) {
                            var act = activitesObj[k];
                            html += '<li style="margin-bottom: 16px; line-height: 1.6;">';
                            html += '<strong>' + act.activite + '</strong>';
                            
                            var commentaire = getCommentaireForActivite(act.activite, act.service);
                            if (commentaire) {
                                html += '<div style="margin-top: 8px; padding: 8px 12px; background-color: #f3f4f6; font-size: 13px; color: #4b5563; font-style: italic; text-align: justify;">';
                                html += commentaire;
                                html += '</div>';
                            }
                            
                            html += '</li>';
                        }
                        
                        html += '</ul>';
                    } else {
                        html += '<p style="margin-top: 12px; color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e √† 100%.</p>';
                    }
                }
                
                // SECTION 3 : BILAN D'EX√âCUTION DES D√âCISIONS
                html += '<h2 style="color: #2563eb; margin-top: 40px;">3. Bilan d\'ex√©cution des D√©cisions du PR et des CM</h2>';
                var rappelDecKey = 'rappelDec_' + (serviceRapport || 'global');
                var rappelDecValue = rapportTextes[rappelDecKey] || '';
                
                html += '<h3 style="margin-top: 16px; color: #4b5563;">Rappel des d√©cisions</h3>';
                html += '<textarea id="rappelDec-text" class="form-control" rows="3" style="margin-top: 8px;" placeholder="Rappel des d√©cisions..." onchange="sauvegarderTexteRapport(\'' + rappelDecKey + '\', this.value)">' + rappelDecValue + '</textarea>';
                
                // TABLEAU 2
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Tableau 2 : Taux par d√©cision</h3>';
                var statsDecisions = calculerStatsDecisions(serviceRapport);
                
                var totalPlanifieesDec2 = 0;
                var totalRealiseesDec2 = 0;
                for (var i = 0; i < statsDecisions.length; i++) {
                    totalPlanifieesDec2 += statsDecisions[i].planifiees;
                    totalRealiseesDec2 += statsDecisions[i].realisees;
                }
                var tauxTotalDec2 = totalPlanifieesDec2 > 0 ? Math.round((totalRealiseesDec2 / totalPlanifieesDec2) * 100) : 0;
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;"><thead class="blue"><tr>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px;">D√©cisions</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Planifi√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">R√©alis√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Taux</th>';
                html += '</tr></thead><tbody>';
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    html += '<tr>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">' + stat.decision + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.planifiees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.realisees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + stat.taux + '%</td>';
                    html += '</tr>';
                }
                
                html += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">Total</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalPlanifieesDec2 + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalRealiseesDec2 + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + tauxTotalDec2 + '%</td>';
                html += '</tr>';
                
                html += '</tbody></table>';
                
                // GRAPHIQUE 2
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Graphique 2 : Taux par d√©cision</h3>';
                html += '<div style="margin-top: 16px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">';
                
                var couleursGraph2 = ['#87CEEB', '#C6F4D6'];
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    var barColor = couleursGraph2[i];
                    html += '<div style="margin-bottom: 16px;">';
                    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 13px; font-weight: 600;">' + stat.decision + '</span><span style="font-size: 13px; font-weight: bold; color: ' + barColor + ';">' + stat.taux + '%</span></div>';
                    html += '<div style="width: 100%; height: 24px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                    html += '<div style="width: ' + stat.taux + '%; height: 100%; background-color: ' + barColor + ';"></div>';
                    html += '</div></div>';
                }
                
                var barColorTotal = '#f59e0b';
                html += '<div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #cbd5e1;">';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 14px; font-weight: bold;">TOTAL</span><span style="font-size: 14px; font-weight: bold; color: ' + barColorTotal + ';">' + tauxTotalDec2 + '%</span></div>';
                html += '<div style="width: 100%; height: 28px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                html += '<div style="width: ' + tauxTotalDec2 + '%; height: 100%; background-color: ' + barColorTotal + ';"></div>';
                html += '</div></div>';
                
                html += '</div>';
// LISTES DES D√âCISIONS
                var decisionsPR = getActivitesRealisees(serviceRapport, 'D√©cisions du PR');
                var decisionsCM = getActivitesRealisees(serviceRapport, 'D√©cisions du CM');
                
                html += '<h3 style="margin-top: 24px; color: #2563eb; font-size: 18px;">D√©cisions du PR</h3>';
                if (decisionsPR.length > 0) {
                    html += '<ul style="list-style-type: disc; margin-left: 24px; margin-top: 12px;">';
                    for (var k = 0; k < decisionsPR.length; k++) {
                        var act = decisionsPR[k];
                        html += '<li style="margin-bottom: 16px; line-height: 1.6;"><strong>' + act.activite + '</strong>';
                        var commentaire = getCommentaireForActivite(act.activite, act.service);
                        if (commentaire) {
                            html += '<div style="margin-top: 8px; padding: 8px 12px; background-color: #f3f4f6; font-size: 13px; color: #4b5563; font-style: italic; text-align: justify;">' + commentaire + '</div>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p style="margin-top: 12px; color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
                }
                
                html += '<h3 style="margin-top: 24px; color: #2563eb; font-size: 18px;">D√©cisions du CM</h3>';
                if (decisionsCM.length > 0) {
                    html += '<ul style="list-style-type: disc; margin-left: 24px; margin-top: 12px;">';
                    for (var k = 0; k < decisionsCM.length; k++) {
                        var act = decisionsCM[k];
                        html += '<li style="margin-bottom: 16px; line-height: 1.6;"><strong>' + act.activite + '</strong>';
                        var commentaire = getCommentaireForActivite(act.activite, act.service);
                        if (commentaire) {
                            html += '<div style="margin-top: 8px; padding: 8px 12px; background-color: #f3f4f6; font-size: 13px; color: #4b5563; font-style: italic; text-align: justify;">' + commentaire + '</div>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p style="margin-top: 12px; color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
                }
                
                // TABLEAU 3 : VUE GLOBALE
                html += '<h3 style="margin-top: 32px; color: #4b5563;">Tableau 3 : Vue globale</h3>';
                
                var totalPlanifieesDec = 0;
                var totalRealiseesDec = 0;
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    totalPlanifieesDec += statsDecisions[i].planifiees;
                    totalRealiseesDec += statsDecisions[i].realisees;
                }
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;"><thead class="blue"><tr>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px;">Cat√©gories</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Planifi√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">R√©alis√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Taux</th>';
                html += '</tr></thead><tbody>';
                
                // LIGNES DES OBJECTIFS
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    html += '<tr>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">' + stat.objectif + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.planifiees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.realisees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + stat.taux + '%</td>';
                    html += '</tr>';
                }
                
                // LIGNES DES D√âCISIONS
                html += '<tr>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">D√©cisions du PR</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[0].planifiees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[0].realisees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + statsDecisions[0].taux + '%</td>';
                html += '</tr>';
                
                html += '<tr>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">D√©cisions du CM</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[1].planifiees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[1].realisees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + statsDecisions[1].taux + '%</td>';
                html += '</tr>';
                
                // LIGNE TOTALE
                html += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">Total</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + (totalPlanifieesObj + totalPlanifieesDec) + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + (totalRealiseesObj + totalRealiseesDec) + '</td>';
                var tauxGlobalTotal = (totalPlanifieesObj + totalPlanifieesDec) > 0 ? Math.round(((totalRealiseesObj + totalRealiseesDec) / (totalPlanifieesObj + totalPlanifieesDec)) * 100) : 0;
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + tauxGlobalTotal + '%</td>';
                html += '</tr>';
                html += '</tbody></table>';
                
                // GRAPHIQUE 3 : BARRES VERTICALES
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Graphique 3 : Taux de r√©alisation par cat√©gorie</h3>';
                
                html += '<div style="margin-top: 16px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">';
                
                html += '<div style="display: flex; align-items: flex-end; justify-content: space-around; height: 300px; border-bottom: 2px solid #cbd5e1; padding: 0 20px;">';
                
                // Barres pour les 3 objectifs
                var couleursGraph3Obj = ['#87CEEB', '#C6F4D6', '#F7DC6F'];
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    var barColor = couleursGraph3Obj[i];
                    var hauteur = stat.taux * 2.5;
                    
                    html += '<div style="display: flex; flex-direction: column; align-items: center; width: 80px;">';
                    html += '<div style="font-weight: bold; font-size: 16px; color: ' + barColor + '; margin-bottom: 8px;">' + stat.taux + '%</div>';
                    html += '<div style="width: 60px; height: ' + hauteur + 'px; background-color: ' + barColor + '; border-radius: 4px 4px 0 0;"></div>';
                    html += '</div>';
                }
                
                // Barres pour les 2 d√©cisions
                var couleursGraph3Dec = ['#FFC5C5', '#AFEEEE'];
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    var barColor = couleursGraph3Dec[i];
                    var hauteur = stat.taux * 2.5;
                    
                    html += '<div style="display: flex; flex-direction: column; align-items: center; width: 80px;">';
                    html += '<div style="font-weight: bold; font-size: 16px; color: ' + barColor + '; margin-bottom: 8px;">' + stat.taux + '%</div>';
                    html += '<div style="width: 60px; height: ' + hauteur + 'px; background-color: ' + barColor + '; border-radius: 4px 4px 0 0;"></div>';
                    html += '</div>';
                }
                
                // Barre TOTAL (plus large et dor√©e)
                var barColorGlobal = '#f59e0b';
                var hauteurGlobal = tauxGlobalTotal * 2.5;
                html += '<div style="display: flex; flex-direction: column; align-items: center; width: 100px; margin-left: 20px; padding-left: 20px; border-left: 2px solid #cbd5e1;">';
                html += '<div style="font-weight: bold; font-size: 18px; color: ' + barColorGlobal + '; margin-bottom: 8px;">' + tauxGlobalTotal + '%</div>';
                html += '<div style="width: 80px; height: ' + hauteurGlobal + 'px; background-color: ' + barColorGlobal + '; border-radius: 4px 4px 0 0;"></div>';
                html += '</div>';
                
                html += '</div>';
                
                // L√âGENDES SOUS LES BARRES
                html += '<div style="display: flex; align-items: center; justify-content: space-around; margin-top: 16px; padding: 0 20px;">';
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    var nomCourt = stat.objectif.replace('Objectifs ', 'Obj. ');
                    html += '<div style="width: 80px; text-align: center; font-size: 11px; font-weight: 600; color: #4b5563;">' + nomCourt + '</div>';
                }
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    var nomCourt = stat.decision.replace('D√©cisions ', 'D√©c. ');
                    html += '<div style="width: 80px; text-align: center; font-size: 11px; font-weight: 600; color: #4b5563;">' + nomCourt + '</div>';
                }
                
                html += '<div style="width: 100px; text-align: center; font-size: 12px; font-weight: bold; color: #1e293b; margin-left: 20px; padding-left: 20px; border-left: 2px solid #cbd5e1;">TOTAL GLOBAL</div>';
                
                html += '</div>';
                
                // R√âSUM√â
                html += '<div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #cbd5e1; display: flex; justify-content: center; gap: 40px; font-size: 13px; color: #6b7280;">';
                html += '<span><strong>Total Planifi√©es:</strong> ' + (totalPlanifieesObj + totalPlanifieesDec) + '</span>';
                html += '<span><strong>Total R√©alis√©es:</strong> ' + (totalRealiseesObj + totalRealiseesDec) + '</span>';
                html += '<span style="color: ' + barColorGlobal + '; font-weight: bold;">Taux Global: ' + tauxGlobalTotal + '%</span>';
                html += '</div>';
                
                html += '</div>';
                
                // SECTION 4 : DIFFICULT√âS ET SOLUTIONS
                html += '<h2 style="color: #2563eb; margin-top: 40px;">4. Difficult√©s et Solutions</h2>';
                var diffKey = 'difficultes_' + (serviceRapport || 'global');
                var diffValue = rapportTextes[diffKey] || '';
                
                html += '<h3 style="margin-top: 16px; color: #4b5563;">4.1 Difficult√©s</h3>';
                html += '<textarea id="difficultes-text" class="form-control" rows="5" style="margin-top: 8px;" placeholder="D√©crivez les difficult√©s..." onchange="sauvegarderTexteRapport(\'' + diffKey + '\', this.value)">' + diffValue + '</textarea>';
                
                var pistesKey = 'pistes_' + (serviceRapport || 'global');
                var pistesValue = rapportTextes[pistesKey] || '';
                
                html += '<h3 style="margin-top: 24px; color: #4b5563;">4.2 Pistes de Solutions</h3>';
                html += '<textarea id="pistes-text" class="form-control" rows="5" style="margin-top: 8px;" placeholder="Proposez des solutions..." onchange="sauvegarderTexteRapport(\'' + pistesKey + '\', this.value)">' + pistesValue + '</textarea>';
                
                html += '</div>'; // Fermeture rapport-content
            }
// ========== ONGLET 6 : ANALYSE ==========
if (activeTab === 'analyse') {
    html += '<h2 style="margin-bottom: 16px;">üìä Analyse Strat√©gique</h2>';
    
   // SOUS-MENU avec couleurs personnalis√©es
html += '<div style="background-color: white; padding: 16px; margin-bottom: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">';

// Bouton 1 : Acc√®s √©quitable (Bleu turquoise)
var styleAcces = activeAnalyseTab === 'acces' 
    ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: scale(1.02);' 
    : 'background: linear-gradient(135deg, #a8b7f5 0%, #c3b1d9 100%); color: #4c1d95;';
html += '<button onclick="changeAnalyseTab(\'acces\')" style="' + styleAcces + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">‚öñÔ∏è Acc√®s √©quitable</button>';

// Bouton 2 : Qualit√© des enseignements (Vert √©meraude)
var styleQualite = activeAnalyseTab === 'qualite'
    ? 'background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; transform: scale(1.02);'
    : 'background: linear-gradient(135deg, #a7f3d0 0%, #d1fae5 100%); color: #065f46;';
html += '<button onclick="changeAnalyseTab(\'qualite\')" style="' + styleQualite + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">üéì Qualit√© des enseignements</button>';

// Bouton 3 : Alphab√©tisation (Orange corail)
var styleAlpha = activeAnalyseTab === 'alphabetisation'
    ? 'background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; transform: scale(1.02);'
    : 'background: linear-gradient(135deg, #fed7aa 0%, #fecaca 100%); color: #9a3412;';
html += '<button onclick="changeAnalyseTab(\'alphabetisation\')" style="' + styleAlpha + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">‚úçÔ∏è Alphab√©tisation</button>';

// Bouton 4 : D√©cisions (Bleu cyan)
var styleDecisions = activeAnalyseTab === 'decisions'
    ? 'background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%); color: white; transform: scale(1.02);'
    : 'background: linear-gradient(135deg, #bfdbfe 0%, #a5f3fc 100%); color: #075985;';
html += '<button onclick="changeAnalyseTab(\'decisions\')" style="' + styleDecisions + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">üéØ D√©cisions</button>';

html += '</div></div>';
   
    // CONTENU CONDITIONNEL
    if (activeAnalyseTab === 'acces') {
        html += renderAnalyseAcces();
    } else if (activeAnalyseTab === 'qualite') {
        html += renderAnalyseQualite();
    } else if (activeAnalyseTab === 'alphabetisation') {
        html += renderAnalyseAlphabetisation();
    } else if (activeAnalyseTab === 'decisions') {
        html += renderAnalyseDecisions();
    }
}
// ========== ONGLET 7 : ADMINISTRATION ==========
            if (activeTab === 'admin') {
                html += '<h2 style="margin-bottom: 16px;">‚öôÔ∏è Administration</h2>';
                
                html += '<div class="cards" style="margin-top: 24px;">';
                
                html += '<div class="card card-blue" style="cursor: pointer;" onclick="showUserList()"><div class="card-title" style="color: #2563eb;">üë• Gestion des Comptes</div><div style="font-size: 14px; margin-top: 8px;">Cr√©er, modifier, supprimer</div></div>';
                
                html += '<div class="card card-green" style="cursor: pointer;" onclick="showConnectedUsers()"><div class="card-title" style="color: #059669;">üü¢ Utilisateurs Connect√©s</div><div class="card-value" style="font-size: 24px; margin-top: 8px;">' + connectedUsers.length + '</div></div>';
                
                html += '<div class="card card-orange" style="cursor: pointer;"><div class="card-title" style="color: #ea580c;">üìä Statistiques</div><div style="font-size: 14px; margin-top: 8px;">Total: ' + users.length + ' comptes</div></div>';
                
                html += '<div class="card" style="cursor: pointer; background-color: #f3e8ff; border-color: #7c3aed;" onclick="showPermissions()"><div class="card-title" style="color: #7c3aed;">üîí S√©curit√©</div><div style="font-size: 14px; margin-top: 8px;">Gestion des acc√®s</div></div>';
                
                html += '</div>';
                
                // TABLEAU DES UTILISATEURS
                html += '<h3 style="margin-top: 32px; margin-bottom: 16px;">Liste des Utilisateurs</h3>';
                html += '<div class="table-container"><table><thead class="blue"><tr><th>Utilisateur</th><th>Nom</th><th>Service</th><th>R√¥le</th><th>Statut</th><th>Derni√®re connexion</th></tr></thead><tbody>';
                
                var usersByRole = {admin: [], chefdept: [], chef: []};
                for (var i = 0; i < users.length; i++) {
                    usersByRole[users[i].role].push(users[i]);
                }
                
                // Admin en premier
                for (var i = 0; i < usersByRole.admin.length; i++) {
                    var u = usersByRole.admin[i];
                    html += '<tr>';
                    html += '<td><strong>' + u.user + '</strong></td>';
                    html += '<td>' + u.nom + '</td>';
                    html += '<td><span class="badge badge-purple">' + u.service + '</span></td>';
                    html += '<td><span class="badge" style="background-color: #dc2626; color: white;">Admin</span></td>';
                    html += '<td><span class="badge badge-green" style="color: #065f46;">Actif</span></td>';
                    html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    html += '</tr>';
                }
                
                // Chef d√©partement
                for (var i = 0; i < usersByRole.chefdept.length; i++) {
                    var u = usersByRole.chefdept[i];
                    html += '<tr>';
                    html += '<td>' + u.user + '</td>';
                    html += '<td>' + u.nom + '</td>';
                    html += '<td><span class="badge badge-purple">' + u.service + '</span></td>';
                    html += '<td><span class="badge" style="background-color: #d97706; color: white;">Chef D√©p.</span></td>';
                    html += '<td>';
                    if (u.actif) html += '<span class="badge badge-green" style="color: #065f46;">Actif</span>';
                    else html += '<span class="badge" style="background-color: #fee2e2; color: #991b1b;">D√©sactiv√©</span>';
                    html += '</td>';
                    
                    var connected = false;
                    for (var j = 0; j < connectedUsers.length; j++) {
                        if (connectedUsers[j].user === u.user) {
                            html += '<td style="font-size: 12px; color: #059669;">' + connectedUsers[j].connectedAt + '</td>';
                            connected = true;
                            break;
                        }
                    }
                    if (!connected) html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    html += '</tr>';
                }
                
                // Chefs de service
                for (var i = 0; i < usersByRole.chef.length; i++) {
                    var u = usersByRole.chef[i];
                    html += '<tr>';
                    html += '<td>' + u.user + '</td>';
                    html += '<td>' + u.nom + '</td>';
                    html += '<td><span class="badge badge-purple">' + u.service + '</span></td>';
                    html += '<td><span class="badge" style="background-color: #059669; color: white;">Chef</span></td>';
                    html += '<td>';
                    if (u.actif) html += '<span class="badge badge-green" style="color: #065f46;">Actif</span>';
                    else html += '<span class="badge" style="background-color: #fee2e2; color: #991b1b;">D√©sactiv√©</span>';
                    html += '</td>';
                    
                    var connected = false;
                    for (var j = 0; j < connectedUsers.length; j++) {
                        if (connectedUsers[j].user === u.user) {
                            html += '<td style="font-size: 12px; color: #059669;">' + connectedUsers[j].connectedAt + '</td>';
                            connected = true;
                            break;
                        }
                    }
                    if (!connected) html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    html += '</tr>';
                }
                
                html += '</tbody></table></div>';
                
                // STATISTIQUES
                html += '<h3 style="margin-top: 32px; margin-bottom: 16px;">Statistiques d\'Utilisation</h3>';
                html += '<div class="cards" style="grid-template-columns: repeat(3, 1fr);">';
                
                var activeCount = 0;
                var inactiveCount = 0;
                for (var i = 0; i < users.length; i++) {
                    if (users[i].actif) activeCount++;
                    else inactiveCount++;
                }
                
                html += '<div class="card card-blue"><div class="card-title" style="color: #2563eb;">Total Comptes</div><div class="card-value">' + users.length + '</div></div>';
                html += '<div class="card card-green"><div class="card-title" style="color: #059669;">Comptes Actifs</div><div class="card-value">' + activeCount + '</div></div>';
                html += '<div class="card card-orange"><div class="card-title" style="color: #ea580c;">Comptes D√©sactiv√©s</div><div class="card-value">' + inactiveCount + '</div></div>';
                
                html += '</div>';
            }
// ========== ONGLET 8 : STATISTIQUES ==========
           if (activeTab === 'statistiques') {
    html += '<h2 style="margin-bottom: 16px;">üìä Statistiques √âducatives</h2>';
    
    // Bouton d'ajout
    if (currentUser.role === 'admin' || currentUser.service === 'BSD') {
        html += '<div style="margin-bottom: 16px;"><button class="btn btn-success" onclick="showStatistiquesModal()">+ Saisir des statistiques</button></div>';
    }
    
    // Filtres
    // Filtres
html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
html += '<h3 style="margin-bottom: 12px;">Filtres</h3>';
html += '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">';

// 1Ô∏è‚É£ AFFICHER JUSQU'√Ä (P√©riode)
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üìÖ Afficher jusqu\'√†</label>';
html += '<select id="filter-stats-periode" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="TOUS">Toutes les p√©riodes</option>';
html += '<option value="T1">Jusqu\'√† T1</option>';
html += '<option value="T2">Jusqu\'√† T2</option>';
html += '<option value="T3">Jusqu\'√† T3</option>';
html += '<option value="T4">Jusqu\'√† T4</option>';
html += '<option value="Annuel">Ann√©e compl√®te</option>';
html += '</select></div>';

// 2Ô∏è‚É£ R√âGION
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üåç R√©gion</label>';
html += '<select id="filter-stats-region" class="form-control" onchange="appliquerFiltresStatistiques(); updateStatsPrefectureDropdown();">';
html += '<option value="">Toutes</option>';
for (var i = 0; i < regionsData.length; i++) {
    html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
}
html += '</select></div>';

// 3Ô∏è‚É£ PR√âFECTURE
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üèõÔ∏è Pr√©fecture</label>';
html += '<select id="filter-stats-prefecture" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="">Toutes</option>';
html += '</select></div>';

// 4Ô∏è‚É£ ZONE
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üèòÔ∏è Zone</label>';
html += '<select id="filter-stats-zone" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="">Toutes</option>';
html += '<option value="Urbaine">Urbaine</option>';
html += '<option value="Rurale">Rurale</option>';
html += '</select></div>';

// 5Ô∏è‚É£ NIVEAU
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üìö Niveau</label>';
html += '<select id="filter-stats-niveau" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="">Tous</option>';
html += '<option value="Pr√©scolaire">Pr√©scolaire</option>';
html += '<option value="Primaire">Primaire</option>';
html += '<option value="Secondaire">Secondaire</option>';
html += '<option value="Alphab√©tisation">Alphab√©tisation</option>';
html += '</select></div>';

// 6Ô∏è‚É£ GENRE
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üë§ Genre</label>';
html += '<select id="filter-stats-genre" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="Total">Total</option>';
html += '<option value="Filles">Filles</option>';
html += '</select></div>';

html += '</div></div>';
                
                // Cartes d'indicateurs
                html += '<div class="cards" style="grid-template-columns: repeat(7, 1fr); margin-bottom: 24px;">';
                
                var moyenneAbandon = calculerMoyenne(statistiquesData, 'taux_abandon');
                var moyenneReussite = calculerMoyenne(statistiquesData, 'taux_reussite_examens');
                var moyenneScolarisation = calculerMoyenne(statistiquesData, 'taux_scolarisation');
                var moyenneAlphabetisation = calculerMoyenne(statistiquesData, 'taux_alphabetisation');
                var moyenneRatioEnseignant = calculerMoyenne(statistiquesData, 'ratio_eleves_enseignant');
                var moyenneRatioClasse = calculerMoyenne(statistiquesData, 'ratio_eleves_classe');
                var moyenneDistance = calculerMoyenne(statistiquesData, 'distance_moyenne_ecole_domicile');
                
                html += '<div class="card card-orange"><div class="card-title" style="color: #ea580c;">Taux d\'abandon scolaire</div><div class="card-value">' + moyenneAbandon + '%</div></div>';
                html += '<div class="card card-green"><div class="card-title" style="color: #059669;">Taux de r√©ussite</div><div class="card-value">' + moyenneReussite + '%</div></div>';
                html += '<div class="card card-blue"><div class="card-title" style="color: #2563eb;">Taux de scolarisation</div><div class="card-value">' + moyenneScolarisation + '%</div></div>';
                html += '<div class="card card-yellow"><div class="card-title" style="color: #d97706;">Taux d\'alphab√©tisation</div><div class="card-value">' + moyenneAlphabetisation + '%</div></div>';
                html += '<div class="card" style="background-color: #fce7f3; border-left: 4px solid #db2777;"><div class="card-title" style="color: #db2777;">Ratio √©l√®ves/enseignant</div><div class="card-value">' + moyenneRatioEnseignant + '</div></div>';
                html += '<div class="card" style="background-color: #e0e7ff; border-left: 4px solid #6366f1;"><div class="card-title" style="color: #6366f1;">Ratio √©l√®ves/classe</div><div class="card-value">' + moyenneRatioClasse + '</div></div>';
                html += '<div class="card" style="background-color: #fef3c7; border-left: 4px solid #f59e0b;"><div class="card-title" style="color: #f59e0b;">Distance moy. (km)</div><div class="card-value">' + moyenneDistance + '</div></div>';
                
                html += '</div>';
                
                // Tableau des donn√©es
                html += '<div class="table-container"><table><thead class="blue"><tr><th>R√©gion</th><th>Pr√©fecture</th><th>Niveau</th><th>Genre</th><th>Taux abandon (%)</th><th>Taux r√©ussite (%)</th><th>Taux scolarisation (%)</th>';
                
                if (currentUser.role === 'admin' || currentUser.service === 'BSD') {
                    html += '<th style="text-align: center;">Actions</th>';
                }
                
                html += '</tr></thead><tbody>';
                
                if (statistiquesData.length > 0) {
                    for (var i = 0; i < statistiquesData.length; i++) {
                        var stat = statistiquesData[i];
                        html += '<tr>';
                        html += '<td>' + stat.region + '</td>';
                        html += '<td>' + stat.prefecture + '</td>';
                        html += '<td><span class="badge badge-blue">' + stat.niveau + '</span></td>';
                        html += '<td><span class="badge badge-purple">' + stat.genre + '</span></td>';
                        html += '<td>' + (stat.taux_abandon || '-') + '</td>';
                        html += '<td>' + (stat.taux_reussite_examens || '-') + '</td>';
                        html += '<td>' + (stat.taux_scolarisation || '-') + '</td>';
                        
                        if (currentUser.role === 'admin' || currentUser.service === 'BSD') {
                            html += '<td style="text-align: center;"><button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteStatistique(' + stat.id + ')">Supprimer</button></td>';
                        }
                        
                        html += '</tr>';
                    }
                } else {
                    var colspan = (currentUser.role === 'admin' || currentUser.service === 'BSD') ? '8' : '7';
                    html += '<tr><td colspan="' + colspan + '" class="empty-state">Aucune statistique enregistr√©e</td></tr>';
                }
                
                html += '</tbody></table></div>';
            }

            html += '</div><div id="modal-container"></div>';
            app.innerHTML = html;
        }

        // ========== INITIALISATION ==========
async function init() {
    await loadData();
    await loadPermissions(); 
    await checkInvitationToken(); // NOUVELLE LIGNE 
    var saved = localStorage.getItem('currentUser');
    if (saved) {
        currentUser = JSON.parse(saved);
        await loadRapportTextes();
        
        var alreadyConnected = false;
        for (var i = 0; i < connectedUsers.length; i++) {
            if (connectedUsers[i].user === currentUser.user) {
                alreadyConnected = true;
                break;
            }
        }
        if (!alreadyConnected) {
            connectedUsers.push({
                user: currentUser.user,
                nom: currentUser.nom,
                service: currentUser.service,
                connectedAt: new Date().toLocaleString('fr-FR')
            });
            localStorage.setItem('connectedUsers', JSON.stringify(connectedUsers));
        }
    }
    
    render();
}
        // ========== FONCTIONS DE VISUALISATION ET EXPORT ==========

function ouvrirPreuve(fileUrl, nomFichier) {
    console.log('üìÇ Ouverture du fichier:', nomFichier);
    
    if (!fileUrl || fileUrl === 'undefined' || fileUrl === '') {
        alert('‚ùå Ce fichier n\'a pas d\'URL valide.');
        return;
    }
    
    var extension = nomFichier.split('.').pop().toLowerCase();
    showDocumentViewer(fileUrl, nomFichier, extension);
}

function showDocumentViewer(fileUrl, nomFichier, extension) {
    var modalContainer = document.getElementById('modal-container');
    
    var html = '<div class="modal"><div class="modal-content" style="max-width: 95vw; max-height: 95vh; display: flex; flex-direction: column;">';
    
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">';
    html += '<h2 style="margin: 0;">üìÑ ' + nomFichier + '</h2>';
    html += '<div style="display: flex; gap: 8px;">';
    html += '<button class="btn btn-primary" onclick="telechargerFichier(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">‚¨áÔ∏è T√©l√©charger original</button>';
    
    html += '<div style="position: relative; display: inline-block;">';
    html += '<button class="btn btn-success" onclick="toggleExportMenu()" id="export-menu-btn">üì• Exporter ‚ñº</button>';
    html += '<div id="export-menu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 4px; min-width: 180px; z-index: 1000;">';
    html += '<button onclick="exporterDocument(\'pdf\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìÑ PDF</button>';
    html += '<button onclick="exporterDocument(\'docx\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìù Word (.docx)</button>';
    html += '<button onclick="exporterDocument(\'xlsx\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìä Excel (.xlsx)</button>';
    html += '<button onclick="exporterDocument(\'pptx\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìΩÔ∏è PowerPoint (.pptx)</button>';
    html += '<button onclick="exporterDocument(\'txt\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìã Texte (.txt)</button>';
    html += '<button onclick="exporterDocument(\'png\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üñºÔ∏è Image (.png)</button>';
    html += '</div></div>';
    
    html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Fermer</button>';
    html += '</div></div>';
    
    html += '<div id="document-viewer-container" style="flex: 1; overflow: auto; background-color: #f9fafb; border-radius: 8px; padding: 16px;">';
    
    if (extension === 'pdf') {
        html += '<iframe src="' + fileUrl + '" style="width: 100%; height: 100%; min-height: 600px; border: none;"></iframe>';
    } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].indexOf(extension) !== -1) {
        html += '<div style="text-align: center;"><img src="' + fileUrl + '" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>';
    } else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].indexOf(extension) !== -1) {
        html += '<div style="text-align: center; padding: 40px;">';
        html += '<p style="font-size: 18px; color: #6b7280; margin-bottom: 24px;">üìÑ Document Office d√©tect√©</p>';
        html += '<p style="margin-bottom: 16px;">Choisissez votre m√©thode de visualisation :</p>';
        html += '<div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">';
        var googleViewerUrl = 'https://docs.google.com/viewer?url=' + encodeURIComponent(fileUrl) + '&embedded=true';
        html += '<button class="btn btn-primary" onclick="chargerDocumentDansViewer(\'' + googleViewerUrl.replace(/'/g, "\\'") + '\')">üîç Visualiser avec Google Docs</button>';
        var officeViewerUrl = 'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(fileUrl);
        html += '<button class="btn btn-success" onclick="chargerDocumentDansViewer(\'' + officeViewerUrl.replace(/'/g, "\\'") + '\')">üìä Visualiser avec Office Online</button>';
        html += '<button class="btn btn-warning" onclick="telechargerFichier(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">‚¨áÔ∏è T√©l√©charger</button>';
        html += '</div></div>';
    } else if (['txt', 'csv', 'json', 'xml', 'html', 'css', 'js'].indexOf(extension) !== -1) {
        html += '<div style="text-align: center; padding: 20px;"><p>üìù Chargement du fichier texte...</p></div>';
    } else {
        html += '<div style="text-align: center; padding: 40px;">';
        html += '<p style="font-size: 18px; color: #6b7280; margin-bottom: 16px;">‚ö†Ô∏è Aper√ßu non disponible</p>';
        html += '<button class="btn btn-primary" onclick="telechargerFichier(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">‚¨áÔ∏è T√©l√©charger</button>';
        html += '</div>';
    }
    
    html += '</div></div></div>';
    
    modalContainer.innerHTML = html;
    
    if (['txt', 'csv', 'json', 'xml', 'html', 'css', 'js'].indexOf(extension) !== -1) {
        setTimeout(function() { chargerFichierTexte(fileUrl); }, 100);
    }
}

function toggleExportMenu() {
    var menu = document.getElementById('export-menu');
    if (!menu) return;
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

document.addEventListener('click', function(e) {
    var menu = document.getElementById('export-menu');
    var btn = document.getElementById('export-menu-btn');
    if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.style.display = 'none';
    }
});

function chargerDocumentDansViewer(viewerUrl) {
    var container = document.getElementById('document-viewer-container');
    if (!container) return;
    container.innerHTML = '<iframe src="' + viewerUrl + '" style="width: 100%; height: 100%; min-height: 600px; border: none;"></iframe>';
}

async function chargerFichierTexte(fileUrl) {
    try {
        var response = await fetch(fileUrl);
        var texte = await response.text();
        var container = document.getElementById('document-viewer-container');
        if (!container) return;
        container.innerHTML = '<pre style="background-color: white; padding: 20px; border-radius: 8px; overflow: auto; max-height: 600px; font-family: monospace; font-size: 13px; line-height: 1.5;">' + texte.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
    } catch (error) {
        console.error('Erreur:', error);
        var container = document.getElementById('document-viewer-container');
        if (container) container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><p>‚ùå Erreur</p></div>';
    }
}

function telechargerFichier(fileUrl, nomFichier) {
    var link = document.createElement('a');
    link.href = fileUrl;
    link.download = nomFichier;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exporterDocument(format, nomFichier) {
    var container = document.getElementById('document-viewer-container');
    if (!container) {
        alert('‚ùå Impossible d\'exporter');
        return;
    }
    
    var menu = document.getElementById('export-menu');
    if (menu) menu.style.display = 'none';
    
    var contenu = container.innerText || container.textContent || '';
    var contenuHTML = container.innerHTML || '';
    var nomBase = nomFichier.replace(/\.[^.]+$/, '');
    
    switch(format) {
        case 'pdf': exporterEnPDF(nomBase, container); break;
        case 'docx': exporterEnWord(nomBase, contenuHTML); break;
        case 'xlsx': exporterEnExcel(nomBase, contenu); break;
        case 'pptx': exporterEnPowerPoint(nomBase, container); break;
        case 'txt': exporterEnTexte(nomBase, contenu); break;
        case 'png': exporterEnImage(nomBase, container); break;
        default: alert('‚ö†Ô∏è Format non support√©');
    }
}

function exporterEnPDF(nomBase, container) {
    if (typeof html2pdf === 'undefined') {
        alert('‚ö†Ô∏è html2pdf non disponible');
        return;
    }
    var options = {
        margin: 10,
        filename: nomBase + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(options).from(container).save();
}

function exporterEnWord(nomBase, contenuHTML) {
    var htmlWord = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>' + nomBase + '</title></head><body>' + contenuHTML + '</body></html>';
    var blob = new Blob(['\ufeff', htmlWord], { type: 'application/msword' });
    telechargerBlob(blob, nomBase + '.doc');
}

function exporterEnExcel(nomBase, contenu) {
    var lignes = contenu.split('\n');
    var csv = lignes.join('\n');
    var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    telechargerBlob(blob, nomBase + '.csv');
}

async function exporterEnPowerPoint(nomBase, container) {
    try {
        if (typeof PptxGenJS === 'undefined') {
            alert('‚ùå PptxGenJS non disponible');
            return;
        }
        
        if (typeof html2canvas === 'undefined') {
            alert('‚ùå html2canvas non disponible');
            return;
        }
        
        var loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 10000; text-align: center;';
        loadingMsg.innerHTML = '<h3 style="margin: 0 0 10px 0;">‚è≥ Cr√©ation...</h3><p style="margin: 0;">Patientez</p>';
        document.body.appendChild(loadingMsg);
        
        let pptx = new PptxGenJS();
        pptx.author = 'GESTION-BSD-MEPUA';
        pptx.company = 'MEPUA';
        pptx.title = nomBase;
        pptx.layout = 'LAYOUT_16x9';
        
        const canvas = await html2canvas(container, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });
        
        const imageData = canvas.toDataURL('image/png');
        
        let slide1 = pptx.addSlide();
        slide1.background = { fill: '2563eb' };
        slide1.addText(nomBase, { x: 0.5, y: 2, w: 9, h: 1.5, fontSize: 44, bold: true, color: 'FFFFFF', align: 'center' });
        slide1.addText('Gestion D√©partementale - MEPUA', { x: 0.5, y: 3.8, w: 9, h: 0.5, fontSize: 20, color: 'E0E7FF', align: 'center' });
        
        let slide2 = pptx.addSlide();
        slide2.addText('Document', { x: 0.5, y: 0.3, w: 9, h: 0.6, fontSize: 28, bold: true, color: '2563eb' });
        slide2.addImage({ data: imageData, x: 0.5, y: 1, w: 9, h: 4.8 });
        
        await pptx.writeFile({ fileName: nomBase + '.pptx' });
        
        document.body.removeChild(loadingMsg);
        alert('‚úÖ Pr√©sentation cr√©√©e !');
        
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}

function exporterEnTexte(nomBase, contenu) {
    var blob = new Blob([contenu], { type: 'text/plain;charset=utf-8' });
    telechargerBlob(blob, nomBase + '.txt');
}

function exporterEnImage(nomBase, container) {
    if (typeof html2canvas === 'undefined') {
        alert('‚ö†Ô∏è html2canvas non disponible');
        return;
    }
    html2canvas(container, { scale: 2, useCORS: true, allowTaint: true }).then(function(canvas) {
        canvas.toBlob(function(blob) {
            telechargerBlob(blob, nomBase + '.png');
        });
    });
}

function telechargerBlob(blob, nomFichier) {
    var url = window.URL.createObjectURL(blob);
    var link = document.createElement('a');
    link.href = url;
    link.download = nomFichier;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}
// ========== FONCTIONS DE RENDU ANALYSE ==========

function renderAnalyseAcces() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>‚öñÔ∏è Analyse de l\'Acc√®s √âquitable</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}

function renderAnalyseQualite() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>üéì Analyse de la Qualit√©</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}

function renderAnalyseAlphabetisation() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>‚úçÔ∏è Analyse de l\'Alphab√©tisation</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}
function renderAnalyseDecisions() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>üéØ D√©cisions Strat√©giques</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}
        // Lancer l'initialisation
        init();
    </script>
</body>
</html>
   <!-- Variables d'environnement configur√©es --> 




































































    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion D√©partementale - 36 Services</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f9fafb; }
        .header { background-color: #2563eb; color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; }
        .header-right { display: flex; gap: 16px; align-items: center; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-success { background-color: #059669; color: white; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .nav { background-color: white; padding: 0 16px; display: flex; gap: 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav button { padding: 16px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 16px; }
        .nav button.active { border-bottom-color: #2563eb; color: #2563eb; }
        .main { max-width: 1280px; margin: 0 auto; padding: 32px 16px; }
        .cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; margin-top: 32px; }
        .card { padding: 24px; border-radius: 8px; border-left: 4px solid; }
        .card-blue { background-color: #dbeafe; border-color: #2563eb; }
        .card-yellow { background-color: #fef3c7; border-color: #d97706; }
        .card-green { background-color: #d1fae5; border-color: #059669; }
        .card-orange { background-color: #fed7aa; border-color: #ea580c; }
        .card-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        .card-value { font-size: 32px; font-weight: bold; }
        .table-container { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; margin-top: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 16px; border: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; text-align: left; }
        thead.blue th { background-color: #2563eb; color: white; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        tbody tr:hover { background-color: #f3f4f6; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block; }
        .badge-blue { background-color: #dbeafe; }
        .badge-green { background-color: #d1fae5; }
        .badge-purple { background-color: #e9d5ff; }
        .badge-taux { padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: bold; }
        .badge-taux-green { background-color: #d1fae5; color: #065f46; }
        .badge-taux-yellow { background-color: #fef3c7; color: #92400e; }
        .badge-taux-red { background-color: #fee2e2; color: #991b1b; }
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; border-radius: 8px; padding: 32px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .form-control { width: 100%; padding: 8px 16px; border: 1px solid #ccc; border-radius: 8px; }
        .btn-group { display: flex; gap: 8px; justify-content: center; }
        .check-icon { color: #059669; font-size: 20px; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        input[type="checkbox"]:disabled { cursor: not-allowed; opacity: 0.5; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        h2 { font-size: 24px; font-weight: bold; }
        .empty-state { padding: 32px; text-align: center; color: #6b7280; font-size: 18px; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; }
        .alert-info { background-color: #dbeafe; color: #1e40af; }
        .alert-warning { background-color: #fef3c7; color: #92400e; border-left: 4px solid #d97706; }
        .service-badge { display: inline-block; padding: 6px 12px; background-color: #7c3aed; color: white; border-radius: 6px; font-weight: bold; margin-left: 10px; }
        .notif-button { position: relative; padding: 8px 16px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background-color: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
        .notif-panel { position: absolute; top: 60px; right: 16px; width: 450px; max-height: 600px; background-color: white; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); z-index: 100; overflow: hidden; }
        .notif-header { background-color: #7c3aed; color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
        .notif-body { max-height: 500px; overflow-y: auto; }
        .notif-item { padding: 16px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background-color 0.2s; }
        .notif-item:hover { background-color: #f9fafb; }
        .notif-item.unread { background-color: #eff6ff; border-left: 4px solid #2563eb; }
        .notif-type { font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .notif-type.ajout { color: #059669; }
        .notif-type.modification { color: #d97706; }
        .notif-type.rapport { color: #7c3aed; }
        .notif-type.preuve { color: #2563eb; }
        .notif-message { font-size: 14px; margin-bottom: 8px; }
        .notif-meta { font-size: 12px; color: #6b7280; display: flex; justify-content: space-between; align-items: center; }
        .notif-delete { padding: 4px 8px; background-color: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .fichier-item { padding: 8px; background-color: #f3f4f6; border-radius: 4px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .fichier-item:hover { background-color: #e5e7eb; }
    </style>
    <!-- ========== CONNEXION SUPABASE ========== -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://kosqzeueikyehkblqosq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtvc3F6ZXVlaWt5ZWhrYmxxb3NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDU0MTUsImV4cCI6MjA3ODYyMTQxNX0.oGGDuOSb4M-NkJILVSDKfjXyTVqBvnJmWuR46YEEVyQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // ================================================
// SYST√àME DE PERMISSIONS FLEXIBLE
// ================================================

// Cache des permissions (√©vite de recharger √† chaque fois)
var permissionsCache = {};

// Charger les permissions depuis Supabase
async function loadPermissions() {
    try {
        const { data, error } = await supabase
            .from('permissions_config')
            .select('*')
            .eq('enabled', true);
        
        if (error) throw error;
        
        // Organiser par r√¥le/resource/action
        permissionsCache = {};
        for (var i = 0; i < data.length; i++) {
            var perm = data[i];
            var key = perm.role + ':' + perm.resource + ':' + perm.action;
            permissionsCache[key] = {
                enabled: perm.enabled,
                condition: perm.condition ? JSON.parse(perm.condition) : null
            };
        }
        
        console.log('‚úÖ Permissions charg√©es:', Object.keys(permissionsCache).length);
        
    } catch (error) {
        console.error('‚ùå Erreur chargement permissions:', error);
    }
}

// V√©rifier si l'utilisateur a une permission
function hasPermission(resource, action, context) {
    if (!currentUser) return false;
    
    var key = currentUser.role + ':' + resource + ':' + action;
    var perm = permissionsCache[key];
    
    if (!perm || !perm.enabled) {
        return false;
    }
    
    // V√©rifier les conditions suppl√©mentaires
    if (perm.condition && context) {
        if (perm.condition.service === 'own' && context.service !== currentUser.service) {
            return false;
        }
        if (perm.condition.valide === false && context.valide === true) {
            return false;
        }
    }
    
    return true;
}

// Obtenir un message d'erreur personnalis√©
function getPermissionErrorMessage(resource, action) {
    var messages = {
        'activites:create': 'Vous n\'avez pas le droit d\'ajouter des activit√©s',
        'activites:update': 'Vous ne pouvez pas modifier cette activit√©',
        'activites:delete': 'Vous ne pouvez pas supprimer cette activit√©',
        'commentaires:create': 'Vous ne pouvez pas ajouter de commentaires',
        'commentaires:update': 'Vous ne pouvez pas modifier ce commentaire',
        'commentaires:delete': 'Vous ne pouvez pas supprimer ce commentaire'
    };
    
    return messages[resource + ':' + action] || 'Action non autoris√©e';
}

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
</head>
<body>
    <div id="app">Chargement...</div>

    <script>
// ========== DONN√âES DES 36 SERVICES ==========
        

        function generateServices() {
            return [
                'SNEAA', 'SNPUP', 'DRH', 'PRMP', 'DNEP', 'DNCaS', 'SG-E', 'DNAEFP-LN', 
                'SNFCPE', 'DNEF', 'ANAFE', 'DNESGT', 'SNEC', 'SNIES', 'INRAP', 'SMSI', 
                'SNSS', 'CRD', 'IGE', 'SNESU', 'SC', 'DAF', 'BSD', 'DGECS', 'ICESCO', 
                'IRE_CONAKRY', 'IRE_BOKE', 'IRE_KINDIA', 'IRE_MAMOU', 'IRE_LABE', 
                'IRE_FARANAH', 'IRE_KANKAN', 'IRE_NZEREKORE', 'SCRP', 'SLT', 'SA'
            ];
        }

        // ========== VARIABLES GLOBALES ==========
var users = [];
        var services = generateServices();
        var currentUser = null;
        var data = [];
        var commentairesEtPreuves = [];
        var notifications = [];
        var activeTab = 'dashboard';
        var selectedServiceFilter = 'TOUS';
        var activeAnalyseTab = 'acces'; // 'acces' | 'qualite' | 'alphabetisation' | 'decisions'
        var selectedStatusFilter = 'TOUS';
        var selectedObjectifFilter = 'TOUS';
        var selectedTrimestreFilter = 'TOUS';
        var suiviObjectifFilter = 'TOUS';
        var suiviTrimestreFilter = 'TOUS';
        var commentairesServiceFilter = 'TOUS';
        var commentairesObjectifFilter = 'TOUS';
        var showNotifications = false;
        var connectedUsers = [];
        var rapportTextes = {};
        var initialData = [];
        var statistiquesData = [];
        var reussiteExamensData = [];
        var alphabetisationData = [];
        var regionsData = [];
        var prefecturesData = [];
        function calcTaux(item) {
            var checks = 0;
            if (item.tdr) checks++;
            if (item.eng) checks++;
            if (item.mand) checks++;
            if (item.ordo) checks++;
            if (item.liq) checks++;
            if (item.exec) checks++;
            return Math.round((checks / 6) * 100);
        }
async function toggle(activityId, field) {
    var activity = null;
    for (var i = 0; i < data.length; i++) {
        if (data[i].id === activityId) {
            activity = data[i];
            break;
        }
    }
    
    if (!activity) {
        alert('Activit√© introuvable');
        return;
    }
    
    // üî• V√âRIFICATION SIMPLIFI√âE
    if (!canModify(activity)) {
        alert('‚ùå Vous ne pouvez pas modifier cette activit√©');
        return;
    }

    // Inverser la valeur
    var newValue = !activity[field];
    
    console.log('üîÑ Sauvegarde:', field, '=', newValue, 'pour activit√©', activityId);
    
    try {
        // üî• SAUVEGARDER DANS SUPABASE
        var updateObj = {};
        updateObj[field] = newValue;
        updateObj.derniere_maj = new Date().toISOString();
        updateObj.maj_par = currentUser.nom;
        
        const { error } = await supabase
            .from('activites')
            .update(updateObj)
            .eq('id', activityId);
        
        if (error) {
            console.error('‚ùå Erreur Supabase:', error);
            throw error;
        }
        
        console.log('‚úÖ Sauvegarde r√©ussie dans Supabase');
        
        // Mettre √† jour localement
        activity[field] = newValue;
        activity.derniere_maj = new Date().toISOString();
        activity.maj_par = currentUser.nom;
        
        render();
        
    } catch (error) {
        console.error('‚ùå Erreur toggle:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}
        // ========== FONCTIONS DE STOCKAGE SUPABASE ==========
        async function loadData() {
            try {
                // Charger les utilisateurs
                const { data: usersData, error: usersError } = await supabase
                    .from('users')
                    .select('*');
                
                if (usersError) throw usersError;
                
                if (usersData && usersData.length > 0) {
                    users = usersData.map(u => ({
                        id: u.id,
                        user: u.username,
                        pass: u.password,
                        role: u.role,
                        nom: u.nom,
                        service: u.service,
                        actif: u.actif !== false
                    }));
                }
                
                // Charger les activit√©s
                const { data: DataTemp, error: activitesError } = await supabase
                    .from('activites')
                    .select('*');
                
                if (activitesError) throw activitesError;
                
if (DataTemp && DataTemp.length > 0) {
    data = DataTemp;
                } else {
                    data = initialData;
                    await saveData();
                }
                
                // Charger commentaires et preuves
                const { data: commentairesData, error: commentairesError } = await supabase
                    .from('commentaires_preuves')
                    .select('*');
                
                if (commentairesError) throw commentairesError;
                
   if (commentairesData) {
    commentairesEtPreuves = commentairesData.map(c => ({
        id: c.id,
        type: c.type,
        objectif: c.objectif,
        activite: c.activite,
        service: c.service,
        commentaire: c.commentaire,
        nomFichier: c.nom_fichier,
        nomFichierStorage: c.nom_fichier_storage,
        fileUrl: c.file_url,
        // ...
    }));
}

             // Charger les r√©gions
                const { data: regionsDataRaw, error: regionsError } = await supabase
                    .from('regions')
                    .select('*')
                    .order('nom');
                
                if (regionsError) throw regionsError;
                if (regionsDataRaw) regionsData = regionsDataRaw;
                
                // Charger les pr√©fectures
                const { data: prefecturesDataRaw, error: prefecturesError } = await supabase
                    .from('prefectures')
                    .select('*, regions(nom)')
                    .order('nom');
                
                if (prefecturesError) throw prefecturesError;
                if (prefecturesDataRaw) prefecturesData = prefecturesDataRaw;
                
                // Charger les statistiques
                const { data: statistiquesDataRaw, error: statistiquesError } = await supabase
                    .from('statistiques_educatives')
                    .select('*')
                    .order('date_saisie', { ascending: false });
                
                if (statistiquesError) throw statistiquesError;
                if (statistiquesDataRaw) statistiquesData = statistiquesDataRaw;
   // üî• NOUVEAU : Charger R√âUSSITE EXAMENS
const { data: examensDataRaw, error: examensError } = await supabase
    .from('reussite_examens')
    .select('*')
    .order('date_saisie', { ascending: false });

if (examensError) throw examensError;
if (examensDataRaw) reussiteExamensData = examensDataRaw;

// üî• NOUVEAU : Charger ALPHAB√âTISATION
const { data: alphaDataRaw, error: alphaError } = await supabase
    .from('alphabetisation')
    .select('*')
    .order('date_saisie', { ascending: false });

if (alphaError) throw alphaError;
if (alphaDataRaw) alphabetisationData = alphaDataRaw;
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                alert('Erreur de connexion √† la base de donn√©es');
            }
        }

        async function saveData() {
    // CETTE FONCTION NE DEVRAIT PLUS √äTRE UTILIS√âE
    // Les mises √† jour se font directement dans toggle(), validateActivity(), etc.
    console.warn('‚ö†Ô∏è saveData() appel√©e - cette fonction est obsol√®te');
}


        async function saveCommentairesEtPreuves() {
            try {
                // Supprimer tous les commentaires existants
                await supabase.from('commentaires_preuves').delete().neq('id', 0);
                
                // Ins√©rer les nouveaux
const toSave = commentairesEtPreuves.map(c => ({
    id: c.id,
    type: c.type,
    objectif: c.objectif,
    activite: c.activite,
    service: c.service,
    commentaire: c.commentaire || null,
    nom_fichier: c.nomFichier || null,
    nom_fichier_storage: c.nomFichierStorage || null,
    file_url: c.fileUrl || null,
    taille_fichier: c.tailleFichier || null,
    cree_par: c.creePar,
    date_creation: c.dateCreation || new Date().toISOString(),
    depose_par: c.deposePar || null,
    date_depot: c.dateDepot || null,
    modifie_par: c.modifiePar || null,
    date_modification: c.dateModification || null
}));
                if (toSave.length > 0) {
                    const { error } = await supabase.from('commentaires_preuves').insert(toSave);
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur saveCommentaires:', error);
            }
        }

        async function saveUsers() {
            try {
                // Supprimer tous les utilisateurs existants
                await supabase.from('users').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                
                // Ins√©rer les nouveaux utilisateurs
                const usersToSave = users.map(u => ({
                    username: u.user,
                    password: u.pass,
                    role: u.role,
                    nom: u.nom,
                    service: u.service,
                    actif: u.actif !== false
                }));
                
                if (usersToSave.length > 0) {
                    const { error } = await supabase.from('users').insert(usersToSave);
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur saveUsers:', error);
            }
        }

        async function saveRapportTextes() {
            try {
                if (!currentUser) return;
                
                // Pour chaque cl√© dans rapportTextes, faire un upsert
                for (var key in rapportTextes) {
                    const { error } = await supabase
                        .from('rapport_textes')
                        .upsert({
                            user_key: currentUser.user,
                            cle: key,
                            valeur: rapportTextes[key],
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_key,cle'
                        });
                    
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur saveRapportTextes:', error);
            }
        }

        async function loadRapportTextes() {
            try {
                if (!currentUser) return;
                
                const { data: textes, error } = await supabase
                    .from('rapport_textes')
                    .select('*')
                    .eq('user_key', currentUser.user);
                
                if (error) throw error;
                
                rapportTextes = {};
                if (textes) {
                    for (var i = 0; i < textes.length; i++) {
                        rapportTextes[textes[i].cle] = textes[i].valeur;
                    }
                }
            } catch (error) {
                console.error('Erreur loadRapportTextes:', error);
            }
        }
// ========== FONCTIONS UTILITAIRES ==========
        function canModify(activity) {
            if (!currentUser) return false;
            if (currentUser.role === 'chefdept') return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.role === 'chef' && activity.service === currentUser.service) return true;
            return false;
        }

        function canValidate(activity) {
            return currentUser && currentUser.role === 'admin';
        }

        function canDeleteInPlanning(activity) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.role === 'chef' && activity.service === currentUser.service) return !activity.valide;
            return false;
        }

        // ========== FONCTIONS DE NAVIGATION ==========
async function login(username, password) {
    try {
        // Rechercher l'utilisateur dans Supabase
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .eq('password', password)
            .single();
        
        if (error || !user) {
            alert('Identifiants incorrects');
            return;
        }
        
        if (user.actif === false) {
            alert('Ce compte est d√©sactiv√©');
            return;
        }
        
        // Connexion r√©ussie
        currentUser = {
            id: user.id,
            user: user.username,
            pass: user.password,
            role: user.role,
            nom: user.nom,
            service: user.service,
            actif: user.actif
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        await loadRapportTextes();
        
        var alreadyConnected = false;
        for (var i = 0; i < connectedUsers.length; i++) {
            if (connectedUsers[i].user === currentUser.user) {
                alreadyConnected = true;
                connectedUsers[i].connectedAt = new Date().toLocaleString('fr-FR');
                break;
            }
        }
        if (!alreadyConnected) {
            connectedUsers.push({
                user: currentUser.user,
                nom: currentUser.nom,
                service: currentUser.service,
                connectedAt: new Date().toLocaleString('fr-FR')
            });
        }
        localStorage.setItem('connectedUsers', JSON.stringify(connectedUsers));
        
        // V√©rifier si c'est un mot de passe provisoire
        if (!user.password_changed && user.password === 'TempMepua@2024!') {
            render();
            setTimeout(function() {
                showChangePasswordModal();
            }, 500);
        } else {
            render();
        }
    } catch (error) {
        console.error('Erreur login:', error);
        alert('Erreur de connexion');
    }
}
function showChangePasswordModal() {
    var modalContainer = document.getElementById('modal-container');
    var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">üîí Changement de mot de passe</h2>';
    
    html += '<div class="alert alert-warning">Vous utilisez un mot de passe provisoire. Veuillez le changer maintenant.</div>';
    
    html += '<div class="form-group"><label>Ancien mot de passe</label><input type="password" id="old-password" class="form-control"></div>';
    html += '<div class="form-group"><label>Nouveau mot de passe</label><input type="password" id="new-password" class="form-control"></div>';
    html += '<div class="form-group"><label>Confirmer le nouveau mot de passe</label><input type="password" id="confirm-password" class="form-control"></div>';
    
    html += '<div class="btn-group"><button class="btn btn-primary" onclick="submitChangePassword()">Changer le mot de passe</button></div>';
    html += '</div></div>';
    
    modalContainer.innerHTML = html;
}

async function submitChangePassword() {
    var oldPassword = document.getElementById('old-password').value;
    var newPassword = document.getElementById('new-password').value;
    var confirmPassword = document.getElementById('confirm-password').value;
    
    if (!oldPassword || !newPassword || !confirmPassword) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    if (oldPassword !== currentUser.pass) {
        alert('Ancien mot de passe incorrect');
        return;
    }
    
    if (newPassword.length < 8) {
        alert('Le nouveau mot de passe doit contenir au moins 8 caract√®res');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('Les mots de passe ne correspondent pas');
        return;
    }
    
    try {
        // Mettre √† jour le mot de passe dans Supabase
        const { error } = await supabase
            .from('users')
            .update({ password: newPassword, password_changed: true })
            .eq('id', currentUser.id);
        
        if (error) throw error;
        
        currentUser.pass = newPassword;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        alert('Mot de passe chang√© avec succ√®s !');
        closeModal();
    } catch (error) {
        console.error('Erreur changement mot de passe:', error);
        alert('Erreur lors du changement de mot de passe');
    }
}
        function logout() {
            if (currentUser) {
                var newConnectedUsers = [];
                for (var i = 0; i < connectedUsers.length; i++) {
                    if (connectedUsers[i].user !== currentUser.user) {
                        newConnectedUsers.push(connectedUsers[i]);
                    }
                }
                connectedUsers = newConnectedUsers;
                localStorage.setItem('connectedUsers', JSON.stringify(connectedUsers));
            }
            
            localStorage.removeItem('currentUser');
            currentUser = null;
            render();
        }

        function changeTab(tab) {
            activeTab = tab;
            render();
        }
        function changeAnalyseTab(subTab) {
    activeAnalyseTab = subTab;
    render();
}
        async function attemptLogin() {
            var username = document.getElementById('username').value.trim();
            var password = document.getElementById('password').value;
            await login(username, password);
        }

        function changeServiceFilter(service) {
            selectedServiceFilter = service;
            render();
        }
// ========== INSCRIPTION PAR INVITATION ==========
async function submitSignupWithInvitation() {
    var email = document.getElementById('signup-email').value.trim();
    var password = document.getElementById('signup-password').value;
    var confirmPassword = document.getElementById('signup-confirm-password').value;
    
    if (!email || !password || !confirmPassword) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    if (password.length < 8) {
        alert('Le mot de passe doit contenir au moins 8 caract√®res');
        return;
    }
    
    if (password !== confirmPassword) {
        alert('Les mots de passe ne correspondent pas');
        return;
    }
    
    // V√©rifier si l'email existe d√©j√†
    const { data: existingUsers, error: checkError } = await supabase
        .from('users')
        .select('*')
        .eq('username', invitationData.username);
    
    if (checkError) {
        alert('Erreur lors de la v√©rification');
        return;
    }
    
    if (existingUsers && existingUsers.length > 0) {
        alert('Ce nom d\'utilisateur existe d√©j√†');
        return;
    }
    
    try {
        // Cr√©er le compte dans la table users
        const { error: insertError } = await supabase
            .from('users')
            .insert({
                username: invitationData.username,
                password: password,
                role: 'chef',
                nom: invitationData.username,
                service: invitationData.username.split('.')[0],
                actif: true,
                email: email,
            });
        
        if (insertError) throw insertError;
        
        // Marquer l'invitation comme accept√©e
        const { error: updateError } = await supabase
            .from('invitations')
            .update({
                status: 'accepted',
                email: email,
                used_at: new Date().toISOString()
            })
            .eq('id', invitationData.id);
        
        if (updateError) throw updateError;
        
        alert('‚úÖ Compte cr√©√© avec succ√®s ! Vous pouvez maintenant vous connecter.');
        
        // Rediriger vers la page de connexion
        window.location.href = window.location.pathname;
        
    } catch (error) {
        console.error('Erreur cr√©ation compte:', error);
        alert('Erreur lors de la cr√©ation du compte');
    }
}

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // ========== FONCTIONS DE FILTRAGE ==========
        function changeStatusFilter(status) {
            selectedStatusFilter = status;
            render();
        }

        function changeDashboardObjectifFilter(objectif) {
            selectedObjectifFilter = objectif;
            render();
        }

        function changeDashboardTrimestreFilter(trimestre) {
            selectedTrimestreFilter = trimestre;
            render();
        }

        function getFilteredDataForDashboard() {
            if (!currentUser) return [];
            
            var baseData = [];
            for (var i = 0; i < data.length; i++) {
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    if (data[i].valide) baseData.push(data[i]);
                } else {
                    if (data[i].service === currentUser.service && data[i].valide) {
                        baseData.push(data[i]);
                    }
                }
            }
            
            if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && selectedServiceFilter !== 'TOUS') {
                var filtered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].service === selectedServiceFilter) filtered.push(baseData[i]);
                }
                baseData = filtered;
            }
            
            if (selectedStatusFilter !== 'TOUS') {
                var statusFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    var taux = calcTaux(baseData[i]);
                    var status = taux === 100 ? 'Ex√©cut√©e' : taux > 0 ? 'En cours' : 'Non commenc√©e';
                    if (status === selectedStatusFilter) {
                        statusFiltered.push(baseData[i]);
                    }
                }
                baseData = statusFiltered;
            }
            
            if (selectedObjectifFilter !== 'TOUS') {
                var objectifFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].categorie === selectedObjectifFilter) {
                        objectifFiltered.push(baseData[i]);
                    }
                }
                baseData = objectifFiltered;
            }
            
            if (selectedTrimestreFilter !== 'TOUS') {
                var trimestreFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    var programmee = false;
                    if (selectedTrimestreFilter === 'T1' && baseData[i].t1) programmee = true;
                    else if (selectedTrimestreFilter === 'T2' && (baseData[i].t1 || baseData[i].t2)) programmee = true;
                    else if (selectedTrimestreFilter === 'T3' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3)) programmee = true;
                    else if (selectedTrimestreFilter === 'T4' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3 || baseData[i].t4)) programmee = true;
                    if (programmee) trimestreFiltered.push(baseData[i]);
                }
                baseData = trimestreFiltered;
            }
            
            return baseData;
        }

        function getFilteredDataForPlanning() {
            if (!currentUser) return [];
            
            var baseData = [];
            if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                baseData = data;
            } else {
                for (var i = 0; i < data.length; i++) {
                    if (data[i].service === currentUser.service && !data[i].valide) {
                        baseData.push(data[i]);
                    }
                }
            }
            
            if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && selectedServiceFilter !== 'TOUS') {
                var filtered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].service === selectedServiceFilter) filtered.push(baseData[i]);
                }
                return filtered;
            }
            
            return baseData;
        }
       async function validateActivity(activityId) {
    if (!canValidate()) {
        alert('Seul l\'administrateur peut valider');
        return;
    }
    
    if (confirm('Valider cette activit√©?')) {
        try {
            const { error } = await supabase
                .from('activites')
                .update({
                    valide: true,
                    valide_par: currentUser.nom,
                    date_validation: new Date().toISOString()
                })
                .eq('id', activityId);
            
            if (error) throw error;
            
            // Mettre √† jour localement
            for (var i = 0; i < data.length; i++) {
                if (data[i].id === activityId) {
                    data[i].valide = true;
                    data[i].valide_par = currentUser.nom;
                    data[i].date_validation = new Date().toISOString();
                    break;
                }
            }
            
            render();
        } catch (error) {
            console.error('Erreur validation:', error);
            alert('‚ùå Erreur lors de la validation');
        }
    }
}
async function deleteActivity(activityId) {
    var activity = null;
    for (var i = 0; i < data.length; i++) {
        if (data[i].id === activityId) {
            activity = data[i];
            break;
        }
    }
    
    if (!activity) {
        alert('Activit√© introuvable');
        return;
    }
    
    // üî• V√âRIFICATION SIMPLIFI√âE
    if (!canDeleteInPlanning(activity)) {
        alert('‚ùå Vous ne pouvez pas supprimer cette activit√©');
        return;
    }

    if (confirm('Supprimer cette activit√©?')) {
        try {
            const { error } = await supabase
                .from('activites')
                .delete()
                .eq('id', activityId);
            
            if (error) throw error;
            
            // Mettre √† jour localement
            var newData = [];
            for (var i = 0; i < data.length; i++) {
                if (data[i].id !== activityId) newData.push(data[i]);
            }
            data = newData;
            
            render();
        } catch (error) {
            console.error('Erreur suppression:', error);
            alert('‚ùå Erreur lors de la suppression');
        }
    }
}
        function showAddModal() {
            var modalContainer = document.getElementById('modal-container');
            var defaultService = currentUser.role === 'chef' ? currentUser.service : services[0];
            
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">Ajouter une activit√©</h2>';
            
            if (currentUser.role === 'chef') {
                html += '<div class="alert alert-warning">Vous ne pouvez ajouter que pour votre service: <strong>' + currentUser.service + '</strong></div>';
            }
            
            html += '<div class="form-group"><label>Objectif</label><select id="new-categorie" class="form-control"><option>Objectifs G√©n√©raux</option><option>Objectifs de R√©forme</option><option>Objectifs Sp√©cifiques</option><option>D√©cisions du CM</option><option>D√©cisions du PR</option></select></div>';
            html += '<div class="form-group"><label>Activit√©</label><textarea id="new-activite" class="form-control" rows="3"></textarea></div>';
            html += '<div class="form-group"><label>Service</label>';
            
            if (currentUser.role === 'chef') {
                html += '<input type="text" class="form-control" value="' + currentUser.service + '" disabled><input type="hidden" id="new-service" value="' + currentUser.service + '">';
            } else {
                html += '<select id="new-service" class="form-control">';
                for (var i = 0; i < services.length; i++) {
                    var selected = services[i] === defaultService ? ' selected' : '';
                    html += '<option value="' + services[i] + '"' + selected + '>' + services[i] + '</option>';
                }
                html += '</select>';
            }
            
            html += '</div><div class="btn-group"><button class="btn btn-primary" onclick="submitNewActivity()">Ajouter</button><button class="btn btn-secondary" onclick="closeModal()">Annuler</button></div></div></div>';
            
            modalContainer.innerHTML = html;
        }

        async function submitNewActivity() {
    var activite = document.getElementById('new-activite').value.trim();
    var service = document.getElementById('new-service').value; // üî• D√âPLACER ICI
    
    // üî• V√âRIFICATION SIMPLIFI√âE
    if (currentUser.role === 'chef' && service !== currentUser.service) {
        alert('‚ùå Vous ne pouvez ajouter que pour votre service');
        return;
    }
 
    if (!activite) {
        alert('Veuillez remplir l\'activit√©');
        return;
    }

    var newActivity = {
        categorie: document.getElementById('new-categorie').value,
        activite: activite,
        service: service,
        t1: false, t2: false, t3: false, t4: false,
        tdr: false, eng: false, mand: false, ordo: false, liq: false, exec: false,
        valide: false,
        valide_par: null,
        date_validation: null,
        derniere_maj: new Date().toISOString(),
        maj_par: currentUser.nom
    };
    
    // Ins√©rer DIRECTEMENT dans Supabase
    try {
        const { data: insertedData, error } = await supabase
            .from('activites')
            .insert([newActivity])
            .select();
        
        if (error) throw error;
        
        // Ajouter l'activit√© avec son ID g√©n√©r√© au tableau local
        if (insertedData && insertedData.length > 0) {
            data.push(insertedData[0]);
        }
        
        alert('‚úÖ Activit√© ajout√©e avec succ√®s !');
        closeModal();
        render();
    } catch (error) {
        console.error('Erreur ajout activit√©:', error);
        alert('‚ùå Erreur lors de l\'ajout de l\'activit√©');
    }
}
        function getFilteredDataForSuivi() {
            if (!currentUser) return [];
            
            var baseData = [];
            for (var i = 0; i < data.length; i++) {
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    if (data[i].valide) baseData.push(data[i]);
                } else {
                    if (data[i].service === currentUser.service && data[i].valide) {
                        baseData.push(data[i]);
                    }
                }
            }
            
            if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && selectedServiceFilter !== 'TOUS') {
                var filtered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].service === selectedServiceFilter) filtered.push(baseData[i]);
                }
                baseData = filtered;
            }
            
            if (suiviObjectifFilter !== 'TOUS') {
                var objectifFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].categorie === suiviObjectifFilter) {
                        objectifFiltered.push(baseData[i]);
                    }
                }
                baseData = objectifFiltered;
            }
            
            if (suiviTrimestreFilter !== 'TOUS') {
                var trimestreFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    var programmee = false;
                    if (suiviTrimestreFilter === 'T1' && baseData[i].t1) programmee = true;
                    else if (suiviTrimestreFilter === 'T2' && (baseData[i].t1 || baseData[i].t2)) programmee = true;
                    else if (suiviTrimestreFilter === 'T3' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3)) programmee = true;
                    else if (suiviTrimestreFilter === 'T4' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3 || baseData[i].t4)) programmee = true;
                    if (programmee) trimestreFiltered.push(baseData[i]);
                }
                baseData = trimestreFiltered;
            }
            
            return baseData;
        }

        function changeCommentairesServiceFilter(service) {
            commentairesServiceFilter = service;
            render();
        }

        function changeCommentairesObjectifFilter(objectif) {
            commentairesObjectifFilter = objectif;
            render();
        }

        function updateActiviteSelection() {
            var activiteSelect = document.getElementById('combined-activite');
            var objectifDisplay = document.getElementById('objectif-display');
            var serviceSelect = document.getElementById('combined-service');
            var serviceHidden = document.getElementById('combined-service-hidden');
            
            if (!activiteSelect || !objectifDisplay) return;
            
            var selectedOption = activiteSelect.options[activiteSelect.selectedIndex];
            var objectif = selectedOption.getAttribute('data-objectif');
            var service = selectedOption.getAttribute('data-service');
            
            if (objectif) {
                objectifDisplay.textContent = objectif;
                objectifDisplay.style.color = '#2563eb';
                objectifDisplay.style.fontWeight = 'bold';
            } else {
                objectifDisplay.textContent = '-';
            }
            
            if (service) {
                if (serviceSelect) serviceSelect.value = service;
                if (serviceHidden) serviceHidden.value = service;
            }
        }

        function showCommentaireEtPreuveModal() {
    var modalContainer = document.getElementById('modal-container');
    
    var html = '<div class="modal"><div class="modal-content" style="max-width: 700px;">';
    html += '<h2 style="margin-bottom: 24px;">üìã D√©poser une preuve et/ou commenter</h2>';
    
    html += '<div class="form-group"><label>Objectif *</label><select id="preuve-objectif" class="form-control" onchange="updatePreuveActivites()"><option value="">S√©lectionnez...</option>';
    
    var objectifs = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques', 'D√©cisions du CM', 'D√©cisions du PR'];
    for (var i = 0; i < objectifs.length; i++) {
        html += '<option>' + objectifs[i] + '</option>';
    }
    html += '</select></div>';
    
    html += '<div class="form-group"><label>Activit√© *</label><select id="preuve-activite" class="form-control"><option value="">S√©lectionnez d\'abord un objectif</option></select></div>';
    
    html += '<div class="form-group"><label>Commentaire (optionnel)</label><textarea id="preuve-commentaire" class="form-control" rows="4" placeholder="Ajoutez un commentaire..."></textarea></div>';
    
    html += '<div class="form-group"><label>Document de preuve (optionnel)</label>';
    html += '<input type="file" id="preuve-fichier" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.txt">';
    html += '<small style="color: #6b7280; display: block; margin-top: 4px;">Formats accept√©s : PDF, Word, Excel, PowerPoint, Images, Texte</small>';
    html += '</div>';
    
    html += '<div style="display: flex; gap: 10px; margin-top: 24px;">';
    html += '<button class="btn btn-primary" onclick="submitCommentaireEtPreuve()">üíæ Enregistrer</button>';
    html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
    html += '</div>';
    
    html += '</div></div>';
    
    modalContainer.innerHTML = html;
}

       async function submitCommentaireEtPreuve() {
    var objectif = document.getElementById('preuve-objectif').value;
    var activiteSelect = document.getElementById('preuve-activite');
    var activite = activiteSelect.value;
    var commentaire = document.getElementById('preuve-commentaire').value.trim();
    var fichierInput = document.getElementById('preuve-fichier');
    var fichier = fichierInput && fichierInput.files.length > 0 ? fichierInput.files[0] : null;
    
    if (!objectif || !activite) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner un objectif et une activit√©');
        return;
    }
    
    if (!commentaire && !fichier) {
        alert('‚ö†Ô∏è Veuillez ajouter au moins un commentaire OU un document');
        return;
    }
    
    var selectedOption = activiteSelect.options[activiteSelect.selectedIndex];
    var service = selectedOption.getAttribute('data-service') || currentUser.service;
    
    try {
        var dataToInsert = [];
        
        // üî• COMMENTAIRE
        if (commentaire) {
            dataToInsert.push({
                type: 'commentaire',
                objectif: objectif,
                activite: activite,
                service: service,
                commentaire: commentaire,
                cree_par: currentUser.nom,
                date_creation: new Date().toISOString(),
                depose_par: currentUser.nom,
                date_depot: new Date().toISOString()
            });
        }
        
        // üî• FICHIER
        if (fichier) {
            console.log('üì§ Upload du fichier:', fichier.name);
            
            var timestamp = Date.now();
            var extension = fichier.name.split('.').pop();
            var nomUnique = 'preuve_' + timestamp + '_' + service.replace(/\s+/g, '_') + '.' + extension;
            
            // Upload dans Supabase Storage
            const { data: uploadData, error: uploadError } = await supabase
                .storage
                .from('preuves_documents')
                .upload(nomUnique, fichier, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (uploadError) {
                console.error('‚ùå Erreur upload:', uploadError);
                throw uploadError;
            }
            
            // R√©cup√©rer l'URL publique
            const { data: urlData } = await supabase
                .storage
                .from('preuves_documents')
                .getPublicUrl(nomUnique);
            
            var fileUrl = urlData ? urlData.publicUrl : null;
            
            if (!fileUrl) {
                throw new Error('Impossible de g√©n√©rer l\'URL du fichier');
            }
            
            console.log('‚úÖ Fichier upload√©, URL:', fileUrl);
            
            dataToInsert.push({
                type: 'preuve',
                objectif: objectif,
                activite: activite,
                service: service,
                nom_fichier: fichier.name,
                nom_fichier_storage: nomUnique,
                file_url: fileUrl,
                taille_fichier: Math.round(fichier.size / 1024) + ' Ko',
                cree_par: currentUser.nom,
                date_creation: new Date().toISOString(),
                depose_par: currentUser.nom,
                date_depot: new Date().toISOString()
            });
        }
        
        // üî• INS√âRER DANS SUPABASE
        if (dataToInsert.length > 0) {
            const { data: insertData, error: insertError } = await supabase
                .from('commentaires_preuves')
                .insert(dataToInsert)
                .select();
            
            if (insertError) {
                console.error('‚ùå Erreur insertion:', insertError);
                throw insertError;
            }
            
            console.log('‚úÖ Donn√©es ins√©r√©es:', insertData);
            
            // Ajouter aux donn√©es locales
            if (insertData) {
                for (var i = 0; i < insertData.length; i++) {
                    commentairesEtPreuves.push(insertData[i]);
                }
            }
        }
        
        alert('‚úÖ Enregistrement r√©ussi !');
        closeModal();
        render();
        
    } catch (error) {
        console.error('‚ùå Erreur compl√®te:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}

        function showEditCommentaireModal(id) {
            var item = null;
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id === id) {
                    item = commentairesEtPreuves[i];
                    break;
                }
            }
            
            if (!item || item.type !== 'commentaire') return;
            
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">‚úèÔ∏è Modifier le commentaire</h2>';
            
            html += '<div class="form-group"><label>Objectif</label><div style="padding: 8px 16px; background-color: #f3f4f6; border-radius: 8px;">' + item.objectif + '</div></div>';
            html += '<div class="form-group"><label>Activit√©</label><div style="padding: 8px 16px; background-color: #f3f4f6; border-radius: 8px;">' + item.activite + '</div></div>';
            html += '<div class="form-group"><label>Commentaire *</label><textarea id="edit-commentaire" class="form-control" rows="4">' + item.commentaire + '</textarea></div>';
            
            html += '<div class="btn-group"><button class="btn btn-primary" onclick="submitEditCommentaire(' + id + ')">Enregistrer</button><button class="btn btn-secondary" onclick="closeModal()">Annuler</button></div></div></div>';
            
            modalContainer.innerHTML = html;
        }

        async function submitEditCommentaire(id) {
            var newCommentaire = document.getElementById('edit-commentaire').value.trim();
            
            if (!newCommentaire) {
                alert('Le commentaire ne peut pas √™tre vide');
                return;
            }
            
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id === id) {
                    commentairesEtPreuves[i].commentaire = newCommentaire;
                    commentairesEtPreuves[i].modifiePar = currentUser.nom;
                    commentairesEtPreuves[i].dateModification = new Date().toLocaleString('fr-FR');
                    break;
                }
            }
            
            await saveCommentairesEtPreuves();
            closeModal();
            render();
        }

        function showManagePreuvesModal(activite, service) {
            var modalContainer = document.getElementById('modal-container');
            
            var preuvesActivite = [];
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                var item = commentairesEtPreuves[i];
                if (item.type === 'preuve' && item.activite === activite && item.service === service) {
                    preuvesActivite.push(item);
                }
            }
            
                            var html = '<div class="modal"><div class="modal-content" style="max-width: 900px;"><h2 style="margin-bottom: 16px;">üìé G√©rer les preuves</h2>';
            
            html += '<div style="background-color: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 16px;"><strong>Activit√©:</strong> ' + activite + '<br/><strong>Service:</strong> ' + service + '</div>';
            
            html += '<h3 style="margin-bottom: 12px;">Documents d√©pos√©s</h3>';
            
            if (preuvesActivite.length > 0) {
                for (var i = 0; i < preuvesActivite.length; i++) {
                    var p = preuvesActivite[i];
                    html += '<div class="fichier-item"><div><strong>üìÑ ' + p.nomFichier + '</strong><br/><small style="color: #6b7280;">D√©pos√© par ' + p.deposePar + ' le ' + p.dateDepot + '</small></div><button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deletePreuve(' + p.id + ')">Supprimer</button></div>';
                }
            } else {
                html += '<p style="text-align: center; padding: 16px; color: #6b7280;">Aucune preuve</p>';
            }
            
            html += '<h3 style="margin-top: 24px; margin-bottom: 12px;">Ajouter nouvelles preuves</h3>';
            html += '<div class="form-group"><input type="file" id="new-preuves-fichiers" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple style="padding: 4px 8px;"></div>';
            
            html += '<div class="btn-group"><button class="btn btn-success" onclick="ajouterNouvellesPreuves(\'' + activite.replace(/'/g, "\\'") + '\', \'' + service + '\')">Ajouter</button><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div></div></div>';
            
            modalContainer.innerHTML = html;
        }

        async function ajouterNouvellesPreuves(activite, service) {
            var fichiersInput = document.getElementById('new-preuves-fichiers');
            
            if (!fichiersInput.files || fichiersInput.files.length === 0) {
                alert('Veuillez s√©lectionner au moins un fichier');
                return;
            }
            
            var maxId = 0;
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id > maxId) maxId = commentairesEtPreuves[i].id;
            }
            
            var activiteData = null;
            for (var i = 0; i < data.length; i++) {
                if (data[i].activite === activite && data[i].service === service) {
                    activiteData = data[i];
                    break;
                }
            }
            
            var objectif = activiteData ? activiteData.categorie : '';
            
            for (var i = 0; i < fichiersInput.files.length; i++) {
                var fichier = fichiersInput.files[i];
                commentairesEtPreuves.push({
                    id: maxId + 1 + i,
                    type: 'preuve',
                    objectif: objectif,
                    activite: activite,
                    service: service,
                    nomFichier: fichier.name,
                    tailleFichier: Math.round(fichier.size / 1024) + ' Ko',
                    deposePar: currentUser.nom,
                    dateDepot: new Date().toLocaleString('fr-FR')
                });
            }
            
            await saveCommentairesEtPreuves();
            alert('Fichiers ajout√©s');
            showManagePreuvesModal(activite, service);
        }

        async function deletePreuve(id) {
            if (!confirm('Supprimer cette preuve ?')) return;
            
            var newItems = [];
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id !== id) newItems.push(commentairesEtPreuves[i]);
            }
            commentairesEtPreuves = newItems;
            await saveCommentairesEtPreuves();
            closeModal();
            render();
        }

        async function deleteCommentaireOuPreuve(id) {
            if (confirm('Supprimer cet √©l√©ment?')) {
                var newItems = [];
                for (var i = 0; i < commentairesEtPreuves.length; i++) {
                    if (commentairesEtPreuves[i].id !== id) newItems.push(commentairesEtPreuves[i]);
                }
                commentairesEtPreuves = newItems;
                await saveCommentairesEtPreuves();
                render();
            }
        }
function exporterRapportWord() {
            var isGlobal = currentUser.role === 'chefdept' || (currentUser.role === 'admin' && selectedServiceFilter === 'TOUS');
            var serviceRapport = currentUser.role === 'chef' ? currentUser.service : (isGlobal ? null : selectedServiceFilter);
            
            var statsObjectifs = calculerStatsObjectifs(serviceRapport);
            var statsDecisions = calculerStatsDecisions(serviceRapport);
            
            var totalPlanifieesObj = 0, totalRealiseesObj = 0;
            for (var i = 0; i < statsObjectifs.length; i++) {
                totalPlanifieesObj += statsObjectifs[i].planifiees;
                totalRealiseesObj += statsObjectifs[i].realisees;
            }
            var tauxTotalObj = totalPlanifieesObj > 0 ? Math.round((totalRealiseesObj / totalPlanifieesObj) * 100) : 0;
            
            var totalPlanifieesDec = 0, totalRealiseesDec = 0;
            for (var i = 0; i < statsDecisions.length; i++) {
                totalPlanifieesDec += statsDecisions[i].planifiees;
                totalRealiseesDec += statsDecisions[i].realisees;
            }
            var tauxTotalDec = totalPlanifieesDec > 0 ? Math.round((totalRealiseesDec / totalPlanifieesDec) * 100) : 0;
            
            var tauxGlobalTotal = (totalPlanifieesObj + totalPlanifieesDec) > 0 ? Math.round(((totalRealiseesObj + totalRealiseesDec) / (totalPlanifieesObj + totalPlanifieesDec)) * 100) : 0;
            
            // R√©cup√©rer les textes
            var contexteKey = 'contexte_' + (serviceRapport || 'global');
            var contexteValue = rapportTextes[contexteKey] || 'Non renseign√©';
            var rappelKey = 'rappel_' + (serviceRapport || 'global');
            var rappelValue = rapportTextes[rappelKey] || 'Non renseign√©';
            var rappelDecKey = 'rappelDec_' + (serviceRapport || 'global');
            var rappelDecValue = rapportTextes[rappelDecKey] || 'Non renseign√©';
            var diffKey = 'difficultes_' + (serviceRapport || 'global');
            var diffValue = rapportTextes[diffKey] || 'Non renseign√©';
            var pistesKey = 'pistes_' + (serviceRapport || 'global');
            var pistesValue = rapportTextes[pistesKey] || 'Non renseign√©';
            
            var html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/1999/xhtml">';
            html += '<head><meta charset="utf-8"><title>Rapport de Performance</title>';
            html += '<style>';
            html += 'body { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; line-height: 1.6; margin: 1cm; }';
            html += 'h1 { color: #2563eb; text-align: center; font-size: 20pt; font-weight: bold; margin-bottom: 20px; }';
            html += 'h2 { color: #2563eb; font-size: 14pt; font-weight: bold; margin-top: 30px; margin-bottom: 15px; }';
            html += 'h3 { color: #4b5563; font-size: 14pt; margin-top: 20px; margin-bottom: 12px; font-weight: bold; }';
            html += 'p { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; margin: 10px 0; text-align: justify; line-height: 1.6; }';
            html += 'table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12pt; }';
            html += 'th, td { border: 1px solid #000; padding: 4px 8px; height: 18px; }';
            html += 'th { background-color: #2563eb; color: white; font-weight: bold; text-align: center; }';
            html += 'td { text-align: center; }';
            html += 'td:first-child { text-align: left; font-weight: bold; }';
            html += 'tr.total { background-color: #e5e7eb; font-weight: bold; }';
            html += '.graph-space { margin: 30px 0; padding: 60px 20px; text-align: center; }';
            html += '.graph-title { font-family: "Century Gothic", Arial, sans-serif; font-size: 14pt; font-weight: bold; color: #4b5563; margin-bottom: 10px; }';
            html += '.graph-instruction { font-family: "Century Gothic", Arial, sans-serif; font-size: 11pt; color: #6b7280; font-style: italic; }';
            html += 'ul { margin: 15px 0; padding: 0; list-style-type: none !important; }';
            html += 'li { margin-bottom: 12px; padding: 0; list-style-type: none !important; list-style: none !important; }';
            html += 'li .activite-titre { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; font-weight: bold; display: block; margin-bottom: 4px; }';
            html += 'li .commentaire { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; display: block; text-align: justify; font-style: italic; color: #000; margin-left: 0; line-height: 1.6; }';
            html += '</style></head><body>';
            
            var titreRapport = isGlobal ? 'RAPPORT DE PERFORMANCE GLOBAL' : 'RAPPORT DE PERFORMANCE - ' + (serviceRapport || 'SERVICE');
            html += '<h1>' + titreRapport + '</h1>';
            html += '<p style="text-align: center; color: #6b7280; margin-bottom: 30px;">Ann√©e 2026 - G√©n√©r√© le ' + new Date().toLocaleString('fr-FR') + '</p>';
            
            // SECTION 1
            html += '<h2>1. √âl√©ments de contexte</h2>';
            html += '<p>' + contexteValue.replace(/\n/g, '<br/>') + '</p>';
            
            // SECTION 2
            html += '<h2>2. Bilan des r√©alisations des objectifs</h2>';
            html += '<h3>Rappel des actions programm√©es</h3>';
            html += '<p>' + rappelValue.replace(/\n/g, '<br/>') + '</p>';
            
            // TABLEAU 1 - COMPLET
            html += '<h3>Tableau 1 : Taux par objectif</h3>';
            html += '<table><thead><tr><th>Objectifs</th><th>Planifi√©es</th><th>R√©alis√©es</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.planifiees + '</td><td>' + stat.realisees + '</td><td><strong>' + stat.taux + '</strong></td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + totalPlanifieesObj + '</td><td>' + totalRealiseesObj + '</td><td><strong>' + tauxTotalObj + '</strong></td></tr>';
            html += '</tbody></table>';
            
            // ESPACE GRAPHIQUE 1
            html += '<div class="graph-space">';
            html += '<div class="graph-title">Graphique 1 : Taux par objectif</div>';
            html += '<div class="graph-instruction">[Ins√©rer ici le graphique]</div>';
            html += '</div>';
            
            // LISTES DES ACTIVIT√âS
            var objectifsList = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques'];
            for (var j = 0; j < objectifsList.length; j++) {
                var objNom = objectifsList[j];
                var activitesObj = getActivitesRealisees(serviceRapport, objNom);
                html += '<h3>' + objNom + '</h3>';
                if (activitesObj.length > 0) {
                    html += '<ul>';
                    for (var k = 0; k < activitesObj.length; k++) {
                        var act = activitesObj[k];
                        html += '<li>';
                        html += '<div class="activite-titre">' + act.activite + ' :</div>';
                        var commentaire = getCommentaireForActivite(act.activite, act.service);
                        if (commentaire) {
                            html += '<div class="commentaire">' + commentaire + '</div>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p style="color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e √† 100%.</p>';
                }
            }
            
            // SECTION 3
            html += '<h2>3. Bilan d\'ex√©cution des D√©cisions du PR et des CM</h2>';
            html += '<h3>Rappel des d√©cisions</h3>';
            html += '<p>' + rappelDecValue.replace(/\n/g, '<br/>') + '</p>';
            
            // TABLEAU 2 - COMPLET
            html += '<h3>Tableau 2 : Taux par d√©cision</h3>';
            html += '<table><thead><tr><th>D√©cisions</th><th>Planifi√©es</th><th>R√©alis√©es</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsDecisions.length; i++) {
                var stat = statsDecisions[i];
                html += '<tr><td>' + stat.decision + '</td><td>' + stat.planifiees + '</td><td>' + stat.realisees + '</td><td><strong>' + stat.taux + '</strong></td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + totalPlanifieesDec + '</td><td>' + totalRealiseesDec + '</td><td><strong>' + tauxTotalDec + '</strong></td></tr>';
            html += '</tbody></table>';
            
            // ESPACE GRAPHIQUE 2
            html += '<div class="graph-space">';
            html += '<div class="graph-title">Graphique 2 : Taux par d√©cision</div>';
            html += '<div class="graph-instruction">[Ins√©rer ici le graphique]</div>';
            html += '</div>';
            
            // LISTES DES D√âCISIONS
            var decisionsPR = getActivitesRealisees(serviceRapport, 'D√©cisions du PR');
            var decisionsCM = getActivitesRealisees(serviceRapport, 'D√©cisions du CM');
            
            html += '<h3>D√©cisions du PR</h3>';
            if (decisionsPR.length > 0) {
                html += '<ul>';
                for (var k = 0; k < decisionsPR.length; k++) {
                    var act = decisionsPR[k];
                    html += '<li>';
                    html += '<div class="activite-titre">' + act.activite + ' :</div>';
                    var commentaire = getCommentaireForActivite(act.activite, act.service);
                    if (commentaire) {
                        html += '<div class="commentaire">' + commentaire + '</div>';
                    }
                    html += '</li>';
                }
                html += '</ul>';
            } else {
                html += '<p style="color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
            }
            
            html += '<h3>D√©cisions du CM</h3>';
            if (decisionsCM.length > 0) {
                html += '<ul>';
                for (var k = 0; k < decisionsCM.length; k++) {
                    var act = decisionsCM[k];
                    html += '<li>';
                    html += '<div class="activite-titre">' + act.activite + ' :</div>';
                    var commentaire = getCommentaireForActivite(act.activite, act.service);
                    if (commentaire) {
                        html += '<div class="commentaire">' + commentaire + '</div>';
                    }
                    html += '</li>';
                }
                html += '</ul>';
            } else {
                html += '<p style="color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
            }
            
            // TABLEAU 3 - COMPLET
            html += '<h3>Tableau 3 : Vue globale</h3>';
            html += '<table><thead><tr><th>Cat√©gories</th><th>Planifi√©es</th><th>R√©alis√©es</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.planifiees + '</td><td>' + stat.realisees + '</td><td><strong>' + stat.taux + '</strong></td></tr>';
            }
            html += '<tr><td>D√©cisions du PR</td><td>' + statsDecisions[0].planifiees + '</td><td>' + statsDecisions[0].realisees + '</td><td><strong>' + statsDecisions[0].taux + '</strong></td></tr>';
            html += '<tr><td>D√©cisions du CM</td><td>' + statsDecisions[1].planifiees + '</td><td>' + statsDecisions[1].realisees + '</td><td><strong>' + statsDecisions[1].taux + '</strong></td></tr>';
            html += '<tr class="total"><td>TOTAL GLOBAL</td><td>' + (totalPlanifieesObj + totalPlanifieesDec) + '</td><td>' + (totalRealiseesObj + totalRealiseesDec) + '</td><td><strong>' + tauxGlobalTotal + '</strong></td></tr>';
            html += '</tbody></table>';
            
            // ESPACE GRAPHIQUE 3
            html += '<div class="graph-space">';
            html += '<div class="graph-title">Graphique 3 : Vue globale</div>';
            html += '<div class="graph-instruction">[Ins√©rer ici le graphique]</div>';
            html += '</div>';
            
            // SECTION 4
            html += '<h2>4. Difficult√©s et Solutions</h2>';
            html += '<h3>4.1 Difficult√©s</h3>';
            html += '<p>' + diffValue.replace(/\n/g, '<br/>') + '</p>';
            html += '<h3>4.2 Pistes de Solutions</h3>';
            html += '<p>' + pistesValue.replace(/\n/g, '<br/>') + '</p>';
            
            html += '</body></html>';
            
            var blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'Rapport_Performance_2026_' + new Date().getTime() + '.doc';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exporterDonneesExcel() {
            var isGlobal = currentUser.role === 'chefdept' || (currentUser.role === 'admin' && selectedServiceFilter === 'TOUS');
            var serviceRapport = currentUser.role === 'chef' ? currentUser.service : (isGlobal ? null : selectedServiceFilter);
            
            var statsObjectifs = calculerStatsObjectifs(serviceRapport);
            var statsDecisions = calculerStatsDecisions(serviceRapport);
            
            // Calculer totaux
            var totalPlanifieesObj = 0, totalRealiseesObj = 0;
            for (var i = 0; i < statsObjectifs.length; i++) {
                totalPlanifieesObj += statsObjectifs[i].planifiees;
                totalRealiseesObj += statsObjectifs[i].realisees;
            }
            var tauxTotalObj = totalPlanifieesObj > 0 ? Math.round((totalRealiseesObj / totalPlanifieesObj) * 100) : 0;
            
            var totalPlanifieesDec = 0, totalRealiseesDec = 0;
            for (var i = 0; i < statsDecisions.length; i++) {
                totalPlanifieesDec += statsDecisions[i].planifiees;
                totalRealiseesDec += statsDecisions[i].realisees;
            }
            var tauxTotalDec = totalPlanifieesDec > 0 ? Math.round((totalRealiseesDec / totalPlanifieesDec) * 100) : 0;
            
            var tauxGlobalTotal = (totalPlanifieesObj + totalPlanifieesDec) > 0 ? Math.round(((totalRealiseesObj + totalRealiseesDec) / (totalPlanifieesObj + totalPlanifieesDec)) * 100) : 0;
            
            var html = '<html xmlns:x="urn:schemas-microsoft-com:office:excel">';
            html += '<head><meta charset="utf-8"><style>';
            html += 'table { border-collapse: collapse; width: 100%; margin-bottom: 40px; }';
            html += 'th, td { border: 1px solid #000; padding: 8px; text-align: left; }';
            html += 'th { background-color: #2563eb; color: white; font-weight: bold; }';
            html += 'tr.total { background-color: #e5e7eb; font-weight: bold; }';
            html += 'h2 { color: #2563eb; margin-top: 30px; }';
            html += '</style></head><body>';
            
            var titreRapport = isGlobal ? 'DONN√âES RAPPORT GLOBAL' : 'DONN√âES RAPPORT - ' + (serviceRapport || 'SERVICE');
            html += '<h1>' + titreRapport + '</h1>';
            html += '<p>Ann√©e 2026 - G√©n√©r√© le ' + new Date().toLocaleString('fr-FR') + '</p>';
            
            // TABLEAU 1 : Objectifs
            html += '<h2>Tableau 1 : Taux par objectif</h2>';
            html += '<table><thead><tr><th>Objectifs</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.taux + '</td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + tauxTotalObj + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<p style="font-style: italic; color: #666; margin-bottom: 40px;">‚Üí S√©lectionnez ce tableau et cr√©ez un graphique en barres horizontales</p>';
            
            // TABLEAU 2 : D√©cisions
            html += '<h2>Tableau 2 : Taux par d√©cision</h2>';
            html += '<table><thead><tr><th>D√©cisions</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsDecisions.length; i++) {
                var stat = statsDecisions[i];
                html += '<tr><td>' + stat.decision + '</td><td>' + stat.taux + '</td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + tauxTotalDec + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<p style="font-style: italic; color: #666; margin-bottom: 40px;">‚Üí S√©lectionnez ce tableau et cr√©ez un graphique en barres horizontales</p>';
            
            // TABLEAU 3 : Vue globale
            html += '<h2>Tableau 3 : Vue globale</h2>';
            html += '<table><thead><tr><th>Cat√©gories</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.taux + '</td></tr>';
            }
            html += '<tr><td>D√©cisions du PR</td><td>' + statsDecisions[0].taux + '</td></tr>';
            html += '<tr><td>D√©cisions du CM</td><td>' + statsDecisions[1].taux + '</td></tr>';
            html += '<tr class="total"><td>TOTAL GLOBAL</td><td>' + tauxGlobalTotal + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<p style="font-style: italic; color: #666;">‚Üí S√©lectionnez ce tableau et cr√©ez un histogramme vertical</p>';
            
            html += '</body></html>';
            
            var blob = new Blob(['\ufeff' + html], { type: 'application/vnd.ms-excel' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'Donnees_Rapport_2026_' + new Date().getTime() + '.xls';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function sauvegarderTexteRapport(key, value) {
            rapportTextes[key] = value;
            saveRapportTextes();
        }

        function getActivitesRealisees(service, objectif) {
            var activites = [];
            for (var i = 0; i < data.length; i++) {
                var d = data[i];
                if (d.valide && calcTaux(d) === 100) {
                    if (service && d.service !== service) continue;
                    if (objectif && d.categorie !== objectif) continue;
                    activites.push(d);
                }
            }
            return activites;
        }

        function getCommentaireForActivite(activite, service) {
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                var item = commentairesEtPreuves[i];
                if (item.type === 'commentaire' && item.activite === activite && item.service === service) {
                    return item.commentaire;
                }
            }
            return '';
        }

        function calculerStatsObjectifs(service) {
            var objectifs = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques'];
            var stats = [];
            
            for (var j = 0; j < objectifs.length; j++) {
                var obj = objectifs[j];
                var planifiees = 0;
                var realisees = 0;
                
                for (var i = 0; i < data.length; i++) {
                    var d = data[i];
                    if (!d.valide) continue;
                    if (service && d.service !== service) continue;
                    if (d.categorie === obj) {
                        planifiees++;
                        if (calcTaux(d) === 100) realisees++;
                    }
                }
                
                var taux = planifiees > 0 ? Math.round((realisees / planifiees) * 100) : 0;
                stats.push({
                    objectif: obj,
                    planifiees: planifiees,
                    realisees: realisees,
                    taux: taux
                });
            }
            
            return stats;
        }

        function calculerStatsDecisions(service) {
            var decisions = ['D√©cisions du PR', 'D√©cisions du CM'];
            var stats = [];
            
            for (var j = 0; j < decisions.length; j++) {
                var dec = decisions[j];
                var planifiees = 0;
                var realisees = 0;
                
                for (var i = 0; i < data.length; i++) {
                    var d = data[i];
                    if (!d.valide) continue;
                    if (service && d.service !== service) continue;
                    if (d.categorie === dec) {
                        planifiees++;
                        if (calcTaux(d) === 100) realisees++;
                    }
                }
                
                var taux = planifiees > 0 ? Math.round((realisees / planifiees) * 100) : 0;
                stats.push({
                    decision: dec,
                    planifiees: planifiees,
                    realisees: realisees,
                    taux: taux
                });
            }
            
            return stats;
        }
function showUserList() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content" style="max-width: 1000px;"><h2 style="margin-bottom: 24px;">Gestion des Comptes</h2>';
            
            html += '<div style="margin-bottom: 16px;"><button class="btn btn-success" onclick="showCreateUserForm()">+ Cr√©er un compte</button></div>';
            
            html += '<div class="table-container"><table><thead class="blue"><tr><th>Utilisateur</th><th>Nom</th><th>Service</th><th>R√¥le</th><th>Statut</th><th style="text-align: center;">Actions</th></tr></thead><tbody>';
            
            for (var i = 0; i < users.length; i++) {
                var u = users[i];
                if (typeof u.actif === 'undefined') u.actif = true;
                
                html += '<tr><td>' + u.user + '</td><td>' + u.nom + '</td><td>' + u.service + '</td><td>';
                
                if (u.role === 'admin') html += '<span class="badge" style="background-color: #dc2626; color: white;">Admin</span>';
                else if (u.role === 'chef') html += '<span class="badge" style="background-color: #059669; color: white;">Chef</span>';
                else html += '<span class="badge" style="background-color: #d97706; color: white;">Chef D√©p.</span>';
                
                html += '</td><td>';
                
                if (u.actif) {
                    html += '<span class="badge badge-green" style="color: #065f46;">Actif</span>';
                } else {
                    html += '<span class="badge" style="background-color: #fee2e2; color: #991b1b;">D√©sactiv√©</span>';
                }
                
                html += '</td><td style="text-align: center;">';
                
                if (u.role !== 'admin') {
                    html += '<div style="display: flex; gap: 4px; justify-content: center;">';
                    html += '<button class="btn btn-primary" style="font-size: 11px; padding: 4px 8px;" onclick="showEditUserForm(' + u.id + ')">Modifier</button>';
                    
                    if (u.actif) {
                        html += '<button class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;" onclick="toggleUserStatus(' + u.id + ')">D√©sactiver</button>';
                    } else {
                        html += '<button class="btn btn-success" style="font-size: 11px; padding: 4px 8px;" onclick="toggleUserStatus(' + u.id + ')">Activer</button>';
                    }
                    
                    html += '<button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="confirmDeleteUser(' + u.id + ')">Supprimer</button>';
                    html += '</div>';
                } else {
                    html += '<span style="color: #6b7280; font-size: 12px;">Compte prot√©g√©</span>';
                }
                
                html += '</td></tr>';
            }
            
            html += '</tbody></table></div>';
            html += '<div style="margin-top: 16px; text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        function showConnectedUsers() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2>Utilisateurs Connect√©s</h2>';
            
            if (connectedUsers.length > 0) {
                html += '<div class="table-container" style="margin-top: 16px;"><table><thead class="blue"><tr><th>Nom</th><th>Service</th><th>Connect√© √†</th></tr></thead><tbody>';
                for (var i = 0; i < connectedUsers.length; i++) {
                    var u = connectedUsers[i];
                    html += '<tr><td>' + u.nom + '</td><td>' + u.service + '</td><td>' + u.connectedAt + '</td></tr>';
                }
                html += '</tbody></table></div>';
            } else {
                html += '<p style="text-align: center; padding: 32px; color: #6b7280;">Aucun utilisateur connect√©</p>';
            }
            
            html += '<div style="margin-top: 16px; text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        function showCreateUserForm() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">Cr√©er un compte</h2>';
            
            html += '<div class="form-group"><label>Nom d\'utilisateur *</label><input type="text" id="new-username" class="form-control" placeholder="ex: chef.nouveauservice"></div>';
            html += '<div class="form-group"><label>Mot de passe *</label><input type="password" id="new-password" class="form-control"></div>';
            html += '<div class="form-group"><label>Nom complet *</label><input type="text" id="new-fullname" class="form-control" placeholder="ex: Chef Nouveau Service"></div>';
            html += '<div class="form-group"><label>R√¥le *</label><select id="new-role" class="form-control"><option value="chef">Chef</option><option value="chefdept">Chef D√©partement</option></select></div>';
            html += '<div class="form-group"><label>Service *</label><select id="new-service" class="form-control">';
            for (var i = 0; i < services.length; i++) {
                html += '<option value="' + services[i] + '">' + services[i] + '</option>';
            }
            html += '<option value="TOUS">TOUS</option></select></div>';
            
            html += '<div class="btn-group"><button class="btn btn-success" onclick="createNewUser()">Cr√©er</button><button class="btn btn-secondary" onclick="showUserList()">Annuler</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        async function createNewUser() {
            var username = document.getElementById('new-username').value.trim();
            var password = document.getElementById('new-password').value;
            var fullname = document.getElementById('new-fullname').value.trim();
            var role = document.getElementById('new-role').value;
            var service = document.getElementById('new-service').value;
            
            if (!username || !password || !fullname) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            for (var i = 0; i < users.length; i++) {
                if (users[i].user === username) {
                    alert('Ce nom d\'utilisateur existe d√©j√†');
                    return;
                }
            }
            
            var maxId = 0;
            for (var i = 0; i < users.length; i++) {
                if (users[i].id > maxId) maxId = users[i].id;
            }
            
            users.push({
                id: maxId + 1,
                user: username,
                pass: password,
                role: role,
                nom: fullname,
                service: service,
                actif: true
            });
            
            await saveUsers();
            alert('Compte cr√©√© avec succ√®s');
            showUserList();
        }

        async function showEditUserForm(userId) {
            var user = null;
            for (var i = 0; i < users.length; i++) {
                if (users[i].id === userId) {
                    user = users[i];
                    break;
                }
            }
            
            if (!user) return;
            
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">Modifier: ' + user.user + '</h2>';
            
            html += '<div class="form-group"><label>Nom d\'utilisateur</label><input type="text" value="' + user.user + '" class="form-control" disabled></div>';
            html += '<div class="form-group"><label>Nouveau mot de passe (laisser vide si inchang√©)</label><input type="password" id="edit-password" class="form-control"></div>';
            html += '<div class="form-group"><label>Nom complet *</label><input type="text" id="edit-fullname" class="form-control" value="' + user.nom + '"></div>';
            
            html += '<div class="form-group"><label>Service *</label><select id="edit-service" class="form-control">';
            for (var i = 0; i < services.length; i++) {
                html += '<option value="' + services[i] + '"' + (user.service === services[i] ? ' selected' : '') + '>' + services[i] + '</option>';
            }
            html += '<option value="TOUS"' + (user.service === 'TOUS' ? ' selected' : '') + '>TOUS</option></select></div>';
            
            html += '<div class="btn-group"><button class="btn btn-primary" onclick="updateUser(' + userId + ')">Enregistrer</button><button class="btn btn-secondary" onclick="showUserList()">Annuler</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        async function updateUser(userId) {
            var password = document.getElementById('edit-password').value;
            var fullname = document.getElementById('edit-fullname').value.trim();
            var service = document.getElementById('edit-service').value;
            
            if (!fullname) {
                alert('Veuillez remplir le nom complet');
                return;
            }
            
            for (var i = 0; i < users.length; i++) {
                if (users[i].id === userId) {
                    if (password) users[i].pass = password;
                    users[i].nom = fullname;
                    users[i].service = service;
                    break;
                }
            }
            
            await saveUsers();
            alert('Compte modifi√© avec succ√®s');
            showUserList();
        }

        async function toggleUserStatus(userId) {
            for (var i = 0; i < users.length; i++) {
                if (users[i].id === userId) {
                    if (typeof users[i].actif === 'undefined') users[i].actif = true;
                    users[i].actif = !users[i].actif;
                    await saveUsers();
                    showUserList();
                    return;
                }
            }
        }

        async function confirmDeleteUser(userId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce compte ?')) return;
            
            var newUsers = [];
            for (var i = 0; i < users.length; i++) {
                if (users[i].id !== userId) newUsers.push(users[i]);
            }
            users = newUsers;
            await saveUsers();
            alert('Compte supprim√©');
            showUserList();
        }

        function showPermissions() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content" style="max-width: 900px;"><h2 style="margin-bottom: 24px;">üîí Gestion des Permissions</h2>';
            
            html += '<div class="alert alert-info" style="margin-bottom: 24px;">‚ÑπÔ∏è <strong>Information:</strong> Les permissions sont d√©finies par r√¥le. Chaque utilisateur h√©rite automatiquement des permissions de son r√¥le.</div>';
            
            html += '<div class="table-container"><table><thead class="blue"><tr><th style="width: 30%;">Fonctionnalit√©</th><th style="text-align: center;">Admin</th><th style="text-align: center;">Chef D√©partement</th><th style="text-align: center;">Chef de Service</th></tr></thead><tbody>';
            
            var permissions = [
                {nom: 'Voir Tableau de Bord', admin: true, chefdept: true, chef: true},
                {nom: 'Ajouter des activit√©s', admin: true, chefdept: false, chef: true},
                {nom: 'Modifier les activit√©s', admin: true, chefdept: false, chef: true},
                {nom: 'Valider les activit√©s', admin: true, chefdept: false, chef: false},
                {nom: 'Supprimer les activit√©s', admin: true, chefdept: false, chef: true},
                {nom: 'Cocher les √©tapes d\'ex√©cution', admin: true, chefdept: false, chef: true},
                {nom: 'D√©poser des commentaires', admin: true, chefdept: false, chef: true},
                {nom: 'D√©poser des preuves', admin: true, chefdept: false, chef: true},
                {nom: 'Voir les commentaires/preuves', admin: true, chefdept: true, chef: true},
                {nom: 'Modifier/Supprimer commentaires', admin: true, chefdept: false, chef: true},
                {nom: 'Voir Performance', admin: true, chefdept: true, chef: true},
                {nom: 'G√©n√©rer Rapport', admin: true, chefdept: true, chef: true},
                {nom: 'Filtrer tous les services', admin: true, chefdept: true, chef: false},
                {nom: 'G√©rer les utilisateurs', admin: true, chefdept: false, chef: false},
                {nom: 'Voir utilisateurs connect√©s', admin: true, chefdept: false, chef: false}
            ];
            
            for (var i = 0; i < permissions.length; i++) {
                var p = permissions[i];
                html += '<tr>';
                html += '<td><strong>' + p.nom + '</strong></td>';
                html += '<td style="text-align: center;">' + (p.admin ? '<span style="color: #059669; font-size: 20px;">‚úì</span>' : '<span style="color: #dc2626;">‚úó</span>') + '</td>';
                html += '<td style="text-align: center;">' + (p.chefdept ? '<span style="color: #059669; font-size: 20px;">‚úì</span>' : '<span style="color: #dc2626;">‚úó</span>') + '</td>';
                html += '<td style="text-align: center;">' + (p.chef ? '<span style="color: #059669; font-size: 20px;">‚úì</span>' : '<span style="color: #dc2626;">‚úó</span>') + '</td>';
                html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            
            html += '<h3 style="margin-top: 32px; margin-bottom: 16px;">Description des R√¥les</h3>';
            
            html += '<div style="background-color: #fee2e2; padding: 16px; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 16px;">';
            html += '<h4 style="color: #dc2626; margin-bottom: 8px;">üë§ Administrateur</h4>';
            html += '<p style="font-size: 14px; color: #991b1b;">Acc√®s complet au syst√®me. Peut g√©rer tous les services, valider les activit√©s, g√©rer les utilisateurs et acc√©der √† toutes les fonctionnalit√©s.</p>';
            html += '</div>';
            
            html += '<div style="background-color: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #d97706; margin-bottom: 16px;">';
            html += '<h4 style="color: #d97706; margin-bottom: 8px;">üë§ Chef de D√©partement</h4>';
            html += '<p style="font-size: 14px; color: #92400e;">Vue globale en lecture seule. Peut consulter toutes les donn√©es, g√©n√©rer des rapports globaux, mais ne peut pas modifier les activit√©s.</p>';
            html += '</div>';
            
            html += '<div style="background-color: #d1fae5; padding: 16px; border-radius: 8px; border-left: 4px solid #059669;">';
            html += '<h4 style="color: #059669; margin-bottom: 8px;">üë§ Chef de Service</h4>';
            html += '<p style="font-size: 14px; color: #065f46;">Gestion compl√®te de son service uniquement. Peut ajouter, modifier, supprimer des activit√©s, d√©poser commentaires et preuves pour son service.</p>';
            html += '</div>';
            
            html += '<div style="margin-top: 16px; text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div>';
            html += '</div></div>';
            
            modalContainer.innerHTML = html;
        }
// ========== D√âTECTION TOKEN D'INVITATION ==========
function getInvitationToken() {
    const params = new URLSearchParams(window.location.search);
    return params.get('token');
}

var invitationToken = null;
var invitationData = null;

async function checkInvitationToken() {
    invitationToken = getInvitationToken();
    
    if (invitationToken) {
        try {
            const { data, error } = await supabase
                .from('invitations')
                .select('*')
                .eq('token', invitationToken)
                .eq('status', 'pending')
                .single();
            
            if (error || !data) {
                alert('Invitation invalide ou d√©j√† utilis√©e');
                window.location.href = window.location.pathname;
                return;
            }
            
            if (new Date(data.expires_at) < new Date()) {
                alert('Cette invitation a expir√©. Contactez l\'administrateur.');
                window.location.href = window.location.pathname;
                return;
            }
            
            invitationData = data;
        } catch (error) {
            console.error('Erreur v√©rification invitation:', error);
        }
    }
}
// ========== FONCTIONS STATISTIQUES ==========
function calculerMoyenne(data, field) {
    if (data.length === 0) return 0;
    var total = 0;
    var count = 0;
    for (var i = 0; i < data.length; i++) {
        if (data[i][field] !== null && data[i][field] !== undefined) {
            total += parseFloat(data[i][field]);
            count++;
        }
    }
    return count > 0 ? Math.round(total / count * 10) / 10 : 0;
}
function updateFormFilters() {
    var regionId = document.getElementById('filter-region') ? document.getElementById('filter-region').value : '';
    var prefectureSelect = document.getElementById('filter-prefecture');
    
    console.log('=== UPDATE FILTERS ===');
    console.log('R√©gion s√©lectionn√©e:', regionId);
    
    if (!prefectureSelect) {
        console.log('ERROR: prefectureSelect not found');
        return;
    }
    
    // Vider et reconstruire les options
    prefectureSelect.innerHTML = '<option value="">Toutes les pr√©fectures</option>';
    
    if (regionId) {
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
        console.log('Pr√©fectures ajout√©es pour r√©gion', regionId);
    }
    
    // IMPORTANT : R√©attacher l'√©v√©nement onchange
    prefectureSelect.onchange = function() {
        console.log('Prefecture changed!');
        filterTableRows();
    };
    
    // Appliquer le filtrage
    filterTableRows();
}

function filterTableRows() {
    var regionId = document.getElementById('filter-region') ? document.getElementById('filter-region').value : '';
    var prefectureNom = document.getElementById('filter-prefecture') ? document.getElementById('filter-prefecture').value : '';
    
    console.log('=== FILTRAGE ===');
    console.log('R√©gion ID s√©lectionn√©e:', regionId);
    console.log('Pr√©fecture s√©lectionn√©e:', prefectureNom);
    
    var rows = document.querySelectorAll('.stat-row');
    console.log('Nombre de lignes trouv√©es:', rows.length);
    
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var rowRegion = row.getAttribute('data-region');
        var rowPrefecture = row.getAttribute('data-prefecture');
        
        var showRow = true;
        
        // Filtre par r√©gion
        if (regionId && regionId !== '' && rowRegion != regionId) {
            showRow = false;
        }
        
        // Filtre par pr√©fecture
        if (prefectureNom && prefectureNom !== '' && rowPrefecture != prefectureNom) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
        
        if (showRow) {
            visibleCount++;
        }
    }
    
    console.log('Lignes visibles:', visibleCount);
    console.log('================');
}

function showStatistiquesModal() {
    var modalContainer = document.getElementById('modal-container');
   var html = '<div class="modal"><div class="modal-content" style="max-width: 98vw; max-height: 98vh; overflow: hidden; display: flex; flex-direction: column;"><h2 style="margin-bottom: 16px;">üìä Saisir les statistiques nationales</h2>';
    
    // En-t√™te avec p√©riode et genre
   html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; background-color: #f9fafb; padding: 16px; border-radius: 8px;">';
html += '<div class="form-group"><label>Ann√©e scolaire *</label><input type="text" id="global-annee" class="form-control" value="2025-2026" onchange="rechargerFormulaireStatistiques()"></div>';
html += '<div class="form-group"><label>P√©riode *</label><select id="global-periode" class="form-control" onchange="rechargerFormulaireStatistiques()"><option>T1</option><option>T2</option><option>T3</option><option>T4</option><option>Annuel</option></select></div>';
    
    html += '<div class="form-group"><label>Filtre R√©gion</label><select id="filter-region" class="form-control" onchange="updateFormFilters()"><option value="">Toutes les r√©gions</option>';
    for (var i = 0; i < regionsData.length; i++) {
        html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
    }
    html += '</select></div>';
    
    html += '<div class="form-group"><label>Filtre Pr√©fecture</label><select id="filter-prefecture" class="form-control" onchange="updateFormFilters()"><option value="">Toutes les pr√©fectures</option></select></div>';
    html += '</div>';

    
    // Tableau de saisie
   html += '<div style="flex: 1; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">';
   html += '<table id="stats-table" style="width: 100%; font-size: 11px; border-collapse: collapse;"><thead style="position: sticky; top: 0; background-color: #2563eb; color: white; z-index: 10;"><tr>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">R√©gion</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">Pr√©fecture</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">Zone</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">Niveau</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #059669; color: white; font-weight: bold;">Abandon T (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #db2777; color: white; font-weight: bold;">Abandon F (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #059669; color: white; font-weight: bold;">R√©ussite T (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #db2777; color: white; font-weight: bold;">R√©ussite F (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #059669; color: white; font-weight: bold;">Scolarisa. T (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #db2777; color: white; font-weight: bold;">Scolarisa. F (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #059669; color: white; font-weight: bold;">Alphab√©t. T (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #db2777; color: white; font-weight: bold;">Alphab√©t. F (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #2563eb; color: white; font-weight: bold;">Ratio E/Ens</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #2563eb; color: white; font-weight: bold;">Ratio E/Classe</th>';
html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #2563eb; color: white; font-weight: bold;">Distance (km)</th>';
html += '</tr></thead><tbody>';
    
    var rowIndex = 0;
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Pr√©scolaire', 'Primaire', 'Secondaire'];
    
    // G√©n√©rer toutes les lignes
    var rowIndex = 0;
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Pr√©scolaire', 'Primaire', 'Secondaire'];
    
    // G√©n√©rer toutes les lignes
   for (var r = 0; r < regionsData.length; r++) {
    var region = regionsData[r];
    
    var prefecturesRegion = [];
    for (var p = 0; p < prefecturesData.length; p++) {
        if (prefecturesData[p].region_id == region.id) {
            prefecturesRegion.push(prefecturesData[p]);
        }
    }
    
    for (var p = 0; p < prefecturesRegion.length; p++) {
        var prefecture = prefecturesRegion[p];
        
        for (var z = 0; z < zones.length; z++) {
            var zone = zones[z];
            
            // ========== LIGNES PAR NIVEAU (abandon, r√©ussite, scolarisation) ==========
            for (var n = 0; n < niveaux.length; n++) {
                var niveau = niveaux[n];
                var bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
                
                html += '<tr class="stat-row" data-region="' + region.id + '" data-prefecture="' + prefecture.nom + '" data-zone="' + zone + '" data-niveau="' + niveau + '" style="background-color: ' + bgColor + ';">';
                html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + region.nom + '</td>';
                html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + prefecture.nom + '</td>';
                html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + zone + '</td>';
                html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + niveau + '</td>';
                
                // Taux abandon (T/F)
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="abandon_total" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="abandon_filles" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                
                // Taux r√©ussite (T/F)
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="reussite_total" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="reussite_filles" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                
                // Taux scolarisation (T/F)
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="scolarisation_total" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="scolarisation_filles" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                
                // Alphab√©tisation (d√©sactiv√© pour les lignes par niveau)
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
                
                // Ratios et distance
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="ratio_ens" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="ratio_classe" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
                html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="distance" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
                
                html += '</tr>';
                rowIndex++;
            }
            
            // ========== LIGNE PAR ZONE (alphab√©tisation uniquement) ==========
            var bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
            
            html += '<tr class="stat-row stat-row-zone" data-region="' + region.id + '" data-prefecture="' + prefecture.nom + '" data-zone="' + zone + '" data-niveau="zone-entiere" style="background-color: #fff3cd; border-left: 4px solid #ffc107;">';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + region.nom + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + prefecture.nom + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + zone + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; text-align: center; font-style: italic; color: #6b7280;">Zone enti√®re</td>';
            
            // D√©sactiver abandon, r√©ussite, scolarisation
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            
            // Alphab√©tisation (ACTIF pour les lignes par zone)
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #fffbeb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="alphabetisation_total" data-type="zone" style="width: 100%; font-size: 11px; padding: 4px; font-weight: bold;" min="0" max="100" placeholder="T"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #fffbeb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="alphabetisation_filles" data-type="zone" style="width: 100%; font-size: 11px; padding: 4px; font-weight: bold;" min="0" max="100" placeholder="F"></td>';
            
            // Ratios d√©sactiv√©s
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb; background-color: #f3f4f6;"><input type="number" class="form-control" style="width: 100%; font-size: 11px; padding: 4px;" disabled></td>';
            
            html += '</tr>';
            rowIndex++;
        }
    }
}

    html += '</tbody></table></div>';
    
  html += '<div style="margin-top: 16px; display: flex; gap: 10px; justify-content: space-between; align-items: center;">';
html += '<span id="progression-saisie" style="color: #666; font-size: 0.9em; font-weight: bold;"></span>';
html += '<div style="display: flex; gap: 10px;">';
html += '<button class="btn btn-primary" onclick="submitStatistiquesTableau(false)">üíæ Enregistrer nouvelles</button>';
html += '<button class="btn btn-warning" onclick="submitStatistiquesTableau(true)" style="background-color: #f59e0b; color: white;">üîÑ Mettre √† jour</button>';
html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
html += '</div>';
html += '</div>';

    html += '</div></div>';
    modalContainer.innerHTML = html;
   } 
  // ========== CHARGER LES DONN√âES EXISTANTES ==========
setTimeout(async function() {
    var annee = document.getElementById('global-annee').value.trim();
    var periode = document.getElementById('global-periode').value;
    
    if (!annee || !periode) return;
    
    try {
        const { data: existingData, error } = await supabase
            .from('statistiques_educatives')
            .select('*')
            .eq('annee_scolaire', annee)
            .eq('periode', periode);
        
        if (error) throw error;
        
        if (existingData && existingData.length > 0) {
            console.log('üì• Chargement de ' + existingData.length + ' donn√©es existantes...');
            
            var loaded = 0;
            
            // Pour chaque donn√©e existante
            for (var i = 0; i < existingData.length; i++) {
                var stat = existingData[i];
                
                // Trouver l'index de ligne correspondant
                var rowIndex = 0;
                var found = false;
                
                for (var r = 0; r < regionsData.length && !found; r++) {
                    var region = regionsData[r];
                    
                    var prefecturesRegion = [];
                    for (var p = 0; p < prefecturesData.length; p++) {
                        if (prefecturesData[p].region_id == region.id) {
                            prefecturesRegion.push(prefecturesData[p]);
                        }
                    }
                    
                    for (var p = 0; p < prefecturesRegion.length && !found; p++) {
                        var prefecture = prefecturesRegion[p];
                        
                        if (prefecture.nom !== stat.prefecture) {
                            rowIndex += 8; // 6 lignes par niveau (3 niveaux x 2 zones) + 2 lignes zone
                            continue;
                        }
                        
                        var zones = ['Urbaine', 'Rurale'];
                        for (var z = 0; z < zones.length && !found; z++) {
                            var zone = zones[z];
                            
                            if (zone !== stat.zone) {
                                rowIndex += 4; // 3 lignes niveau + 1 ligne zone
                                continue;
                            }
                            
                            if (stat.niveau && stat.niveau !== 'Alphab√©tisation') {
                                // Donn√©es par niveau
                                var niveaux = ['Pr√©scolaire', 'Primaire', 'Secondaire'];
                                for (var n = 0; n < niveaux.length; n++) {
                                    if (niveaux[n] === stat.niveau) {
                                        var suffix = stat.genre === 'Total' ? 'total' : 'filles';
                                        
                                        // Taux abandon
                                        if (stat.taux_abandon !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_' + suffix + '"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.taux_abandon;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Taux r√©ussite
                                        if (stat.taux_reussite_examens !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="reussite_' + suffix + '"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.taux_reussite_examens;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Taux scolarisation
                                        if (stat.taux_scolarisation !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_' + suffix + '"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.taux_scolarisation;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Ratio enseignant (seulement pour Total)
                                        if (stat.genre === 'Total' && stat.ratio_eleves_enseignant !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_ens"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.ratio_eleves_enseignant;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Ratio classe (seulement pour Total)
                                        if (stat.genre === 'Total' && stat.ratio_eleves_classe !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_classe"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.ratio_eleves_classe;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        // Distance (seulement pour Total)
                                        if (stat.genre === 'Total' && stat.distance_moyenne_ecole_domicile !== null) {
                                            var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="distance"][data-type="niveau"]');
                                            if (input) {
                                                input.value = stat.distance_moyenne_ecole_domicile;
                                                input.style.background = '#e8f5e9';
                                                input.style.borderColor = '#4caf50';
                                                input.disabled = true;
                                                input.setAttribute('data-saved', 'true');
                                                input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                                loaded++;
                                            }
                                        }
                                        
                                        found = true;
                                        break;
                                    }
                                    rowIndex++;
                                }
                            } else {
                                // Donn√©es par zone (alphab√©tisation)
                                rowIndex += 3; // Sauter les 3 niveaux
                                
                                var suffix = stat.genre === 'Total' ? 'total' : 'filles';
                                if (stat.taux_alphabetisation !== null) {
                                    var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alphabetisation_' + suffix + '"][data-type="zone"]');
                                    if (input) {
                                        input.value = stat.taux_alphabetisation;
                                        input.style.background = '#e8f5e9';
                                        input.style.borderColor = '#4caf50';
                                        input.disabled = true;
                                        input.setAttribute('data-saved', 'true');
                                        input.setAttribute('data-periode', stat.periode); // üî• NOUVEAU
    
    // Ajouter la p√©riode sur la ligne enti√®re
    var row = input.closest('tr');
    if (row && !row.getAttribute('data-periode')) {
        row.setAttribute('data-periode', stat.periode);
    }

                                        loaded++;
                                    }
                                }
                                
                                found = true;
                                rowIndex++;
                            }
                        }
                    }
                }
            }
            
            // Mettre √† jour la progression
            updateProgression();
            
            if (loaded > 0) {
                alert('üì• ' + loaded + ' champs d√©j√† enregistr√©s ont √©t√© charg√©s (en vert).\n\nVous pouvez continuer la saisie des autres lignes.');
            }
        }
    } catch (error) {
        console.error('Erreur chargement:', error);
    }
}, 500);
  
    modalContainer.innerHTML = html;

  // Initialiser les cartes avec toutes les donn√©es
    setTimeout(function() {
        updateCartesIndicateurs(['T1', 'T2', 'T3', 'T4', 'Annuel']);
    }, 100);
  
    // ========== D√âTECTER LES MODIFICATIONS POUR R√âACTIVER L'ENREGISTREMENT ==========
    setTimeout(function() {
        var allInputs = document.querySelectorAll('input[data-field]:not([disabled])');
        for (var i = 0; i < allInputs.length; i++) {
            allInputs[i].addEventListener('input', function() {
                // Retirer le statut "sauvegard√©" quand l'utilisateur modifie
                if (this.getAttribute('data-saved') === 'true') {
                    this.removeAttribute('data-saved');
                    this.style.background = '';
                    this.style.borderColor = '';
                    this.disabled = false;
                }
            });
        }
    }, 600);
// ========== MODAL R√âUSSITE AUX EXAMENS (DGECS) - PARTIE 1/2 ========== function showReussiteExamensModal() { if (!canSaisirExamens()) { alert('‚ùå Vous n\'avez pas acc√®s √† ce formulaire'); return; }
var modalContainer = document.getElementById('modal-container');

var html = '<div class="modal"><div class="modal-content" style="max-width: 95vw; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">';
html += '<h2 style="margin-bottom: 16px;">‚úÖ Saisir les Taux de R√©ussite aux Examens Nationaux</h2>';

// En-t√™te avec ann√©e et p√©riode
html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; background-color: #f9fafb; padding: 16px; border-radius: 8px;">';
html += '<div class="form-group"><label>Ann√©e scolaire *</label><input type="text" id="examens-annee" class="form-control" value="2025-2026"></div>';
html += '<div class="form-group"><label>P√©riode *</label><select id="examens-periode" class="form-control"><option>T1</option><option>T2</option><option>T3</option><option>T4</option><option>Annuel</option></select></div>';

html += '<div class="form-group"><label>Filtre R√©gion</label><select id="filter-examens-region" class="form-control" onchange="updateExamensPrefectureDropdown(); filterExamensRows();"><option value="">Toutes les r√©gions</option>';
for (var i = 0; i < regionsData.length; i++) {
    html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
}
html += '</select></div>';

html += '<div class="form-group"><label>Filtre Pr√©fecture</label><select id="filter-examens-prefecture" class="form-control" onchange="filterExamensRows()"><option value="">Toutes les pr√©fectures</option></select></div>';
html += '</div>';

// Tableau de saisie
html += '<div style="flex: 1; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">';
html += '<table id="examens-table" style="width: 100%; font-size: 11px; border-collapse: collapse;">';
html += '<thead style="position: sticky; top: 0; background-color: #059669; color: white; z-index: 10;"><tr>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap;">R√©gion</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap;">Pr√©fecture</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap;">Zone</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 80px; background-color: #2563eb;">CEE Total (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 80px; background-color: #db2777;">CEE Filles (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 80px; background-color: #2563eb;">BEPC Total (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 80px; background-color: #db2777;">BEPC Filles (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 80px; background-color: #2563eb;">BAC Total (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 80px; background-color: #db2777;">BAC Filles (%)</th>';
html += '</tr></thead><tbody>';

var rowIndex = 0;
var zones = ['Urbaine', 'Rurale'];

for (var r = 0; r < regionsData.length; r++) {
    var region = regionsData[r];
    var prefecturesRegion = [];
    
    for (var p = 0; p < prefecturesData.length; p++) {
        if (prefecturesData[p].region_id == region.id) {
            prefecturesRegion.push(prefecturesData[p]);
        }
    }
    
    for (var p = 0; p < prefecturesRegion.length; p++) {
        var prefecture = prefecturesRegion[p];
        
        for (var z = 0; z < zones.length; z++) {
            var zone = zones[z];
            var bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
            
            html += '<tr class="examens-row" data-region="' + region.id + '" data-prefecture="' + prefecture.nom + '" style="background-color: ' + bgColor + ';">';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; font-weight: 600;">' + region.nom + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb;">' + prefecture.nom + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb;">' + zone + '</td>';
            
            // CEE
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="cee_total" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="cee_filles" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            
            // BEPC
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bepc_total" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bepc_filles" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            
            // BAC
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bac_total" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bac_filles" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            
            html += '</tr>';
            rowIndex++;
        }
    }
}

html += '</tbody></table></div>';

html += '<div style="margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end;">';
html += '<button class="btn btn-primary" onclick="submitReussiteExamens()">üíæ Enregistrer</button>';
html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
html += '</div>';

html += '</div></div>';
modalContainer.innerHTML = html;
        
function updateExamensPrefectureDropdown() {
var regionId = document.getElementById('filter-examens-region') ? document.getElementById('filter-examens-region').value : '';
var prefectureSelect = document.getElementById('filter-examens-prefecture');
if (!prefectureSelect) return;

prefectureSelect.innerHTML = '<option value="">Toutes les pr√©fectures</option>';

if (regionId) {
    for (var i = 0; i < prefecturesData.length; i++) {
        if (prefecturesData[i].region_id == regionId) {
            var option = document.createElement('option');
            option.value = prefecturesData[i].nom;
            option.textContent = prefecturesData[i].nom;
            prefectureSelect.appendChild(option);
        }
    }
}
}
function filterExamensRows() {
var regionId = document.getElementById('filter-examens-region') ? document.getElementById('filter-examens-region').value : '';
var prefecture = document.getElementById('filter-examens-prefecture') ? document.getElementById('filter-examens-prefecture').value : '';
var rows = document.querySelectorAll('.examens-row');

for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var rowRegion = row.getAttribute('data-region');
    var rowPrefecture = row.getAttribute('data-prefecture');
    
    var show = true;
    if (regionId && rowRegion != regionId) show = false;
    if (prefecture && rowPrefecture != prefecture) show = false;
    
    row.style.display = show ? '' : 'none';
}
}
async function submitReussiteExamens() {
var annee = document.getElementById('examens-annee').value.trim();
var periode = document.getElementById('examens-periode').value;
if (!annee || !periode) {
    alert('‚ö†Ô∏è Veuillez remplir ann√©e et p√©riode');
    return;
}

var dataToInsert = [];
var rowIndex = 0;
var zones = ['Urbaine', 'Rurale'];

for (var r = 0; r < regionsData.length; r++) {
    var region = regionsData[r];
    var prefecturesRegion = [];
    
    for (var p = 0; p < prefecturesData.length; p++) {
        if (prefecturesData[p].region_id == region.id) {
            prefecturesRegion.push(prefecturesData[p]);
        }
    }
    
    for (var p = 0; p < prefecturesRegion.length; p++) {
        var prefecture = prefecturesRegion[p];
        
        for (var z = 0; z < zones.length; z++) {
            var zone = zones[z];
            
            var ceeTotal = document.querySelector('input[data-row="' + rowIndex + '"][data-field="cee_total"]');
            var ceeFilles = document.querySelector('input[data-row="' + rowIndex + '"][data-field="cee_filles"]');
            var bepcTotal = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bepc_total"]');
            var bepcFilles = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bepc_filles"]');
            var bacTotal = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bac_total"]');
            var bacFilles = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bac_filles"]');
            
            var valCeeT = ceeTotal && ceeTotal.value ? parseFloat(ceeTotal.value) : null;
            var valCeeF = ceeFilles && ceeFilles.value ? parseFloat(ceeFilles.value) : null;
            var valBepcT = bepcTotal && bepcTotal.value ? parseFloat(bepcTotal.value) : null;
            var valBepcF = bepcFilles && bepcFilles.value ? parseFloat(bepcFilles.value) : null;
            var valBacT = bacTotal && bacTotal.value ? parseFloat(bacTotal.value) : null;
            var valBacF = bacFilles && bacFilles.value ? parseFloat(bacFilles.value) : null;
            
            // Total
            if (valCeeT !== null || valBepcT !== null || valBacT !== null) {
                dataToInsert.push({
                    annee_scolaire: annee,
                    periode: periode,
                    region: region.nom,
                    prefecture: prefecture.nom,
                    zone: zone,
                    genre: 'Total',
                    taux_reussite_cee: valCeeT,
                    taux_reussite_bepc: valBepcT,
                    taux_reussite_bac: valBacT,
                    saisi_par: currentUser.nom
                });
            }
            
            // Filles
            if (valCeeF !== null || valBepcF !== null || valBacF !== null) {
                dataToInsert.push({
                    annee_scolaire: annee,
                    periode: periode,
                    region: region.nom,
                    prefecture: prefecture.nom,
                    zone: zone,
                    genre: 'Filles',
                    taux_reussite_cee: valCeeF,
                    taux_reussite_bepc: valBepcF,
                    taux_reussite_bac: valBacF,
                    saisi_par: currentUser.nom
                });
            }
            
            rowIndex++;
        }
    }
}

if (dataToInsert.length === 0) {
    alert('‚ö†Ô∏è Aucune donn√©e √† enregistrer');
    return;
}

if (!confirm('üíæ Enregistrer ' + dataToInsert.length + ' lignes ?')) {
    return;
}

try {
    const { data: insertedData, error } = await supabase
        .from('reussite_examens')
        .upsert(dataToInsert, { 
            onConflict: 'annee_scolaire,periode,region,prefecture,zone,genre',
            ignoreDuplicates: false 
        })
        .select();
    
    if (error) throw error;
    
    if (insertedData) {
        for (var i = 0; i < insertedData.length; i++) {
            var found = false;
            for (var j = 0; j < reussiteExamensData.length; j++) {
                if (reussiteExamensData[j].id === insertedData[i].id) {
                    reussiteExamensData[j] = insertedData[i];
                    found = true;
                    break;
                }
            }
            if (!found) {
                reussiteExamensData.unshift(insertedData[i]);
            }
        }
    }
    
    alert('‚úÖ Donn√©es enregistr√©es avec succ√®s !');
    closeModal();
    render();
    
} catch (error) {
    console.error('Erreur:', error);
    alert('‚ùå Erreur : ' + error.message);
}
}
// ========== MODAL ALPHAB√âTISATION (DNAENFP-LN) - PARTIE 2/2 ========== function showAlphabetisationModal() { if (!canSaisirAlphabetisation()) { alert('‚ùå Vous n\'avez pas acc√®s √† ce formulaire'); return; }
var modalContainer = document.getElementById('modal-container');

var html = '<div class="modal"><div class="modal-content" style="max-width: 95vw; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">';
html += '<h2 style="margin-bottom: 16px;">‚úçÔ∏è Saisir les Donn√©es d\'Alphab√©tisation</h2>';

// En-t√™te
html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; background-color: #f9fafb; padding: 16px; border-radius: 8px;">';
html += '<div class="form-group"><label>Ann√©e scolaire *</label><input type="text" id="alpha-annee" class="form-control" value="2025-2026"></div>';
html += '<div class="form-group"><label>P√©riode *</label><select id="alpha-periode" class="form-control"><option>T1</option><option>T2</option><option>T3</option><option>T4</option><option>Annuel</option></select></div>';

html += '<div class="form-group"><label>Filtre R√©gion</label><select id="filter-alpha-region" class="form-control" onchange="updateAlphaPrefectureDropdown(); filterAlphaRows();"><option value="">Toutes les r√©gions</option>';
for (var i = 0; i < regionsData.length; i++) {
    html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
}
html += '</select></div>';

html += '<div class="form-group"><label>Filtre Pr√©fecture</label><select id="filter-alpha-prefecture" class="form-control" onchange="filterAlphaRows()"><option value="">Toutes les pr√©fectures</option></select></div>';
html += '</div>';

// Tableau
html += '<div style="flex: 1; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">';
html += '<table id="alpha-table" style="width: 100%; font-size: 11px; border-collapse: collapse;">';
html += '<thead style="position: sticky; top: 0; background-color: #f59e0b; color: white; z-index: 10;"><tr>';
html += '<th style="padding: 8px; border: 1px solid #d97706;">R√©gion</th>';
html += '<th style="padding: 8px; border: 1px solid #d97706;">Pr√©fecture</th>';
html += '<th style="padding: 8px; border: 1px solid #d97706;">Zone</th>';
html += '<th style="padding: 8px; border: 1px solid #d97706; width: 80px; background-color: #2563eb;">Nb Centres</th>';
html += '<th style="padding: 8px; border: 1px solid #d97706; width: 80px; background-color: #059669;">Taux Particip. Total (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #d97706; width: 80px; background-color: #db2777;">Taux Particip. Filles (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #d97706; width: 80px; background-color: #059669;">Taux Alpha Jeunes Total (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #d97706; width: 80px; background-color: #db2777;">Taux Alpha Jeunes Filles (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #d97706; width: 80px; background-color: #059669;">Taux Alpha Adultes Total (%)</th>';
html += '<th style="padding: 8px; border: 1px solid #d97706; width: 80px; background-color: #db2777;">Taux Alpha Adultes Filles (%)</th>';
html += '</tr></thead><tbody>';

var rowIndex = 0;
var zones = ['Urbaine', 'Rurale'];

for (var r = 0; r < regionsData.length; r++) {
    var region = regionsData[r];
    var prefecturesRegion = [];
    
    for (var p = 0; p < prefecturesData.length; p++) {
        if (prefecturesData[p].region_id == region.id) {
            prefecturesRegion.push(prefecturesData[p]);
        }
    }
    
    for (var p = 0; p < prefecturesRegion.length; p++) {
        var prefecture = prefecturesRegion[p];
        
        for (var z = 0; z < zones.length; z++) {
            var zone = zones[z];
            var bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
            
            html += '<tr class="alpha-row" data-region="' + region.id + '" data-prefecture="' + prefecture.nom + '" style="background-color: ' + bgColor + ';">';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb; font-weight: 600;">' + region.nom + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb;">' + prefecture.nom + '</td>';
            html += '<td style="padding: 6px; border: 1px solid #e5e7eb;">' + zone + '</td>';
            
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" class="form-control" data-row="' + rowIndex + '" data-field="nb_centres" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="particip_total" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="particip_filles" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="jeunes_total" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="jeunes_filles" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="adultes_total" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="adultes_filles" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100"></td>';
            
            html += '</tr>';
            rowIndex++;
        }
    }
}

html += '</tbody></table></div>';

html += '<div style="margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end;">';
html += '<button class="btn btn-primary" onclick="submitAlphabetisation()">üíæ Enregistrer</button>';
html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
html += '</div>';

html += '</div></div>';
modalContainer.innerHTML = html;
        
function updateAlphaPrefectureDropdown() {
var regionId = document.getElementById('filter-alpha-region') ? document.getElementById('filter-alpha-region').value : '';
var prefectureSelect = document.getElementById('filter-alpha-prefecture');
if (!prefectureSelect) return;

prefectureSelect.innerHTML = '<option value="">Toutes les pr√©fectures</option>';

if (regionId) {
    for (var i = 0; i < prefecturesData.length; i++) {
        if (prefecturesData[i].region_id == regionId) {
            var option = document.createElement('option');
            option.value = prefecturesData[i].nom;
            option.textContent = prefecturesData[i].nom;
            prefectureSelect.appendChild(option);
        }
    }
}
}
function filterAlphaRows() {
var regionId = document.getElementById('filter-alpha-region') ? document.getElementById('filter-alpha-region').value : '';
var prefecture = document.getElementById('filter-alpha-prefecture') ? document.getElementById('filter-alpha-prefecture').value : '';
var rows = document.querySelectorAll('.alpha-row');

for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var rowRegion = row.getAttribute('data-region');
    var rowPrefecture = row.getAttribute('data-prefecture');
    
    var show = true;
    if (regionId && rowRegion != regionId) show = false;
    if (prefecture && rowPrefecture != prefecture) show = false;
    
    row.style.display = show ? '' : 'none';
}
}
async function submitAlphabetisation() {
var annee = document.getElementById('alpha-annee').value.trim();
var periode = document.getElementById('alpha-periode').value;
if (!annee || !periode) {
    alert('‚ö†Ô∏è Veuillez remplir ann√©e et p√©riode');
    return;
}

var dataToInsert = [];
var rowIndex = 0;
var zones = ['Urbaine', 'Rurale'];

for (var r = 0; r < regionsData.length; r++) {
    var region = regionsData[r];
    var prefecturesRegion = [];
    
    for (var p = 0; p < prefecturesData.length; p++) {
        if (prefecturesData[p].region_id == region.id) {
            prefecturesRegion.push(prefecturesData[p]);
        }
    }
    
    for (var p = 0; p < prefecturesRegion.length; p++) {
        var prefecture = prefecturesRegion[p];
        
        for (var z = 0; z < zones.length; z++) {
            var zone = zones[z];
            
            var nbCentres = document.querySelector('input[data-row="' + rowIndex + '"][data-field="nb_centres"]');
            var participTotal = document.querySelector('input[data-row="' + rowIndex + '"][data-field="particip_total"]');
            var participFilles = document.querySelector('input[data-row="' + rowIndex + '"][data-field="particip_filles"]');
            var jeunesTotal = document.querySelector('input[data-row="' + rowIndex + '"][data-field="jeunes_total"]');
            var jeunesFilles = document.querySelector('input[data-row="' + rowIndex + '"][data-field="jeunes_filles"]');
            var adultesTotal = document.querySelector('input[data-row="' + rowIndex + '"][data-field="adultes_total"]');
            var adultesFilles = document.querySelector('input[data-row="' + rowIndex + '"][data-field="adultes_filles"]');
            
            var valNbCentres = nbCentres && nbCentres.value ? parseInt(nbCentres.value) : null;
            var valParticipT = participTotal && participTotal.value ? parseFloat(participTotal.value) : null;
            var valParticipF = participFilles && participFilles.value ? parseFloat(participFilles.value) : null;
            var valJeunesT = jeunesTotal && jeunesTotal.value ? parseFloat(jeunesTotal.value) : null;
            var valJeunesF = jeunesFilles && jeunesFilles.value ? parseFloat(jeunesFilles.value) : null;
            var valAdultesT = adultesTotal && adultesTotal.value ? parseFloat(adultesTotal.value) : null;
            var valAdultesF = adultesFilles && adultesFilles.value ? parseFloat(adultesFilles.value) : null;
            
            // Total
            if (valNbCentres !== null || valParticipT !== null || valJeunesT !== null || valAdultesT !== null) {
                dataToInsert.push({
                    annee_scolaire: annee,
                    periode: periode,
                    region: region.nom,
                    prefecture: prefecture.nom,
                    zone: zone,
genre: 'Total',
                        nb_centres: valNbCentres,
                        taux_participation: valParticipT,
                        taux_alpha_jeunes: valJeunesT,
                        taux_alpha_adultes: valAdultesT,
                        saisi_par: currentUser.nom
                    });
                }
                
                // Filles
                if (valParticipF !== null || valJeunesF !== null || valAdultesF !== null) {
                    dataToInsert.push({
                        annee_scolaire: annee,
                        periode: periode,
                        region: region.nom,
                        prefecture: prefecture.nom,
                        zone: zone,
                        genre: 'Filles',
                        nb_centres: null,
                        taux_participation: valParticipF,
                        taux_alpha_jeunes: valJeunesF,
                        taux_alpha_adultes: valAdultesF,
                        saisi_par: currentUser.nom
                    });
                }
                
                rowIndex++;
            }
        }
    }
    
    if (dataToInsert.length === 0) {
        alert('‚ö†Ô∏è Aucune donn√©e √† enregistrer');
        return;
    }
    
    if (!confirm('üíæ Enregistrer ' + dataToInsert.length + ' lignes ?')) {
        return;
    }
    
    try {
        const { data: insertedData, error } = await supabase
            .from('alphabetisation')
            .upsert(dataToInsert, { 
                onConflict: 'annee_scolaire,periode,region,prefecture,zone,genre',
                ignoreDuplicates: false 
            })
            .select();
        
        if (error) throw error;
        
        if (insertedData) {
            for (var i = 0; i < insertedData.length; i++) {
                var found = false;
                for (var j = 0; j < alphabetisationData.length; j++) {
                    if (alphabetisationData[j].id === insertedData[i].id) {
                        alphabetisationData[j] = insertedData[i];
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    alphabetisationData.unshift(insertedData[i]);
                }
            }
        }
        
        alert('‚úÖ Donn√©es enregistr√©es avec succ√®s !');
        closeModal();
        render();
        
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}
function rechargerFormulaireStatistiques() {
    console.log('üîÑ Rechargement du formulaire...');
    
    // R√©cup√©rer les valeurs actuelles
    var annee = document.getElementById('global-annee') ? document.getElementById('global-annee').value : '2025-2026';
    var periode = document.getElementById('global-periode') ? document.getElementById('global-periode').value : 'T1';
    var filterRegion = document.getElementById('filter-region') ? document.getElementById('filter-region').value : '';
    var filterPrefecture = document.getElementById('filter-prefecture') ? document.getElementById('filter-prefecture').value : '';
    
    console.log('P√©riode s√©lectionn√©e:', periode);
    
    // Fermer et rouvrir le modal avec les m√™mes param√®tres
    showStatistiquesModal();
    
    // Restaurer les valeurs apr√®s rechargement
    setTimeout(function() {
        if (document.getElementById('global-annee')) {
            document.getElementById('global-annee').value = annee;
        }
        if (document.getElementById('global-periode')) {
            document.getElementById('global-periode').value = periode;
        }
        if (document.getElementById('filter-region')) {
            document.getElementById('filter-region').value = filterRegion;
            updateFormFilters(); // Mettre √† jour les pr√©fectures
        }
        if (document.getElementById('filter-prefecture')) {
            document.getElementById('filter-prefecture').value = filterPrefecture;
            filterTableRows();
        }
    }, 100);
}

function updatePrefecturesDropdown() {
    var regionId = document.getElementById('stat-region').value;
    var prefectureSelect = document.getElementById('stat-prefecture');
    
    prefectureSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
    
    if (regionId) {
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
    }
}
function updatePreuveActivites() {
    var objectif = document.getElementById('preuve-objectif').value;
    var activiteSelect = document.getElementById('preuve-activite');
    
    activiteSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
    
    if (!objectif) return;
    
    var activitesFiltrees = [];
    for (var i = 0; i < data.length; i++) {
    var act = data[i];        
        // V√©rifier si l'activit√© est valid√©e ET termin√©e √† 100%
        var taux = calcTaux(act);
        var estTerminee = taux === 100;
        
        if (act.valide && estTerminee && act.categorie === objectif) {
            if (currentUser.role === 'admin' || currentUser.role === 'chefdept' || act.service === currentUser.service) {
                activitesFiltrees.push(act);
            }
        }
    }
    
    if (activitesFiltrees.length === 0) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Aucune activit√© termin√©e √† 100%';
        option.disabled = true;
        activiteSelect.appendChild(option);
        return;
    }
    
    for (var i = 0; i < activitesFiltrees.length; i++) {
        var option = document.createElement('option');
        option.value = activitesFiltrees[i].activite;
        option.textContent = activitesFiltrees[i].activite + ' (' + activitesFiltrees[i].service + ')';
        option.setAttribute('data-service', activitesFiltrees[i].service);
        activiteSelect.appendChild(option);
    }
}


async function submitStatistiquesTableau(forcerMiseAJour) {
    forcerMiseAJour = forcerMiseAJour || false;
    
    var annee = document.getElementById('global-annee').value.trim();
    var periode = document.getElementById('global-periode').value;
    
    if (!annee || !periode) {
        alert('‚ö†Ô∏è Veuillez remplir ann√©e et p√©riode');
        return;
    }
    
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Pr√©scolaire', 'Primaire', 'Secondaire'];
    var dataToInsert = [];
    var rowIndex = 0;
    
    // Parcourir toutes les lignes
    for (var r = 0; r < regionsData.length; r++) {
        var region = regionsData[r];
        var prefecturesRegion = [];
        
        for (var p = 0; p < prefecturesData.length; p++) {
            if (prefecturesData[p].region_id == region.id) {
                prefecturesRegion.push(prefecturesData[p]);
            }
        }
        
        for (var p = 0; p < prefecturesRegion.length; p++) {
            var prefecture = prefecturesRegion[p];
            
            for (var z = 0; z < zones.length; z++) {
                var zone = zones[z];
                
                // ========== LIGNES PAR NIVEAU (3 lignes) ==========
                for (var n = 0; n < niveaux.length; n++) {
                    var niveau = niveaux[n];
                    
                    // R√©cup√©rer les valeurs des inputs PAR NIVEAU
                    var inputAbandonT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_total"][data-type="niveau"]');
                    var inputAbandonF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_filles"][data-type="niveau"]');
                    var inputReussiteT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="reussite_total"][data-type="niveau"]');
                    var inputReussiteF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="reussite_filles"][data-type="niveau"]');
                    var inputScolarisationT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_total"][data-type="niveau"]');
                    var inputScolarisationF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_filles"][data-type="niveau"]');
                    var inputRatioEns = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_ens"][data-type="niveau"]');
                    var inputRatioClasse = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_classe"][data-type="niveau"]');
                    var inputDistance = document.querySelector('input[data-row="' + rowIndex + '"][data-field="distance"][data-type="niveau"]');
                    
                    // V√©rifier si d√©j√† enregistr√©
                    var alreadySavedT = inputAbandonT && inputAbandonT.getAttribute('data-saved') === 'true';
                    var alreadySavedF = inputAbandonF && inputAbandonF.getAttribute('data-saved') === 'true';
                    
                    // Si forcerMiseAJour, on collecte m√™me si d√©j√† saved
                    var abandonT = inputAbandonT && inputAbandonT.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputAbandonT.value) : null;
                    var abandonF = inputAbandonF && inputAbandonF.value && (!alreadySavedF || forcerMiseAJour) ? parseFloat(inputAbandonF.value) : null;
                    var reussiteT = inputReussiteT && inputReussiteT.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputReussiteT.value) : null;
                    var reussiteF = inputReussiteF && inputReussiteF.value && (!alreadySavedF || forcerMiseAJour) ? parseFloat(inputReussiteF.value) : null;
                    var scolarisationT = inputScolarisationT && inputScolarisationT.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputScolarisationT.value) : null;
                    var scolarisationF = inputScolarisationF && inputScolarisationF.value && (!alreadySavedF || forcerMiseAJour) ? parseFloat(inputScolarisationF.value) : null;
                    var ratioEns = inputRatioEns && inputRatioEns.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputRatioEns.value) : null;
                    var ratioClasse = inputRatioClasse && inputRatioClasse.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputRatioClasse.value) : null;
                    var distance = inputDistance && inputDistance.value && (!alreadySavedT || forcerMiseAJour) ? parseFloat(inputDistance.value) : null;
                    
                    // Cr√©er enregistrement Total
                    if ((!alreadySavedT || forcerMiseAJour) && (abandonT !== null || reussiteT !== null || scolarisationT !== null || ratioEns !== null || ratioClasse !== null || distance !== null)) {
                        dataToInsert.push({
                            annee_scolaire: annee,
                            periode: periode,
                            region: region.nom,
                            prefecture: prefecture.nom,
                            zone: zone,
                            niveau: niveau,
                            genre: 'Total',
                            taux_abandon: abandonT,
                            taux_reussite_examens: reussiteT,
                            taux_scolarisation: scolarisationT,
                            taux_alphabetisation: null,
                            ratio_eleves_enseignant: ratioEns,
                            ratio_eleves_classe: ratioClasse,
                            distance_moyenne_ecole_domicile: distance,
                            saisi_par: currentUser.nom
                        });
                        
                        // Marquer comme enregistr√©
                        if (inputAbandonT) { inputAbandonT.setAttribute('data-saved', 'true'); }
                        if (inputReussiteT) { inputReussiteT.setAttribute('data-saved', 'true'); }
                        if (inputScolarisationT) { inputScolarisationT.setAttribute('data-saved', 'true'); }
                        if (inputRatioEns) { inputRatioEns.setAttribute('data-saved', 'true'); }
                        if (inputRatioClasse) { inputRatioClasse.setAttribute('data-saved', 'true'); }
                        if (inputDistance) { inputDistance.setAttribute('data-saved', 'true'); }
                    }
                    
                    // Cr√©er enregistrement Filles
                    if ((!alreadySavedF || forcerMiseAJour) && (abandonF !== null || reussiteF !== null || scolarisationF !== null)) {
                        dataToInsert.push({
                            annee_scolaire: annee,
                            periode: periode,
                            region: region.nom,
                            prefecture: prefecture.nom,
                            zone: zone,
                            niveau: niveau,
                            genre: 'Filles',
                            taux_abandon: abandonF,
                            taux_reussite_examens: reussiteF,
                            taux_scolarisation: scolarisationF,
                            taux_alphabetisation: null,
                            ratio_eleves_enseignant: null,
                            ratio_eleves_classe: null,
                            distance_moyenne_ecole_domicile: null,
                            saisi_par: currentUser.nom
                        });
                        
                        // Marquer comme enregistr√©
                        if (inputAbandonF) { inputAbandonF.setAttribute('data-saved', 'true'); }
                        if (inputReussiteF) { inputReussiteF.setAttribute('data-saved', 'true'); }
                        if (inputScolarisationF) { inputScolarisationF.setAttribute('data-saved', 'true'); }
                    }
                    
                    rowIndex++;
                }
                
                // ========== LIGNE PAR ZONE (alphab√©tisation) ==========
                var inputAlphabetisationT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alphabetisation_total"][data-type="zone"]');
                var inputAlphabetisationF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alphabetisation_filles"][data-type="zone"]');
                
                var alreadySavedAlphaT = inputAlphabetisationT && inputAlphabetisationT.getAttribute('data-saved') === 'true';
                var alreadySavedAlphaF = inputAlphabetisationF && inputAlphabetisationF.getAttribute('data-saved') === 'true';
                
                var alphabetisationT = inputAlphabetisationT && inputAlphabetisationT.value && (!alreadySavedAlphaT || forcerMiseAJour) ? parseFloat(inputAlphabetisationT.value) : null;
                var alphabetisationF = inputAlphabetisationF && inputAlphabetisationF.value && (!alreadySavedAlphaF || forcerMiseAJour) ? parseFloat(inputAlphabetisationF.value) : null;
                
                // Cr√©er enregistrement alphab√©tisation Total
                if ((!alreadySavedAlphaT || forcerMiseAJour) && alphabetisationT !== null) {
                    dataToInsert.push({
                        annee_scolaire: annee,
                        periode: periode,
                        region: region.nom,
                        prefecture: prefecture.nom,
                        zone: zone,
                        niveau: 'Alphab√©tisation',
                        genre: 'Total',
                        taux_abandon: null,
                        taux_reussite_examens: null,
                        taux_scolarisation: null,
                        taux_alphabetisation: alphabetisationT,
                        ratio_eleves_enseignant: null,
                        ratio_eleves_classe: null,
                        distance_moyenne_ecole_domicile: null,
                        saisi_par: currentUser.nom
                    });
                    
                    if (inputAlphabetisationT) { inputAlphabetisationT.setAttribute('data-saved', 'true'); }
                }
                
                // Cr√©er enregistrement alphab√©tisation Filles
                if ((!alreadySavedAlphaF || forcerMiseAJour) && alphabetisationF !== null) {
                    dataToInsert.push({
                        annee_scolaire: annee,
                        periode: periode,
                        region: region.nom,
                        prefecture: prefecture.nom,
                        zone: zone,
                        niveau: 'Alphab√©tisation',
                        genre: 'Filles',
                        taux_abandon: null,
                        taux_reussite_examens: null,
                        taux_scolarisation: null,
                        taux_alphabetisation: alphabetisationF,
                        ratio_eleves_enseignant: null,
                        ratio_eleves_classe: null,
                        distance_moyenne_ecole_domicile: null,
                        saisi_par: currentUser.nom
                    });
                    
                    if (inputAlphabetisationF) { inputAlphabetisationF.setAttribute('data-saved', 'true'); }
                }
                
                rowIndex++;
            }
        }
    }
    
    if (dataToInsert.length === 0) {
        if (forcerMiseAJour) {
            alert('‚ö†Ô∏è Aucune donn√©e √† mettre √† jour.\n\nModifiez au moins un champ avant de mettre √† jour.');
        } else {
            alert('‚ö†Ô∏è Aucune nouvelle donn√©e √† enregistrer.\n\nUtilisez le bouton "Mettre √† jour" pour modifier des donn√©es existantes.');
        }
        return;
    }
    
    var message = forcerMiseAJour 
        ? 'üîÑ Vous allez mettre √† jour ' + dataToInsert.length + ' lignes.\n\nContinuer ?' 
        : 'üíæ Vous allez enregistrer ' + dataToInsert.length + ' nouvelles lignes.\n\nContinuer ?';
    
    if (!confirm(message)) {
        return;
    }
    
    try {
        // Ins√©rer/Mettre √† jour par lots de 50
        var batchSize = 50;
        var totalProcessed = 0;
        
        for (var i = 0; i < dataToInsert.length; i += batchSize) {
            var batch = dataToInsert.slice(i, i + batchSize);
            
            const { data: processedData, error } = await supabase
                .from('statistiques_educatives')
                .upsert(batch, { 
                    onConflict: 'annee_scolaire,periode,region,prefecture,zone,niveau,genre',
                    ignoreDuplicates: false 
                })
                .select();
            
            if (error) throw error;
            
            if (processedData) {
                totalProcessed += processedData.length;
                
                // Mettre √† jour le tableau local
                for (var j = 0; j < processedData.length; j++) {
                    var found = false;
                    for (var k = 0; k < statistiquesData.length; k++) {
                        if (statistiquesData[k].id === processedData[j].id) {
                            statistiquesData[k] = processedData[j];
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        statistiquesData.unshift(processedData[j]);
                    }
                }
            }
        }
        
        var successMessage = forcerMiseAJour 
            ? '‚úÖ ' + totalProcessed + ' statistiques mises √† jour avec succ√®s !'
            : '‚úÖ ' + totalProcessed + ' statistiques enregistr√©es avec succ√®s !';
        
        alert(successMessage);
        closeModal();
        render();
        
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}

function updateProgression() {
    var totalInputs = document.querySelectorAll('input[data-field]:not([disabled])').length;
    var savedInputs = document.querySelectorAll('input[data-saved="true"]').length;
    var pourcentage = totalInputs > 0 ? Math.round((savedInputs / totalInputs) * 100) : 0;
    
    var progressElement = document.getElementById('progression-saisie');
    if (progressElement) {
        progressElement.textContent = 'üìä Progression : ' + savedInputs + '/' + totalInputs + ' champs (' + pourcentage + '%)';
        progressElement.style.color = pourcentage === 100 ? '#4caf50' : '#ff9800';
        progressElement.style.fontWeight = 'bold';
    }
}
function filterStatistiquesByPeriode() {
    var periodeFilter = document.getElementById('filter-periode-cumulative') ? document.getElementById('filter-periode-cumulative').value : 'TOUS';
    
    console.log('=== FILTRAGE P√âRIODE CUMULATIF ===');
    console.log('P√©riode s√©lectionn√©e:', periodeFilter);
    
    // D√©finir les p√©riodes incluses
    var periodesIncluses = [];
    if (periodeFilter === 'TOUS') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    } else if (periodeFilter === 'T1') {
        periodesIncluses = ['T1'];
    } else if (periodeFilter === 'T2') {
        periodesIncluses = ['T1', 'T2'];
    } else if (periodeFilter === 'T3') {
        periodesIncluses = ['T1', 'T2', 'T3'];
    } else if (periodeFilter === 'T4') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4'];
    } else if (periodeFilter === 'Annuel') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    }
    
    console.log('P√©riodes incluses:', periodesIncluses);
    
    // Filtrer les inputs par p√©riode
    var allInputs = document.querySelectorAll('input[data-field][data-periode]');
    var inputsAffichesCount = 0;
    
    for (var i = 0; i < allInputs.length; i++) {
        var input = allInputs[i];
        var inputPeriode = input.getAttribute('data-periode');
        
        if (periodesIncluses.indexOf(inputPeriode) !== -1) {
            input.style.display = '';
            inputsAffichesCount++;
        } else {
            input.style.display = 'none';
        }
    }
    
    // Filtrer aussi les lignes
    var rows = document.querySelectorAll('.stat-row');
    var rowsVisibles = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var rowPeriode = row.getAttribute('data-periode');
        
        if (rowPeriode && periodesIncluses.indexOf(rowPeriode) !== -1) {
            row.style.display = '';
            rowsVisibles++;
        } else if (!rowPeriode) {
            // Si pas de p√©riode d√©finie, afficher la ligne (donn√©es non encore saisies)
            row.style.display = '';
            rowsVisibles++;
        }
    }
    
    console.log('Inputs affich√©s:', inputsAffichesCount);
    console.log('Lignes visibles:', rowsVisibles);
    
    // Mettre √† jour les cartes d'indicateurs
    updateCartesIndicateurs(periodesIncluses);
}
function updateCartesIndicateurs(periodesIncluses) {
    console.log('=== MISE √Ä JOUR DES CARTES ===');
    
    // Filtrer statistiquesData selon les p√©riodes incluses
    var dataFiltree = [];
    for (var i = 0; i < statistiquesData.length; i++) {
        if (periodesIncluses.indexOf(statistiquesData[i].periode) !== -1) {
            dataFiltree.push(statistiquesData[i]);
        }
    }
    
    console.log('Donn√©es filtr√©es:', dataFiltree.length, 'sur', statistiquesData.length);
    
    // Recalculer les moyennes
    var moyenneAbandon = calculerMoyenne(dataFiltree, 'taux_abandon');
    var moyenneReussite = calculerMoyenne(dataFiltree, 'taux_reussite_examens');
    var moyenneScolarisation = calculerMoyenne(dataFiltree, 'taux_scolarisation');
    var moyenneAlphabetisation = calculerMoyenne(dataFiltree, 'taux_alphabetisation');
    var moyenneRatioEnseignant = calculerMoyenne(dataFiltree, 'ratio_eleves_enseignant');
    var moyenneRatioClasse = calculerMoyenne(dataFiltree, 'ratio_eleves_classe');
    var moyenneDistance = calculerMoyenne(dataFiltree, 'distance_moyenne_ecole_domicile');
    
    // Mettre √† jour les valeurs affich√©es dans les cartes
    var cartes = document.querySelectorAll('.card-value');
    if (cartes.length >= 7) {
        cartes[0].textContent = moyenneAbandon + '%';
        cartes[1].textContent = moyenneReussite + '%';
        cartes[2].textContent = moyenneScolarisation + '%';
        cartes[3].textContent = moyenneAlphabetisation + '%';
        cartes[4].textContent = moyenneRatioEnseignant;
        cartes[5].textContent = moyenneRatioClasse;
        cartes[6].textContent = moyenneDistance;
    }
    
    console.log('Cartes mises √† jour');
}

async function deleteStatistique(id) {
    if (!confirm('Supprimer cette statistique ?')) return;
    
    try {
        const { error } = await supabase
            .from('statistiques_educatives')
            .delete()
            .eq('id', id);
        
        if (error) throw error;
        
        statistiquesData = statistiquesData.filter(s => s.id !== id);
        render();
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur lors de la suppression');
    }
}
function updateStatsPrefectureDropdown() {
    var regionId = document.getElementById('filter-stats-region') ? document.getElementById('filter-stats-region').value : '';
    var prefectureSelect = document.getElementById('filter-stats-prefecture');
    
    if (!prefectureSelect) return;
    
    // Vider et reconstruire les options
    prefectureSelect.innerHTML = '<option value="">Toutes les pr√©fectures</option>';
    
    if (regionId) {
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
    }
}
       
function appliquerFiltresStatistiques() {
    console.log('=== APPLICATION DES FILTRES STATISTIQUES ===');
    
    // R√©cup√©rer tous les filtres
    var periodeFilter = document.getElementById('filter-stats-periode') ? document.getElementById('filter-stats-periode').value : 'TOUS';
    var regionId = document.getElementById('filter-stats-region') ? document.getElementById('filter-stats-region').value : '';
    var prefecture = document.getElementById('filter-stats-prefecture') ? document.getElementById('filter-stats-prefecture').value : '';
    var zone = document.getElementById('filter-stats-zone') ? document.getElementById('filter-stats-zone').value : '';
    var niveau = document.getElementById('filter-stats-niveau') ? document.getElementById('filter-stats-niveau').value : '';
    var genre = document.getElementById('filter-stats-genre') ? document.getElementById('filter-stats-genre').value : '';
    
    console.log('Filtres:', {periodeFilter, regionId, prefecture, zone, niveau, genre});
    
    // D√©finir les p√©riodes incluses (cumulatif)
    var periodesIncluses = [];
    if (periodeFilter === 'TOUS') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    } else if (periodeFilter === 'T1') {
        periodesIncluses = ['T1'];
    } else if (periodeFilter === 'T2') {
        periodesIncluses = ['T1', 'T2'];
    } else if (periodeFilter === 'T3') {
        periodesIncluses = ['T1', 'T2', 'T3'];
    } else if (periodeFilter === 'T4') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4'];
    } else if (periodeFilter === 'Annuel') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    }
    
    // Trouver le nom de la r√©gion si un ID est s√©lectionn√©
    var regionNom = '';
    if (regionId) {
        for (var i = 0; i < regionsData.length; i++) {
            if (regionsData[i].id == regionId) {
                regionNom = regionsData[i].nom;
                break;
            }
        }
    }
    
    // Filtrer les donn√©es POUR LES TAUX (Genre inclus)
    var dataFiltreeTaux = [];
    for (var i = 0; i < statistiquesData.length; i++) {
        var stat = statistiquesData[i];
        
        // Filtre p√©riode
        if (periodesIncluses.indexOf(stat.periode) === -1) continue;
        
        // Filtre r√©gion
        if (regionNom && stat.region !== regionNom) continue;
        
        // Filtre pr√©fecture
        if (prefecture && stat.prefecture !== prefecture) continue;
        
        // Filtre zone
        if (zone && stat.zone !== zone) continue;
        
        // Filtre niveau
        if (niveau && stat.niveau !== niveau) continue;
        
        // Filtre genre (pour les taux)
        if (genre && stat.genre !== genre) continue;
        
        dataFiltreeTaux.push(stat);
    }
    
    // Filtrer les donn√©es POUR LES RATIOS/DISTANCE (Genre ignor√©, seulement Total)
    var dataFiltreeRatios = [];
    for (var i = 0; i < statistiquesData.length; i++) {
        var stat = statistiquesData[i];
        
        // Filtre p√©riode
        if (periodesIncluses.indexOf(stat.periode) === -1) continue;
        
        // Filtre r√©gion
        if (regionNom && stat.region !== regionNom) continue;
        
        // Filtre pr√©fecture
        if (prefecture && stat.prefecture !== prefecture) continue;
        
        // Filtre zone
        if (zone && stat.zone !== zone) continue;
        
        // Filtre niveau
        if (niveau && stat.niveau !== niveau) continue;
        
        // SEULEMENT Total pour les ratios
        if (stat.genre !== 'Total') continue;
        
        dataFiltreeRatios.push(stat);
    }
    
    console.log('Donn√©es filtr√©es - Taux:', dataFiltreeTaux.length);
    console.log('Donn√©es filtr√©es - Ratios:', dataFiltreeRatios.length);
    
    // Calculer les moyennes POUR LES TAUX
    var moyenneAbandon = calculerMoyenne(dataFiltreeTaux, 'taux_abandon');
    var moyenneReussite = calculerMoyenne(dataFiltreeTaux, 'taux_reussite_examens');
    var moyenneScolarisation = calculerMoyenne(dataFiltreeTaux, 'taux_scolarisation');
    var moyenneAlphabetisation = calculerMoyenne(dataFiltreeTaux, 'taux_alphabetisation');
    
    // Calculer les moyennes POUR LES RATIOS/DISTANCE
    var moyenneRatioEnseignant = calculerMoyenne(dataFiltreeRatios, 'ratio_eleves_enseignant');
    var moyenneRatioClasse = calculerMoyenne(dataFiltreeRatios, 'ratio_eleves_classe');
    var moyenneDistance = calculerMoyenne(dataFiltreeRatios, 'distance_moyenne_ecole_domicile');
    
    // Mettre √† jour l'affichage des cartes
    var cards = document.querySelectorAll('.card');
    if (cards.length >= 7) {
        // Carte 1 : Taux abandon
        var value = cards[0].querySelector('.card-value');
        if (value) value.textContent = moyenneAbandon + '%';
        
        // Carte 2 : Taux r√©ussite
        value = cards[1].querySelector('.card-value');
        if (value) value.textContent = moyenneReussite + '%';
        
        // Carte 3 : Taux scolarisation
        value = cards[2].querySelector('.card-value');
        if (value) value.textContent = moyenneScolarisation + '%';
        
        // Carte 4 : Taux alphab√©tisation
        value = cards[3].querySelector('.card-value');
        if (value) value.textContent = moyenneAlphabetisation + '%';
        
        // Carte 5 : Ratio enseignant (Genre ignor√©)
        value = cards[4].querySelector('.card-value');
        if (value) value.textContent = moyenneRatioEnseignant;
        
        // Carte 6 : Ratio classe (Genre ignor√©)
        value = cards[5].querySelector('.card-value');
        if (value) value.textContent = moyenneRatioClasse;
        
        // Carte 7 : Distance (Genre ignor√©)
        value = cards[6].querySelector('.card-value');
        if (value) value.textContent = moyenneDistance;
    }
    
    console.log('Cartes mises √† jour');
    console.log('========================================');
}
// ========== PERMISSIONS ONGLET STATISTIQUES ========== function canAccessStatistiques() { if (!currentUser) return false; if (currentUser.role === 'admin') return true; if (currentUser.role === 'chefdept') return true; // Lecture seule if (currentUser.service === 'BSD') return true; if (currentUser.service === 'DGECS') return true; if (currentUser.service === 'DNAEFP-LN') return true; return false; }
function canSaisirStatsGenerales() {
if (!currentUser) return false;
if (currentUser.role === 'admin') return true;
if (currentUser.service === 'BSD') return true;
return false;
}
function canSaisirExamens() {
if (!currentUser) return false;
if (currentUser.role === 'admin') return true;
if (currentUser.service === 'DGECS') return true;
return false;
}
function canSaisirAlphabetisation() {
if (!currentUser) return false;
if (currentUser.role === 'admin') return true;
if (currentUser.service === 'DNAEFP-LN') return true;
return false;
}
        // ========== FONCTION RENDER PRINCIPALE 
function render() {
            var app = document.getElementById('app');
            
if (!currentUser) {
    // SI TOKEN D'INVITATION : Afficher formulaire d'inscription
    if (invitationData) {
        app.innerHTML = '<div class="modal"><div class="modal-content" style="max-width: 550px;"><h2 style="text-align: center; margin-bottom: 24px;">üèõÔ∏è Cr√©er votre compte</h2><div class="alert alert-info" style="text-align: center;">Bienvenue ! Compl√©tez votre inscription</div><div class="username-display"><label>Nom d\'utilisateur attribu√©</label><div class="username" id="usernameDisplay">' + invitationData.username + '</div></div><div class="form-group"><label>Adresse email *</label><input type="email" id="signup-email" class="form-control" placeholder="votre.email@example.com"></div><div class="form-group"><label>Mot de passe *</label><input type="password" id="signup-password" class="form-control" placeholder="Minimum 8 caract√®res"></div><div class="form-group"><label>Confirmer le mot de passe *</label><input type="password" id="signup-confirm-password" class="form-control" placeholder="Confirmez votre mot de passe"></div><button class="btn btn-primary" style="width: 100%;" onclick="submitSignupWithInvitation()">Cr√©er mon compte</button></div></div>';
    } else {
        // SINON : Afficher formulaire de connexion normal
        app.innerHTML = '<div class="modal"><div class="modal-content" style="max-width: 550px;"><h2 style="text-align: center; margin-bottom: 24px;">üèõÔ∏è Gestion MEPUA</h2><div class="alert alert-info" style="text-align: center;">Bienvenue sur le syst√®me de gestion d√©partementale</div><div class="form-group"><label>Nom d\'utilisateur</label><input type="text" id="username" class="form-control" placeholder="Entrez votre nom d\'utilisateur"></div><div class="form-group"><label>Mot de passe</label><input type="password" id="password" class="form-control" placeholder="Entrez votre mot de passe"></div><button class="btn btn-primary" style="width: 100%;" onclick="attemptLogin()">Se connecter</button><div style="margin-top: 16px; padding: 12px; background-color: #fef3c7; border-radius: 8px; font-size: 12px; text-align: center; color: #92400e;"><strong>‚ö†Ô∏è Premi√®re connexion ?</strong><br/>Utilisez votre mot de passe provisoire et changez-le apr√®s connexion.</div></div></div>';
    }
                
                var passwordInput = document.getElementById('password');
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') attemptLogin();
                    });
                }
                return;
            }

            var html = '<div class="header"><h1>Gestion D√©partementale</h1><div class="header-right"><span>' + currentUser.nom;
            if (currentUser.service !== 'TOUS') {
                html += '<span class="service-badge">' + currentUser.service + '</span>';
            }
            html += '</span><button class="btn btn-secondary" onclick="logout()">D√©connexion</button></div></div>';

            html += '<div class="nav">';
            html += '<button class="' + (activeTab === 'dashboard' ? 'active' : '') + '" onclick="changeTab(\'dashboard\')">Tableau de Bord</button>';
            html += '<button class="' + (activeTab === 'planning' ? 'active' : '') + '" onclick="changeTab(\'planning\')">Planification</button>';
            html += '<button class="' + (activeTab === 'suivi' ? 'active' : '') + '" onclick="changeTab(\'suivi\')">Suivi-√âvaluation</button>';
            html += '<button class="' + (activeTab === 'commentaires' ? 'active' : '') + '" onclick="changeTab(\'commentaires\')">Commentaires et Preuves</button>';
            html += '<button class="' + (activeTab === 'rapport' ? 'active' : '') + '" onclick="changeTab(\'rapport\')">Rapport de performance</button>';

// Onglet Statistiques (visible pour DG du BSD, Chef D√©p, Admin)
if (currentUser.role === 'admin' || currentUser.role === 'chefdept' || ['BSD', 'DGECS', 'DNAEFP-LN'].indexOf(currentUser.service) !== -1) {
    html += '<button class="' + (activeTab === 'statistiques' ? 'active' : '') + '" onclick="changeTab(\'statistiques\')">üìä Statistiques</button>';
}
// Onglet Analyse (visible pour Admin, Chef D√©p, et chefs de service)
if (currentUser.role === 'admin' || currentUser.role === 'chefdept' || currentUser.role === 'chef') {
    html += '<button class="' + (activeTab === 'analyse' ? 'active' : '') + '" onclick="changeTab(\'analyse\')">üîç Analyse</button>';
}

            if (currentUser.role === 'admin') {
                html += '<button class="' + (activeTab === 'admin' ? 'active' : '') + '" onclick="changeTab(\'admin\')">Administration</button>';
            }
            html += '</div>';
// Afficher le filtre service SAUF dans l'onglet statistiques
if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && activeTab !== 'statistiques') {
    html += '<div style="background-color: white; padding: 12px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="max-width: 1280px; margin: 0 auto; display: flex; align-items: center; gap: 16px;"><label style="font-weight: bold; font-size: 14px;">Filtrer:</label><select onchange="changeServiceFilter(this.value)" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px;"><option value="TOUS"' + (selectedServiceFilter === 'TOUS' ? ' selected' : '') + '>Tous les services</option>';
    
    for (var i = 0; i < services.length; i++) {
        html += '<option value="' + services[i] + '"' + (selectedServiceFilter === services[i] ? ' selected' : '') + '>' + services[i] + '</option>';
    }
    
    html += '</select>';
    if (selectedServiceFilter !== 'TOUS') {
        html += '<button onclick="changeServiceFilter(\'TOUS\')" style="padding: 6px 12px; background-color: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">R√©initialiser</button>';
    }
    html += '</div></div>';
}
            html += '<div class="main">';
// ========== ONGLET 1 : TABLEAU DE BORD ==========
            if (activeTab === 'dashboard') {
                html += '<h2 style="margin-bottom: 16px;">Tableau de Bord</h2>';
                
                html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">';
                
                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üìä Statut</label><select onchange="changeStatusFilter(this.value)" class="form-control"><option value="TOUS"' + (selectedStatusFilter === 'TOUS' ? ' selected' : '') + '>Tous les statuts</option><option value="Non commenc√©e"' + (selectedStatusFilter === 'Non commenc√©e' ? ' selected' : '') + '>Non commenc√©e</option><option value="En cours"' + (selectedStatusFilter === 'En cours' ? ' selected' : '') + '>En cours</option><option value="Ex√©cut√©e"' + (selectedStatusFilter === 'Ex√©cut√©e' ? ' selected' : '') + '>Ex√©cut√©e</option></select></div>';
                
                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Objectif</label><select onchange="changeDashboardObjectifFilter(this.value)" class="form-control"><option value="TOUS"' + (selectedObjectifFilter === 'TOUS' ? ' selected' : '') + '>Tous les objectifs</option><option value="Objectifs G√©n√©raux"' + (selectedObjectifFilter === 'Objectifs G√©n√©raux' ? ' selected' : '') + '>Objectifs G√©n√©raux</option><option value="Objectifs de R√©forme"' + (selectedObjectifFilter === 'Objectifs de R√©forme' ? ' selected' : '') + '>Objectifs de R√©forme</option><option value="Objectifs Sp√©cifiques"' + (selectedObjectifFilter === 'Objectifs Sp√©cifiques' ? ' selected' : '') + '>Objectifs Sp√©cifiques</option><option value="D√©cisions du CM"' + (selectedObjectifFilter === 'D√©cisions du CM' ? ' selected' : '') + '>D√©cisions du CM</option><option value="D√©cisions du PR"' + (selectedObjectifFilter === 'D√©cisions du PR' ? ' selected' : '') + '>D√©cisions du PR</option></select></div>';
                
                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üìÖ Trimestre (cumul√©)</label><select onchange="changeDashboardTrimestreFilter(this.value)" class="form-control"><option value="TOUS"' + (selectedTrimestreFilter === 'TOUS' ? ' selected' : '') + '>Toute l\'ann√©e</option><option value="T1"' + (selectedTrimestreFilter === 'T1' ? ' selected' : '') + '>Jusqu\'√† T1</option><option value="T2"' + (selectedTrimestreFilter === 'T2' ? ' selected' : '') + '>Jusqu\'√† T2</option><option value="T3"' + (selectedTrimestreFilter === 'T3' ? ' selected' : '') + '>Jusqu\'√† T3</option><option value="T4"' + (selectedTrimestreFilter === 'T4' ? ' selected' : '') + '>Jusqu\'√† T4</option></select></div>';
                
                html += '</div></div>';
                
                var dashboardData = getFilteredDataForDashboard();
                
                var enCours = 0, terminees = 0, nonCommencees = 0;
                for (var i = 0; i < dashboardData.length; i++) {
                    var taux = calcTaux(dashboardData[i]);
                    if (taux === 100) terminees++;
                    else if (taux > 0) enCours++;
                    else nonCommencees++;
                }
                
                var tauxExecution = dashboardData.length > 0 ? Math.round((terminees / dashboardData.length) * 100) : 0;
                
                html += '<div class="cards">';
                html += '<div class="card card-blue"><div class="card-title" style="color: #2563eb;">Planifi√©es</div><div class="card-value">' + dashboardData.length + '</div></div>';
                html += '<div class="card card-orange"><div class="card-title" style="color: #ea580c;">Non Commenc√©es</div><div class="card-value">' + nonCommencees + '</div></div>';
                html += '<div class="card card-yellow"><div class="card-title" style="color: #d97706;">En Cours</div><div class="card-value">' + enCours + '</div></div>';
                html += '<div class="card card-green"><div class="card-title" style="color: #059669;">Ex√©cut√©es</div><div class="card-value">' + terminees + '</div></div>';
                html += '<div class="card card-rose pastel"><div class="card-title" style="color: #7c3aed;">üìà Taux d\'Ex√©cution</div><div class="card-value">' + tauxExecution + '%</div></div>';
                html += '</div>';
                
                html += '<div class="table-container"><table><thead class="blue"><tr><th>Objectif</th><th>Activit√©</th><th>Service</th><th style="text-align: center; background-color: #1e40af;">T1</th><th style="text-align: center; background-color: #1e40af;">T2</th><th style="text-align: center; background-color: #1e40af;">T3</th><th style="text-align: center; background-color: #1e40af;">T4</th><th style="text-align: center;">TDR</th><th style="text-align: center;">ENGAG√â</th><th style="text-align: center;">MANDAT√â</th><th style="text-align: center;">ORDONNANC√â</th><th style="text-align: center;">LIQUID√â</th><th style="text-align: center;">EX√âCUT√â</th><th style="text-align: center;">TAUX</th></tr></thead><tbody>';
                
                if (dashboardData.length > 0) {
                    for (var i = 0; i < dashboardData.length; i++) {
                        var d = dashboardData[i];
                        var taux = calcTaux(d);
                        var tauxClass = taux === 100 ? 'badge-taux-green' : taux >= 50 ? 'badge-taux-yellow' : 'badge-taux-red';
                        
                        html += '<tr><td><span class="badge badge-blue">' + d.categorie + '</span></td><td>' + d.activite + '</td><td><span class="badge badge-purple">' + d.service + '</span></td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t1 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t2 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t3 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t4 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.tdr ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.eng ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.mand ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.ordo ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.liq ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.exec ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;"><span class="badge-taux ' + tauxClass + '">' + taux + '%</span></td></tr>';
                    }
                } else {
                    html += '<tr><td colspan="14" class="empty-state">Aucune activit√© valid√©e</td></tr>';
                }
                html += '</tbody></table></div>';
            }
// ========== ONGLET 2 : PLANIFICATION ==========
            if (activeTab === 'planning') {
                html += '<div class="flex-between"><h2>Planification 2026</h2>';
                if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                    html += '<button class="btn btn-success" onclick="showAddModal()">+ Ajouter</button>';
                }
                html += '</div>';
                
                var planningData = getFilteredDataForPlanning();
                
                html += '<div class="table-container"><table><thead class="blue"><tr><th>Objectif</th><th>Activit√©</th><th>Service</th><th style="text-align: center;">T1</th><th style="text-align: center;">T2</th><th style="text-align: center;">T3</th><th style="text-align: center;">T4</th><th style="text-align: center;">Statut</th>';
                if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                    html += '<th style="text-align: center;">Actions</th>';
                }
                html += '</tr></thead><tbody>';
                
                if (planningData.length > 0) {
                    for (var i = 0; i < planningData.length; i++) {
                        var d = planningData[i];
                        html += '<tr><td><span class="badge badge-blue">' + d.categorie + '</span></td><td>' + d.activite + '</td><td><span class="badge badge-purple">' + d.service + '</span></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t1 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t1\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t2 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t2\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t3 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t3\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t4 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t4\')"></td>';
                        html += '<td style="text-align: center;">';
                        if (d.valide) html += '<span class="badge" style="background-color: #d1fae5; color: #065f46;">Valid√©e</span>';
                        else html += '<span class="badge" style="background-color: #fef3c7; color: #92400e;">En attente</span>';
                        html += '</td>';
                        
                        if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                            html += '<td style="text-align: center;"><div style="display: flex; gap: 4px; justify-content: center;">';
                            if (canValidate() && !d.valide) {
                                html += '<button class="btn btn-success" style="font-size: 11px; padding: 4px 8px;" onclick="validateActivity(' + d.id + ')">Valider</button>';
                            }
                            if (canDeleteInPlanning(d)) {
                                html += '<button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteActivity(' + d.id + ')">Supprimer</button>';
                            }
                            html += '</div></td>';
                        }
                        html += '</tr>';
                    }
                } else {
                    var colspan = (currentUser.role === 'admin' || currentUser.role === 'chef') ? '9' : '8';
                    html += '<tr><td colspan="' + colspan + '" class="empty-state">Aucune activit√© en planification</td></tr>';
                }
                html += '</tbody></table></div>';
            }

            // ========== ONGLET 3 : SUIVI-√âVALUATION ==========
            if (activeTab === 'suivi') {
                html += '<h2 style="margin-bottom: 16px;">Suivi-√âvaluation 2026</h2>';
                html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">';

                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Objectif</label><select onchange="changeSuiviObjectifFilter(this.value)" class="form-control"><option value="TOUS"' + (suiviObjectifFilter === 'TOUS' ? ' selected' : '') + '>Tous les objectifs</option><option value="Objectifs G√©n√©raux"' + (suiviObjectifFilter === 'Objectifs G√©n√©raux' ? ' selected' : '') + '>Objectifs G√©n√©raux</option><option value="Objectifs de R√©forme"' + (suiviObjectifFilter === 'Objectifs de R√©forme' ? ' selected' : '') + '>Objectifs de R√©forme</option><option value="Objectifs Sp√©cifiques"' + (suiviObjectifFilter === 'Objectifs Sp√©cifiques' ? ' selected' : '') + '>Objectifs Sp√©cifiques</option><option value="D√©cisions du CM"' + (suiviObjectifFilter === 'D√©cisions du CM' ? ' selected' : '') + '>D√©cisions du CM</option><option value="D√©cisions du PR"' + (suiviObjectifFilter === 'D√©cisions du PR' ? ' selected' : '') + '>D√©cisions du PR</option></select></div>';

                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üìÖ Trimestre (cumul√©)</label><select onchange="changeSuiviTrimestreFilter(this.value)" class="form-control"><option value="TOUS"' + (suiviTrimestreFilter === 'TOUS' ? ' selected' : '') + '>Toute l\'ann√©e</option><option value="T1"' + (suiviTrimestreFilter === 'T1' ? ' selected' : '') + '>Jusqu\'√† T1</option><option value="T2"' + (suiviTrimestreFilter === 'T2' ? ' selected' : '') + '>Jusqu\'√† T2</option><option value="T3"' + (suiviTrimestreFilter === 'T3' ? ' selected' : '') + '>Jusqu\'√† T3</option><option value="T4"' + (suiviTrimestreFilter === 'T4' ? ' selected' : '') + '>Jusqu\'√† T4</option></select></div>';

                html += '</div></div>';

                var suiviData = getFilteredDataForSuivi();

                html += '<div class="table-container"><table><thead class="blue"><tr><th>Objectif</th><th>Activit√©</th><th>Service</th><th style="text-align: center; background-color: #1e40af;">T1</th><th style="text-align: center; background-color: #1e40af;">T2</th><th style="text-align: center; background-color: #1e40af;">T3</th><th style="text-align: center; background-color: #1e40af;">T4</th><th style="text-align: center;">TDR</th><th style="text-align: center;">ENGAG√â</th><th style="text-align: center;">MANDAT√â</th><th style="text-align: center;">ORDONNANC√â</th><th style="text-align: center;">LIQUID√â</th><th style="text-align: center;">EX√âCUT√â</th><th style="text-align: center;">TAUX</th></tr></thead><tbody>';

                if (suiviData.length > 0) {
                    for (var i = 0; i < suiviData.length; i++) {
                        var d = suiviData[i];
                        var taux = calcTaux(d);
                        var tauxClass = taux === 100 ? 'badge-taux-green' : taux >= 50 ? 'badge-taux-yellow' : 'badge-taux-red';
                        
                        html += '<tr><td><span class="badge badge-blue">' + d.categorie + '</span></td><td>' + d.activite + '</td><td><span class="badge badge-purple">' + d.service + '</span></td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t1 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t2 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t3 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t4 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.tdr ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'tdr\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.eng ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'eng\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.mand ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'mand\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.ordo ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'ordo\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.liq ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'liq\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.exec ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'exec\')"></td>';
                        html += '<td style="text-align: center;"><span class="badge-taux ' + tauxClass + '">' + taux + '%</span></td></tr>';
                    }
                } else {
                    html += '<tr><td colspan="14" class="empty-state">Aucune activit√© valid√©e</td></tr>';
                }
                html += '</tbody></table></div>';
            }
// ========== ONGLET 4 : COMMENTAIRES ET PREUVES ==========
            if (activeTab === 'commentaires') {
                html += '<div class="flex-between"><h2>üìã Commentaires et Preuves 2026</h2>';
                if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                    html += '<button class="btn btn-primary" onclick="showCommentaireEtPreuveModal()">üìã D√©poser une preuve et Commenter</button>';
                }
                html += '</div>';
                
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;"><div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üè¢ Service</label><select onchange="changeCommentairesServiceFilter(this.value)" class="form-control"><option value="TOUS"' + (commentairesServiceFilter === 'TOUS' ? ' selected' : '') + '>Tous les services</option>';              
                    for (var i = 0; i < services.length; i++) {
                        html += '<option value="' + services[i] + '"' + (commentairesServiceFilter === services[i] ? ' selected' : '') + '>' + services[i] + '</option>';
                    }
                    
                    html += '</select></div><div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Objectif</label><select onchange="changeCommentairesObjectifFilter(this.value)" class="form-control"><option value="TOUS"' + (commentairesObjectifFilter === 'TOUS' ? ' selected' : '') + '>Tous les objectifs</option><option value="Objectifs G√©n√©raux"' + (commentairesObjectifFilter === 'Objectifs G√©n√©raux' ? ' selected' : '') + '>Objectifs G√©n√©raux</option><option value="Objectifs de R√©forme"' + (commentairesObjectifFilter === 'Objectifs de R√©forme' ? ' selected' : '') + '>Objectifs de R√©forme</option><option value="Objectifs Sp√©cifiques"' + (commentairesObjectifFilter === 'Objectifs Sp√©cifiques' ? ' selected' : '') + '>Objectifs Sp√©cifiques</option><option value="D√©cisions du CM"' + (commentairesObjectifFilter === 'D√©cisions du CM' ? ' selected' : '') + '>D√©cisions du CM</option><option value="D√©cisions du PR"' + (commentairesObjectifFilter === 'D√©cisions du PR' ? ' selected' : '') + '>D√©cisions du PR</option></select></div></div></div>';
                }
                
                html += '<div class="table-container"><table><thead class="blue"><tr><th style="width: 15%;">Objectif</th><th style="width: 30%;">Activit√©</th><th style="width: 10%;">Service</th><th style="width: 20%;">Commentaire</th><th style="width: 15%;">Document</th><th style="width: 10%;">Date</th>';
                if (currentUser.role !== 'chefdept') {
                    html += '<th style="text-align: center; width: 4%;">Actions</th>';
                }
                html += '</tr></thead><tbody>';
                
                var commentairesData = [];
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    commentairesData = commentairesEtPreuves;
                } else {
                    for (var i = 0; i < commentairesEtPreuves.length; i++) {
                        if (commentairesEtPreuves[i].service === currentUser.service) {
                            commentairesData.push(commentairesEtPreuves[i]);
                        }
                    }
                }
                
                if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && commentairesServiceFilter !== 'TOUS') {
                    var filtered = [];
                    for (var i = 0; i < commentairesData.length; i++) {
                        if (commentairesData[i].service === commentairesServiceFilter) {
                            filtered.push(commentairesData[i]);
                        }
                    }
                    commentairesData = filtered;
                }
                
                if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && commentairesObjectifFilter !== 'TOUS') {
                    var filtered = [];
                    for (var i = 0; i < commentairesData.length; i++) {
                        if (commentairesData[i].objectif === commentairesObjectifFilter) {
                            filtered.push(commentairesData[i]);
                        }
                    }
                    commentairesData = filtered;
                }
                
                var activitesWithData = {};
                for (var i = 0; i < commentairesData.length; i++) {
                    var key = commentairesData[i].activite + '|' + commentairesData[i].service;
                    if (!activitesWithData[key]) {
                        activitesWithData[key] = {
                            objectif: commentairesData[i].objectif,
                            activite: commentairesData[i].activite,
                            service: commentairesData[i].service,
                            commentaires: [],
                            preuves: []
                        };
                    }
                    
                    if (commentairesData[i].type === 'commentaire') {
                        activitesWithData[key].commentaires.push(commentairesData[i]);
                    } else {
                        activitesWithData[key].preuves.push(commentairesData[i]);
                    }
                }
                
                var hasData = false;
                for (var key in activitesWithData) {
                    hasData = true;
                    var item = activitesWithData[key];
                    
                    html += '<tr>';
                    html += '<td><span class="badge badge-blue">' + item.objectif + '</span></td>';
                    html += '<td>' + item.activite + '</td>';
                    html += '<td><span class="badge badge-purple">' + item.service + '</span></td>';
                    
                    html += '<td>';
                    if (item.commentaires.length > 0) {
                        for (var j = 0; j < item.commentaires.length; j++) {
                            var c = item.commentaires[j];
                            if (j > 0) html += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #e5e7eb;">';
                            html += '<div style="text-align: left; text-align: justify;">' + c.commentaire + '</div>';
                        }
                    } else {
                        html += '-';
                    }
                    html += '</td>';
                    
              html += '<td>';
                if (item.preuves.length > 0) {
                    for (var j = 0; j < item.preuves.length; j++) {
                        var p = item.preuves[j];
                        if (j > 0) html += '<br/>';
                        
                        // üî• CORRECTION - V√©rifier que les propri√©t√©s existent
                        var fileUrl = p.file_url || p.fileUrl || '';
                        var nomFichier = p.nom_fichier || p.nomFichier || 'Fichier';
                        
                        if (fileUrl && nomFichier) {
                            html += '<span style="color: #2563eb; cursor: pointer; text-decoration: underline;" onclick="ouvrirPreuve(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">üìé ' + nomFichier + '</span>';
                        } else {
                            html += '<span style="color: #dc2626;">‚ùå Fichier invalide</span>';
                        }
                    }
                } else {
                    html += '-';
                }
                html += '</td>';

                    html += '</td>';
                    
                    html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    
                    if (currentUser.role !== 'chefdept') {
                        html += '<td style="text-align: center;">';
                        var canManage = currentUser.role === 'admin' || (currentUser.role === 'chef' && item.service === currentUser.service);
                        if (canManage) {
                            html += '<div style="display: flex; flex-direction: column; gap: 4px;">';
                            
                            if (item.commentaires.length > 0) {
                                html += '<button class="btn btn-warning" style="font-size: 11px; padding: 4px 8px;" onclick="showEditCommentaireModal(' + item.commentaires[0].id + ')">‚úèÔ∏è Modifier</button>';
                                html += '<button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteCommentaireOuPreuve(' + item.commentaires[0].id + ')">üóëÔ∏è Suppr. comm.</button>';
                            }
                            
                            if (item.preuves.length > 0) {
                                html += '<button class="btn btn-primary" style="font-size: 11px; padding: 4px 8px;" onclick="showManagePreuvesModal(\'' + item.activite.replace(/'/g, "\\'") + '\', \'' + item.service + '\')">üìé G√©rer (' + item.preuves.length + ')</button>';
                            }
                            
                            html += '</div>';
                        }
                        html += '</td>';
                    }
                    html += '</tr>';
                }
                
                if (!hasData) {
                    var colspan = (currentUser.role !== 'chefdept') ? '7' : '6';
                    html += '<tr><td colspan="' + colspan + '" class="empty-state">Aucun commentaire ou preuve</td></tr>';
                }
                html += '</tbody></table></div>';
            }
// ========== ONGLET 5 : RAPPORT DE PERFORMANCE ==========
            if (activeTab === 'rapport') {
                var isGlobal = currentUser.role === 'chefdept' || (currentUser.role === 'admin' && selectedServiceFilter === 'TOUS');
                var serviceRapport = currentUser.role === 'chef' ? currentUser.service : (isGlobal ? null : selectedServiceFilter);
                
                html += '<div class="flex-between"><h2>üìÑ Rapport de Performance 2026</h2>';
                html += '<div style="display: flex; gap: 8px;">';
                
                html += '<button class="btn btn-primary" onclick="exporterRapportWord()">üì• Export Word</button>';
                html += '<button class="btn btn-success" onclick="exporterDonneesExcel()" style="margin-left: 8px;">üìä Export Excel (Donn√©es)</button>';
                
                if (currentUser.role === 'admin' && !isGlobal) {
                    html += '<button class="btn btn-secondary" onclick="selectedServiceFilter=\'TOUS\'; render();">üìä Rapport global</button>';
                }
                
                html += '</div></div>';
                
                html += '<div id="rapport-content" style="background-color: white; padding: 32px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 16px;">';
                
                var titreRapport = isGlobal ? 'RAPPORT DE PERFORMANCE GLOBAL' : 'RAPPORT DE PERFORMANCE - ' + (serviceRapport || 'SERVICE');
                html += '<h1 style="text-align: center; color: #2563eb; margin-bottom: 24px;">' + titreRapport + '</h1>';
                html += '<p style="text-align: center; color: #6b7280; margin-bottom: 32px;">Ann√©e 2026</p>';
                
                // SECTION 1 : CONTEXTE
                html += '<h2 style="color: #2563eb; margin-top: 32px;">1. √âl√©ments de contexte</h2>';
                var contexteKey = 'contexte_' + (serviceRapport || 'global');
                var contexteValue = rapportTextes[contexteKey] || '';
                
                html += '<textarea id="contexte-text" class="form-control" rows="4" style="margin-top: 16px;" placeholder="Saisissez les √©l√©ments de contexte..." onchange="sauvegarderTexteRapport(\'' + contexteKey + '\', this.value)">' + contexteValue + '</textarea>';
                
                // SECTION 2 : BILAN DES R√âALISATIONS DES OBJECTIFS
                html += '<h2 style="color: #2563eb; margin-top: 32px;">2. Bilan des r√©alisations des objectifs</h2>';
                
                var rappelKey = 'rappel_' + (serviceRapport || 'global');
                var rappelValue = rapportTextes[rappelKey] || '';
                
                html += '<h3 style="margin-top: 16px; color: #4b5563;">Rappel des actions programm√©es</h3>';
                html += '<textarea id="rappel-text" class="form-control" rows="3" style="margin-top: 8px;" placeholder="Rappel..." onchange="sauvegarderTexteRapport(\'' + rappelKey + '\', this.value)">' + rappelValue + '</textarea>';
                
                // TABLEAU 1
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Tableau 1 : Taux par objectif</h3>';
                
                var statsObjectifs = calculerStatsObjectifs(serviceRapport);
                var totalPlanifieesObj = 0;
                var totalRealiseesObj = 0;
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;"><thead class="blue"><tr>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px;">Objectifs</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Planifi√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">R√©alis√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Taux</th>';
                html += '</tr></thead><tbody>';
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    totalPlanifieesObj += stat.planifiees;
                    totalRealiseesObj += stat.realisees;
                    
                    html += '<tr>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">' + stat.objectif + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.planifiees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.realisees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + stat.taux + '%</td>';
                    html += '</tr>';
                }
                
                var tauxTotalObj = totalPlanifieesObj > 0 ? Math.round((totalRealiseesObj / totalPlanifieesObj) * 100) : 0;
                html += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">Total</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalPlanifieesObj + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalRealiseesObj + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + tauxTotalObj + '%</td>';
                html += '</tr>';
                html += '</tbody></table>';
                
                // GRAPHIQUE 1
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Graphique 1 : Taux par objectif</h3>';
                html += '<div style="margin-top: 16px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">';
                
                var couleursGraph1 = ['#87CEEB', '#C6F4D6', '#F7DC6F'];
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    var barColor = couleursGraph1[i];
                    html += '<div style="margin-bottom: 16px;">';
                    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 13px; font-weight: 600;">' + stat.objectif + '</span><span style="font-size: 13px; font-weight: bold; color: ' + barColor + ';">' + stat.taux + '%</span></div>';
                    html += '<div style="width: 100%; height: 24px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                    html += '<div style="width: ' + stat.taux + '%; height: 100%; background-color: ' + barColor + ';"></div>';
                    html += '</div></div>';
                }
                
                var barColorTotalGraph1 = '#f59e0b';
                html += '<div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #cbd5e1;">';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 14px; font-weight: bold;">TOTAL</span><span style="font-size: 14px; font-weight: bold; color: ' + barColorTotalGraph1 + ';">' + tauxTotalObj + '%</span></div>';
                html += '<div style="width: 100%; height: 28px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                html += '<div style="width: ' + tauxTotalObj + '%; height: 100%; background-color: ' + barColorTotalGraph1 + ';"></div>';
                html += '</div></div>';
                
                html += '</div>';
// LISTES DES ACTIVIT√âS PAR OBJECTIF
                var objectifsList = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques'];
                
                for (var j = 0; j < objectifsList.length; j++) {
                    var objNom = objectifsList[j];
                    var activitesObj = getActivitesRealisees(serviceRapport, objNom);
                    
                    html += '<h3 style="margin-top: 32px; color: #2563eb; font-size: 18px;">' + objNom + '</h3>';
                    
                    if (activitesObj.length > 0) {
                        html += '<ul style="list-style-type: disc; margin-left: 24px; margin-top: 12px;">';
                        
                        for (var k = 0; k < activitesObj.length; k++) {
                            var act = activitesObj[k];
                            html += '<li style="margin-bottom: 16px; line-height: 1.6;">';
                            html += '<strong>' + act.activite + '</strong>';
                            
                            var commentaire = getCommentaireForActivite(act.activite, act.service);
                            if (commentaire) {
                                html += '<div style="margin-top: 8px; padding: 8px 12px; background-color: #f3f4f6; font-size: 13px; color: #4b5563; font-style: italic; text-align: justify;">';
                                html += commentaire;
                                html += '</div>';
                            }
                            
                            html += '</li>';
                        }
                        
                        html += '</ul>';
                    } else {
                        html += '<p style="margin-top: 12px; color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e √† 100%.</p>';
                    }
                }
                
                // SECTION 3 : BILAN D'EX√âCUTION DES D√âCISIONS
                html += '<h2 style="color: #2563eb; margin-top: 40px;">3. Bilan d\'ex√©cution des D√©cisions du PR et des CM</h2>';
                var rappelDecKey = 'rappelDec_' + (serviceRapport || 'global');
                var rappelDecValue = rapportTextes[rappelDecKey] || '';
                
                html += '<h3 style="margin-top: 16px; color: #4b5563;">Rappel des d√©cisions</h3>';
                html += '<textarea id="rappelDec-text" class="form-control" rows="3" style="margin-top: 8px;" placeholder="Rappel des d√©cisions..." onchange="sauvegarderTexteRapport(\'' + rappelDecKey + '\', this.value)">' + rappelDecValue + '</textarea>';
                
                // TABLEAU 2
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Tableau 2 : Taux par d√©cision</h3>';
                var statsDecisions = calculerStatsDecisions(serviceRapport);
                
                var totalPlanifieesDec2 = 0;
                var totalRealiseesDec2 = 0;
                for (var i = 0; i < statsDecisions.length; i++) {
                    totalPlanifieesDec2 += statsDecisions[i].planifiees;
                    totalRealiseesDec2 += statsDecisions[i].realisees;
                }
                var tauxTotalDec2 = totalPlanifieesDec2 > 0 ? Math.round((totalRealiseesDec2 / totalPlanifieesDec2) * 100) : 0;
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;"><thead class="blue"><tr>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px;">D√©cisions</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Planifi√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">R√©alis√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Taux</th>';
                html += '</tr></thead><tbody>';
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    html += '<tr>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">' + stat.decision + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.planifiees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.realisees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + stat.taux + '%</td>';
                    html += '</tr>';
                }
                
                html += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">Total</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalPlanifieesDec2 + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalRealiseesDec2 + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + tauxTotalDec2 + '%</td>';
                html += '</tr>';
                
                html += '</tbody></table>';
                
                // GRAPHIQUE 2
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Graphique 2 : Taux par d√©cision</h3>';
                html += '<div style="margin-top: 16px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">';
                
                var couleursGraph2 = ['#87CEEB', '#C6F4D6'];
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    var barColor = couleursGraph2[i];
                    html += '<div style="margin-bottom: 16px;">';
                    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 13px; font-weight: 600;">' + stat.decision + '</span><span style="font-size: 13px; font-weight: bold; color: ' + barColor + ';">' + stat.taux + '%</span></div>';
                    html += '<div style="width: 100%; height: 24px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                    html += '<div style="width: ' + stat.taux + '%; height: 100%; background-color: ' + barColor + ';"></div>';
                    html += '</div></div>';
                }
                
                var barColorTotal = '#f59e0b';
                html += '<div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #cbd5e1;">';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 14px; font-weight: bold;">TOTAL</span><span style="font-size: 14px; font-weight: bold; color: ' + barColorTotal + ';">' + tauxTotalDec2 + '%</span></div>';
                html += '<div style="width: 100%; height: 28px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                html += '<div style="width: ' + tauxTotalDec2 + '%; height: 100%; background-color: ' + barColorTotal + ';"></div>';
                html += '</div></div>';
                
                html += '</div>';
// LISTES DES D√âCISIONS
                var decisionsPR = getActivitesRealisees(serviceRapport, 'D√©cisions du PR');
                var decisionsCM = getActivitesRealisees(serviceRapport, 'D√©cisions du CM');
                
                html += '<h3 style="margin-top: 24px; color: #2563eb; font-size: 18px;">D√©cisions du PR</h3>';
                if (decisionsPR.length > 0) {
                    html += '<ul style="list-style-type: disc; margin-left: 24px; margin-top: 12px;">';
                    for (var k = 0; k < decisionsPR.length; k++) {
                        var act = decisionsPR[k];
                        html += '<li style="margin-bottom: 16px; line-height: 1.6;"><strong>' + act.activite + '</strong>';
                        var commentaire = getCommentaireForActivite(act.activite, act.service);
                        if (commentaire) {
                            html += '<div style="margin-top: 8px; padding: 8px 12px; background-color: #f3f4f6; font-size: 13px; color: #4b5563; font-style: italic; text-align: justify;">' + commentaire + '</div>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p style="margin-top: 12px; color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
                }
                
                html += '<h3 style="margin-top: 24px; color: #2563eb; font-size: 18px;">D√©cisions du CM</h3>';
                if (decisionsCM.length > 0) {
                    html += '<ul style="list-style-type: disc; margin-left: 24px; margin-top: 12px;">';
                    for (var k = 0; k < decisionsCM.length; k++) {
                        var act = decisionsCM[k];
                        html += '<li style="margin-bottom: 16px; line-height: 1.6;"><strong>' + act.activite + '</strong>';
                        var commentaire = getCommentaireForActivite(act.activite, act.service);
                        if (commentaire) {
                            html += '<div style="margin-top: 8px; padding: 8px 12px; background-color: #f3f4f6; font-size: 13px; color: #4b5563; font-style: italic; text-align: justify;">' + commentaire + '</div>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p style="margin-top: 12px; color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
                }
                
                // TABLEAU 3 : VUE GLOBALE
                html += '<h3 style="margin-top: 32px; color: #4b5563;">Tableau 3 : Vue globale</h3>';
                
                var totalPlanifieesDec = 0;
                var totalRealiseesDec = 0;
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    totalPlanifieesDec += statsDecisions[i].planifiees;
                    totalRealiseesDec += statsDecisions[i].realisees;
                }
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;"><thead class="blue"><tr>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px;">Cat√©gories</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Planifi√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">R√©alis√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Taux</th>';
                html += '</tr></thead><tbody>';
                
                // LIGNES DES OBJECTIFS
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    html += '<tr>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">' + stat.objectif + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.planifiees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.realisees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + stat.taux + '%</td>';
                    html += '</tr>';
                }
                
                // LIGNES DES D√âCISIONS
                html += '<tr>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">D√©cisions du PR</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[0].planifiees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[0].realisees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + statsDecisions[0].taux + '%</td>';
                html += '</tr>';
                
                html += '<tr>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">D√©cisions du CM</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[1].planifiees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[1].realisees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + statsDecisions[1].taux + '%</td>';
                html += '</tr>';
                
                // LIGNE TOTALE
                html += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">Total</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + (totalPlanifieesObj + totalPlanifieesDec) + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + (totalRealiseesObj + totalRealiseesDec) + '</td>';
                var tauxGlobalTotal = (totalPlanifieesObj + totalPlanifieesDec) > 0 ? Math.round(((totalRealiseesObj + totalRealiseesDec) / (totalPlanifieesObj + totalPlanifieesDec)) * 100) : 0;
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + tauxGlobalTotal + '%</td>';
                html += '</tr>';
                html += '</tbody></table>';
                
                // GRAPHIQUE 3 : BARRES VERTICALES
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Graphique 3 : Taux de r√©alisation par cat√©gorie</h3>';
                
                html += '<div style="margin-top: 16px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">';
                
                html += '<div style="display: flex; align-items: flex-end; justify-content: space-around; height: 300px; border-bottom: 2px solid #cbd5e1; padding: 0 20px;">';
                
                // Barres pour les 3 objectifs
                var couleursGraph3Obj = ['#87CEEB', '#C6F4D6', '#F7DC6F'];
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    var barColor = couleursGraph3Obj[i];
                    var hauteur = stat.taux * 2.5;
                    
                    html += '<div style="display: flex; flex-direction: column; align-items: center; width: 80px;">';
                    html += '<div style="font-weight: bold; font-size: 16px; color: ' + barColor + '; margin-bottom: 8px;">' + stat.taux + '%</div>';
                    html += '<div style="width: 60px; height: ' + hauteur + 'px; background-color: ' + barColor + '; border-radius: 4px 4px 0 0;"></div>';
                    html += '</div>';
                }
                
                // Barres pour les 2 d√©cisions
                var couleursGraph3Dec = ['#FFC5C5', '#AFEEEE'];
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    var barColor = couleursGraph3Dec[i];
                    var hauteur = stat.taux * 2.5;
                    
                    html += '<div style="display: flex; flex-direction: column; align-items: center; width: 80px;">';
                    html += '<div style="font-weight: bold; font-size: 16px; color: ' + barColor + '; margin-bottom: 8px;">' + stat.taux + '%</div>';
                    html += '<div style="width: 60px; height: ' + hauteur + 'px; background-color: ' + barColor + '; border-radius: 4px 4px 0 0;"></div>';
                    html += '</div>';
                }
                
                // Barre TOTAL (plus large et dor√©e)
                var barColorGlobal = '#f59e0b';
                var hauteurGlobal = tauxGlobalTotal * 2.5;
                html += '<div style="display: flex; flex-direction: column; align-items: center; width: 100px; margin-left: 20px; padding-left: 20px; border-left: 2px solid #cbd5e1;">';
                html += '<div style="font-weight: bold; font-size: 18px; color: ' + barColorGlobal + '; margin-bottom: 8px;">' + tauxGlobalTotal + '%</div>';
                html += '<div style="width: 80px; height: ' + hauteurGlobal + 'px; background-color: ' + barColorGlobal + '; border-radius: 4px 4px 0 0;"></div>';
                html += '</div>';
                
                html += '</div>';
                
                // L√âGENDES SOUS LES BARRES
                html += '<div style="display: flex; align-items: center; justify-content: space-around; margin-top: 16px; padding: 0 20px;">';
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    var nomCourt = stat.objectif.replace('Objectifs ', 'Obj. ');
                    html += '<div style="width: 80px; text-align: center; font-size: 11px; font-weight: 600; color: #4b5563;">' + nomCourt + '</div>';
                }
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    var nomCourt = stat.decision.replace('D√©cisions ', 'D√©c. ');
                    html += '<div style="width: 80px; text-align: center; font-size: 11px; font-weight: 600; color: #4b5563;">' + nomCourt + '</div>';
                }
                
                html += '<div style="width: 100px; text-align: center; font-size: 12px; font-weight: bold; color: #1e293b; margin-left: 20px; padding-left: 20px; border-left: 2px solid #cbd5e1;">TOTAL GLOBAL</div>';
                
                html += '</div>';
                
                // R√âSUM√â
                html += '<div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #cbd5e1; display: flex; justify-content: center; gap: 40px; font-size: 13px; color: #6b7280;">';
                html += '<span><strong>Total Planifi√©es:</strong> ' + (totalPlanifieesObj + totalPlanifieesDec) + '</span>';
                html += '<span><strong>Total R√©alis√©es:</strong> ' + (totalRealiseesObj + totalRealiseesDec) + '</span>';
                html += '<span style="color: ' + barColorGlobal + '; font-weight: bold;">Taux Global: ' + tauxGlobalTotal + '%</span>';
                html += '</div>';
                
                html += '</div>';
                
                // SECTION 4 : DIFFICULT√âS ET SOLUTIONS
                html += '<h2 style="color: #2563eb; margin-top: 40px;">4. Difficult√©s et Solutions</h2>';
                var diffKey = 'difficultes_' + (serviceRapport || 'global');
                var diffValue = rapportTextes[diffKey] || '';
                
                html += '<h3 style="margin-top: 16px; color: #4b5563;">4.1 Difficult√©s</h3>';
                html += '<textarea id="difficultes-text" class="form-control" rows="5" style="margin-top: 8px;" placeholder="D√©crivez les difficult√©s..." onchange="sauvegarderTexteRapport(\'' + diffKey + '\', this.value)">' + diffValue + '</textarea>';
                
                var pistesKey = 'pistes_' + (serviceRapport || 'global');
                var pistesValue = rapportTextes[pistesKey] || '';
                
                html += '<h3 style="margin-top: 24px; color: #4b5563;">4.2 Pistes de Solutions</h3>';
                html += '<textarea id="pistes-text" class="form-control" rows="5" style="margin-top: 8px;" placeholder="Proposez des solutions..." onchange="sauvegarderTexteRapport(\'' + pistesKey + '\', this.value)">' + pistesValue + '</textarea>';
                
                html += '</div>'; // Fermeture rapport-content
            }
// ========== ONGLET 6 : ANALYSE ==========
if (activeTab === 'analyse') {
    html += '<h2 style="margin-bottom: 16px;">üìä Analyse Strat√©gique</h2>';
    
   // SOUS-MENU avec couleurs personnalis√©es
html += '<div style="background-color: white; padding: 16px; margin-bottom: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">';

// Bouton 1 : Acc√®s √©quitable (Bleu turquoise)
var styleAcces = activeAnalyseTab === 'acces' 
    ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: scale(1.02);' 
    : 'background: linear-gradient(135deg, #a8b7f5 0%, #c3b1d9 100%); color: #4c1d95;';
html += '<button onclick="changeAnalyseTab(\'acces\')" style="' + styleAcces + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">‚öñÔ∏è Acc√®s √©quitable</button>';

// Bouton 2 : Qualit√© des enseignements (Vert √©meraude)
var styleQualite = activeAnalyseTab === 'qualite'
    ? 'background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; transform: scale(1.02);'
    : 'background: linear-gradient(135deg, #a7f3d0 0%, #d1fae5 100%); color: #065f46;';
html += '<button onclick="changeAnalyseTab(\'qualite\')" style="' + styleQualite + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">üéì Qualit√© des enseignements</button>';

// Bouton 3 : Alphab√©tisation (Orange corail)
var styleAlpha = activeAnalyseTab === 'alphabetisation'
    ? 'background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; transform: scale(1.02);'
    : 'background: linear-gradient(135deg, #fed7aa 0%, #fecaca 100%); color: #9a3412;';
html += '<button onclick="changeAnalyseTab(\'alphabetisation\')" style="' + styleAlpha + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">‚úçÔ∏è Alphab√©tisation</button>';

// Bouton 4 : D√©cisions (Bleu cyan)
var styleDecisions = activeAnalyseTab === 'decisions'
    ? 'background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%); color: white; transform: scale(1.02);'
    : 'background: linear-gradient(135deg, #bfdbfe 0%, #a5f3fc 100%); color: #075985;';
html += '<button onclick="changeAnalyseTab(\'decisions\')" style="' + styleDecisions + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">üéØ D√©cisions</button>';

html += '</div></div>';
   
    // CONTENU CONDITIONNEL
    if (activeAnalyseTab === 'acces') {
        html += renderAnalyseAcces();
    } else if (activeAnalyseTab === 'qualite') {
        html += renderAnalyseQualite();
    } else if (activeAnalyseTab === 'alphabetisation') {
        html += renderAnalyseAlphabetisation();
    } else if (activeAnalyseTab === 'decisions') {
        html += renderAnalyseDecisions();
    }
}
// ========== ONGLET 7 : ADMINISTRATION ==========
            if (activeTab === 'admin') {
                html += '<h2 style="margin-bottom: 16px;">‚öôÔ∏è Administration</h2>';
                
                html += '<div class="cards" style="margin-top: 24px;">';
                
                html += '<div class="card card-blue" style="cursor: pointer;" onclick="showUserList()"><div class="card-title" style="color: #2563eb;">üë• Gestion des Comptes</div><div style="font-size: 14px; margin-top: 8px;">Cr√©er, modifier, supprimer</div></div>';
                
                html += '<div class="card card-green" style="cursor: pointer;" onclick="showConnectedUsers()"><div class="card-title" style="color: #059669;">üü¢ Utilisateurs Connect√©s</div><div class="card-value" style="font-size: 24px; margin-top: 8px;">' + connectedUsers.length + '</div></div>';
                
                html += '<div class="card card-orange" style="cursor: pointer;"><div class="card-title" style="color: #ea580c;">üìä Statistiques</div><div style="font-size: 14px; margin-top: 8px;">Total: ' + users.length + ' comptes</div></div>';
                
                html += '<div class="card" style="cursor: pointer; background-color: #f3e8ff; border-color: #7c3aed;" onclick="showPermissions()"><div class="card-title" style="color: #7c3aed;">üîí S√©curit√©</div><div style="font-size: 14px; margin-top: 8px;">Gestion des acc√®s</div></div>';
                
                html += '</div>';
                
                // TABLEAU DES UTILISATEURS
                html += '<h3 style="margin-top: 32px; margin-bottom: 16px;">Liste des Utilisateurs</h3>';
                html += '<div class="table-container"><table><thead class="blue"><tr><th>Utilisateur</th><th>Nom</th><th>Service</th><th>R√¥le</th><th>Statut</th><th>Derni√®re connexion</th></tr></thead><tbody>';
                
                var usersByRole = {admin: [], chefdept: [], chef: []};
                for (var i = 0; i < users.length; i++) {
                    usersByRole[users[i].role].push(users[i]);
                }
                
                // Admin en premier
                for (var i = 0; i < usersByRole.admin.length; i++) {
                    var u = usersByRole.admin[i];
                    html += '<tr>';
                    html += '<td><strong>' + u.user + '</strong></td>';
                    html += '<td>' + u.nom + '</td>';
                    html += '<td><span class="badge badge-purple">' + u.service + '</span></td>';
                    html += '<td><span class="badge" style="background-color: #dc2626; color: white;">Admin</span></td>';
                    html += '<td><span class="badge badge-green" style="color: #065f46;">Actif</span></td>';
                    html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    html += '</tr>';
                }
                
                // Chef d√©partement
                for (var i = 0; i < usersByRole.chefdept.length; i++) {
                    var u = usersByRole.chefdept[i];
                    html += '<tr>';
                    html += '<td>' + u.user + '</td>';
                    html += '<td>' + u.nom + '</td>';
                    html += '<td><span class="badge badge-purple">' + u.service + '</span></td>';
                    html += '<td><span class="badge" style="background-color: #d97706; color: white;">Chef D√©p.</span></td>';
                    html += '<td>';
                    if (u.actif) html += '<span class="badge badge-green" style="color: #065f46;">Actif</span>';
                    else html += '<span class="badge" style="background-color: #fee2e2; color: #991b1b;">D√©sactiv√©</span>';
                    html += '</td>';
                    
                    var connected = false;
                    for (var j = 0; j < connectedUsers.length; j++) {
                        if (connectedUsers[j].user === u.user) {
                            html += '<td style="font-size: 12px; color: #059669;">' + connectedUsers[j].connectedAt + '</td>';
                            connected = true;
                            break;
                        }
                    }
                    if (!connected) html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    html += '</tr>';
                }
                
                // Chefs de service
                for (var i = 0; i < usersByRole.chef.length; i++) {
                    var u = usersByRole.chef[i];
                    html += '<tr>';
                    html += '<td>' + u.user + '</td>';
                    html += '<td>' + u.nom + '</td>';
                    html += '<td><span class="badge badge-purple">' + u.service + '</span></td>';
                    html += '<td><span class="badge" style="background-color: #059669; color: white;">Chef</span></td>';
                    html += '<td>';
                    if (u.actif) html += '<span class="badge badge-green" style="color: #065f46;">Actif</span>';
                    else html += '<span class="badge" style="background-color: #fee2e2; color: #991b1b;">D√©sactiv√©</span>';
                    html += '</td>';
                    
                    var connected = false;
                    for (var j = 0; j < connectedUsers.length; j++) {
                        if (connectedUsers[j].user === u.user) {
                            html += '<td style="font-size: 12px; color: #059669;">' + connectedUsers[j].connectedAt + '</td>';
                            connected = true;
                            break;
                        }
                    }
                    if (!connected) html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    html += '</tr>';
                }
                
                html += '</tbody></table></div>';
                
                // STATISTIQUES
                html += '<h3 style="margin-top: 32px; margin-bottom: 16px;">Statistiques d\'Utilisation</h3>';
                html += '<div class="cards" style="grid-template-columns: repeat(3, 1fr);">';
                
                var activeCount = 0;
                var inactiveCount = 0;
                for (var i = 0; i < users.length; i++) {
                    if (users[i].actif) activeCount++;
                    else inactiveCount++;
                }
                
                html += '<div class="card card-blue"><div class="card-title" style="color: #2563eb;">Total Comptes</div><div class="card-value">' + users.length + '</div></div>';
                html += '<div class="card card-green"><div class="card-title" style="color: #059669;">Comptes Actifs</div><div class="card-value">' + activeCount + '</div></div>';
                html += '<div class="card card-orange"><div class="card-title" style="color: #ea580c;">Comptes D√©sactiv√©s</div><div class="card-value">' + inactiveCount + '</div></div>';
                
                html += '</div>';
            }
// ========== ONGLET 8 : STATISTIQUES ==========

// üî• SOUS-MENU avec 3 boutons selon permissions
html += '<div style="background-color: white; padding: 16px; margin-bottom: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">';

// Bouton 1 : Stats G√©n√©rales (BSD)
if (canSaisirStatsGenerales() || currentUser.role === 'chefdept') {
    var styleGeneral = 'background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
    html += '<button onclick="showStatistiquesModal()" style="' + styleGeneral + '">üìä Stats G√©n√©rales (BSD)</button>';
}

// Bouton 2 : R√©ussite Examens (DGECS)
if (canSaisirExamens() || currentUser.role === 'chefdept') {
    var styleExamens = 'background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
    html += '<button onclick="showReussiteExamensModal()" style="' + styleExamens + '">‚úÖ R√©ussite Examens (DGECS)</button>';
}

// Bouton 3 : Alphab√©tisation (DNAENFP-LN)
if (canSaisirAlphabetisation() || currentUser.role === 'chefdept') {
    var styleAlpha = 'background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
    html += '<button onclick="showAlphabetisationModal()" style="' + styleAlpha + '">‚úçÔ∏è Alphab√©tisation (DNAENFP-LN)</button>';
}

html += '</div></div>';

// Filtres
html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
html += '<h3 style="margin-bottom: 12px;">Filtres</h3>';
html += '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">';

html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üìÖ Afficher jusqu\'√†</label>';
html += '<select id="filter-stats-periode" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="TOUS">Toutes les p√©riodes</option>';
html += '<option value="T1">Jusqu\'√† T1</option>';
html += '<option value="T2">Jusqu\'√† T2</option>';
html += '<option value="T3">Jusqu\'√† T3</option>';
html += '<option value="T4">Jusqu\'√† T4</option>';
html += '<option value="Annuel">Ann√©e compl√®te</option>';
html += '</select></div>';

html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üåç R√©gion</label>';
html += '<select id="filter-stats-region" class="form-control" onchange="appliquerFiltresStatistiques(); updateStatsPrefectureDropdown();">';
html += '<option value="">Toutes</option>';
for (var i = 0; i < regionsData.length; i++) {
    html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
}
html += '</select></div>';

html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üèõÔ∏è Pr√©fecture</label>';
html += '<select id="filter-stats-prefecture" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="">Toutes</option>';
html += '</select></div>';

html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üèòÔ∏è Zone</label>';
html += '<select id="filter-stats-zone" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="">Toutes</option>';
html += '<option value="Urbaine">Urbaine</option>';
html += '<option value="Rurale">Rurale</option>';
html += '</select></div>';

html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üìö Niveau</label>';
html += '<select id="filter-stats-niveau" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="">Tous</option>';
html += '<option value="Pr√©scolaire">Pr√©scolaire</option>';
html += '<option value="Primaire">Primaire</option>';
html += '<option value="Secondaire">Secondaire</option>';
html += '</select></div>';

html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üë§ Genre</label>';
html += '<select id="filter-stats-genre" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="Total">Total</option>';
html += '<option value="Filles">Filles</option>';
html += '</select></div>';

html += '</div></div>';

// üî• CARTES D'INDICATEURS - SEULEMENT 5 cartes
html += '<div class="cards" style="grid-template-columns: repeat(5, 1fr); margin-bottom: 24px;">';

var moyenneAbandon = calculerMoyenne(statistiquesData, 'taux_abandon');
var moyenneScolarisation = calculerMoyenne(statistiquesData, 'taux_scolarisation');
var moyenneRatioEnseignant = calculerMoyenne(statistiquesData, 'ratio_eleves_enseignant');
var moyenneRatioClasse = calculerMoyenne(statistiquesData, 'ratio_eleves_classe');
var moyenneDistance = calculerMoyenne(statistiquesData, 'distance_moyenne_ecole_domicile');

html += '<div class="card card-orange"><div class="card-title" style="color: #ea580c;">Taux d\'abandon</div><div class="card-value">' + moyenneAbandon + '%</div></div>';
html += '<div class="card card-blue"><div class="card-title" style="color: #2563eb;">Taux de scolarisation</div><div class="card-value">' + moyenneScolarisation + '%</div></div>';
html += '<div class="card" style="background-color: #fce7f3; border-left: 4px solid #db2777;"><div class="card-title" style="color: #db2777;">Ratio √©l√®ves/enseignant</div><div class="card-value">' + moyenneRatioEnseignant + '</div></div>';
html += '<div class="card" style="background-color: #e0e7ff; border-left: 4px solid #6366f1;"><div class="card-title" style="color: #6366f1;">Ratio √©l√®ves/classe</div><div class="card-value">' + moyenneRatioClasse + '</div></div>';
html += '<div class="card" style="background-color: #fef3c7; border-left: 4px solid #f59e0b;"><div class="card-title" style="color: #f59e0b;">Distance moy. (km)</div><div class="card-value">' + moyenneDistance + '</div></div>';

html += '</div>';
    // Filtres
    // Filtres
html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
html += '<h3 style="margin-bottom: 12px;">Filtres</h3>';
html += '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">';

// 1Ô∏è‚É£ AFFICHER JUSQU'√Ä (P√©riode)
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üìÖ Afficher jusqu\'√†</label>';
html += '<select id="filter-stats-periode" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="TOUS">Toutes les p√©riodes</option>';
html += '<option value="T1">Jusqu\'√† T1</option>';
html += '<option value="T2">Jusqu\'√† T2</option>';
html += '<option value="T3">Jusqu\'√† T3</option>';
html += '<option value="T4">Jusqu\'√† T4</option>';
html += '<option value="Annuel">Ann√©e compl√®te</option>';
html += '</select></div>';

// 2Ô∏è‚É£ R√âGION
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üåç R√©gion</label>';
html += '<select id="filter-stats-region" class="form-control" onchange="appliquerFiltresStatistiques(); updateStatsPrefectureDropdown();">';
html += '<option value="">Toutes</option>';
for (var i = 0; i < regionsData.length; i++) {
    html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
}
html += '</select></div>';

// 3Ô∏è‚É£ PR√âFECTURE
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üèõÔ∏è Pr√©fecture</label>';
html += '<select id="filter-stats-prefecture" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="">Toutes</option>';
html += '</select></div>';

// 4Ô∏è‚É£ ZONE
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üèòÔ∏è Zone</label>';
html += '<select id="filter-stats-zone" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="">Toutes</option>';
html += '<option value="Urbaine">Urbaine</option>';
html += '<option value="Rurale">Rurale</option>';
html += '</select></div>';

// 5Ô∏è‚É£ NIVEAU
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üìö Niveau</label>';
html += '<select id="filter-stats-niveau" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="">Tous</option>';
html += '<option value="Pr√©scolaire">Pr√©scolaire</option>';
html += '<option value="Primaire">Primaire</option>';
html += '<option value="Secondaire">Secondaire</option>';
html += '<option value="Alphab√©tisation">Alphab√©tisation</option>';
html += '</select></div>';

// 6Ô∏è‚É£ GENRE
html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üë§ Genre</label>';
html += '<select id="filter-stats-genre" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="Total">Total</option>';
html += '<option value="Filles">Filles</option>';
html += '</select></div>';

html += '</div></div>';
                
                // Cartes d'indicateurs
                html += '<div class="cards" style="grid-template-columns: repeat(7, 1fr); margin-bottom: 24px;">';
                
                var moyenneAbandon = calculerMoyenne(statistiquesData, 'taux_abandon');
                var moyenneReussite = calculerMoyenne(statistiquesData, 'taux_reussite_examens');
                var moyenneScolarisation = calculerMoyenne(statistiquesData, 'taux_scolarisation');
                var moyenneAlphabetisation = calculerMoyenne(statistiquesData, 'taux_alphabetisation');
                var moyenneRatioEnseignant = calculerMoyenne(statistiquesData, 'ratio_eleves_enseignant');
                var moyenneRatioClasse = calculerMoyenne(statistiquesData, 'ratio_eleves_classe');
                var moyenneDistance = calculerMoyenne(statistiquesData, 'distance_moyenne_ecole_domicile');
                
                html += '<div class="card card-orange"><div class="card-title" style="color: #ea580c;">Taux d\'abandon scolaire</div><div class="card-value">' + moyenneAbandon + '%</div></div>';
                html += '<div class="card card-green"><div class="card-title" style="color: #059669;">Taux de r√©ussite</div><div class="card-value">' + moyenneReussite + '%</div></div>';
                html += '<div class="card card-blue"><div class="card-title" style="color: #2563eb;">Taux de scolarisation</div><div class="card-value">' + moyenneScolarisation + '%</div></div>';
                html += '<div class="card card-yellow"><div class="card-title" style="color: #d97706;">Taux d\'alphab√©tisation</div><div class="card-value">' + moyenneAlphabetisation + '%</div></div>';
                html += '<div class="card" style="background-color: #fce7f3; border-left: 4px solid #db2777;"><div class="card-title" style="color: #db2777;">Ratio √©l√®ves/enseignant</div><div class="card-value">' + moyenneRatioEnseignant + '</div></div>';
                html += '<div class="card" style="background-color: #e0e7ff; border-left: 4px solid #6366f1;"><div class="card-title" style="color: #6366f1;">Ratio √©l√®ves/classe</div><div class="card-value">' + moyenneRatioClasse + '</div></div>';
                html += '<div class="card" style="background-color: #fef3c7; border-left: 4px solid #f59e0b;"><div class="card-title" style="color: #f59e0b;">Distance moy. (km)</div><div class="card-value">' + moyenneDistance + '</div></div>';
                
                html += '</div>';
                
                // Tableau des donn√©es
                html += '<div class="table-container"><table><thead class="blue"><tr><th>R√©gion</th><th>Pr√©fecture</th><th>Niveau</th><th>Genre</th><th>Taux abandon (%)</th><th>Taux r√©ussite (%)</th><th>Taux scolarisation (%)</th>';
                
                if (currentUser.role === 'admin' || currentUser.service === 'BSD') {
                    html += '<th style="text-align: center;">Actions</th>';
                }
                
                html += '</tr></thead><tbody>';
                
                if (statistiquesData.length > 0) {
                    for (var i = 0; i < statistiquesData.length; i++) {
                        var stat = statistiquesData[i];
                        html += '<tr>';
                        html += '<td>' + stat.region + '</td>';
                        html += '<td>' + stat.prefecture + '</td>';
                        html += '<td><span class="badge badge-blue">' + stat.niveau + '</span></td>';
                        html += '<td><span class="badge badge-purple">' + stat.genre + '</span></td>';
                        html += '<td>' + (stat.taux_abandon || '-') + '</td>';
                        html += '<td>' + (stat.taux_reussite_examens || '-') + '</td>';
                        html += '<td>' + (stat.taux_scolarisation || '-') + '</td>';
                        
                        if (currentUser.role === 'admin' || currentUser.service === 'BSD') {
                            html += '<td style="text-align: center;"><button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteStatistique(' + stat.id + ')">Supprimer</button></td>';
                        }
                        
                        html += '</tr>';
                    }
                } else {
                    var colspan = (currentUser.role === 'admin' || currentUser.service === 'BSD') ? '8' : '7';
                    html += '<tr><td colspan="' + colspan + '" class="empty-state">Aucune statistique enregistr√©e</td></tr>';
                }
                
                html += '</tbody></table></div>';
            }

            html += '</div><div id="modal-container"></div>';
            app.innerHTML = html;

        // ========== INITIALISATION ==========
async function init() {
    await loadData();
    await loadPermissions(); 
    await checkInvitationToken(); // NOUVELLE LIGNE 
    var saved = localStorage.getItem('currentUser');
    if (saved) {
        currentUser = JSON.parse(saved);
        await loadRapportTextes();
        
        var alreadyConnected = false;
        for (var i = 0; i < connectedUsers.length; i++) {
            if (connectedUsers[i].user === currentUser.user) {
                alreadyConnected = true;
                break;
            }
        }
        if (!alreadyConnected) {
            connectedUsers.push({
                user: currentUser.user,
                nom: currentUser.nom,
                service: currentUser.service,
                connectedAt: new Date().toLocaleString('fr-FR')
            });
            localStorage.setItem('connectedUsers', JSON.stringify(connectedUsers));
        }
    }
    
    render();
}
        // ========== FONCTIONS DE VISUALISATION ET EXPORT ==========

function ouvrirPreuve(fileUrl, nomFichier) {
    console.log('üìÇ Ouverture du fichier:', nomFichier);
    
    if (!fileUrl || fileUrl === 'undefined' || fileUrl === '') {
        alert('‚ùå Ce fichier n\'a pas d\'URL valide.');
        return;
    }
    
    var extension = nomFichier.split('.').pop().toLowerCase();
    showDocumentViewer(fileUrl, nomFichier, extension);
}

function showDocumentViewer(fileUrl, nomFichier, extension) {
    var modalContainer = document.getElementById('modal-container');
    
    var html = '<div class="modal"><div class="modal-content" style="max-width: 95vw; max-height: 95vh; display: flex; flex-direction: column;">';
    
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">';
    html += '<h2 style="margin: 0;">üìÑ ' + nomFichier + '</h2>';
    html += '<div style="display: flex; gap: 8px;">';
    html += '<button class="btn btn-primary" onclick="telechargerFichier(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">‚¨áÔ∏è T√©l√©charger original</button>';
    
    html += '<div style="position: relative; display: inline-block;">';
    html += '<button class="btn btn-success" onclick="toggleExportMenu()" id="export-menu-btn">üì• Exporter ‚ñº</button>';
    html += '<div id="export-menu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 4px; min-width: 180px; z-index: 1000;">';
    html += '<button onclick="exporterDocument(\'pdf\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìÑ PDF</button>';
    html += '<button onclick="exporterDocument(\'docx\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìù Word (.docx)</button>';
    html += '<button onclick="exporterDocument(\'xlsx\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìä Excel (.xlsx)</button>';
    html += '<button onclick="exporterDocument(\'pptx\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìΩÔ∏è PowerPoint (.pptx)</button>';
    html += '<button onclick="exporterDocument(\'txt\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìã Texte (.txt)</button>';
    html += '<button onclick="exporterDocument(\'png\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üñºÔ∏è Image (.png)</button>';
    html += '</div></div>';
    
    html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Fermer</button>';
    html += '</div></div>';
    
    html += '<div id="document-viewer-container" style="flex: 1; overflow: auto; background-color: #f9fafb; border-radius: 8px; padding: 16px;">';
    
    if (extension === 'pdf') {
        html += '<iframe src="' + fileUrl + '" style="width: 100%; height: 100%; min-height: 600px; border: none;"></iframe>';
    } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].indexOf(extension) !== -1) {
        html += '<div style="text-align: center;"><img src="' + fileUrl + '" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>';
    } else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].indexOf(extension) !== -1) {
        html += '<div style="text-align: center; padding: 40px;">';
        html += '<p style="font-size: 18px; color: #6b7280; margin-bottom: 24px;">üìÑ Document Office d√©tect√©</p>';
        html += '<p style="margin-bottom: 16px;">Choisissez votre m√©thode de visualisation :</p>';
        html += '<div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">';
        var googleViewerUrl = 'https://docs.google.com/viewer?url=' + encodeURIComponent(fileUrl) + '&embedded=true';
        html += '<button class="btn btn-primary" onclick="chargerDocumentDansViewer(\'' + googleViewerUrl.replace(/'/g, "\\'") + '\')">üîç Visualiser avec Google Docs</button>';
        var officeViewerUrl = 'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(fileUrl);
        html += '<button class="btn btn-success" onclick="chargerDocumentDansViewer(\'' + officeViewerUrl.replace(/'/g, "\\'") + '\')">üìä Visualiser avec Office Online</button>';
        html += '<button class="btn btn-warning" onclick="telechargerFichier(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">‚¨áÔ∏è T√©l√©charger</button>';
        html += '</div></div>';
    } else if (['txt', 'csv', 'json', 'xml', 'html', 'css', 'js'].indexOf(extension) !== -1) {
        html += '<div style="text-align: center; padding: 20px;"><p>üìù Chargement du fichier texte...</p></div>';
    } else {
        html += '<div style="text-align: center; padding: 40px;">';
        html += '<p style="font-size: 18px; color: #6b7280; margin-bottom: 16px;">‚ö†Ô∏è Aper√ßu non disponible</p>';
        html += '<button class="btn btn-primary" onclick="telechargerFichier(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">‚¨áÔ∏è T√©l√©charger</button>';
        html += '</div>';
    }
    
    html += '</div></div></div>';
    
    modalContainer.innerHTML = html;
    
    if (['txt', 'csv', 'json', 'xml', 'html', 'css', 'js'].indexOf(extension) !== -1) {
        setTimeout(function() { chargerFichierTexte(fileUrl); }, 100);
    }
}

function toggleExportMenu() {
    var menu = document.getElementById('export-menu');
    if (!menu) return;
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

document.addEventListener('click', function(e) {
    var menu = document.getElementById('export-menu');
    var btn = document.getElementById('export-menu-btn');
    if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.style.display = 'none';
    }
});

function chargerDocumentDansViewer(viewerUrl) {
    var container = document.getElementById('document-viewer-container');
    if (!container) return;
    container.innerHTML = '<iframe src="' + viewerUrl + '" style="width: 100%; height: 100%; min-height: 600px; border: none;"></iframe>';
}

async function chargerFichierTexte(fileUrl) {
    try {
        var response = await fetch(fileUrl);
        var texte = await response.text();
        var container = document.getElementById('document-viewer-container');
        if (!container) return;
        container.innerHTML = '<pre style="background-color: white; padding: 20px; border-radius: 8px; overflow: auto; max-height: 600px; font-family: monospace; font-size: 13px; line-height: 1.5;">' + texte.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
    } catch (error) {
        console.error('Erreur:', error);
        var container = document.getElementById('document-viewer-container');
        if (container) container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><p>‚ùå Erreur</p></div>';
    }
}

function telechargerFichier(fileUrl, nomFichier) {
    var link = document.createElement('a');
    link.href = fileUrl;
    link.download = nomFichier;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exporterDocument(format, nomFichier) {
    var container = document.getElementById('document-viewer-container');
    if (!container) {
        alert('‚ùå Impossible d\'exporter');
        return;
    }
    
    var menu = document.getElementById('export-menu');
    if (menu) menu.style.display = 'none';
    
    var contenu = container.innerText || container.textContent || '';
    var contenuHTML = container.innerHTML || '';
    var nomBase = nomFichier.replace(/\.[^.]+$/, '');
    
    switch(format) {
        case 'pdf': exporterEnPDF(nomBase, container); break;
        case 'docx': exporterEnWord(nomBase, contenuHTML); break;
        case 'xlsx': exporterEnExcel(nomBase, contenu); break;
        case 'pptx': exporterEnPowerPoint(nomBase, container); break;
        case 'txt': exporterEnTexte(nomBase, contenu); break;
        case 'png': exporterEnImage(nomBase, container); break;
        default: alert('‚ö†Ô∏è Format non support√©');
    }
}

function exporterEnPDF(nomBase, container) {
    if (typeof html2pdf === 'undefined') {
        alert('‚ö†Ô∏è html2pdf non disponible');
        return;
    }
    var options = {
        margin: 10,
        filename: nomBase + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(options).from(container).save();
}

function exporterEnWord(nomBase, contenuHTML) {
    var htmlWord = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>' + nomBase + '</title></head><body>' + contenuHTML + '</body></html>';
    var blob = new Blob(['\ufeff', htmlWord], { type: 'application/msword' });
    telechargerBlob(blob, nomBase + '.doc');
}

function exporterEnExcel(nomBase, contenu) {
    var lignes = contenu.split('\n');
    var csv = lignes.join('\n');
    var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    telechargerBlob(blob, nomBase + '.csv');
}

async function exporterEnPowerPoint(nomBase, container) {
    try {
        if (typeof PptxGenJS === 'undefined') {
            alert('‚ùå PptxGenJS non disponible');
            return;
        }
        
        if (typeof html2canvas === 'undefined') {
            alert('‚ùå html2canvas non disponible');
            return;
        }
        
        var loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 10000; text-align: center;';
        loadingMsg.innerHTML = '<h3 style="margin: 0 0 10px 0;">‚è≥ Cr√©ation...</h3><p style="margin: 0;">Patientez</p>';
        document.body.appendChild(loadingMsg);
        
        let pptx = new PptxGenJS();
        pptx.author = 'GESTION-BSD-MEPUA';
        pptx.company = 'MEPUA';
        pptx.title = nomBase;
        pptx.layout = 'LAYOUT_16x9';
        
        const canvas = await html2canvas(container, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });
        
        const imageData = canvas.toDataURL('image/png');
        
        let slide1 = pptx.addSlide();
        slide1.background = { fill: '2563eb' };
        slide1.addText(nomBase, { x: 0.5, y: 2, w: 9, h: 1.5, fontSize: 44, bold: true, color: 'FFFFFF', align: 'center' });
        slide1.addText('Gestion D√©partementale - MEPUA', { x: 0.5, y: 3.8, w: 9, h: 0.5, fontSize: 20, color: 'E0E7FF', align: 'center' });
        
        let slide2 = pptx.addSlide();
        slide2.addText('Document', { x: 0.5, y: 0.3, w: 9, h: 0.6, fontSize: 28, bold: true, color: '2563eb' });
        slide2.addImage({ data: imageData, x: 0.5, y: 1, w: 9, h: 4.8 });
        
        await pptx.writeFile({ fileName: nomBase + '.pptx' });
        
        document.body.removeChild(loadingMsg);
        alert('‚úÖ Pr√©sentation cr√©√©e !');
        
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}

function exporterEnTexte(nomBase, contenu) {
    var blob = new Blob([contenu], { type: 'text/plain;charset=utf-8' });
    telechargerBlob(blob, nomBase + '.txt');
}

function exporterEnImage(nomBase, container) {
    if (typeof html2canvas === 'undefined') {
        alert('‚ö†Ô∏è html2canvas non disponible');
        return;
    }
    html2canvas(container, { scale: 2, useCORS: true, allowTaint: true }).then(function(canvas) {
        canvas.toBlob(function(blob) {
            telechargerBlob(blob, nomBase + '.png');
        });
    });
}

function telechargerBlob(blob, nomFichier) {
    var url = window.URL.createObjectURL(blob);
    var link = document.createElement('a');
    link.href = url;
    link.download = nomFichier;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}
// ========== FONCTIONS DE RENDU ANALYSE ==========

function renderAnalyseAcces() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>‚öñÔ∏è Analyse de l\'Acc√®s √âquitable</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}

function renderAnalyseQualite() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>üéì Analyse de la Qualit√©</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}

function renderAnalyseAlphabetisation() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>‚úçÔ∏è Analyse de l\'Alphab√©tisation</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}
function renderAnalyseDecisions() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>üéØ D√©cisions Strat√©giques</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}
        // Lancer l'initialisation
        init();
    </script>
</body>
</html>
   <!-- Variables d'environnement configur√©es --> 

















































































