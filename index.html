<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion D√©partementale - 36 Services</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f9fafb; }
        .header { background-color: #2563eb; color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; }
        .header-right { display: flex; gap: 16px; align-items: center; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-success { background-color: #059669; color: white; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .nav { background-color: white; padding: 0 16px; display: flex; gap: 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav button { padding: 16px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 16px; }
        .nav button.active { border-bottom-color: #2563eb; color: #2563eb; }
        .main { max-width: 1280px; margin: 0 auto; padding: 32px 16px; }
        .cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; margin-top: 32px; }
        
        .card { padding: 24px; border-radius: 8px; border-left: 4px solid; }
        .card-blue { background-color: #dbeafe; border-color: #2563eb; }
        .card-yellow { background-color: #fef3c7; border-color: #d97706; }
        .card-green { background-color: #d1fae5; border-color: #059669; }
        .card-orange { background-color: #fed7aa; border-color: #ea580c; }
        .card-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        .card-value { font-size: 32px; font-weight: bold; }
        .table-container { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; margin-top: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 16px; border: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; text-align: left; }
        thead.blue th { background-color: #2563eb; color: white; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        tbody tr:hover { background-color: #f3f4f6; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block; }
        .badge-blue { background-color: #dbeafe; }
        .badge-green { background-color: #d1fae5; }
        .badge-purple { background-color: #e9d5ff; }
        .badge-taux { padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: bold; }
        .badge-taux-green { background-color: #d1fae5; color: #065f46; }
        .badge-taux-yellow { background-color: #fef3c7; color: #92400e; }
        .badge-taux-red { background-color: #fee2e2; color: #991b1b; }
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; border-radius: 8px; padding: 32px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .form-control { width: 100%; padding: 8px 16px; border: 1px solid #ccc; border-radius: 8px; }
        .btn-group { display: flex; gap: 8px; justify-content: center; }
        .check-icon { color: #059669; font-size: 20px; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        input[type="checkbox"]:disabled { cursor: not-allowed; opacity: 0.5; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        h2 { font-size: 24px; font-weight: bold; }
        .empty-state { padding: 32px; text-align: center; color: #6b7280; font-size: 18px; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; }
        .alert-info { background-color: #dbeafe; color: #1e40af; }
        .alert-warning { background-color: #fef3c7; color: #92400e; border-left: 4px solid #d97706; }
        .service-badge { display: inline-block; padding: 6px 12px; background-color: #7c3aed; color: white; border-radius: 6px; font-weight: bold; margin-left: 10px; }
        .notif-button { position: relative; padding: 8px 16px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background-color: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
        .notif-panel { position: absolute; top: 60px; right: 16px; width: 450px; max-height: 600px; background-color: white; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); z-index: 100; overflow: hidden; }
        .notif-header { background-color: #7c3aed; color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
        .notif-body { max-height: 500px; overflow-y: auto; }
        .notif-item { padding: 16px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background-color 0.2s; }
        .notif-item:hover { background-color: #f9fafb; }
        .notif-item.unread { background-color: #eff6ff; border-left: 4px solid #2563eb; }
        .notif-type { font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .notif-type.ajout { color: #059669; }
        .notif-type.modification { color: #d97706; }
        .notif-type.rapport { color: #7c3aed; }
        .notif-type.preuve { color: #2563eb; }
        .notif-message { font-size: 14px; margin-bottom: 8px; }
        .notif-meta { font-size: 12px; color: #6b7280; display: flex; justify-content: space-between; align-items: center; }
        .notif-delete { padding: 4px 8px; background-color: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .fichier-item { padding: 8px; background-color: #f3f4f6; border-radius: 4px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .fichier-item:hover { background-color: #e5e7eb; }
    </style>
   <!-- ========== CONNEXION SUPABASE ========== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    console.log('üöÄ Initialisation de l\'application...');
    
    // ========== CONFIGURATION SUPABASE ==========
    const SUPABASE_URL = 'https://kosqzeueikyehkblqosq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtvc3F6ZXVlaWt5ZWhrYmxxb3NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDU0MTUsImV4cCI6MjA3ODYyMTQxNX0.oGGDuOSb4M-NkJILVSDKfjXyTVqBvnJmWuR46YEEVyQ';
    
    // V√©rifier que Supabase est charg√©
    if (typeof window.supabase === 'undefined') {
        console.error('‚ùå ERREUR : Supabase non charg√©');
        alert('‚ùå Erreur critique : Impossible de charger Supabase. Rechargez la page.');
        throw new Error('Supabase library not loaded');
    }
    
    console.log('‚úÖ Biblioth√®que Supabase d√©tect√©e');
    
    // Cr√©er le client Supabase
    const { createClient } = window.supabase;
    var supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    console.log('‚úÖ Client Supabase cr√©√©');
    console.log('üîó URL:', SUPABASE_URL);
    
    // Tester la connexion
    supabase.from('users').select('count', { count: 'exact', head: true })
        .then(function(response) {
            if (response.error) {
                console.error('‚ùå Erreur de connexion Supabase:', response.error);
            } else {
                console.log('‚úÖ Connexion Supabase OK');
            }
        });
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
</head>
<body>
    <div id="app">Chargement...</div>

    <script>
// ========== DONN√âES DES 36 SERVICES ==========
        

        function generateServices() {
            return [
                'SNEAA', 'SNPUP', 'DRH', 'PRMP', 'DNEP', 'DNCaS', 'SG-E', 'DNAEFP-LN', 
                'SNFCPE', 'DNEF', 'ANAFE', 'DNESGT', 'SNEC', 'SNIES', 'INRAP', 'SMSI', 
                'SNSS', 'CRD', 'IGE', 'SNESU', 'SC', 'DAF', 'BSD', 'DGECS', 'ICESCO', 
                'IRE_CONAKRY', 'IRE_BOKE', 'IRE_KINDIA', 'IRE_MAMOU', 'IRE_LABE', 
                'IRE_FARANAH', 'IRE_KANKAN', 'IRE_NZEREKORE', 'SCRP', 'SLT', 'SA'
            ];
        }

        // ========== VARIABLES GLOBALES ==========
var users = [];
        var services = generateServices();
        var currentUser = null;
        var data = [];
        var commentairesEtPreuves = [];
        var notifications = [];
        var permissionsCache = {}; 
        var activeTab = 'dashboard';
        var selectedServiceFilter = 'TOUS';
        var activeAnalyseTab = 'acces'; // 'acces' | 'qualite' | 'alphabetisation' | 'decisions'
        var selectedStatusFilter = 'TOUS';
        var selectedObjectifFilter = 'TOUS';
        var selectedTrimestreFilter = 'TOUS';
        var suiviObjectifFilter = 'TOUS';
        var suiviTrimestreFilter = 'TOUS';
        var commentairesServiceFilter = 'TOUS';
        var commentairesObjectifFilter = 'TOUS';
        var showNotifications = false;
        var connectedUsers = [];
        var rapportTextes = {};
        var statistiquesData = [];
        var reussiteExamensData = [];
        var alphabetisationData = [];
        var regionsData = [];
        var prefecturesData = [];
        function calcTaux(item) {
            var checks = 0;
            if (item.tdr) checks++;
            if (item.eng) checks++;
            if (item.mand) checks++;
            if (item.ordo) checks++;
            if (item.liq) checks++;
            if (item.exec) checks++;
            return Math.round((checks / 6) * 100);
        }
async function toggle(activityId, field) {
    var activity = null;
    for (var i = 0; i < data.length; i++) {
        if (data[i].id === activityId) {
            activity = data[i];
            break;
        }
    }
    
    if (!activity) {
        alert('Activit√© introuvable');
        return;
    }
    
    // üî• V√âRIFICATION SIMPLIFI√âE
    if (!canModify(activity)) {
        alert('‚ùå Vous ne pouvez pas modifier cette activit√©');
        return;
    }

    // Inverser la valeur
    var newValue = !activity[field];
    
    console.log('üîÑ Sauvegarde:', field, '=', newValue, 'pour activit√©', activityId);
    
    try {
        // üî• SAUVEGARDER DANS SUPABASE
        var updateObj = {};
        updateObj[field] = newValue;
        updateObj.derniere_maj = new Date().toISOString();
        updateObj.maj_par = currentUser.nom;
        
        const { error } = await supabase
            .from('activites')
            .update(updateObj)
            .eq('id', activityId);
        
        if (error) {
            console.error('‚ùå Erreur Supabase:', error);
            throw error;
        }
        
        console.log('‚úÖ Sauvegarde r√©ussie dans Supabase');
        
        // Mettre √† jour localement
        activity[field] = newValue;
        activity.derniere_maj = new Date().toISOString();
        activity.maj_par = currentUser.nom;
        
        render();
        
    } catch (error) {
        console.error('‚ùå Erreur toggle:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}
        // ========== FONCTIONS DE STOCKAGE SUPABASE ==========
        async function loadPermissions() {
    try {
        console.log('üîê Chargement des permissions...');
        
        const { data: permissionsData, error } = await supabase
            .from('permissions_config')
            .select('*')
            .eq('enabled', true);
        
        if (error) {
            console.error('‚ùå Erreur permissions:', error);
            throw error;
        }
        
        // Organiser par r√¥le/resource/action
        permissionsCache = {};
        if (permissionsData) {
            for (var i = 0; i < permissionsData.length; i++) {
                var perm = permissionsData[i];
                var key = perm.role + ':' + perm.resource + ':' + perm.action;
                permissionsCache[key] = {
                    enabled: perm.enabled,
                    condition: perm.condition ? JSON.parse(perm.condition) : null
                };
            }
        }
        
        console.log('‚úÖ Permissions charg√©es:', Object.keys(permissionsCache).length);
        
    } catch (error) {
        console.error('‚ùå Erreur chargement permissions:', error);
        permissionsCache = {};
        console.warn('‚ö†Ô∏è Application d√©marr√©e sans syst√®me de permissions');
    }
}

       async function loadData() {
    try {
        console.log('üì• Chargement des donn√©es depuis Supabase...');
        
        // üî• Charger les utilisateurs
        const { data: usersData, error: usersError } = await supabase
            .from('users')
            .select('*');
        
        if (usersError) throw usersError;
        
        if (usersData && usersData.length > 0) {
            users = usersData.map(u => ({
                id: u.id,
                user: u.username,
                pass: u.password,
                role: u.role,
                nom: u.nom,
                service: u.service,
                actif: u.actif !== false
            }));
            console.log('‚úÖ Utilisateurs charg√©s:', users.length);
        }
        
        // üî• Charger les activit√©s (CORRECTION CRITIQUE)
        const { data: activitesData, error: activitesError } = await supabase
            .from('activites')
            .select('*')
            .order('id', { ascending: true });
        
        if (activitesError) throw activitesError;
        
        if (activitesData && activitesData.length > 0) {
            data = activitesData; // ‚úÖ Utiliser directement les donn√©es Supabase
            console.log('‚úÖ Activit√©s charg√©es:', data.length);
        } else {
            data = []; // ‚úÖ Tableau vide si aucune donn√©e
            console.warn('‚ö†Ô∏è Aucune activit√© trouv√©e dans Supabase');
        }
        
        // üî• Charger commentaires et preuves (CORRECTION MAPPING)
        const { data: commentairesData, error: commentairesError } = await supabase
            .from('commentaires_preuves')
            .select('*')
            .order('date_creation', { ascending: false });
        
        if (commentairesError) throw commentairesError;
        
        if (commentairesData && commentairesData.length > 0) {
            commentairesEtPreuves = commentairesData.map(c => ({
                id: c.id,
                type: c.type,
                objectif: c.objectif,
                activite: c.activite,
                service: c.service,
                commentaire: c.commentaire || null,
                nomFichier: c.nom_fichier || null,
                nomFichierStorage: c.nom_fichier_storage || null,
                fileUrl: c.file_url || null,
                tailleFichier: c.taille_fichier || null,
                creePar: c.cree_par,
                dateCreation: c.date_creation,
                deposePar: c.depose_par || null,
                dateDepot: c.date_depot || null,
                modifiePar: c.modifie_par || null,
                dateModification: c.date_modification || null
            }));
            console.log('‚úÖ Commentaires/preuves charg√©s:', commentairesEtPreuves.length);
        }
        
        // üî• Charger les r√©gions
        const { data: regionsDataRaw, error: regionsError } = await supabase
            .from('regions')
            .select('*')
            .order('nom');
        
        if (regionsError) throw regionsError;
        if (regionsDataRaw) {
            regionsData = regionsDataRaw;
            console.log('‚úÖ R√©gions charg√©es:', regionsData.length);
        }
        
        // üî• Charger les pr√©fectures
        const { data: prefecturesDataRaw, error: prefecturesError } = await supabase
            .from('prefectures')
            .select('*, regions(nom)')
            .order('nom');
        
        if (prefecturesError) throw prefecturesError;
        if (prefecturesDataRaw) {
            prefecturesData = prefecturesDataRaw;
            console.log('‚úÖ Pr√©fectures charg√©es:', prefecturesData.length);
        }
        
        // üî• Charger les statistiques
        const { data: statistiquesDataRaw, error: statistiquesError } = await supabase
            .from('statistiques_educatives')
            .select('*')
            .order('date_saisie', { ascending: false });
        
        if (statistiquesError) throw statistiquesError;
        if (statistiquesDataRaw) {
            statistiquesData = statistiquesDataRaw;
            console.log('‚úÖ Statistiques charg√©es:', statistiquesData.length);
        }
        
        // üî• Charger r√©ussite examens
        const { data: examensDataRaw, error: examensError } = await supabase
            .from('reussite_examens')
            .select('*')
            .order('date_saisie', { ascending: false });
        
        if (examensError) throw examensError;
        if (examensDataRaw) {
            reussiteExamensData = examensDataRaw;
            console.log('‚úÖ Examens charg√©s:', reussiteExamensData.length);
        }
        
        // üî• Charger alphab√©tisation
        const { data: alphaDataRaw, error: alphaError } = await supabase
            .from('alphabetisation')
            .select('*')
            .order('date_saisie', { ascending: false });
        
        if (alphaError) throw alphaError;
        if (alphaDataRaw) {
            alphabetisationData = alphaDataRaw;
            console.log('‚úÖ Alphab√©tisation charg√©e:', alphabetisationData.length);
        }
        
        console.log('‚úÖ Toutes les donn√©es charg√©es avec succ√®s !');
        
    } catch (error) {
        console.error('‚ùå ERREUR CRITIQUE lors du chargement:', error);
        alert('‚ùå Erreur de connexion √† la base de donn√©es : ' + error.message);
    }
}

        async function saveCommentairesEtPreuves() {
            try {
                // Supprimer tous les commentaires existants
                await supabase.from('commentaires_preuves').delete().neq('id', 0);
                
                // Ins√©rer les nouveaux
const toSave = commentairesEtPreuves.map(c => ({
    id: c.id,
    type: c.type,
    objectif: c.objectif,
    activite: c.activite,
    service: c.service,
    commentaire: c.commentaire || null,
    nom_fichier: c.nomFichier || null,
    nom_fichier_storage: c.nomFichierStorage || null,
    file_url: c.fileUrl || null,
    taille_fichier: c.tailleFichier || null,
    cree_par: c.creePar,
    date_creation: c.dateCreation || new Date().toISOString(),
    depose_par: c.deposePar || null,
    date_depot: c.dateDepot || null,
    modifie_par: c.modifiePar || null,
    date_modification: c.dateModification || null
}));
                if (toSave.length > 0) {
                    const { error } = await supabase.from('commentaires_preuves').insert(toSave);
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur saveCommentaires:', error);
            }
        }

        async function saveUsers() {
            try {
                // Supprimer tous les utilisateurs existants
                await supabase.from('users').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                
                // Ins√©rer les nouveaux utilisateurs
                const usersToSave = users.map(u => ({
                    username: u.user,
                    password: u.pass,
                    role: u.role,
                    nom: u.nom,
                    service: u.service,
                    actif: u.actif !== false
                }));
                
                if (usersToSave.length > 0) {
                    const { error } = await supabase.from('users').insert(usersToSave);
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur saveUsers:', error);
            }
        }

        async function saveRapportTextes() {
            try {
                if (!currentUser) return;
                
                // Pour chaque cl√© dans rapportTextes, faire un upsert
                for (var key in rapportTextes) {
                    const { error } = await supabase
                        .from('rapport_textes')
                        .upsert({
                            user_key: currentUser.user,
                            cle: key,
                            valeur: rapportTextes[key],
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_key,cle'
                        });
                    
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur saveRapportTextes:', error);
            }
        }

        async function loadRapportTextes() {
            try {
                if (!currentUser) return;
                
                const { data: textes, error } = await supabase
                    .from('rapport_textes')
                    .select('*')
                    .eq('user_key', currentUser.user);
                
                if (error) throw error;
                
                rapportTextes = {};
                if (textes) {
                    for (var i = 0; i < textes.length; i++) {
                        rapportTextes[textes[i].cle] = textes[i].valeur;
                    }
                }
            } catch (error) {
                console.error('Erreur loadRapportTextes:', error);
            }
        }
// ========== FONCTIONS UTILITAIRES ==========
        function canModify(activity) {
            if (!currentUser) return false;
            if (currentUser.role === 'chefdept') return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.role === 'chef' && activity.service === currentUser.service) return true;
            return false;
        }

        function canValidate(activity) {
            return currentUser && currentUser.role === 'admin';
        }

        function canDeleteInPlanning(activity) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.role === 'chef' && activity.service === currentUser.service) return !activity.valide;
            return false;
        }

        // ========== FONCTIONS DE NAVIGATION ==========
async function login(username, password) {
    try {
        // Rechercher l'utilisateur dans Supabase
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .eq('password', password)
            .single();
        
        if (error || !user) {
            alert('Identifiants incorrects');
            return;
        }
        
        if (user.actif === false) {
            alert('Ce compte est d√©sactiv√©');
            return;
        }
        
        // Connexion r√©ussie
        currentUser = {
            id: user.id,
            user: user.username,
            pass: user.password,
            role: user.role,
            nom: user.nom,
            service: user.service,
            actif: user.actif
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        await loadRapportTextes();
        
        var alreadyConnected = false;
        for (var i = 0; i < connectedUsers.length; i++) {
            if (connectedUsers[i].user === currentUser.user) {
                alreadyConnected = true;
                connectedUsers[i].connectedAt = new Date().toLocaleString('fr-FR');
                break;
            }
        }
        if (!alreadyConnected) {
            connectedUsers.push({
                user: currentUser.user,
                nom: currentUser.nom,
                service: currentUser.service,
                connectedAt: new Date().toLocaleString('fr-FR')
            });
        }
        localStorage.setItem('connectedUsers', JSON.stringify(connectedUsers));
        
        // V√©rifier si c'est un mot de passe provisoire
        if (!user.password_changed && user.password === 'TempMepua@2024!') {
            render();
            setTimeout(function() {
                showChangePasswordModal();
            }, 500);
        } else {
            render();
        }
    } catch (error) {
        console.error('Erreur login:', error);
        alert('Erreur de connexion');
    }
}
function showChangePasswordModal() {
    var modalContainer = document.getElementById('modal-container');
    var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">üîí Changement de mot de passe</h2>';
    
    html += '<div class="alert alert-warning">Vous utilisez un mot de passe provisoire. Veuillez le changer maintenant.</div>';
    
    html += '<div class="form-group"><label>Ancien mot de passe</label><input type="password" id="old-password" class="form-control"></div>';
    html += '<div class="form-group"><label>Nouveau mot de passe</label><input type="password" id="new-password" class="form-control"></div>';
    html += '<div class="form-group"><label>Confirmer le nouveau mot de passe</label><input type="password" id="confirm-password" class="form-control"></div>';
    
    html += '<div class="btn-group"><button class="btn btn-primary" onclick="submitChangePassword()">Changer le mot de passe</button></div>';
    html += '</div></div>';
    
    modalContainer.innerHTML = html;
}

async function submitChangePassword() {
    var oldPassword = document.getElementById('old-password').value;
    var newPassword = document.getElementById('new-password').value;
    var confirmPassword = document.getElementById('confirm-password').value;
    
    if (!oldPassword || !newPassword || !confirmPassword) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    if (oldPassword !== currentUser.pass) {
        alert('Ancien mot de passe incorrect');
        return;
    }
    
    if (newPassword.length < 8) {
        alert('Le nouveau mot de passe doit contenir au moins 8 caract√®res');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('Les mots de passe ne correspondent pas');
        return;
    }
    
    try {
        // Mettre √† jour le mot de passe dans Supabase
        const { error } = await supabase
            .from('users')
            .update({ password: newPassword, password_changed: true })
            .eq('id', currentUser.id);
        
        if (error) throw error;
        
        currentUser.pass = newPassword;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        alert('Mot de passe chang√© avec succ√®s !');
        closeModal();
    } catch (error) {
        console.error('Erreur changement mot de passe:', error);
        alert('Erreur lors du changement de mot de passe');
    }
}
        function logout() {
            if (currentUser) {
                var newConnectedUsers = [];
                for (var i = 0; i < connectedUsers.length; i++) {
                    if (connectedUsers[i].user !== currentUser.user) {
                        newConnectedUsers.push(connectedUsers[i]);
                    }
                }
                connectedUsers = newConnectedUsers;
                localStorage.setItem('connectedUsers', JSON.stringify(connectedUsers));
            }
            
            localStorage.removeItem('currentUser');
            currentUser = null;
            render();
        }

        function changeTab(tab) {
            activeTab = tab;
            render();
        }
        function changeAnalyseTab(subTab) {
    activeAnalyseTab = subTab;
    render();
}
        async function attemptLogin() {
            var username = document.getElementById('username').value.trim();
            var password = document.getElementById('password').value;
            await login(username, password);
        }

        function changeServiceFilter(service) {
            selectedServiceFilter = service;
            render();
        }
// ========== INSCRIPTION PAR INVITATION ==========
async function submitSignupWithInvitation() {
    var email = document.getElementById('signup-email').value.trim();
    var password = document.getElementById('signup-password').value;
    var confirmPassword = document.getElementById('signup-confirm-password').value;
    
    if (!email || !password || !confirmPassword) {
        alert('Veuillez remplir tous les champs');
        return;
    }
    
    if (password.length < 8) {
        alert('Le mot de passe doit contenir au moins 8 caract√®res');
        return;
    }
    
    if (password !== confirmPassword) {
        alert('Les mots de passe ne correspondent pas');
        return;
    }
    
    // V√©rifier si l'email existe d√©j√†
    const { data: existingUsers, error: checkError } = await supabase
        .from('users')
        .select('*')
        .eq('username', invitationData.username);
    
    if (checkError) {
        alert('Erreur lors de la v√©rification');
        return;
    }
    
    if (existingUsers && existingUsers.length > 0) {
        alert('Ce nom d\'utilisateur existe d√©j√†');
        return;
    }
    
    try {
        // Cr√©er le compte dans la table users
        const { error: insertError } = await supabase
            .from('users')
            .insert({
                username: invitationData.username,
                password: password,
                role: 'chef',
                nom: invitationData.username,
                service: invitationData.username.split('.')[0],
                actif: true,
                email: email,
            });
        
        if (insertError) throw insertError;
        
        // Marquer l'invitation comme accept√©e
        const { error: updateError } = await supabase
            .from('invitations')
            .update({
                status: 'accepted',
                email: email,
                used_at: new Date().toISOString()
            })
            .eq('id', invitationData.id);
        
        if (updateError) throw updateError;
        
        alert('‚úÖ Compte cr√©√© avec succ√®s ! Vous pouvez maintenant vous connecter.');
        
        // Rediriger vers la page de connexion
        window.location.href = window.location.pathname;
        
    } catch (error) {
        console.error('Erreur cr√©ation compte:', error);
        alert('Erreur lors de la cr√©ation du compte');
    }
}

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // ========== FONCTIONS DE FILTRAGE ==========
        function changeStatusFilter(status) {
            selectedStatusFilter = status;
            render();
        }

        function changeDashboardObjectifFilter(objectif) {
            selectedObjectifFilter = objectif;
            render();
        }

        function changeDashboardTrimestreFilter(trimestre) {
            selectedTrimestreFilter = trimestre;
            render();
        }

        function getFilteredDataForDashboard() {
            if (!currentUser) return [];
            
            var baseData = [];
            for (var i = 0; i < data.length; i++) {
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    if (data[i].valide) baseData.push(data[i]);
                } else {
                    if (data[i].service === currentUser.service && data[i].valide) {
                        baseData.push(data[i]);
                    }
                }
            }
            
            if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && selectedServiceFilter !== 'TOUS') {
                var filtered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].service === selectedServiceFilter) filtered.push(baseData[i]);
                }
                baseData = filtered;
            }
            
            if (selectedStatusFilter !== 'TOUS') {
                var statusFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    var taux = calcTaux(baseData[i]);
                    var status = taux === 100 ? 'Ex√©cut√©e' : taux > 0 ? 'En cours' : 'Non commenc√©e';
                    if (status === selectedStatusFilter) {
                        statusFiltered.push(baseData[i]);
                    }
                }
                baseData = statusFiltered;
            }
            
            if (selectedObjectifFilter !== 'TOUS') {
                var objectifFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].categorie === selectedObjectifFilter) {
                        objectifFiltered.push(baseData[i]);
                    }
                }
                baseData = objectifFiltered;
            }
            
            if (selectedTrimestreFilter !== 'TOUS') {
                var trimestreFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    var programmee = false;
                    if (selectedTrimestreFilter === 'T1' && baseData[i].t1) programmee = true;
                    else if (selectedTrimestreFilter === 'T2' && (baseData[i].t1 || baseData[i].t2)) programmee = true;
                    else if (selectedTrimestreFilter === 'T3' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3)) programmee = true;
                    else if (selectedTrimestreFilter === 'T4' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3 || baseData[i].t4)) programmee = true;
                    if (programmee) trimestreFiltered.push(baseData[i]);
                }
                baseData = trimestreFiltered;
            }
            
            return baseData;
        }

        function getFilteredDataForPlanning() {
            if (!currentUser) return [];
            
            var baseData = [];
            if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                baseData = data;
            } else {
                for (var i = 0; i < data.length; i++) {
                    if (data[i].service === currentUser.service && !data[i].valide) {
                        baseData.push(data[i]);
                    }
                }
            }
            
            if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && selectedServiceFilter !== 'TOUS') {
                var filtered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].service === selectedServiceFilter) filtered.push(baseData[i]);
                }
                return filtered;
            }
            
            return baseData;
        }
       async function validateActivity(activityId) {
    if (!canValidate()) {
        alert('Seul l\'administrateur peut valider');
        return;
    }
    
    if (confirm('Valider cette activit√©?')) {
        try {
            const { error } = await supabase
                .from('activites')
                .update({
                    valide: true,
                    valide_par: currentUser.nom,
                    date_validation: new Date().toISOString()
                })
                .eq('id', activityId);
            
            if (error) throw error;
            
            // Mettre √† jour localement
            for (var i = 0; i < data.length; i++) {
                if (data[i].id === activityId) {
                    data[i].valide = true;
                    data[i].valide_par = currentUser.nom;
                    data[i].date_validation = new Date().toISOString();
                    break;
                }
            }
            
            render();
        } catch (error) {
            console.error('Erreur validation:', error);
            alert('‚ùå Erreur lors de la validation');
        }
    }
}
async function deleteActivity(activityId) {
    var activity = null;
    for (var i = 0; i < data.length; i++) {
        if (data[i].id === activityId) {
            activity = data[i];
            break;
        }
    }
    
    if (!activity) {
        alert('Activit√© introuvable');
        return;
    }
    
    // üî• V√âRIFICATION SIMPLIFI√âE
    if (!canDeleteInPlanning(activity)) {
        alert('‚ùå Vous ne pouvez pas supprimer cette activit√©');
        return;
    }

    if (confirm('Supprimer cette activit√©?')) {
        try {
            const { error } = await supabase
                .from('activites')
                .delete()
                .eq('id', activityId);
            
            if (error) throw error;
            
            // Mettre √† jour localement
            var newData = [];
            for (var i = 0; i < data.length; i++) {
                if (data[i].id !== activityId) newData.push(data[i]);
            }
            data = newData;
            
            render();
        } catch (error) {
            console.error('Erreur suppression:', error);
            alert('‚ùå Erreur lors de la suppression');
        }
    }
}
        function showAddModal() {
            var modalContainer = document.getElementById('modal-container');
            var defaultService = currentUser.role === 'chef' ? currentUser.service : services[0];
            
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">Ajouter une activit√©</h2>';
            
            if (currentUser.role === 'chef') {
                html += '<div class="alert alert-warning">Vous ne pouvez ajouter que pour votre service: <strong>' + currentUser.service + '</strong></div>';
            }
            
            html += '<div class="form-group"><label>Objectif</label><select id="new-categorie" class="form-control"><option>Objectifs G√©n√©raux</option><option>Objectifs de R√©forme</option><option>Objectifs Sp√©cifiques</option><option>D√©cisions du CM</option><option>D√©cisions du PR</option></select></div>';
            html += '<div class="form-group"><label>Activit√©</label><textarea id="new-activite" class="form-control" rows="3"></textarea></div>';
            html += '<div class="form-group"><label>Service</label>';
            
            if (currentUser.role === 'chef') {
                html += '<input type="text" class="form-control" value="' + currentUser.service + '" disabled><input type="hidden" id="new-service" value="' + currentUser.service + '">';
            } else {
                html += '<select id="new-service" class="form-control">';
                for (var i = 0; i < services.length; i++) {
                    var selected = services[i] === defaultService ? ' selected' : '';
                    html += '<option value="' + services[i] + '"' + selected + '>' + services[i] + '</option>';
                }
                html += '</select>';
            }
            
            html += '</div><div class="btn-group"><button class="btn btn-primary" onclick="submitNewActivity()">Ajouter</button><button class="btn btn-secondary" onclick="closeModal()">Annuler</button></div></div></div>';
            
            modalContainer.innerHTML = html;
        }

        async function submitNewActivity() {
    var activite = document.getElementById('new-activite').value.trim();
    var service = document.getElementById('new-service').value; // üî• D√âPLACER ICI
    
    // üî• V√âRIFICATION SIMPLIFI√âE
    if (currentUser.role === 'chef' && service !== currentUser.service) {
        alert('‚ùå Vous ne pouvez ajouter que pour votre service');
        return;
    }
 
    if (!activite) {
        alert('Veuillez remplir l\'activit√©');
        return;
    }

    var newActivity = {
        categorie: document.getElementById('new-categorie').value,
        activite: activite,
        service: service,
        t1: false, t2: false, t3: false, t4: false,
        tdr: false, eng: false, mand: false, ordo: false, liq: false, exec: false,
        valide: false,
        valide_par: null,
        date_validation: null,
        derniere_maj: new Date().toISOString(),
        maj_par: currentUser.nom
    };
    
    // Ins√©rer DIRECTEMENT dans Supabase
    try {
        const { data: insertedData, error } = await supabase
            .from('activites')
            .insert([newActivity])
            .select();
        
        if (error) throw error;
        
        // Ajouter l'activit√© avec son ID g√©n√©r√© au tableau local
        if (insertedData && insertedData.length > 0) {
            data.push(insertedData[0]);
        }
        
        alert('‚úÖ Activit√© ajout√©e avec succ√®s !');
        closeModal();
        render();
    } catch (error) {
        console.error('Erreur ajout activit√©:', error);
        alert('‚ùå Erreur lors de l\'ajout de l\'activit√©');
    }
}
        function getFilteredDataForSuivi() {
            if (!currentUser) return [];
            
            var baseData = [];
            for (var i = 0; i < data.length; i++) {
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    if (data[i].valide) baseData.push(data[i]);
                } else {
                    if (data[i].service === currentUser.service && data[i].valide) {
                        baseData.push(data[i]);
                    }
                }
            }
            
            if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && selectedServiceFilter !== 'TOUS') {
                var filtered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].service === selectedServiceFilter) filtered.push(baseData[i]);
                }
                baseData = filtered;
            }
            
            if (suiviObjectifFilter !== 'TOUS') {
                var objectifFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    if (baseData[i].categorie === suiviObjectifFilter) {
                        objectifFiltered.push(baseData[i]);
                    }
                }
                baseData = objectifFiltered;
            }
            
            if (suiviTrimestreFilter !== 'TOUS') {
                var trimestreFiltered = [];
                for (var i = 0; i < baseData.length; i++) {
                    var programmee = false;
                    if (suiviTrimestreFilter === 'T1' && baseData[i].t1) programmee = true;
                    else if (suiviTrimestreFilter === 'T2' && (baseData[i].t1 || baseData[i].t2)) programmee = true;
                    else if (suiviTrimestreFilter === 'T3' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3)) programmee = true;
                    else if (suiviTrimestreFilter === 'T4' && (baseData[i].t1 || baseData[i].t2 || baseData[i].t3 || baseData[i].t4)) programmee = true;
                    if (programmee) trimestreFiltered.push(baseData[i]);
                }
                baseData = trimestreFiltered;
            }
            
            return baseData;
        }

        function changeCommentairesServiceFilter(service) {
            commentairesServiceFilter = service;
            render();
        }

        function changeCommentairesObjectifFilter(objectif) {
            commentairesObjectifFilter = objectif;
            render();
        }

        function updateActiviteSelection() {
            var activiteSelect = document.getElementById('combined-activite');
            var objectifDisplay = document.getElementById('objectif-display');
            var serviceSelect = document.getElementById('combined-service');
            var serviceHidden = document.getElementById('combined-service-hidden');
            
            if (!activiteSelect || !objectifDisplay) return;
            
            var selectedOption = activiteSelect.options[activiteSelect.selectedIndex];
            var objectif = selectedOption.getAttribute('data-objectif');
            var service = selectedOption.getAttribute('data-service');
            
            if (objectif) {
                objectifDisplay.textContent = objectif;
                objectifDisplay.style.color = '#2563eb';
                objectifDisplay.style.fontWeight = 'bold';
            } else {
                objectifDisplay.textContent = '-';
            }
            
            if (service) {
                if (serviceSelect) serviceSelect.value = service;
                if (serviceHidden) serviceHidden.value = service;
            }
        }

        function showCommentaireEtPreuveModal() {
    var modalContainer = document.getElementById('modal-container');
    
    var html = '<div class="modal"><div class="modal-content" style="max-width: 700px;">';
    html += '<h2 style="margin-bottom: 24px;">üìã D√©poser une preuve et/ou commenter</h2>';
    
    html += '<div class="form-group"><label>Objectif *</label><select id="preuve-objectif" class="form-control" onchange="updatePreuveActivites()"><option value="">S√©lectionnez...</option>';
    
    var objectifs = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques', 'D√©cisions du CM', 'D√©cisions du PR'];
    for (var i = 0; i < objectifs.length; i++) {
        html += '<option>' + objectifs[i] + '</option>';
    }
    html += '</select></div>';
    
    html += '<div class="form-group"><label>Activit√© *</label><select id="preuve-activite" class="form-control"><option value="">S√©lectionnez d\'abord un objectif</option></select></div>';
    
    html += '<div class="form-group"><label>Commentaire (optionnel)</label><textarea id="preuve-commentaire" class="form-control" rows="4" placeholder="Ajoutez un commentaire..."></textarea></div>';
    
    html += '<div class="form-group"><label>Document de preuve (optionnel)</label>';
    html += '<input type="file" id="preuve-fichier" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.txt">';
    html += '<small style="color: #6b7280; display: block; margin-top: 4px;">Formats accept√©s : PDF, Word, Excel, PowerPoint, Images, Texte</small>';
    html += '</div>';
    
    html += '<div style="display: flex; gap: 10px; margin-top: 24px;">';
    html += '<button class="btn btn-primary" onclick="submitCommentaireEtPreuve()">üíæ Enregistrer</button>';
    html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
    html += '</div>';
    
    html += '</div></div>';
    
    modalContainer.innerHTML = html;
}

       async function submitCommentaireEtPreuve() {
    var objectif = document.getElementById('preuve-objectif').value;
    var activiteSelect = document.getElementById('preuve-activite');
    var activite = activiteSelect.value;
    var commentaire = document.getElementById('preuve-commentaire').value.trim();
    var fichierInput = document.getElementById('preuve-fichier');
    var fichier = fichierInput && fichierInput.files.length > 0 ? fichierInput.files[0] : null;
    
    if (!objectif || !activite) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner un objectif et une activit√©');
        return;
    }
    
    if (!commentaire && !fichier) {
        alert('‚ö†Ô∏è Veuillez ajouter au moins un commentaire OU un document');
        return;
    }
    
    var selectedOption = activiteSelect.options[activiteSelect.selectedIndex];
    var service = selectedOption.getAttribute('data-service') || currentUser.service;
    
    try {
        var dataToInsert = [];
        
        // üî• COMMENTAIRE
        if (commentaire) {
            dataToInsert.push({
                type: 'commentaire',
                objectif: objectif,
                activite: activite,
                service: service,
                commentaire: commentaire,
                cree_par: currentUser.nom,
                date_creation: new Date().toISOString(),
                depose_par: currentUser.nom,
                date_depot: new Date().toISOString()
            });
        }
        
        // üî• FICHIER
        if (fichier) {
            console.log('üì§ Upload du fichier:', fichier.name);
            
            var timestamp = Date.now();
            var extension = fichier.name.split('.').pop();
            var nomUnique = 'preuve_' + timestamp + '_' + service.replace(/\s+/g, '_') + '.' + extension;
            
            // Upload dans Supabase Storage
            const { data: uploadData, error: uploadError } = await supabase
                .storage
                .from('preuves_documents')
                .upload(nomUnique, fichier, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (uploadError) {
                console.error('‚ùå Erreur upload:', uploadError);
                throw uploadError;
            }
            
            // R√©cup√©rer l'URL publique
            const { data: urlData } = await supabase
                .storage
                .from('preuves_documents')
                .getPublicUrl(nomUnique);
            
            var fileUrl = urlData ? urlData.publicUrl : null;
            
            if (!fileUrl) {
                throw new Error('Impossible de g√©n√©rer l\'URL du fichier');
            }
            
            console.log('‚úÖ Fichier upload√©, URL:', fileUrl);
            
            dataToInsert.push({
                type: 'preuve',
                objectif: objectif,
                activite: activite,
                service: service,
                nom_fichier: fichier.name,
                nom_fichier_storage: nomUnique,
                file_url: fileUrl,
                taille_fichier: Math.round(fichier.size / 1024) + ' Ko',
                cree_par: currentUser.nom,
                date_creation: new Date().toISOString(),
                depose_par: currentUser.nom,
                date_depot: new Date().toISOString()
            });
        }
        
        // üî• INS√âRER DANS SUPABASE
        if (dataToInsert.length > 0) {
            const { data: insertData, error: insertError } = await supabase
                .from('commentaires_preuves')
                .insert(dataToInsert)
                .select();
            
            if (insertError) {
                console.error('‚ùå Erreur insertion:', insertError);
                throw insertError;
            }
            
            console.log('‚úÖ Donn√©es ins√©r√©es:', insertData);
            
            // Ajouter aux donn√©es locales
            if (insertData) {
                for (var i = 0; i < insertData.length; i++) {
                    commentairesEtPreuves.push(insertData[i]);
                }
            }
        }
        
        alert('‚úÖ Enregistrement r√©ussi !');
        closeModal();
        render();
        
    } catch (error) {
        console.error('‚ùå Erreur compl√®te:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}

        function showEditCommentaireModal(id) {
            var item = null;
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id === id) {
                    item = commentairesEtPreuves[i];
                    break;
                }
            }
            
            if (!item || item.type !== 'commentaire') return;
            
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">‚úèÔ∏è Modifier le commentaire</h2>';
            
            html += '<div class="form-group"><label>Objectif</label><div style="padding: 8px 16px; background-color: #f3f4f6; border-radius: 8px;">' + item.objectif + '</div></div>';
            html += '<div class="form-group"><label>Activit√©</label><div style="padding: 8px 16px; background-color: #f3f4f6; border-radius: 8px;">' + item.activite + '</div></div>';
            html += '<div class="form-group"><label>Commentaire *</label><textarea id="edit-commentaire" class="form-control" rows="4">' + item.commentaire + '</textarea></div>';
            
            html += '<div class="btn-group"><button class="btn btn-primary" onclick="submitEditCommentaire(' + id + ')">Enregistrer</button><button class="btn btn-secondary" onclick="closeModal()">Annuler</button></div></div></div>';
            
            modalContainer.innerHTML = html;
        }

        async function submitEditCommentaire(id) {
            var newCommentaire = document.getElementById('edit-commentaire').value.trim();
            
            if (!newCommentaire) {
                alert('Le commentaire ne peut pas √™tre vide');
                return;
            }
            
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id === id) {
                    commentairesEtPreuves[i].commentaire = newCommentaire;
                    commentairesEtPreuves[i].modifiePar = currentUser.nom;
                    commentairesEtPreuves[i].dateModification = new Date().toLocaleString('fr-FR');
                    break;
                }
            }
            
            await saveCommentairesEtPreuves();
            closeModal();
            render();
        }

        function showManagePreuvesModal(activite, service) {
            var modalContainer = document.getElementById('modal-container');
            
            var preuvesActivite = [];
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                var item = commentairesEtPreuves[i];
                if (item.type === 'preuve' && item.activite === activite && item.service === service) {
                    preuvesActivite.push(item);
                }
            }
            
                            var html = '<div class="modal"><div class="modal-content" style="max-width: 900px;"><h2 style="margin-bottom: 16px;">üìé G√©rer les preuves</h2>';
            
            html += '<div style="background-color: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 16px;"><strong>Activit√©:</strong> ' + activite + '<br/><strong>Service:</strong> ' + service + '</div>';
            
            html += '<h3 style="margin-bottom: 12px;">Documents d√©pos√©s</h3>';
            
            if (preuvesActivite.length > 0) {
                for (var i = 0; i < preuvesActivite.length; i++) {
                    var p = preuvesActivite[i];
                    html += '<div class="fichier-item"><div><strong>üìÑ ' + p.nomFichier + '</strong><br/><small style="color: #6b7280;">D√©pos√© par ' + p.deposePar + ' le ' + p.dateDepot + '</small></div><button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deletePreuve(' + p.id + ')">Supprimer</button></div>';
                }
            } else {
                html += '<p style="text-align: center; padding: 16px; color: #6b7280;">Aucune preuve</p>';
            }
            
            html += '<h3 style="margin-top: 24px; margin-bottom: 12px;">Ajouter nouvelles preuves</h3>';
            html += '<div class="form-group"><input type="file" id="new-preuves-fichiers" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple style="padding: 4px 8px;"></div>';
            
            html += '<div class="btn-group"><button class="btn btn-success" onclick="ajouterNouvellesPreuves(\'' + activite.replace(/'/g, "\\'") + '\', \'' + service + '\')">Ajouter</button><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div></div></div>';
            
            modalContainer.innerHTML = html;
        }

        async function ajouterNouvellesPreuves(activite, service) {
            var fichiersInput = document.getElementById('new-preuves-fichiers');
            
            if (!fichiersInput.files || fichiersInput.files.length === 0) {
                alert('Veuillez s√©lectionner au moins un fichier');
                return;
            }
            
            var maxId = 0;
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id > maxId) maxId = commentairesEtPreuves[i].id;
            }
            
            var activiteData = null;
            for (var i = 0; i < data.length; i++) {
                if (data[i].activite === activite && data[i].service === service) {
                    activiteData = data[i];
                    break;
                }
            }
            
            var objectif = activiteData ? activiteData.categorie : '';
            
            for (var i = 0; i < fichiersInput.files.length; i++) {
                var fichier = fichiersInput.files[i];
                commentairesEtPreuves.push({
                    id: maxId + 1 + i,
                    type: 'preuve',
                    objectif: objectif,
                    activite: activite,
                    service: service,
                    nomFichier: fichier.name,
                    tailleFichier: Math.round(fichier.size / 1024) + ' Ko',
                    deposePar: currentUser.nom,
                    dateDepot: new Date().toLocaleString('fr-FR')
                });
            }
            
            await saveCommentairesEtPreuves();
            alert('Fichiers ajout√©s');
            showManagePreuvesModal(activite, service);
        }

        async function deletePreuve(id) {
            if (!confirm('Supprimer cette preuve ?')) return;
            
            var newItems = [];
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                if (commentairesEtPreuves[i].id !== id) newItems.push(commentairesEtPreuves[i]);
            }
            commentairesEtPreuves = newItems;
            await saveCommentairesEtPreuves();
            closeModal();
            render();
        }

        async function deleteCommentaireOuPreuve(id) {
            if (confirm('Supprimer cet √©l√©ment?')) {
                var newItems = [];
                for (var i = 0; i < commentairesEtPreuves.length; i++) {
                    if (commentairesEtPreuves[i].id !== id) newItems.push(commentairesEtPreuves[i]);
                }
                commentairesEtPreuves = newItems;
                await saveCommentairesEtPreuves();
                render();
            }
        }
function exporterRapportWord() {
            var isGlobal = currentUser.role === 'chefdept' || (currentUser.role === 'admin' && selectedServiceFilter === 'TOUS');
            var serviceRapport = currentUser.role === 'chef' ? currentUser.service : (isGlobal ? null : selectedServiceFilter);
            
            var statsObjectifs = calculerStatsObjectifs(serviceRapport);
            var statsDecisions = calculerStatsDecisions(serviceRapport);
            
            var totalPlanifieesObj = 0, totalRealiseesObj = 0;
            for (var i = 0; i < statsObjectifs.length; i++) {
                totalPlanifieesObj += statsObjectifs[i].planifiees;
                totalRealiseesObj += statsObjectifs[i].realisees;
            }
            var tauxTotalObj = totalPlanifieesObj > 0 ? Math.round((totalRealiseesObj / totalPlanifieesObj) * 100) : 0;
            
            var totalPlanifieesDec = 0, totalRealiseesDec = 0;
            for (var i = 0; i < statsDecisions.length; i++) {
                totalPlanifieesDec += statsDecisions[i].planifiees;
                totalRealiseesDec += statsDecisions[i].realisees;
            }
            var tauxTotalDec = totalPlanifieesDec > 0 ? Math.round((totalRealiseesDec / totalPlanifieesDec) * 100) : 0;
            
            var tauxGlobalTotal = (totalPlanifieesObj + totalPlanifieesDec) > 0 ? Math.round(((totalRealiseesObj + totalRealiseesDec) / (totalPlanifieesObj + totalPlanifieesDec)) * 100) : 0;
            
            // R√©cup√©rer les textes
            var contexteKey = 'contexte_' + (serviceRapport || 'global');
            var contexteValue = rapportTextes[contexteKey] || 'Non renseign√©';
            var rappelKey = 'rappel_' + (serviceRapport || 'global');
            var rappelValue = rapportTextes[rappelKey] || 'Non renseign√©';
            var rappelDecKey = 'rappelDec_' + (serviceRapport || 'global');
            var rappelDecValue = rapportTextes[rappelDecKey] || 'Non renseign√©';
            var diffKey = 'difficultes_' + (serviceRapport || 'global');
            var diffValue = rapportTextes[diffKey] || 'Non renseign√©';
            var pistesKey = 'pistes_' + (serviceRapport || 'global');
            var pistesValue = rapportTextes[pistesKey] || 'Non renseign√©';
            
            var html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/1999/xhtml">';
            html += '<head><meta charset="utf-8"><title>Rapport de Performance</title>';
            html += '<style>';
            html += 'body { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; line-height: 1.6; margin: 1cm; }';
            html += 'h1 { color: #2563eb; text-align: center; font-size: 20pt; font-weight: bold; margin-bottom: 20px; }';
            html += 'h2 { color: #2563eb; font-size: 14pt; font-weight: bold; margin-top: 30px; margin-bottom: 15px; }';
            html += 'h3 { color: #4b5563; font-size: 14pt; margin-top: 20px; margin-bottom: 12px; font-weight: bold; }';
            html += 'p { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; margin: 10px 0; text-align: justify; line-height: 1.6; }';
            html += 'table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12pt; }';
            html += 'th, td { border: 1px solid #000; padding: 4px 8px; height: 18px; }';
            html += 'th { background-color: #2563eb; color: white; font-weight: bold; text-align: center; }';
            html += 'td { text-align: center; }';
            html += 'td:first-child { text-align: left; font-weight: bold; }';
            html += 'tr.total { background-color: #e5e7eb; font-weight: bold; }';
            html += '.graph-space { margin: 30px 0; padding: 60px 20px; text-align: center; }';
            html += '.graph-title { font-family: "Century Gothic", Arial, sans-serif; font-size: 14pt; font-weight: bold; color: #4b5563; margin-bottom: 10px; }';
            html += '.graph-instruction { font-family: "Century Gothic", Arial, sans-serif; font-size: 11pt; color: #6b7280; font-style: italic; }';
            html += 'ul { margin: 15px 0; padding: 0; list-style-type: none !important; }';
            html += 'li { margin-bottom: 12px; padding: 0; list-style-type: none !important; list-style: none !important; }';
            html += 'li .activite-titre { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; font-weight: bold; display: block; margin-bottom: 4px; }';
            html += 'li .commentaire { font-family: "Century Gothic", Arial, sans-serif; font-size: 12pt; display: block; text-align: justify; font-style: italic; color: #000; margin-left: 0; line-height: 1.6; }';
            html += '</style></head><body>';
            
            var titreRapport = isGlobal ? 'RAPPORT DE PERFORMANCE GLOBAL' : 'RAPPORT DE PERFORMANCE - ' + (serviceRapport || 'SERVICE');
            html += '<h1>' + titreRapport + '</h1>';
            html += '<p style="text-align: center; color: #6b7280; margin-bottom: 30px;">Ann√©e 2026 - G√©n√©r√© le ' + new Date().toLocaleString('fr-FR') + '</p>';
            
            // SECTION 1
            html += '<h2>1. √âl√©ments de contexte</h2>';
            html += '<p>' + contexteValue.replace(/\n/g, '<br/>') + '</p>';
            
            // SECTION 2
            html += '<h2>2. Bilan des r√©alisations des objectifs</h2>';
            html += '<h3>Rappel des actions programm√©es</h3>';
            html += '<p>' + rappelValue.replace(/\n/g, '<br/>') + '</p>';
            
            // TABLEAU 1 - COMPLET
            html += '<h3>Tableau 1 : Taux par objectif</h3>';
            html += '<table><thead><tr><th>Objectifs</th><th>Planifi√©es</th><th>R√©alis√©es</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.planifiees + '</td><td>' + stat.realisees + '</td><td><strong>' + stat.taux + '</strong></td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + totalPlanifieesObj + '</td><td>' + totalRealiseesObj + '</td><td><strong>' + tauxTotalObj + '</strong></td></tr>';
            html += '</tbody></table>';
            
            // ESPACE GRAPHIQUE 1
            html += '<div class="graph-space">';
            html += '<div class="graph-title">Graphique 1 : Taux par objectif</div>';
            html += '<div class="graph-instruction">[Ins√©rer ici le graphique]</div>';
            html += '</div>';
            
            // LISTES DES ACTIVIT√âS
            var objectifsList = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques'];
            for (var j = 0; j < objectifsList.length; j++) {
                var objNom = objectifsList[j];
                var activitesObj = getActivitesRealisees(serviceRapport, objNom);
                html += '<h3>' + objNom + '</h3>';
                if (activitesObj.length > 0) {
                    html += '<ul>';
                    for (var k = 0; k < activitesObj.length; k++) {
                        var act = activitesObj[k];
                        html += '<li>';
                        html += '<div class="activite-titre">' + act.activite + ' :</div>';
                        var commentaire = getCommentaireForActivite(act.activite, act.service);
                        if (commentaire) {
                            html += '<div class="commentaire">' + commentaire + '</div>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p style="color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e √† 100%.</p>';
                }
            }
            
            // SECTION 3
            html += '<h2>3. Bilan d\'ex√©cution des D√©cisions du PR et des CM</h2>';
            html += '<h3>Rappel des d√©cisions</h3>';
            html += '<p>' + rappelDecValue.replace(/\n/g, '<br/>') + '</p>';
            
            // TABLEAU 2 - COMPLET
            html += '<h3>Tableau 2 : Taux par d√©cision</h3>';
            html += '<table><thead><tr><th>D√©cisions</th><th>Planifi√©es</th><th>R√©alis√©es</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsDecisions.length; i++) {
                var stat = statsDecisions[i];
                html += '<tr><td>' + stat.decision + '</td><td>' + stat.planifiees + '</td><td>' + stat.realisees + '</td><td><strong>' + stat.taux + '</strong></td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + totalPlanifieesDec + '</td><td>' + totalRealiseesDec + '</td><td><strong>' + tauxTotalDec + '</strong></td></tr>';
            html += '</tbody></table>';
            
            // ESPACE GRAPHIQUE 2
            html += '<div class="graph-space">';
            html += '<div class="graph-title">Graphique 2 : Taux par d√©cision</div>';
            html += '<div class="graph-instruction">[Ins√©rer ici le graphique]</div>';
            html += '</div>';
            
            // LISTES DES D√âCISIONS
            var decisionsPR = getActivitesRealisees(serviceRapport, 'D√©cisions du PR');
            var decisionsCM = getActivitesRealisees(serviceRapport, 'D√©cisions du CM');
            
            html += '<h3>D√©cisions du PR</h3>';
            if (decisionsPR.length > 0) {
                html += '<ul>';
                for (var k = 0; k < decisionsPR.length; k++) {
                    var act = decisionsPR[k];
                    html += '<li>';
                    html += '<div class="activite-titre">' + act.activite + ' :</div>';
                    var commentaire = getCommentaireForActivite(act.activite, act.service);
                    if (commentaire) {
                        html += '<div class="commentaire">' + commentaire + '</div>';
                    }
                    html += '</li>';
                }
                html += '</ul>';
            } else {
                html += '<p style="color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
            }
            
            html += '<h3>D√©cisions du CM</h3>';
            if (decisionsCM.length > 0) {
                html += '<ul>';
                for (var k = 0; k < decisionsCM.length; k++) {
                    var act = decisionsCM[k];
                    html += '<li>';
                    html += '<div class="activite-titre">' + act.activite + ' :</div>';
                    var commentaire = getCommentaireForActivite(act.activite, act.service);
                    if (commentaire) {
                        html += '<div class="commentaire">' + commentaire + '</div>';
                    }
                    html += '</li>';
                }
                html += '</ul>';
            } else {
                html += '<p style="color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
            }
            
            // TABLEAU 3 - COMPLET
            html += '<h3>Tableau 3 : Vue globale</h3>';
            html += '<table><thead><tr><th>Cat√©gories</th><th>Planifi√©es</th><th>R√©alis√©es</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.planifiees + '</td><td>' + stat.realisees + '</td><td><strong>' + stat.taux + '</strong></td></tr>';
            }
            html += '<tr><td>D√©cisions du PR</td><td>' + statsDecisions[0].planifiees + '</td><td>' + statsDecisions[0].realisees + '</td><td><strong>' + statsDecisions[0].taux + '</strong></td></tr>';
            html += '<tr><td>D√©cisions du CM</td><td>' + statsDecisions[1].planifiees + '</td><td>' + statsDecisions[1].realisees + '</td><td><strong>' + statsDecisions[1].taux + '</strong></td></tr>';
            html += '<tr class="total"><td>TOTAL GLOBAL</td><td>' + (totalPlanifieesObj + totalPlanifieesDec) + '</td><td>' + (totalRealiseesObj + totalRealiseesDec) + '</td><td><strong>' + tauxGlobalTotal + '</strong></td></tr>';
            html += '</tbody></table>';
            
            // ESPACE GRAPHIQUE 3
            html += '<div class="graph-space">';
            html += '<div class="graph-title">Graphique 3 : Vue globale</div>';
            html += '<div class="graph-instruction">[Ins√©rer ici le graphique]</div>';
            html += '</div>';
            
            // SECTION 4
            html += '<h2>4. Difficult√©s et Solutions</h2>';
            html += '<h3>4.1 Difficult√©s</h3>';
            html += '<p>' + diffValue.replace(/\n/g, '<br/>') + '</p>';
            html += '<h3>4.2 Pistes de Solutions</h3>';
            html += '<p>' + pistesValue.replace(/\n/g, '<br/>') + '</p>';
            
            html += '</body></html>';
            
            var blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'Rapport_Performance_2026_' + new Date().getTime() + '.doc';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exporterDonneesExcel() {
            var isGlobal = currentUser.role === 'chefdept' || (currentUser.role === 'admin' && selectedServiceFilter === 'TOUS');
            var serviceRapport = currentUser.role === 'chef' ? currentUser.service : (isGlobal ? null : selectedServiceFilter);
            
            var statsObjectifs = calculerStatsObjectifs(serviceRapport);
            var statsDecisions = calculerStatsDecisions(serviceRapport);
            
            // Calculer totaux
            var totalPlanifieesObj = 0, totalRealiseesObj = 0;
            for (var i = 0; i < statsObjectifs.length; i++) {
                totalPlanifieesObj += statsObjectifs[i].planifiees;
                totalRealiseesObj += statsObjectifs[i].realisees;
            }
            var tauxTotalObj = totalPlanifieesObj > 0 ? Math.round((totalRealiseesObj / totalPlanifieesObj) * 100) : 0;
            
            var totalPlanifieesDec = 0, totalRealiseesDec = 0;
            for (var i = 0; i < statsDecisions.length; i++) {
                totalPlanifieesDec += statsDecisions[i].planifiees;
                totalRealiseesDec += statsDecisions[i].realisees;
            }
            var tauxTotalDec = totalPlanifieesDec > 0 ? Math.round((totalRealiseesDec / totalPlanifieesDec) * 100) : 0;
            
            var tauxGlobalTotal = (totalPlanifieesObj + totalPlanifieesDec) > 0 ? Math.round(((totalRealiseesObj + totalRealiseesDec) / (totalPlanifieesObj + totalPlanifieesDec)) * 100) : 0;
            
            var html = '<html xmlns:x="urn:schemas-microsoft-com:office:excel">';
            html += '<head><meta charset="utf-8"><style>';
            html += 'table { border-collapse: collapse; width: 100%; margin-bottom: 40px; }';
            html += 'th, td { border: 1px solid #000; padding: 8px; text-align: left; }';
            html += 'th { background-color: #2563eb; color: white; font-weight: bold; }';
            html += 'tr.total { background-color: #e5e7eb; font-weight: bold; }';
            html += 'h2 { color: #2563eb; margin-top: 30px; }';
            html += '</style></head><body>';
            
            var titreRapport = isGlobal ? 'DONN√âES RAPPORT GLOBAL' : 'DONN√âES RAPPORT - ' + (serviceRapport || 'SERVICE');
            html += '<h1>' + titreRapport + '</h1>';
            html += '<p>Ann√©e 2026 - G√©n√©r√© le ' + new Date().toLocaleString('fr-FR') + '</p>';
            
            // TABLEAU 1 : Objectifs
            html += '<h2>Tableau 1 : Taux par objectif</h2>';
            html += '<table><thead><tr><th>Objectifs</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.taux + '</td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + tauxTotalObj + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<p style="font-style: italic; color: #666; margin-bottom: 40px;">‚Üí S√©lectionnez ce tableau et cr√©ez un graphique en barres horizontales</p>';
            
            // TABLEAU 2 : D√©cisions
            html += '<h2>Tableau 2 : Taux par d√©cision</h2>';
            html += '<table><thead><tr><th>D√©cisions</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsDecisions.length; i++) {
                var stat = statsDecisions[i];
                html += '<tr><td>' + stat.decision + '</td><td>' + stat.taux + '</td></tr>';
            }
            html += '<tr class="total"><td>TOTAL</td><td>' + tauxTotalDec + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<p style="font-style: italic; color: #666; margin-bottom: 40px;">‚Üí S√©lectionnez ce tableau et cr√©ez un graphique en barres horizontales</p>';
            
            // TABLEAU 3 : Vue globale
            html += '<h2>Tableau 3 : Vue globale</h2>';
            html += '<table><thead><tr><th>Cat√©gories</th><th>Taux (%)</th></tr></thead><tbody>';
            for (var i = 0; i < statsObjectifs.length; i++) {
                var stat = statsObjectifs[i];
                html += '<tr><td>' + stat.objectif + '</td><td>' + stat.taux + '</td></tr>';
            }
            html += '<tr><td>D√©cisions du PR</td><td>' + statsDecisions[0].taux + '</td></tr>';
            html += '<tr><td>D√©cisions du CM</td><td>' + statsDecisions[1].taux + '</td></tr>';
            html += '<tr class="total"><td>TOTAL GLOBAL</td><td>' + tauxGlobalTotal + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<p style="font-style: italic; color: #666;">‚Üí S√©lectionnez ce tableau et cr√©ez un histogramme vertical</p>';
            
            html += '</body></html>';
            
            var blob = new Blob(['\ufeff' + html], { type: 'application/vnd.ms-excel' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'Donnees_Rapport_2026_' + new Date().getTime() + '.xls';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function sauvegarderTexteRapport(key, value) {
            rapportTextes[key] = value;
            saveRapportTextes();
        }

        function getActivitesRealisees(service, objectif) {
            var activites = [];
            for (var i = 0; i < data.length; i++) {
                var d = data[i];
                if (d.valide && calcTaux(d) === 100) {
                    if (service && d.service !== service) continue;
                    if (objectif && d.categorie !== objectif) continue;
                    activites.push(d);
                }
            }
            return activites;
        }

        function getCommentaireForActivite(activite, service) {
            for (var i = 0; i < commentairesEtPreuves.length; i++) {
                var item = commentairesEtPreuves[i];
                if (item.type === 'commentaire' && item.activite === activite && item.service === service) {
                    return item.commentaire;
                }
            }
            return '';
        }

        function calculerStatsObjectifs(service) {
            var objectifs = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques'];
            var stats = [];
            
            for (var j = 0; j < objectifs.length; j++) {
                var obj = objectifs[j];
                var planifiees = 0;
                var realisees = 0;
                
                for (var i = 0; i < data.length; i++) {
                    var d = data[i];
                    if (!d.valide) continue;
                    if (service && d.service !== service) continue;
                    if (d.categorie === obj) {
                        planifiees++;
                        if (calcTaux(d) === 100) realisees++;
                    }
                }
                
                var taux = planifiees > 0 ? Math.round((realisees / planifiees) * 100) : 0;
                stats.push({
                    objectif: obj,
                    planifiees: planifiees,
                    realisees: realisees,
                    taux: taux
                });
            }
            
            return stats;
        }

        function calculerStatsDecisions(service) {
            var decisions = ['D√©cisions du PR', 'D√©cisions du CM'];
            var stats = [];
            
            for (var j = 0; j < decisions.length; j++) {
                var dec = decisions[j];
                var planifiees = 0;
                var realisees = 0;
                
                for (var i = 0; i < data.length; i++) {
                    var d = data[i];
                    if (!d.valide) continue;
                    if (service && d.service !== service) continue;
                    if (d.categorie === dec) {
                        planifiees++;
                        if (calcTaux(d) === 100) realisees++;
                    }
                }
                
                var taux = planifiees > 0 ? Math.round((realisees / planifiees) * 100) : 0;
                stats.push({
                    decision: dec,
                    planifiees: planifiees,
                    realisees: realisees,
                    taux: taux
                });
            }
            
            return stats;
        }
function showUserList() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content" style="max-width: 1000px;"><h2 style="margin-bottom: 24px;">Gestion des Comptes</h2>';
            
            html += '<div style="margin-bottom: 16px;"><button class="btn btn-success" onclick="showCreateUserForm()">+ Cr√©er un compte</button></div>';
            
            html += '<div class="table-container"><table><thead class="blue"><tr><th>Utilisateur</th><th>Nom</th><th>Service</th><th>R√¥le</th><th>Statut</th><th style="text-align: center;">Actions</th></tr></thead><tbody>';
            
            for (var i = 0; i < users.length; i++) {
                var u = users[i];
                if (typeof u.actif === 'undefined') u.actif = true;
                
                html += '<tr><td>' + u.user + '</td><td>' + u.nom + '</td><td>' + u.service + '</td><td>';
                
                if (u.role === 'admin') html += '<span class="badge" style="background-color: #dc2626; color: white;">Admin</span>';
                else if (u.role === 'chef') html += '<span class="badge" style="background-color: #059669; color: white;">Chef</span>';
                else html += '<span class="badge" style="background-color: #d97706; color: white;">Chef D√©p.</span>';
                
                html += '</td><td>';
                
                if (u.actif) {
                    html += '<span class="badge badge-green" style="color: #065f46;">Actif</span>';
                } else {
                    html += '<span class="badge" style="background-color: #fee2e2; color: #991b1b;">D√©sactiv√©</span>';
                }
                
                html += '</td><td style="text-align: center;">';
                
                if (u.role !== 'admin') {
                    html += '<div style="display: flex; gap: 4px; justify-content: center;">';
                    html += '<button class="btn btn-primary" style="font-size: 11px; padding: 4px 8px;" onclick="showEditUserForm(' + u.id + ')">Modifier</button>';
                    
                    if (u.actif) {
                        html += '<button class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;" onclick="toggleUserStatus(' + u.id + ')">D√©sactiver</button>';
                    } else {
                        html += '<button class="btn btn-success" style="font-size: 11px; padding: 4px 8px;" onclick="toggleUserStatus(' + u.id + ')">Activer</button>';
                    }
                    
                    html += '<button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="confirmDeleteUser(' + u.id + ')">Supprimer</button>';
                    html += '</div>';
                } else {
                    html += '<span style="color: #6b7280; font-size: 12px;">Compte prot√©g√©</span>';
                }
                
                html += '</td></tr>';
            }
            
            html += '</tbody></table></div>';
            html += '<div style="margin-top: 16px; text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        function showConnectedUsers() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2>Utilisateurs Connect√©s</h2>';
            
            if (connectedUsers.length > 0) {
                html += '<div class="table-container" style="margin-top: 16px;"><table><thead class="blue"><tr><th>Nom</th><th>Service</th><th>Connect√© √†</th></tr></thead><tbody>';
                for (var i = 0; i < connectedUsers.length; i++) {
                    var u = connectedUsers[i];
                    html += '<tr><td>' + u.nom + '</td><td>' + u.service + '</td><td>' + u.connectedAt + '</td></tr>';
                }
                html += '</tbody></table></div>';
            } else {
                html += '<p style="text-align: center; padding: 32px; color: #6b7280;">Aucun utilisateur connect√©</p>';
            }
            
            html += '<div style="margin-top: 16px; text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        function showCreateUserForm() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">Cr√©er un compte</h2>';
            
            html += '<div class="form-group"><label>Nom d\'utilisateur *</label><input type="text" id="new-username" class="form-control" placeholder="ex: chef.nouveauservice"></div>';
            html += '<div class="form-group"><label>Mot de passe *</label><input type="password" id="new-password" class="form-control"></div>';
            html += '<div class="form-group"><label>Nom complet *</label><input type="text" id="new-fullname" class="form-control" placeholder="ex: Chef Nouveau Service"></div>';
            html += '<div class="form-group"><label>R√¥le *</label><select id="new-role" class="form-control"><option value="chef">Chef</option><option value="chefdept">Chef D√©partement</option></select></div>';
            html += '<div class="form-group"><label>Service *</label><select id="new-service" class="form-control">';
            for (var i = 0; i < services.length; i++) {
                html += '<option value="' + services[i] + '">' + services[i] + '</option>';
            }
            html += '<option value="TOUS">TOUS</option></select></div>';
            
            html += '<div class="btn-group"><button class="btn btn-success" onclick="createNewUser()">Cr√©er</button><button class="btn btn-secondary" onclick="showUserList()">Annuler</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        async function createNewUser() {
            var username = document.getElementById('new-username').value.trim();
            var password = document.getElementById('new-password').value;
            var fullname = document.getElementById('new-fullname').value.trim();
            var role = document.getElementById('new-role').value;
            var service = document.getElementById('new-service').value;
            
            if (!username || !password || !fullname) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            for (var i = 0; i < users.length; i++) {
                if (users[i].user === username) {
                    alert('Ce nom d\'utilisateur existe d√©j√†');
                    return;
                }
            }
            
            var maxId = 0;
            for (var i = 0; i < users.length; i++) {
                if (users[i].id > maxId) maxId = users[i].id;
            }
            
            users.push({
                id: maxId + 1,
                user: username,
                pass: password,
                role: role,
                nom: fullname,
                service: service,
                actif: true
            });
            
            await saveUsers();
            alert('Compte cr√©√© avec succ√®s');
            showUserList();
        }

        async function showEditUserForm(userId) {
            var user = null;
            for (var i = 0; i < users.length; i++) {
                if (users[i].id === userId) {
                    user = users[i];
                    break;
                }
            }
            
            if (!user) return;
            
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content"><h2 style="margin-bottom: 24px;">Modifier: ' + user.user + '</h2>';
            
            html += '<div class="form-group"><label>Nom d\'utilisateur</label><input type="text" value="' + user.user + '" class="form-control" disabled></div>';
            html += '<div class="form-group"><label>Nouveau mot de passe (laisser vide si inchang√©)</label><input type="password" id="edit-password" class="form-control"></div>';
            html += '<div class="form-group"><label>Nom complet *</label><input type="text" id="edit-fullname" class="form-control" value="' + user.nom + '"></div>';
            
            html += '<div class="form-group"><label>Service *</label><select id="edit-service" class="form-control">';
            for (var i = 0; i < services.length; i++) {
                html += '<option value="' + services[i] + '"' + (user.service === services[i] ? ' selected' : '') + '>' + services[i] + '</option>';
            }
            html += '<option value="TOUS"' + (user.service === 'TOUS' ? ' selected' : '') + '>TOUS</option></select></div>';
            
            html += '<div class="btn-group"><button class="btn btn-primary" onclick="updateUser(' + userId + ')">Enregistrer</button><button class="btn btn-secondary" onclick="showUserList()">Annuler</button></div>';
            html += '</div></div>';
            modalContainer.innerHTML = html;
        }

        async function updateUser(userId) {
            var password = document.getElementById('edit-password').value;
            var fullname = document.getElementById('edit-fullname').value.trim();
            var service = document.getElementById('edit-service').value;
            
            if (!fullname) {
                alert('Veuillez remplir le nom complet');
                return;
            }
            
            for (var i = 0; i < users.length; i++) {
                if (users[i].id === userId) {
                    if (password) users[i].pass = password;
                    users[i].nom = fullname;
                    users[i].service = service;
                    break;
                }
            }
            
            await saveUsers();
            alert('Compte modifi√© avec succ√®s');
            showUserList();
        }

        async function toggleUserStatus(userId) {
            for (var i = 0; i < users.length; i++) {
                if (users[i].id === userId) {
                    if (typeof users[i].actif === 'undefined') users[i].actif = true;
                    users[i].actif = !users[i].actif;
                    await saveUsers();
                    showUserList();
                    return;
                }
            }
        }

        async function confirmDeleteUser(userId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce compte ?')) return;
            
            var newUsers = [];
            for (var i = 0; i < users.length; i++) {
                if (users[i].id !== userId) newUsers.push(users[i]);
            }
            users = newUsers;
            await saveUsers();
            alert('Compte supprim√©');
            showUserList();
        }

        function showPermissions() {
            var modalContainer = document.getElementById('modal-container');
            var html = '<div class="modal"><div class="modal-content" style="max-width: 900px;"><h2 style="margin-bottom: 24px;">üîí Gestion des Permissions</h2>';
            
            html += '<div class="alert alert-info" style="margin-bottom: 24px;">‚ÑπÔ∏è <strong>Information:</strong> Les permissions sont d√©finies par r√¥le. Chaque utilisateur h√©rite automatiquement des permissions de son r√¥le.</div>';
            
            html += '<div class="table-container"><table><thead class="blue"><tr><th style="width: 30%;">Fonctionnalit√©</th><th style="text-align: center;">Admin</th><th style="text-align: center;">Chef D√©partement</th><th style="text-align: center;">Chef de Service</th></tr></thead><tbody>';
            
            var permissions = [
                {nom: 'Voir Tableau de Bord', admin: true, chefdept: true, chef: true},
                {nom: 'Ajouter des activit√©s', admin: true, chefdept: false, chef: true},
                {nom: 'Modifier les activit√©s', admin: true, chefdept: false, chef: true},
                {nom: 'Valider les activit√©s', admin: true, chefdept: false, chef: false},
                {nom: 'Supprimer les activit√©s', admin: true, chefdept: false, chef: true},
                {nom: 'Cocher les √©tapes d\'ex√©cution', admin: true, chefdept: false, chef: true},
                {nom: 'D√©poser des commentaires', admin: true, chefdept: false, chef: true},
                {nom: 'D√©poser des preuves', admin: true, chefdept: false, chef: true},
                {nom: 'Voir les commentaires/preuves', admin: true, chefdept: true, chef: true},
                {nom: 'Modifier/Supprimer commentaires', admin: true, chefdept: false, chef: true},
                {nom: 'Voir Performance', admin: true, chefdept: true, chef: true},
                {nom: 'G√©n√©rer Rapport', admin: true, chefdept: true, chef: true},
                {nom: 'Filtrer tous les services', admin: true, chefdept: true, chef: false},
                {nom: 'G√©rer les utilisateurs', admin: true, chefdept: false, chef: false},
                {nom: 'Voir utilisateurs connect√©s', admin: true, chefdept: false, chef: false}
            ];
            
            for (var i = 0; i < permissions.length; i++) {
                var p = permissions[i];
                html += '<tr>';
                html += '<td><strong>' + p.nom + '</strong></td>';
                html += '<td style="text-align: center;">' + (p.admin ? '<span style="color: #059669; font-size: 20px;">‚úì</span>' : '<span style="color: #dc2626;">‚úó</span>') + '</td>';
                html += '<td style="text-align: center;">' + (p.chefdept ? '<span style="color: #059669; font-size: 20px;">‚úì</span>' : '<span style="color: #dc2626;">‚úó</span>') + '</td>';
                html += '<td style="text-align: center;">' + (p.chef ? '<span style="color: #059669; font-size: 20px;">‚úì</span>' : '<span style="color: #dc2626;">‚úó</span>') + '</td>';
                html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            
            html += '<h3 style="margin-top: 32px; margin-bottom: 16px;">Description des R√¥les</h3>';
            
            html += '<div style="background-color: #fee2e2; padding: 16px; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 16px;">';
            html += '<h4 style="color: #dc2626; margin-bottom: 8px;">üë§ Administrateur</h4>';
            html += '<p style="font-size: 14px; color: #991b1b;">Acc√®s complet au syst√®me. Peut g√©rer tous les services, valider les activit√©s, g√©rer les utilisateurs et acc√©der √† toutes les fonctionnalit√©s.</p>';
            html += '</div>';
            
            html += '<div style="background-color: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #d97706; margin-bottom: 16px;">';
            html += '<h4 style="color: #d97706; margin-bottom: 8px;">üë§ Chef de D√©partement</h4>';
            html += '<p style="font-size: 14px; color: #92400e;">Vue globale en lecture seule. Peut consulter toutes les donn√©es, g√©n√©rer des rapports globaux, mais ne peut pas modifier les activit√©s.</p>';
            html += '</div>';
            
            html += '<div style="background-color: #d1fae5; padding: 16px; border-radius: 8px; border-left: 4px solid #059669;">';
            html += '<h4 style="color: #059669; margin-bottom: 8px;">üë§ Chef de Service</h4>';
            html += '<p style="font-size: 14px; color: #065f46;">Gestion compl√®te de son service uniquement. Peut ajouter, modifier, supprimer des activit√©s, d√©poser commentaires et preuves pour son service.</p>';
            html += '</div>';
            
            html += '<div style="margin-top: 16px; text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">Fermer</button></div>';
            html += '</div></div>';
            
            modalContainer.innerHTML = html;
        }
// ========== D√âTECTION TOKEN D'INVITATION ==========
function getInvitationToken() {
    const params = new URLSearchParams(window.location.search);
    return params.get('token');
}

var invitationToken = null;
var invitationData = null;

async function checkInvitationToken() {
    invitationToken = getInvitationToken();
    
    if (invitationToken) {
        try {
            const { data, error } = await supabase
                .from('invitations')
                .select('*')
                .eq('token', invitationToken)
                .eq('status', 'pending')
                .single();
            
            if (error || !data) {
                alert('Invitation invalide ou d√©j√† utilis√©e');
                window.location.href = window.location.pathname;
                return;
            }
            
            if (new Date(data.expires_at) < new Date()) {
                alert('Cette invitation a expir√©. Contactez l\'administrateur.');
                window.location.href = window.location.pathname;
                return;
            }
            
            invitationData = data;
        } catch (error) {
            console.error('Erreur v√©rification invitation:', error);
        }
    }
}
// ========== FONCTIONS STATISTIQUES ==========
function calculerMoyenne(data, field) {
    if (data.length === 0) return 0;
    var total = 0;
    var count = 0;
    for (var i = 0; i < data.length; i++) {
        if (data[i][field] !== null && data[i][field] !== undefined) {
            total += parseFloat(data[i][field]);
            count++;
        }
    }
    return count > 0 ? Math.round(total / count * 10) / 10 : 0;
}
function updateFormFilters() {
    var regionId = document.getElementById('filter-region') ? document.getElementById('filter-region').value : '';
    var prefectureSelect = document.getElementById('filter-prefecture');
    
    console.log('=== UPDATE FILTERS ===');
    console.log('R√©gion s√©lectionn√©e:', regionId);
    
    if (!prefectureSelect) {
        console.log('ERROR: prefectureSelect not found');
        return;
    }
    
    // Vider et reconstruire les options
    prefectureSelect.innerHTML = '<option value="">Toutes les pr√©fectures</option>';
    
    if (regionId) {
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
        console.log('Pr√©fectures ajout√©es pour r√©gion', regionId);
    }
    
    // IMPORTANT : R√©attacher l'√©v√©nement onchange
    prefectureSelect.onchange = function() {
        console.log('Prefecture changed!');
        filterTableRows();
    };
    
    // Appliquer le filtrage
    filterTableRows();
}

function filterTableRows() {
    var regionId = document.getElementById('filter-region') ? document.getElementById('filter-region').value : '';
    var prefectureNom = document.getElementById('filter-prefecture') ? document.getElementById('filter-prefecture').value : '';
    var zoneFilter = document.getElementById('filter-zone') ? document.getElementById('filter-zone').value : '';
    var niveauFilter = document.getElementById('filter-niveau') ? document.getElementById('filter-niveau').value : '';
    var genreFilter = document.getElementById('filter-genre') ? document.getElementById('filter-genre').value : '';
    
    console.log('=== FILTRAGE ===');
    console.log('R√©gion ID:', regionId);
    console.log('Pr√©fecture:', prefectureNom);
    console.log('Zone:', zoneFilter);
    console.log('Niveau:', niveauFilter);
    console.log('Genre:', genreFilter);
    
    var rows = document.querySelectorAll('.stat-row');
    console.log('Nombre de lignes trouv√©es:', rows.length);
    
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var rowRegion = row.getAttribute('data-region');
        var rowPrefecture = row.getAttribute('data-prefecture');
        var rowZone = row.getAttribute('data-zone');
        var rowNiveau = row.getAttribute('data-niveau');
        
        var showRow = true;
        
        // Filtre par r√©gion
        if (regionId && regionId !== '' && rowRegion != regionId) {
            showRow = false;
        }
        
        // Filtre par pr√©fecture
        if (prefectureNom && prefectureNom !== '' && rowPrefecture != prefectureNom) {
            showRow = false;
        }
        
        // Filtre par zone
        if (zoneFilter && zoneFilter !== '' && rowZone != zoneFilter) {
            showRow = false;
        }
        
        // Filtre par niveau
        if (niveauFilter && niveauFilter !== '' && rowNiveau != niveauFilter) {
            showRow = false;
        }
        
        // Afficher/masquer la ligne
        row.style.display = showRow ? '' : 'none';
        
        if (showRow) {
            visibleCount++;
        }
    }
    
// G√©rer le filtre Genre (masquer/afficher colonnes)
if (genreFilter === 'Filles') {
    // üî¥ Afficher uniquement colonnes ROUGES (F)
    document.querySelectorAll('.col-scol-g, .col-scol-t, .col-aban-g, .col-aban-t').forEach(function(el) {
        el.style.display = 'none';
    });
    document.querySelectorAll('.col-scol-f, .col-aban-f').forEach(function(el) {
        el.style.display = '';
    });
    
} else if (genreFilter === 'Garcons') {
    // üü° Afficher uniquement colonnes JAUNES (G)
    document.querySelectorAll('.col-scol-f, .col-scol-t, .col-aban-f, .col-aban-t').forEach(function(el) {
        el.style.display = 'none';
    });
    document.querySelectorAll('.col-scol-g, .col-aban-g').forEach(function(el) {
        el.style.display = '';
    });
    
} else if (genreFilter === 'Total') {
    // üü¢ Afficher uniquement colonnes VERTES (T)
    document.querySelectorAll('.col-scol-f, .col-scol-g, .col-aban-f, .col-aban-g').forEach(function(el) {
        el.style.display = 'none';
    });
    document.querySelectorAll('.col-scol-t, .col-aban-t').forEach(function(el) {
        el.style.display = '';
    });
    
} else {
    // üé® Afficher TOUTES les colonnes
    document.querySelectorAll('.col-scol-f, .col-scol-g, .col-scol-t, .col-aban-f, .col-aban-g, .col-aban-t').forEach(function(el) {
        el.style.display = '';
    });
}
    
    console.log('Lignes visibles:', visibleCount);
    console.log('================');
}
function filterStatsFormRows() {
    var regionId = document.getElementById('filter-stats-form-region') ? document.getElementById('filter-stats-form-region').value : '';
    var prefectureNom = document.getElementById('filter-stats-form-prefecture') ? document.getElementById('filter-stats-form-prefecture').value : '';
    var zoneFilter = document.getElementById('filter-stats-form-zone') ? document.getElementById('filter-stats-form-zone').value : '';
    var niveauFilter = document.getElementById('filter-stats-form-niveau') ? document.getElementById('filter-stats-form-niveau').value : '';
    var genreFilter = document.getElementById('filter-stats-form-genre') ? document.getElementById('filter-stats-form-genre').value : '';
    
    console.log('üîç Filtrage formulaire Stats:', regionId, prefectureNom, zoneFilter, niveauFilter, genreFilter);
    
    // Mettre √† jour les pr√©fectures selon la r√©gion
    var prefectureSelect = document.getElementById('filter-stats-form-prefecture');
    if (regionId && regionId !== '' && prefectureSelect) {
        var currentValue = prefectureSelect.value;
        prefectureSelect.innerHTML = '<option value="">Toutes</option>';
        
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
        
        if (currentValue) prefectureSelect.value = currentValue;
    }
    
    // Filtrer les lignes du tableau
    var rows = document.querySelectorAll('.stat-row');
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var rowRegion = row.getAttribute('data-region');
        var rowPrefecture = row.getAttribute('data-prefecture');
        var rowZone = row.getAttribute('data-zone');
        var rowNiveau = row.getAttribute('data-niveau');
        
        var showRow = true;
        
        if (regionId && regionId !== '' && rowRegion != regionId) showRow = false;
        if (prefectureNom && prefectureNom !== '' && rowPrefecture != prefectureNom) showRow = false;
        if (zoneFilter && zoneFilter !== '' && rowZone != zoneFilter) showRow = false;
        if (niveauFilter && niveauFilter !== '' && rowNiveau != niveauFilter) showRow = false;
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
        
        // G√©rer l'affichage des colonnes selon le genre
        var cells = row.querySelectorAll('td');
        
        if (genreFilter === 'Filles') {
            // Afficher F, masquer G et T
            if (cells.length >= 9) {
                cells[4].style.display = '';     // Scol F
                cells[5].style.display = 'none'; // Scol G
                cells[6].style.display = 'none'; // Scol T
                cells[7].style.display = '';     // Aban F
                cells[8].style.display = 'none'; // Aban G
                cells[9].style.display = 'none'; // Aban T
            }
        } else if (genreFilter === 'Garcons') {
            // Afficher G, masquer F et T
            if (cells.length >= 9) {
                cells[4].style.display = 'none'; // Scol F
                cells[5].style.display = '';     // Scol G
                cells[6].style.display = 'none'; // Scol T
                cells[7].style.display = 'none'; // Aban F
                cells[8].style.display = '';     // Aban G
                cells[9].style.display = 'none'; // Aban T
            }
        } else if (genreFilter === 'Total') {
            // Afficher T, masquer F et G
            if (cells.length >= 9) {
                cells[4].style.display = 'none'; // Scol F
                cells[5].style.display = 'none'; // Scol G
                cells[6].style.display = '';     // Scol T
                cells[7].style.display = 'none'; // Aban F
                cells[8].style.display = 'none'; // Aban G
                cells[9].style.display = '';     // Aban T
            }
        } else {
            // Afficher toutes les colonnes
            for (var c = 4; c <= 9 && c < cells.length; c++) {
                cells[c].style.display = '';
            }
        }
    }
    
    // G√©rer les en-t√™tes
    var table = document.getElementById('stats-table');
    if (table) {
        var headers = table.querySelectorAll('thead th');
        
        if (genreFilter === 'Filles' && headers.length >= 10) {
            headers[4].style.display = '';     // Scol F
            headers[5].style.display = 'none'; // Scol G
            headers[6].style.display = 'none'; // Scol T
            headers[7].style.display = '';     // Aban F
            headers[8].style.display = 'none'; // Aban G
            headers[9].style.display = 'none'; // Aban T
        } else if (genreFilter === 'Garcons' && headers.length >= 10) {
            headers[4].style.display = 'none'; // Scol F
            headers[5].style.display = '';     // Scol G
            headers[6].style.display = 'none'; // Scol T
            headers[7].style.display = 'none'; // Aban F
            headers[8].style.display = '';     // Aban G
            headers[9].style.display = 'none'; // Aban T
        } else if (genreFilter === 'Total' && headers.length >= 10) {
            headers[4].style.display = 'none'; // Scol F
            headers[5].style.display = 'none'; // Scol G
            headers[6].style.display = '';     // Scol T
            headers[7].style.display = 'none'; // Aban F
            headers[8].style.display = 'none'; // Aban G
            headers[9].style.display = '';     // Aban T
        } else {
            for (var h = 4; h <= 9 && h < headers.length; h++) {
                headers[h].style.display = '';
            }
        }
    }
    console.log('‚úÖ Lignes visibles:', visibleCount);
}

function showStatistiquesModal() {
var modalContainer = document.getElementById('modal-container');
    var html = '<div class="modal"><div class="modal-content" style="max-width: 98vw; max-height: 98vh; overflow: hidden; display: flex; flex-direction: column;"><h2 style="margin-bottom: 16px;">üìä Saisir les statistiques nationales</h2>';
    
    // ========== FILTRE SESSION ==========
    html += '<div style="background-color: #f0fdf4; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #059669;">';
    html += '<div class="form-group" style="margin-bottom: 0;"><label style="font-weight: bold; margin-bottom: 8px;">üéì Ann√©e des Statistiques *</label>';
    html += '<select id="Statistique-Ann√©e" class="form-control" style="font-size: 14px; padding: 10px;" onchange="rechargerFormulaireStatistiques()">';
    html += '<option value="2024-2025">Session 2025</option>';
    html += '<option value="2023-2024">Session 2024</option>';
    html += '<option value="2022-2023">Session 2023</option>';
    html += '</select></div>';
    html += '</div>';
// R√©cup√©rer l'ann√©e s√©lectionn√©e par d√©faut
var anneeSelectionnee = '2024-2025'; // Ann√©e par d√©faut

    // ========== FILTRES COMPLETS (5 filtres) ==========
html += '<div style="background-color: #e0f2fe; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #0284c7;">';
html += '<h3 style="margin: 0 0 12px 0; color: #0c4a6e; font-size: 16px;">üîç Filtres d\'affichage</h3>';
html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">';

// Filtre 1 : R√©gion
html += '<div class="form-group"><label>R√©gion</label><select id="filter-region" class="form-control" onchange="updateFormFilters()"><option value="">Toutes</option>';
for (var i = 0; i < regionsData.length; i++) {
    html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
}
html += '</select></div>';

// Filtre 2 : Pr√©fecture
html += '<div class="form-group"><label>Pr√©fecture</label><select id="filter-prefecture" class="form-control" onchange="filterTableRows()"><option value="">Toutes</option></select></div>';

// Filtre 3 : Zone
html += '<div class="form-group"><label>Zone</label><select id="filter-zone" class="form-control" onchange="filterTableRows()"><option value="">Toutes</option><option value="Urbaine">Urbaine</option><option value="Rurale">Rurale</option></select></div>';

// Filtre 4 : Niveau
html += '<div class="form-group"><label>Niveau</label><select id="filter-niveau" class="form-control" onchange="filterTableRows()"><option value="">Tous</option><option value="Pr√©scolaire">Pr√©scolaire</option><option value="Primaire">Primaire</option><option value="Coll√®ge">Coll√®ge</option><option value="Lyc√©e">Lyc√©e</option></select></div>';

// Filtre 5 : Genre
html += '<div class="form-group"><label>Genre</label><select id="filter-genre" class="form-control" onchange="filterTableRows()"><option value="">Tous</option><option value="Filles">üî¥ Filles</option><option value="Garcons">üü° Gar√ßons</option><option value="Total">üü¢ Total</option></select></div>';

html += '</div></div>';
    // ========== TABLEAU DE SAISIE (SANS taux_reussite et alphab√©tisation) ==========
    html += '<div style="flex: 1; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">';
    html += '<table id="stats-table" style="width: 100%; font-size: 11px; border-collapse: collapse;"><thead style="position: sticky; top: 0; background-color: #2563eb; color: white; z-index: 10;"><tr>';
    html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">R√©gion</th>';
    html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">Pr√©fecture</th>';
    html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">Zone</th>';
    html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; background-color: #2563eb !important; color: white !important; font-weight: bold;">Niveau</th>';
// Scolarisation F/G/T - AVEC CLASSES
html += '<th class="col-scol-f" style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #dc2626; color: white; font-weight: bold;">Scol. F (%)</th>';
html += '<th class="col-scol-g" style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #fbbf24; color: #000; font-weight: bold;">Scol. G (%)</th>';
html += '<th class="col-scol-t" style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #16a34a; color: white; font-weight: bold;">Scol. T (%)</th>';
// Abandon F/G/T - AVEC CLASSES
html += '<th class="col-aban-f" style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #dc2626; color: white; font-weight: bold;">Aban. F (%)</th>';
html += '<th class="col-aban-g" style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #fbbf24; color: #000; font-weight: bold;">Aban. G (%)</th>';
html += '<th class="col-aban-t" style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #16a34a; color: white; font-weight: bold;">Aban. T (%)</th>';
    html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #2563eb; color: white; font-weight: bold;">Ratio E/Ens</th>';
    html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #2563eb; color: white; font-weight: bold;">Ratio E/Classe</th>';
    html += '<th style="padding: 8px; border: 1px solid #1e40af; white-space: nowrap; width: 70px; background-color: #2563eb; color: white; font-weight: bold;">Distance (km)</th>';
    html += '</tr></thead><tbody>'; 

var rowIndex = 0;
var zones = ['Urbaine', 'Rurale'];
var niveaux = ['Pr√©scolaire', 'Primaire', 'Coll√®ge', 'Lyc√©e'];    
    // G√©n√©rer les lignes
var anneeFormulaire = document.getElementById('Statistique-Ann√©e') ? document.getElementById('Statistique-Ann√©e').value : '2024-2025';
    for (var r = 0; r < regionsData.length; r++) {
        var region = regionsData[r];  
        var prefecturesRegion = [];
        for (var p = 0; p < prefecturesData.length; p++) {
            if (prefecturesData[p].region_id == region.id) {
                prefecturesRegion.push(prefecturesData[p]);
            }
        }
        
        for (var p = 0; p < prefecturesRegion.length; p++) {
            var prefecture = prefecturesRegion[p];
            
            for (var z = 0; z < zones.length; z++) {
                var zone = zones[z];
                
                for (var n = 0; n < niveaux.length; n++) {
                    var niveau = niveaux[n];
                    var bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
                    
html += '<tr class="stat-row" data-annee="' + anneeSelectionnee + '" data-region="' + region.id + '" data-prefecture="' + prefecture.nom + '" data-zone="' + zone + '" data-niveau="' + niveau + '" style="background-color: ' + bgColor + ';">';
 html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + region.nom + '</td>';
 html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + prefecture.nom + '</td>';
 html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + zone + '</td>';
 html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 700;">' + niveau + '</td>';

// Taux scolarisation (F/G/T - 3 inputs) - AVEC CLASSES
html += '<td class="col-scol-f" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="scolarisation_filles" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
html += '<td class="col-scol-g" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="scolarisation_garcons" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="G"></td>';
html += '<td class="col-scol-t" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="scolarisation_total" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';

// Taux abandon (F/G/T - 3 inputs) - AVEC CLASSES
html += '<td class="col-aban-f" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="abandon_filles" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
html += '<td class="col-aban-g" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="abandon_garcons" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="G"></td>';
html += '<td class="col-aban-t" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="abandon_total" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                    
                    // Ratios et distance
                    html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="ratio_ens" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
                    html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="ratio_classe" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
                    html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="distance" data-type="niveau" style="width: 100%; font-size: 11px; padding: 4px;" min="0"></td>';
                    
                    html += '</tr>';
                    rowIndex++;
                }
            }
        }
    }
    
    html += '</tbody></table></div>';
    
    // ========== BOUTONS D'ACTION ==========
    html += '<div style="margin-top: 16px; display: flex; gap: 10px; justify-content: space-between; align-items: center;">';
    html += '<span id="progression-saisie" style="color: #666; font-size: 0.9em; font-weight: bold;"></span>';
    html += '<div style="display: flex; gap: 10px;">';
    html += '<button class="btn btn-primary" onclick="submitStatistiquesTableau(false)">üíæ Enregistrer nouvelles</button>';
    html += '<button class="btn btn-warning" onclick="submitStatistiquesTableau(true)" style="background-color: #f59e0b; color: white;">üîÑ Mettre √† jour</button>';
    html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
    html += '</div></div>';
    
    html += '</div></div>';
    modalContainer.innerHTML = html;
// ========== CHARGER LES DONN√âES EXISTANTES ==========
setTimeout(async function() {
    var anneeSelect = document.getElementById('Statistique-Ann√©e');
    if (!anneeSelect) return;
    
    var annee = anneeSelect.value.trim();
    console.log('üì• Chargement donn√©es pour ann√©e:', annee);
    
    if (!annee) return;
    
    try {
        const { data: existingData, error } = await supabase
            .from('statistiques_educatives')
            .select('*')
            .eq('annee_scolaire', annee)
            .eq('periode', 'Annuel');
        
        if (error) throw error;
        
        if (existingData && existingData.length > 0) {
            console.log('üì• Chargement de ' + existingData.length + ' donn√©es existantes...');
            
            var loaded = 0;
            
            // Pour chaque donn√©e existante
            for (var i = 0; i < existingData.length; i++) {
                var stat = existingData[i];
                
                // Trouver l'index de ligne correspondant
                var rowIndex = 0;
                var found = false;
                
                for (var r = 0; r < regionsData.length && !found; r++) {
                    var region = regionsData[r];
                    
                    var prefecturesRegion = [];
                    for (var p = 0; p < prefecturesData.length; p++) {
                        if (prefecturesData[p].region_id == region.id) {
                            prefecturesRegion.push(prefecturesData[p]);
                        }
                    }
                    
                    for (var p = 0; p < prefecturesRegion.length && !found; p++) {
                        var prefecture = prefecturesRegion[p];
                        
                        if (prefecture.nom !== stat.prefecture) {
                            rowIndex += 8; // 2 zones √ó 4 niveaux
                            continue;
                        }
                        
                        var zones = ['Urbaine', 'Rurale'];
                        for (var z = 0; z < zones.length && !found; z++) {
                            var zone = zones[z];
                            
                            if (zone !== stat.zone) {
                                rowIndex += 4; // 4 niveaux
                                continue;
                            }
                            
                            var niveaux = ['Pr√©scolaire', 'Primaire', 'Coll√®ge', 'Lyc√©e'];
                            for (var n = 0; n < niveaux.length && !found; n++) {
                                if (niveaux[n] === stat.niveau) {
                                    // üî• CHARGER SCOLARISATION F/G/T
                                    if (stat.taux_scolarisation_filles !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_filles"]');
                                        if (input) {
                                            input.value = stat.taux_scolarisation_filles;
                                            input.style.background = '#fce7f3';
                                            input.style.borderColor = '#db2777';
                                            loaded++;
                                        }
                                    }
                                    
                                    if (stat.taux_scolarisation_garcons !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_garcons"]');
                                        if (input) {
                                            input.value = stat.taux_scolarisation_garcons;
                                            input.style.background = '#fef3c7';
                                            input.style.borderColor = '#f59e0b';
                                            loaded++;
                                        }
                                    }
                                    
                                    if (stat.taux_scolarisation_total !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_total"]');
                                        if (input) {
                                            input.value = stat.taux_scolarisation_total;
                                            input.style.background = '#d1fae5';
                                            input.style.borderColor = '#10b981';
                                            loaded++;
                                        }
                                    }
                                    
                                    // üî• CHARGER ABANDON F/G/T
                                    if (stat.taux_abandon_filles !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_filles"]');
                                        if (input) {
                                            input.value = stat.taux_abandon_filles;
                                            input.style.background = '#fce7f3';
                                            input.style.borderColor = '#db2777';
                                            loaded++;
                                        }
                                    }
                                    
                                    if (stat.taux_abandon_garcons !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_garcons"]');
                                        if (input) {
                                            input.value = stat.taux_abandon_garcons;
                                            input.style.background = '#fef3c7';
                                            input.style.borderColor = '#f59e0b';
                                            loaded++;
                                        }
                                    }
                                    
                                    if (stat.taux_abandon_total !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_total"]');
                                        if (input) {
                                            input.value = stat.taux_abandon_total;
                                            input.style.background = '#d1fae5';
                                            input.style.borderColor = '#10b981';
                                            loaded++;
                                        }
                                    }
                                    
                                    // Ratios et distance
                                    if (stat.ratio_eleves_enseignant !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_ens"]');
                                        if (input) {
                                            input.value = stat.ratio_eleves_enseignant;
                                            input.style.background = '#e0e7ff';
                                            input.style.borderColor = '#6366f1';
                                            loaded++;
                                        }
                                    }
                                    
                                    if (stat.ratio_eleves_classe !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_classe"]');
                                        if (input) {
                                            input.value = stat.ratio_eleves_classe;
                                            input.style.background = '#e0e7ff';
                                            input.style.borderColor = '#6366f1';
                                            loaded++;
                                        }
                                    }
                                    
                                    if (stat.distance_moyenne_ecole_domicile !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="distance"]');
                                        if (input) {
                                            input.value = stat.distance_moyenne_ecole_domicile;
                                            input.style.background = '#e0e7ff';
                                            input.style.borderColor = '#6366f1';
                                            loaded++;
                                        }
                                    }
                                    
                                    found = true;
                                    break;
                                }
                                rowIndex++;
                            }
                        }
                    }
                }
            }
            
            if (loaded > 0) {
                console.log('‚úÖ ' + loaded + ' champs charg√©s');
                alert('üì• ' + loaded + ' champs d√©j√† enregistr√©s ont √©t√© charg√©s.\n\nVous pouvez continuer la saisie.');
            } else {
                console.log('‚ö†Ô∏è Aucune donn√©e trouv√©e pour ' + annee);
            }
        } else {
            console.log('üìù Formulaire vierge pour ' + annee);
        }
    } catch (error) {
        console.error('‚ùå Erreur chargement:', error);
    }
}, 500);
    modalContainer.innerHTML = html;
  // Initialiser les cartes avec toutes les donn√©es
    setTimeout(function() {
        updateCartesIndicateurs(['T1', 'T2', 'T3', 'T4', 'Annuel']);
    }, 100);
}
  
    // ========== D√âTECTER LES MODIFICATIONS POUR R√âACTIVER L'ENREGISTREMENT ==========
    setTimeout(function() {
        var allInputs = document.querySelectorAll('input[data-field]:not([disabled])');
        for (var i = 0; i < allInputs.length; i++) {
            allInputs[i].addEventListener('input', function() {
                // Retirer le statut "sauvegard√©" quand l'utilisateur modifie
                if (this.getAttribute('data-saved') === 'true') {
                    this.removeAttribute('data-saved');
                    this.style.background = '';
                    this.style.borderColor = '';
                    this.disabled = false;
                }
            });
        }
    }, 600);
function rechargerFormulaireStatistiques() {
    console.log('üîÑ Rechargement du formulaire Stats...');
    
    // R√©cup√©rer les valeurs actuelles
    var annee = document.getElementById('Statistique-Ann√©e') ? document.getElementById('Statistique-Ann√©e').value : '2025-2026';
    var filterRegion = document.getElementById('filter-region') ? document.getElementById('filter-region').value : '';
    var filterPrefecture = document.getElementById('filter-prefecture') ? document.getElementById('filter-prefecture').value : '';
    var filterZone = document.getElementById('filter-zone') ? document.getElementById('filter-zone').value : '';
    var filterNiveau = document.getElementById('filter-niveau') ? document.getElementById('filter-niveau').value : '';
    var filterGenre = document.getElementById('filter-genre') ? document.getElementById('filter-genre').value : '';
    
    console.log('üìÖ Ann√©e s√©lectionn√©e:', annee);
    
    // Fermer et rouvrir le modal
    showStatistiquesModal();
    
    // Restaurer les valeurs apr√®s rechargement
    setTimeout(function() {
        if (document.getElementById('Statistique-Ann√©e')) {
            document.getElementById('Statistique-Ann√©e').value = annee;
            console.log('‚úÖ Ann√©e restaur√©e:', annee);
        }
        if (document.getElementById('filter-region')) {
            document.getElementById('filter-region').value = filterRegion;
            updateFormFilters();
        }
        if (document.getElementById('filter-prefecture')) {
            document.getElementById('filter-prefecture').value = filterPrefecture;
        }
        if (document.getElementById('filter-zone')) {
            document.getElementById('filter-zone').value = filterZone;
        }
        if (document.getElementById('filter-niveau')) {
            document.getElementById('filter-niveau').value = filterNiveau;
        }
        if (document.getElementById('filter-genre')) {
            document.getElementById('filter-genre').value = filterGenre;
            filterTableRows();
        }
    }, 100);
}
function updatePrefecturesDropdown() {
    var regionId = document.getElementById('stat-region').value;
    var prefectureSelect = document.getElementById('stat-prefecture');
    
    prefectureSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
    
    if (regionId) {
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
    }
}
function updatePreuveActivites() {
    var objectif = document.getElementById('preuve-objectif').value;
    var activiteSelect = document.getElementById('preuve-activite');
    
    activiteSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
    
    if (!objectif) return;
    
    var activitesFiltrees = [];
    for (var i = 0; i < data.length; i++) {
    var act = data[i];        
        // V√©rifier si l'activit√© est valid√©e ET termin√©e √† 100%
        var taux = calcTaux(act);
        var estTerminee = taux === 100;
        
        if (act.valide && estTerminee && act.categorie === objectif) {
            if (currentUser.role === 'admin' || currentUser.role === 'chefdept' || act.service === currentUser.service) {
                activitesFiltrees.push(act);
            }
        }
    }
    
    if (activitesFiltrees.length === 0) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Aucune activit√© termin√©e √† 100%';
        option.disabled = true;
        activiteSelect.appendChild(option);
        return;
    }
    
    for (var i = 0; i < activitesFiltrees.length; i++) {
        var option = document.createElement('option');
        option.value = activitesFiltrees[i].activite;
        option.textContent = activitesFiltrees[i].activite + ' (' + activitesFiltrees[i].service + ')';
        option.setAttribute('data-service', activitesFiltrees[i].service);
        activiteSelect.appendChild(option);
    }
}
async function submitStatistiquesTableau(forcerMiseAJour) {
    forcerMiseAJour = forcerMiseAJour || false;
    
    var anneeSelect = document.getElementById('Statistique-Ann√©e');
    if (!anneeSelect) {
        alert('‚ùå Erreur : Impossible de trouver le s√©lecteur d\'ann√©e');
        console.error('‚ùå Element "Statistique-Ann√©e" non trouv√©');
        return;
    }
    
    var annee = anneeSelect.value.trim();
    
    console.log('üíæ Enregistrement pour ann√©e:', annee);
    
    if (!annee) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner une ann√©e scolaire');
        return;
    }
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Pr√©scolaire', 'Primaire', 'Coll√®ge', 'Lyc√©e'];
    var dataToInsert = [];
    var rowIndex = 0;
    
    console.log('üìä Collecte des donn√©es pour l\'ann√©e:', annee);
    
    // Parcourir toutes les lignes
    for (var r = 0; r < regionsData.length; r++) {
        var region = regionsData[r];
        
        var prefecturesRegion = [];
        for (var p = 0; p < prefecturesData.length; p++) {
            if (prefecturesData[p].region_id == region.id) {
                prefecturesRegion.push(prefecturesData[p]);
            }
        }
        
        for (var p = 0; p < prefecturesRegion.length; p++) {
            var prefecture = prefecturesRegion[p];
            
            for (var z = 0; z < zones.length; z++) {
                var zone = zones[z];
                
                for (var n = 0; n < niveaux.length; n++) {
                    var niveau = niveaux[n];
                    
                    // ========== R√âCUP√âRER LES 6 INPUTS (Scol F/G/T + Aban F/G/T) ==========
                    var inputScolF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_filles"]');
                    var inputScolG = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_garcons"]');
                    var inputScolT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="scolarisation_total"]');
                    var inputAbanF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_filles"]');
                    var inputAbanG = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_garcons"]');
                    var inputAbanT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="abandon_total"]');
                    
                    // Autres champs
                    var inputRatioEns = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_ens"]');
                    var inputRatioCl = document.querySelector('input[data-row="' + rowIndex + '"][data-field="ratio_classe"]');
                    var inputDist = document.querySelector('input[data-row="' + rowIndex + '"][data-field="distance"]');
                    
                    // Convertir en nombres (null si vide)
                    var scolF = inputScolF && inputScolF.value ? parseFloat(inputScolF.value) : null;
                    var scolG = inputScolG && inputScolG.value ? parseFloat(inputScolG.value) : null;
                    var scolT = inputScolT && inputScolT.value ? parseFloat(inputScolT.value) : null;
                    var abanF = inputAbanF && inputAbanF.value ? parseFloat(inputAbanF.value) : null;
                    var abanG = inputAbanG && inputAbanG.value ? parseFloat(inputAbanG.value) : null;
                    var abanT = inputAbanT && inputAbanT.value ? parseFloat(inputAbanT.value) : null;
                    
                    var ratioEns = inputRatioEns && inputRatioEns.value ? parseFloat(inputRatioEns.value) : null;
                    var ratioCl = inputRatioCl && inputRatioCl.value ? parseFloat(inputRatioCl.value) : null;
                    var dist = inputDist && inputDist.value ? parseFloat(inputDist.value) : null;
                    
                    // üî• N'ins√©rer QUE si au moins une valeur existe
                    if (scolF !== null || scolG !== null || scolT !== null || 
                        abanF !== null || abanG !== null || abanT !== null ||
                        ratioEns !== null || ratioCl !== null || dist !== null) {
                        
                        dataToInsert.push({
                            annee_scolaire: annee,
                            periode: 'Annuel',
                            region: region.nom,
                            prefecture: prefecture.nom,
                            zone: zone,
                            niveau: niveau,
                            taux_scolarisation_filles: scolF,
                            taux_scolarisation_garcons: scolG,
                            taux_scolarisation_total: scolT,
                            taux_abandon_filles: abanF,
                            taux_abandon_garcons: abanG,
                            taux_abandon_total: abanT,
                            ratio_eleves_enseignant: ratioEns,
                            ratio_eleves_classe: ratioCl,
                            distance_moyenne_ecole_domicile: dist,
                            saisi_par: currentUser.nom
                        });
                        
                        console.log('‚úì Ligne ajout√©e:', region.nom, prefecture.nom, zone, niveau);
                    }
                    
                    rowIndex++;
                }
            }
        }
    }
    
    if (dataToInsert.length === 0) {
        alert('‚ö†Ô∏è Aucune donn√©e √† enregistrer.\n\nRemplissez au moins un champ.');
        return;
    }
    
    var message = forcerMiseAJour 
        ? 'üîÑ Vous allez mettre √† jour ' + dataToInsert.length + ' lignes.\n\nContinuer ?' 
        : 'üíæ Vous allez enregistrer ' + dataToInsert.length + ' nouvelles lignes.\n\nContinuer ?';
    
    if (!confirm(message)) {
        return;
    }
    
    try {
        console.log('üì§ Envoi de', dataToInsert.length, 'lignes vers Supabase...');
        
        // Ins√©rer par lots de 50
        var batchSize = 50;
        var totalProcessed = 0;
        
        for (var i = 0; i < dataToInsert.length; i += batchSize) {
            var batch = dataToInsert.slice(i, i + batchSize);
            
            console.log('üì¶ Envoi du lot', Math.floor(i/batchSize) + 1, ':', batch.length, 'lignes');
            
            // üî• UPSERT pour √©viter les doublons
            const { data: processedData, error } = await supabase
                .from('statistiques_educatives')
                .upsert(batch, { 
                    onConflict: 'annee_scolaire,periode,region,prefecture,zone,niveau',
                    ignoreDuplicates: false 
                })
                .select();
            
            if (error) {
                console.error('‚ùå Erreur Supabase:', error);
                throw error;
            }
            
            console.log('‚úÖ Lot trait√© avec succ√®s');
            
            if (processedData) {
                totalProcessed += processedData.length;
                
                // üî• Mettre √† jour statistiquesData en m√©moire
                for (var j = 0; j < processedData.length; j++) {
                    var found = false;
                    for (var k = 0; k < statistiquesData.length; k++) {
                        if (statistiquesData[k].id === processedData[j].id) {
                            statistiquesData[k] = processedData[j];
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        statistiquesData.unshift(processedData[j]);
                    }
                }
            }
        }
        
        var successMessage = forcerMiseAJour 
            ? '‚úÖ ' + totalProcessed + ' donn√©es mises √† jour avec succ√®s !'
            : '‚úÖ ' + totalProcessed + ' donn√©es enregistr√©es avec succ√®s !';
        
        alert(successMessage);
        
        // Recharger les donn√©es depuis Supabase
        await loadData();
        
        closeModal();
        render();
        
    } catch (error) {
        console.error('‚ùå Erreur compl√®te:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}
function updateProgression() {
    var totalInputs = document.querySelectorAll('input[data-field]:not([disabled])').length;
    var savedInputs = document.querySelectorAll('input[data-saved="true"]').length;
    var pourcentage = totalInputs > 0 ? Math.round((savedInputs / totalInputs) * 100) : 0;
    
    var progressElement = document.getElementById('progression-saisie');
    if (progressElement) {
        progressElement.textContent = 'üìä Progression : ' + savedInputs + '/' + totalInputs + ' champs (' + pourcentage + '%)';
        progressElement.style.color = pourcentage === 100 ? '#4caf50' : '#ff9800';
        progressElement.style.fontWeight = 'bold';
    }
}
function filterStatistiquesByPeriode() {
    var periodeFilter = document.getElementById('filter-periode-cumulative') ? document.getElementById('filter-periode-cumulative').value : 'TOUS';
    
    console.log('=== FILTRAGE P√âRIODE CUMULATIF ===');
    console.log('P√©riode s√©lectionn√©e:', periodeFilter);
    
    // D√©finir les p√©riodes incluses
    var periodesIncluses = [];
    if (periodeFilter === 'TOUS') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    } else if (periodeFilter === 'T1') {
        periodesIncluses = ['T1'];
    } else if (periodeFilter === 'T2') {
        periodesIncluses = ['T1', 'T2'];
    } else if (periodeFilter === 'T3') {
        periodesIncluses = ['T1', 'T2', 'T3'];
    } else if (periodeFilter === 'T4') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4'];
    } else if (periodeFilter === 'Annuel') {
        periodesIncluses = ['T1', 'T2', 'T3', 'T4', 'Annuel'];
    }
    
    console.log('P√©riodes incluses:', periodesIncluses);
    
    // Filtrer les inputs par p√©riode
    var allInputs = document.querySelectorAll('input[data-field][data-periode]');
    var inputsAffichesCount = 0;
    
    for (var i = 0; i < allInputs.length; i++) {
        var input = allInputs[i];
        var inputPeriode = input.getAttribute('data-periode');
        
        if (periodesIncluses.indexOf(inputPeriode) !== -1) {
            input.style.display = '';
            inputsAffichesCount++;
        } else {
            input.style.display = 'none';
        }
    }
    
    // Filtrer aussi les lignes
    var rows = document.querySelectorAll('.stat-row');
    var rowsVisibles = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var rowPeriode = row.getAttribute('data-periode');
        
        if (rowPeriode && periodesIncluses.indexOf(rowPeriode) !== -1) {
            row.style.display = '';
            rowsVisibles++;
        } else if (!rowPeriode) {
            // Si pas de p√©riode d√©finie, afficher la ligne (donn√©es non encore saisies)
            row.style.display = '';
            rowsVisibles++;
        }
    }
    
    console.log('Inputs affich√©s:', inputsAffichesCount);
    console.log('Lignes visibles:', rowsVisibles);
    
    // Mettre √† jour les cartes d'indicateurs
    updateCartesIndicateurs(periodesIncluses);
}
function updateCartesIndicateurs(periodesIncluses) {
    console.log('=== MISE √Ä JOUR DES CARTES ===');
    
    // Filtrer statistiquesData selon les p√©riodes incluses
    var dataFiltree = [];
    for (var i = 0; i < statistiquesData.length; i++) {
        if (periodesIncluses.indexOf(statistiquesData[i].periode) !== -1) {
            dataFiltree.push(statistiquesData[i]);
        }
    }
    
    console.log('Donn√©es filtr√©es:', dataFiltree.length, 'sur', statistiquesData.length);
    
    // Recalculer les moyennes
    var moyenneAbandon = calculerMoyenne(dataFiltree, 'taux_abandon');
    var moyenneReussite = calculerMoyenne(dataFiltree, 'taux_reussite_examens');
    var moyenneScolarisation = calculerMoyenne(dataFiltree, 'taux_scolarisation');
    var moyenneAlphabetisation = calculerMoyenne(dataFiltree, 'taux_alphabetisation');
    var moyenneRatioEnseignant = calculerMoyenne(dataFiltree, 'ratio_eleves_enseignant');
    var moyenneRatioClasse = calculerMoyenne(dataFiltree, 'ratio_eleves_classe');
    var moyenneDistance = calculerMoyenne(dataFiltree, 'distance_moyenne_ecole_domicile');
    
    // Mettre √† jour les valeurs affich√©es dans les cartes
    var cartes = document.querySelectorAll('.card-value');
    if (cartes.length >= 7) {
        cartes[0].textContent = moyenneAbandon + '%';
        cartes[1].textContent = moyenneReussite + '%';
        cartes[2].textContent = moyenneScolarisation + '%';
        cartes[3].textContent = moyenneAlphabetisation + '%';
        cartes[4].textContent = moyenneRatioEnseignant;
        cartes[5].textContent = moyenneRatioClasse;
        cartes[6].textContent = moyenneDistance;
    }
    
    console.log('Cartes mises √† jour');
}
async function deleteStatistique(region, prefecture, zone, niveau, annee) {
    if (!confirm('‚ö†Ô∏è Supprimer toutes les donn√©es (Stats + Examens + Alpha) pour cette ligne ?\n\nR√©gion: ' + region + '\nPr√©fecture: ' + prefecture + '\nZone: ' + zone + '\nNiveau: ' + niveau)) {
        return;
    }
    
    try {
        console.log('üóëÔ∏è Suppression pour:', region, prefecture, zone, niveau, annee);
        
        // Supprimer dans statistiques_educatives
        const { error: errorStats } = await supabase
            .from('statistiques_educatives')
            .delete()
            .eq('region', region)
            .eq('prefecture', prefecture)
            .eq('zone', zone)
            .eq('niveau', niveau)
            .eq('annee_scolaire', annee);
        
        if (errorStats) {
            console.error('Erreur stats:', errorStats);
        } else {
            console.log('‚úÖ Stats supprim√©es');
        }
        
        // Supprimer dans reussite_examens
        const { error: errorExamens } = await supabase
            .from('reussite_examens')
            .delete()
            .eq('region', region)
            .eq('prefecture', prefecture)
            .eq('zone', zone)
            .eq('niveau', niveau)
            .eq('annee_scolaire', annee);
        
        if (errorExamens) {
            console.error('Erreur examens:', errorExamens);
        } else {
            console.log('‚úÖ Examens supprim√©s');
        }
        
        // Supprimer dans alphabetisation
        const { error: errorAlpha } = await supabase
            .from('alphabetisation')
            .delete()
            .eq('region', region)
            .eq('prefecture', prefecture)
            .eq('zone', zone)
            .eq('niveau', niveau)
            .eq('annee_scolaire', annee);
        
        if (errorAlpha) {
            console.error('Erreur alpha:', errorAlpha);
        } else {
            console.log('‚úÖ Alphab√©tisation supprim√©e');
        }
        
        // Recharger les donn√©es
        await loadData();
        
        // Recharger le tableau
        rechargerTableauStatistiques();
        
        alert('‚úÖ Ligne supprim√©e avec succ√®s !');
        
    } catch (error) {
        console.error('‚ùå Erreur compl√®te:', error);
        alert('‚ùå Erreur lors de la suppression: ' + error.message);
    }
}
function updateStatsPrefectureDropdown() {
    var regionId = document.getElementById('filter-stats-region') ? document.getElementById('filter-stats-region').value : '';
    var prefectureSelect = document.getElementById('filter-stats-prefecture');
    
    if (!prefectureSelect) return;
    
    // Vider et reconstruire les options
    prefectureSelect.innerHTML = '<option value="">Toutes les pr√©fectures</option>';
    
    if (regionId) {
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
    }
}
// ========== FILTRER LES LIGNES DU TABLEAU + COLONNES SELON GENRE ==========
function appliquerFiltresStatistiques() {
    console.log('üéØ D√©but du filtrage statistiques...');
 
    // üî• R√âCUP√âRER LE FILTRE ANN√âE PRINCIPAL (ID CORRECT)
    var anneeSelectionnee = document.getElementById('filter-annee-principale') ? document.getElementById('filter-annee-principale').value : '2025';
    console.log('üìÖ Ann√©e s√©lectionn√©e:', anneeSelectionnee);
    
    // Convertir l'ann√©e en format annee_scolaire
    var anneeScolaireRecherchee = '';
    if (anneeSelectionnee === '2025') {
        anneeScolaireRecherchee = '2024-2025';
    } else if (anneeSelectionnee === '2024') {
        anneeScolaireRecherchee = '2023-2024';
    } else if (anneeSelectionnee === '2023') {
        anneeScolaireRecherchee = '2022-2023';
    }
    
    console.log('üìÖ Ann√©e scolaire recherch√©e:', anneeScolaireRecherchee);
    
    // üî• R√âCUP√âRER LES AUTRES FILTRES
    var filterRegion = document.getElementById('filter-stats-region') ? document.getElementById('filter-stats-region').value : '';
    var filterPrefecture = document.getElementById('filter-stats-prefecture') ? document.getElementById('filter-stats-prefecture').value : '';
    var filterZone = document.getElementById('filter-stats-zone') ? document.getElementById('filter-stats-zone').value : '';
    var filterNiveau = document.getElementById('filter-stats-niveau') ? document.getElementById('filter-stats-niveau').value : '';
var filterGenre = document.getElementById('filter-stats-genre') ? document.getElementById('filter-stats-genre').value : '';
    console.log('üìã Filtres actifs:');
    console.log('  - R√©gion:', filterRegion);
    console.log('  - Pr√©fecture:', filterPrefecture);
    console.log('  - Zone:', filterZone);
    console.log('  - Niveau:', filterNiveau);
    console.log('  - Genre:', filterGenre);
    
    // üî• FILTRER LES 3 SOURCES DE DONN√âES
    
    // 1Ô∏è‚É£ Stats G√©n√©rales - AVEC FILTRE ANN√âE
    var dataStatsGeneralesFiltrees = [];
    for (var i = 0; i < statistiquesData.length; i++) {
        var stat = statistiquesData[i];
        
        // ‚úÖ UTILISER L'ANN√âE S√âLECTIONN√âE AU LIEU D'UNE ANN√âE FIXE
        if (stat.annee_scolaire !== anneeScolaireRecherchee) continue;
        
        var regionId = '';
        for (var r = 0; r < regionsData.length; r++) {
            if (regionsData[r].nom === stat.region) {
                regionId = regionsData[r].id.toString();
                break;
            }
        }
        
        var inclure = true;
        
        if (filterRegion && filterRegion !== '' && regionId !== filterRegion) inclure = false;
        if (inclure && filterPrefecture && filterPrefecture !== '' && stat.prefecture !== filterPrefecture) inclure = false;
        if (inclure && filterZone && filterZone !== '' && stat.zone !== filterZone) inclure = false;
if (inclure && filterNiveau && filterNiveau !== '') {
    if (['Prescolaire', 'Primaire', 'Coll√®ge', 'Lyc√©e'].indexOf(filterNiveau) !== -1) {
        // Comparer directement sans transformation
        if (stat.niveau !== filterNiveau) inclure = false;
    } else if (['Debutant', 'Intermediaire', 'Avance'].indexOf(filterNiveau) !== -1) {
        // C'est un niveau alphab√©tisation, exclure les stats
        inclure = false;
    }
}
        if (inclure) dataStatsGeneralesFiltrees.push(stat);
    }
    
    // 2Ô∏è‚É£ Examens - AVEC FILTRE ANN√âE
    var dataExamensFiltrees = [];
    for (var i = 0; i < reussiteExamensData.length; i++) {
        var exam = reussiteExamensData[i];
        
        // ‚úÖ UTILISER L'ANN√âE S√âLECTIONN√âE AU LIEU D'UNE ANN√âE FIXE
        if (exam.annee_scolaire !== anneeScolaireRecherchee) continue;
        
        var examRegionId = '';
        for (var r = 0; r < regionsData.length; r++) {
            if (regionsData[r].nom === exam.region) {
                examRegionId = regionsData[r].id.toString();
                break;
            }
        }
        
        var inclure = true;
        
        if (filterRegion && filterRegion !== '' && examRegionId !== filterRegion) inclure = false;
        if (inclure && filterPrefecture && filterPrefecture !== '' && exam.prefecture !== filterPrefecture) inclure = false;
        if (inclure && filterZone && filterZone !== '' && exam.zone !== filterZone) inclure = false;
if (inclure && filterNiveau && filterNiveau !== '') {
    if (['Prescolaire', 'Primaire', 'Coll√®ge', 'Lyc√©e'].indexOf(filterNiveau) !== -1) {
        // Comparer directement
        if (exam.niveau !== filterNiveau) inclure = false;
    } else if (['Debutant', 'Intermediaire', 'Avance'].indexOf(filterNiveau) !== -1) {
        // C'est un niveau alphab√©tisation, exclure les examens
        inclure = false;
    }
}
        if (inclure) dataExamensFiltrees.push(exam);
    }
    
    // 3Ô∏è‚É£ Alphab√©tisation - AVEC FILTRE ANN√âE
    var dataAlphaFiltrees = [];
    for (var i = 0; i < alphabetisationData.length; i++) {
        var alpha = alphabetisationData[i];
        
        // ‚úÖ UTILISER L'ANN√âE S√âLECTIONN√âE AU LIEU D'UNE ANN√âE FIXE
        if (alpha.annee_scolaire !== anneeScolaireRecherchee) continue;
        
        var regionId = '';
        for (var r = 0; r < regionsData.length; r++) {
            if (regionsData[r].nom === alpha.region) {
                regionId = regionsData[r].id.toString();
                break;
            }
        }
        
        var inclure = true;
        
        if (filterRegion && filterRegion !== '' && regionId !== filterRegion) inclure = false;
        if (inclure && filterPrefecture && filterPrefecture !== '' && alpha.prefecture !== filterPrefecture) inclure = false;
        if (inclure && filterZone && filterZone !== '' && alpha.zone !== filterZone) inclure = false;
        
        if (inclure && filterNiveau && filterNiveau !== '') {
            if (['Debutant', 'Intermediaire', 'Avance'].indexOf(filterNiveau) !== -1) {
                if (alpha.niveau !== filterNiveau) inclure = false;
            } else if (['Pr√©scolaire', 'Primaire', 'Coll√®ge', 'Lyc√©e'].indexOf(filterNiveau) !== -1) {
                inclure = false;
            }
        }
        
        if (inclure) dataAlphaFiltrees.push(alpha);
    }
    
    console.log('‚úÖ Donn√©es filtr√©es pour l\'ann√©e', anneeScolaireRecherchee, ':');
    console.log('  Stats:', dataStatsGeneralesFiltrees.length);
    console.log('  Examens:', dataExamensFiltrees.length);
    console.log('  Alpha:', dataAlphaFiltrees.length);
    
    // üî• RECALCULER LES MOYENNES
    var moyenneScolarisation = calculerMoyenne(dataStatsGeneralesFiltrees, 'taux_scolarisation', filterGenre || 'Total');
    var moyenneAbandon = calculerMoyenne(dataStatsGeneralesFiltrees, 'taux_abandon', filterGenre || 'Total');
    var moyenneAlphabetisation = calculerMoyenne(dataAlphaFiltrees, 'taux_alphab√©tisation', filterGenre || 'Total');
    var moyenneRatioEnseignant = calculerMoyenne(dataStatsGeneralesFiltrees, 'ratio_eleves_enseignant', 'Total');
    var moyenneRatioClasse = calculerMoyenne(dataStatsGeneralesFiltrees, 'ratio_eleves_classe', 'Total');
    var moyenneDistance = calculerMoyenne(dataStatsGeneralesFiltrees, 'distance_moyenne_ecole_domicile', 'Total');
    var moyenneReussiteCEE = calculerMoyenneParGenre(dataExamensFiltrees, 'taux_reussite_cee', filterGenre || 'Total');
    var moyenneReussiteBEPC = calculerMoyenneParGenre(dataExamensFiltrees, 'taux_reussite_bepc', filterGenre || 'Total');
    var moyenneReussiteBAC = calculerMoyenneParGenre(dataExamensFiltrees, 'taux_reussite_bac', filterGenre || 'Total');
    
    var totalBeneficiaires = 0;
    for (var i = 0; i < dataAlphaFiltrees.length; i++) {
        var alpha = dataAlphaFiltrees[i];
        var benef = 0;
        if (filterGenre === 'Filles' && alpha.beneficiaires_filles) {
            benef = alpha.beneficiaires_filles;
        } else if (filterGenre === 'Garcons' && alpha.beneficiaires_garcons) {
            benef = alpha.beneficiaires_garcons;
        } else if (alpha.beneficiaires_total) {
            benef = alpha.beneficiaires_total;
        }
        totalBeneficiaires += benef || 0;
    }
    
    // üî• METTRE √Ä JOUR LES 10 CARTES
    var carteScolarisation = document.getElementById('carte-scolarisation');
    var carteAbandon = document.getElementById('carte-abandon');
    var carteCEE = document.getElementById('carte-cee');
    var carteBEPC = document.getElementById('carte-bepc');
    var carteBAC = document.getElementById('carte-bac');
    var carteAlpha = document.getElementById('carte-alpha');
    var carteBeneficiaires = document.getElementById('carte-beneficiaires');
    var carteRatioEns = document.getElementById('carte-ratio-ens');
    var carteRatioClasse = document.getElementById('carte-ratio-classe');
    var carteDistance = document.getElementById('carte-distance');
    
    if (carteScolarisation) carteScolarisation.textContent = moyenneScolarisation + '%';
    if (carteAbandon) carteAbandon.textContent = moyenneAbandon + '%';
    if (carteCEE) carteCEE.textContent = moyenneReussiteCEE + '%';
    if (carteBEPC) carteBEPC.textContent = moyenneReussiteBEPC + '%';
    if (carteBAC) carteBAC.textContent = moyenneReussiteBAC + '%';
    if (carteAlpha) carteAlpha.textContent = moyenneAlphabetisation + '%';
    if (carteBeneficiaires) carteBeneficiaires.textContent = totalBeneficiaires.toLocaleString();
    if (carteRatioEns) carteRatioEns.textContent = moyenneRatioEnseignant;
    if (carteRatioClasse) carteRatioClasse.textContent = moyenneRatioClasse;
    if (carteDistance) carteDistance.textContent = moyenneDistance + ' km';
    
    console.log('‚úÖ Cartes mises √† jour');
    
    // üî• FILTRER LE TABLEAU (LIGNES) - AVEC FILTRE ANN√âE
    var rows = document.querySelectorAll('.stat-row');
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        
        var rowAnnee = row.getAttribute('data-annee');
        var rowRegion = row.getAttribute('data-region');
        var rowPrefecture = row.getAttribute('data-prefecture');
        var rowZone = row.getAttribute('data-zone');
        var rowNiveau = row.getAttribute('data-niveau');
        
        var showRow = true;
        
        // ‚úÖ FILTRER PAR ANN√âE
        if (rowAnnee && rowAnnee !== anneeScolaireRecherchee) showRow = false;
        
        if (showRow && filterRegion && filterRegion !== '' && rowRegion !== filterRegion) showRow = false;
        if (showRow && filterPrefecture && filterPrefecture !== '' && rowPrefecture !== filterPrefecture) showRow = false;
        if (showRow && filterZone && filterZone !== '' && rowZone !== filterZone) showRow = false;
if (showRow && filterNiveau && filterNiveau !== '') {
    // Comparer directement le niveau du tableau avec le filtre
    if (rowNiveau !== filterNiveau) showRow = false;
}
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    }
    
    // üî• G√âRER L'AFFICHAGE DES COLONNES F/G/T SELON LE GENRE
    var table = document.getElementById('stats-table');
    if (table) {
        if (filterGenre === 'Filles') {
            // üî¥ AFFICHER UNIQUEMENT LES COLONNES ROUGES (F)
            document.querySelectorAll('.col-scol-g, .col-scol-t, .col-aban-g, .col-aban-t, .col-cee-g, .col-cee-t, .col-bepc-g, .col-bepc-t, .col-bac-g, .col-bac-t, .col-alpha-g, .col-alpha-t, .col-benef-g, .col-benef-t').forEach(function(el) {
                el.style.display = 'none';
            });
            document.querySelectorAll('.col-scol-f, .col-aban-f, .col-cee-f, .col-bepc-f, .col-bac-f, .col-alpha-f, .col-benef-f').forEach(function(el) {
                el.style.display = '';
            });
            
        } else if (filterGenre === 'Garcons') {
            // üü° AFFICHER UNIQUEMENT LES COLONNES JAUNES (G)
            document.querySelectorAll('.col-scol-f, .col-scol-t, .col-aban-f, .col-aban-t, .col-cee-f, .col-cee-t, .col-bepc-f, .col-bepc-t, .col-bac-f, .col-bac-t, .col-alpha-f, .col-alpha-t, .col-benef-f, .col-benef-t').forEach(function(el) {
                el.style.display = 'none';
            });
            document.querySelectorAll('.col-scol-g, .col-aban-g, .col-cee-g, .col-bepc-g, .col-bac-g, .col-alpha-g, .col-benef-g').forEach(function(el) {
                el.style.display = '';
            });
            
        } else if (filterGenre === 'Total') {
            // üü¢ AFFICHER UNIQUEMENT LES COLONNES VERTES (T)
            document.querySelectorAll('.col-scol-f, .col-scol-g, .col-aban-f, .col-aban-g, .col-cee-f, .col-cee-g, .col-bepc-f, .col-bepc-g, .col-bac-f, .col-bac-g, .col-alpha-f, .col-alpha-g, .col-benef-f, .col-benef-g').forEach(function(el) {
                el.style.display = 'none';
            });
            document.querySelectorAll('.col-scol-t, .col-aban-t, .col-cee-t, .col-bepc-t, .col-bac-t, .col-alpha-t, .col-benef-t').forEach(function(el) {
                el.style.display = '';
            });
            
        } else {
            // üé® AFFICHER TOUTES LES COLONNES (F + G + T)
            document.querySelectorAll('.col-scol-f, .col-scol-g, .col-scol-t, .col-aban-f, .col-aban-g, .col-aban-t, .col-cee-f, .col-cee-g, .col-cee-t, .col-bepc-f, .col-bepc-g, .col-bepc-t, .col-bac-f, .col-bac-g, .col-bac-t, .col-alpha-f, .col-alpha-g, .col-alpha-t, .col-benef-f, .col-benef-g, .col-benef-t').forEach(function(el) {
                el.style.display = '';
            });
        }
    }
    
    console.log('‚úÖ Filtrage termin√© - Lignes visibles:', visibleCount);
}
function rechargerTableauStatistiques() {
    console.log('üîÑ Rechargement du tableau...');
    
    // R√©cup√©rer l'ann√©e s√©lectionn√©e
    var anneeSelectionnee = document.getElementById('filter-annee-principale')?.value || '2025';
    var anneeScolaireTableau = '';
    
    if (anneeSelectionnee === '2025') {
        anneeScolaireTableau = '2024-2025';
    } else if (anneeSelectionnee === '2024') {
        anneeScolaireTableau = '2023-2024';
    } else if (anneeSelectionnee === '2023') {
        anneeScolaireTableau = '2022-2023';
    }
    
    console.log('üìÖ Recharger pour ann√©e:', anneeScolaireTableau);
    
    // Reconstruire lignesTableau avec la nouvelle ann√©e
    var lignesTableau = {};
    
    // Stats G√©n√©rales
    for (var i = 0; i < statistiquesData.length; i++) {
        var stat = statistiquesData[i];
        if (stat.annee_scolaire !== anneeScolaireTableau) continue;
        
        var key = stat.region + '|' + stat.prefecture + '|' + stat.zone + '|' + stat.niveau;
        
        if (!lignesTableau[key]) {
            lignesTableau[key] = {
                region: stat.region,
                prefecture: stat.prefecture,
                zone: stat.zone,
                niveau: stat.niveau,
                annee: stat.annee_scolaire,
                id: stat.id
            };
        }
        
        lignesTableau[key].scol_f = stat.taux_scolarisation_filles;
        lignesTableau[key].scol_g = stat.taux_scolarisation_garcons;
        lignesTableau[key].scol_t = stat.taux_scolarisation_total;
        lignesTableau[key].aban_f = stat.taux_abandon_filles;
        lignesTableau[key].aban_g = stat.taux_abandon_garcons;
        lignesTableau[key].aban_t = stat.taux_abandon_total;
        lignesTableau[key].ratio_ens = stat.ratio_eleves_enseignant;
        lignesTableau[key].ratio_classe = stat.ratio_eleves_classe;
        lignesTableau[key].distance = stat.distance_moyenne_ecole_domicile;
    }
    
    // Examens
    for (var i = 0; i < reussiteExamensData.length; i++) {
        var exam = reussiteExamensData[i];
        if (exam.annee_scolaire !== anneeScolaireTableau) continue;
        
        var key = exam.region + '|' + exam.prefecture + '|' + exam.zone + '|' + exam.niveau;
        
        if (!lignesTableau[key]) {
            lignesTableau[key] = {
                region: exam.region,
                prefecture: exam.prefecture,
                zone: exam.zone,
                niveau: exam.niveau,
                annee: exam.annee_scolaire,
                id: exam.id
            };
        }
        
        lignesTableau[key].cee_f = exam.taux_reussite_cee_filles;
        lignesTableau[key].cee_g = exam.taux_reussite_cee_garcons;
        lignesTableau[key].cee_t = exam.taux_reussite_cee_total;
        lignesTableau[key].bepc_f = exam.taux_reussite_bepc_filles;
        lignesTableau[key].bepc_g = exam.taux_reussite_bepc_garcons;
        lignesTableau[key].bepc_t = exam.taux_reussite_bepc_total;
        lignesTableau[key].bac_f = exam.taux_reussite_bac_filles;
        lignesTableau[key].bac_g = exam.taux_reussite_bac_garcons;
        lignesTableau[key].bac_t = exam.taux_reussite_bac_total;
    }
    
    // Alphab√©tisation
    for (var i = 0; i < alphabetisationData.length; i++) {
        var alpha = alphabetisationData[i];
        if (alpha.annee_scolaire !== anneeScolaireTableau) continue;
        
        var key = alpha.region + '|' + alpha.prefecture + '|' + alpha.zone + '|' + alpha.niveau;
        
        if (!lignesTableau[key]) {
            lignesTableau[key] = {
                region: alpha.region,
                prefecture: alpha.prefecture,
                zone: alpha.zone,
                niveau: alpha.niveau,
                annee: alpha.annee_scolaire,
                id: alpha.id
            };
        }
        
        lignesTableau[key].alpha_f = alpha.taux_alphabetisation_filles;
        lignesTableau[key].alpha_g = alpha.taux_alphabetisation_garcons;
        lignesTableau[key].alpha_t = alpha.taux_alphabetisation_total;
        lignesTableau[key].benef_f = alpha.beneficiaires_filles;
        lignesTableau[key].benef_g = alpha.beneficiaires_garcons;
        lignesTableau[key].benef_t = alpha.beneficiaires_total;
    }
    
    // Reconstruire le tbody
    var tbody = document.querySelector('#stats-table tbody');
    if (!tbody) {
        console.error('‚ùå Tbody introuvable');
        return;
    }
    
    tbody.innerHTML = '';
    
    var lignesArray = [];
    for (var key in lignesTableau) {
        lignesArray.push(lignesTableau[key]);
    }
    
    if (lignesArray.length > 0) {
        for (var i = 0; i < lignesArray.length; i++) {
            var ligne = lignesArray[i];
            
            // Trouver l'ID de la r√©gion
            var regionId = '';
            for (var r = 0; r < regionsData.length; r++) {
                if (regionsData[r].nom === ligne.region) {
                    regionId = regionsData[r].id;
                    break;
                }
            }
            
            var bgColor = i % 2 === 0 ? '#ffffff' : '#f9fafb';
            
            var tr = document.createElement('tr');
            tr.className = 'stat-row';
            tr.setAttribute('data-annee', ligne.annee);
            tr.setAttribute('data-region', regionId);
            tr.setAttribute('data-prefecture', ligne.prefecture);
            tr.setAttribute('data-zone', ligne.zone);
            tr.setAttribute('data-niveau', ligne.niveau);
            tr.style.backgroundColor = bgColor;
            
            tr.innerHTML = '<td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">' + ligne.region + '</td>' +
                '<td style="padding: 10px; border: 1px solid #e5e7eb;">' + ligne.prefecture + '</td>' +
                '<td style="padding: 10px; border: 1px solid #e5e7eb;">' + ligne.zone + '</td>' +
                '<td style="padding: 10px; border: 1px solid #e5e7eb;"><span class="badge badge-blue">' + ligne.niveau + '</span></td>' +
                
                '<td class="col-scol-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.scol_f !== null && ligne.scol_f !== undefined ? ligne.scol_f : '-') + '</td>' +
                '<td class="col-scol-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.scol_g !== null && ligne.scol_g !== undefined ? ligne.scol_g : '-') + '</td>' +
                '<td class="col-scol-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.scol_t !== null && ligne.scol_t !== undefined ? ligne.scol_t : '-') + '</td>' +
                
                '<td class="col-aban-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.aban_f !== null && ligne.aban_f !== undefined ? ligne.aban_f : '-') + '</td>' +
                '<td class="col-aban-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.aban_g !== null && ligne.aban_g !== undefined ? ligne.aban_g : '-') + '</td>' +
                '<td class="col-aban-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.aban_t !== null && ligne.aban_t !== undefined ? ligne.aban_t : '-') + '</td>' +
                
                '<td class="col-cee-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.cee_f !== null && ligne.cee_f !== undefined ? ligne.cee_f : '-') + '</td>' +
                '<td class="col-cee-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.cee_g !== null && ligne.cee_g !== undefined ? ligne.cee_g : '-') + '</td>' +
                '<td class="col-cee-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.cee_t !== null && ligne.cee_t !== undefined ? ligne.cee_t : '-') + '</td>' +
                
                '<td class="col-bepc-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bepc_f !== null && ligne.bepc_f !== undefined ? ligne.bepc_f : '-') + '</td>' +
                '<td class="col-bepc-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bepc_g !== null && ligne.bepc_g !== undefined ? ligne.bepc_g : '-') + '</td>' +
                '<td class="col-bepc-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bepc_t !== null && ligne.bepc_t !== undefined ? ligne.bepc_t : '-') + '</td>' +
                
                '<td class="col-bac-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bac_f !== null && ligne.bac_f !== undefined ? ligne.bac_f : '-') + '</td>' +
                '<td class="col-bac-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bac_g !== null && ligne.bac_g !== undefined ? ligne.bac_g : '-') + '</td>' +
                '<td class="col-bac-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bac_t !== null && ligne.bac_t !== undefined ? ligne.bac_t : '-') + '</td>' +
                
                '<td class="col-alpha-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.alpha_f !== null && ligne.alpha_f !== undefined ? ligne.alpha_f : '-') + '</td>' +
                '<td class="col-alpha-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.alpha_g !== null && ligne.alpha_g !== undefined ? ligne.alpha_g : '-') + '</td>' +
                '<td class="col-alpha-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.alpha_t !== null && ligne.alpha_t !== undefined ? ligne.alpha_t : '-') + '</td>' +
                
                '<td class="col-benef-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.benef_f !== null && ligne.benef_f !== undefined ? ligne.benef_f : '-') + '</td>' +
                '<td class="col-benef-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.benef_g !== null && ligne.benef_g !== undefined ? ligne.benef_g : '-') + '</td>' +
                '<td class="col-benef-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.benef_t !== null && ligne.benef_t !== undefined ? ligne.benef_t : '-') + '</td>' +
                
                '<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.ratio_ens !== null && ligne.ratio_ens !== undefined ? ligne.ratio_ens : '-') + '</td>' +
                '<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.ratio_classe !== null && ligne.ratio_classe !== undefined ? ligne.ratio_classe : '-') + '</td>' +
                '<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.distance !== null && ligne.distance !== undefined ? ligne.distance : '-') + '</td>';

if (currentUser.role === 'admin' || currentUser.service === 'BSD') {
    tr.innerHTML += '<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;"><button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteStatistique(\'' + ligne.region + '\', \'' + ligne.prefecture + '\', \'' + ligne.zone + '\', \'' + ligne.niveau + '\', \'' + ligne.annee + '\')">Supprimer</button></td>';
}
            tbody.appendChild(tr);
        }
    } else {
        var colspan = (currentUser.role === 'admin' || currentUser.service === 'BSD') ? '29' : '28';
        tbody.innerHTML = '<tr><td colspan="' + colspan + '" class="empty-state">Aucune statistique pour l\'ann√©e ' + anneeSelectionnee + '</td></tr>';
    }
    
    console.log('‚úÖ Tableau recharg√©:', lignesArray.length, 'lignes');
    
    // Appliquer les filtres apr√®s rechargement
    appliquerFiltresStatistiques();
}

function initialiserFiltreAnneeStatistiques() {
    // ‚úÖ UTILISER LE BON ID
    var selectAnnee = document.getElementById('filter-annee-principale');
    if (selectAnnee) {
        selectAnnee.addEventListener('change', function() {
            console.log('üìÖ Changement d\'ann√©e d√©tect√©:', this.value);
            appliquerFiltresStatistiques();
        });
        console.log('‚úÖ √âv√©nement change attach√© au filtre ann√©e');
    } else {
        console.error('‚ùå Filtre ann√©e "filter-annee-principale" introuvable');
    }
    
    // Attacher aussi les √©v√©nements aux autres filtres (si pas d√©j√† fait)
    var filtres = [
        'filter-stats-region',
        'filter-stats-prefecture',
        'filter-stats-zone',
        'filter-stats-niveau',
        'filter-stats-genre'
    ];
    
    filtres.forEach(function(filtreId) {
        var element = document.getElementById(filtreId);
        if (element) {
            element.addEventListener('change', function() {
                console.log('üîÑ Filtre', filtreId, 'chang√©');
                appliquerFiltresStatistiques();
            });
        }
    });
}

function updateStatsPrefectureDropdown() {
    var regionSelect = document.getElementById('filter-stats-region');
    var prefectureSelect = document.getElementById('filter-stats-prefecture');
    
    if (!regionSelect || !prefectureSelect) return;
    
    var regionId = regionSelect.value;
    
    console.log('üîÑ Mise √† jour pr√©fectures pour r√©gion:', regionId);
    
    prefectureSelect.innerHTML = '<option value="">Toutes</option>';
    
    if (regionId && regionId !== '') {
        var count = 0;
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
                count++;
            }
        }
        console.log('‚úÖ', count, 'pr√©fectures ajout√©es');
    }
}
        // ========== FONCTION RENDER PRINCIPALE 
function render() {
            var app = document.getElementById('app');
            
if (!currentUser) {
    // SI TOKEN D'INVITATION : Afficher formulaire d'inscription
    if (invitationData) {
        app.innerHTML = '<div class="modal"><div class="modal-content" style="max-width: 550px;"><h2 style="text-align: center; margin-bottom: 24px;">üèõÔ∏è Cr√©er votre compte</h2><div class="alert alert-info" style="text-align: center;">Bienvenue ! Compl√©tez votre inscription</div><div class="username-display"><label>Nom d\'utilisateur attribu√©</label><div class="username" id="usernameDisplay">' + invitationData.username + '</div></div><div class="form-group"><label>Adresse email *</label><input type="email" id="signup-email" class="form-control" placeholder="votre.email@example.com"></div><div class="form-group"><label>Mot de passe *</label><input type="password" id="signup-password" class="form-control" placeholder="Minimum 8 caract√®res"></div><div class="form-group"><label>Confirmer le mot de passe *</label><input type="password" id="signup-confirm-password" class="form-control" placeholder="Confirmez votre mot de passe"></div><button class="btn btn-primary" style="width: 100%;" onclick="submitSignupWithInvitation()">Cr√©er mon compte</button></div></div>';
    } else {
        // SINON : Afficher formulaire de connexion normal
        app.innerHTML = '<div class="modal"><div class="modal-content" style="max-width: 550px;"><h2 style="text-align: center; margin-bottom: 24px;">üèõÔ∏è Gestion MEPUA</h2><div class="alert alert-info" style="text-align: center;">Bienvenue sur le syst√®me de gestion d√©partementale</div><div class="form-group"><label>Nom d\'utilisateur</label><input type="text" id="username" class="form-control" placeholder="Entrez votre nom d\'utilisateur"></div><div class="form-group"><label>Mot de passe</label><input type="password" id="password" class="form-control" placeholder="Entrez votre mot de passe"></div><button class="btn btn-primary" style="width: 100%;" onclick="attemptLogin()">Se connecter</button><div style="margin-top: 16px; padding: 12px; background-color: #fef3c7; border-radius: 8px; font-size: 12px; text-align: center; color: #92400e;"><strong>‚ö†Ô∏è Premi√®re connexion ?</strong><br/>Utilisez votre mot de passe provisoire et changez-le apr√®s connexion.</div></div></div>';
    }
                
                var passwordInput = document.getElementById('password');
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') attemptLogin();
                    });
                }
                return;
            }

            var html = '<div class="header"><h1>Gestion D√©partementale</h1><div class="header-right"><span>' + currentUser.nom;
            if (currentUser.service !== 'TOUS') {
                html += '<span class="service-badge">' + currentUser.service + '</span>';
            }
            html += '</span><button class="btn btn-secondary" onclick="logout()">D√©connexion</button></div></div>';

            html += '<div class="nav">';
            html += '<button class="' + (activeTab === 'dashboard' ? 'active' : '') + '" onclick="changeTab(\'dashboard\')">Tableau de Bord</button>';
            html += '<button class="' + (activeTab === 'planning' ? 'active' : '') + '" onclick="changeTab(\'planning\')">Planification</button>';
            html += '<button class="' + (activeTab === 'suivi' ? 'active' : '') + '" onclick="changeTab(\'suivi\')">Suivi-√âvaluation</button>';
            html += '<button class="' + (activeTab === 'commentaires' ? 'active' : '') + '" onclick="changeTab(\'commentaires\')">Commentaires et Preuves</button>';
            html += '<button class="' + (activeTab === 'rapport' ? 'active' : '') + '" onclick="changeTab(\'rapport\')">Rapport de performance</button>';

if (currentUser.role === 'admin' || currentUser.role === 'chefdept' || ['BSD', 'DGECS', 'DNAEFP-LN'].indexOf(currentUser.service) !== -1) {
    html += '<button class="' + (activeTab === 'statistiques' ? 'active' : '') + '" onclick="changeTab(\'statistiques\')">üìä Statistiques</button>';
}

if (currentUser.role === 'admin' || currentUser.role === 'chefdept' || currentUser.role === 'chef') {
    html += '<button class="' + (activeTab === 'analyse' ? 'active' : '') + '" onclick="changeTab(\'analyse\')">üîç Analyse</button>';
}

            if (currentUser.role === 'admin') {
                html += '<button class="' + (activeTab === 'admin' ? 'active' : '') + '" onclick="changeTab(\'admin\')">Administration</button>';
            }
            html += '</div>';
// Afficher le filtre service SAUF dans l'onglet statistiques
if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && activeTab !== 'statistiques') && activeTab !== 'analyse')  {
    html += '<div style="background-color: white; padding: 12px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="max-width: 1280px; margin: 0 auto; display: flex; align-items: center; gap: 16px;"><label style="font-weight: bold; font-size: 14px;">Filtrer:</label><select onchange="changeServiceFilter(this.value)" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px;"><option value="TOUS"' + (selectedServiceFilter === 'TOUS' ? ' selected' : '') + '>Tous les services</option>';
    
    for (var i = 0; i < services.length; i++) {
        html += '<option value="' + services[i] + '"' + (selectedServiceFilter === services[i] ? ' selected' : '') + '>' + services[i] + '</option>';
    }
    
    html += '</select>';
    if (selectedServiceFilter !== 'TOUS') {
        html += '<button onclick="changeServiceFilter(\'TOUS\')" style="padding: 6px 12px; background-color: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">R√©initialiser</button>';
    }
    html += '</div></div>';
}
            html += '<div class="main">';
// ========== ONGLET 1 : TABLEAU DE BORD ==========
            if (activeTab === 'dashboard') {
                html += '<h2 style="margin-bottom: 16px;">Tableau de Bord</h2>';
                
                html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">';
                
                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üìä Statut</label><select onchange="changeStatusFilter(this.value)" class="form-control"><option value="TOUS"' + (selectedStatusFilter === 'TOUS' ? ' selected' : '') + '>Tous les statuts</option><option value="Non commenc√©e"' + (selectedStatusFilter === 'Non commenc√©e' ? ' selected' : '') + '>Non commenc√©e</option><option value="En cours"' + (selectedStatusFilter === 'En cours' ? ' selected' : '') + '>En cours</option><option value="Ex√©cut√©e"' + (selectedStatusFilter === 'Ex√©cut√©e' ? ' selected' : '') + '>Ex√©cut√©e</option></select></div>';
                
                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Objectif</label><select onchange="changeDashboardObjectifFilter(this.value)" class="form-control"><option value="TOUS"' + (selectedObjectifFilter === 'TOUS' ? ' selected' : '') + '>Tous les objectifs</option><option value="Objectifs G√©n√©raux"' + (selectedObjectifFilter === 'Objectifs G√©n√©raux' ? ' selected' : '') + '>Objectifs G√©n√©raux</option><option value="Objectifs de R√©forme"' + (selectedObjectifFilter === 'Objectifs de R√©forme' ? ' selected' : '') + '>Objectifs de R√©forme</option><option value="Objectifs Sp√©cifiques"' + (selectedObjectifFilter === 'Objectifs Sp√©cifiques' ? ' selected' : '') + '>Objectifs Sp√©cifiques</option><option value="D√©cisions du CM"' + (selectedObjectifFilter === 'D√©cisions du CM' ? ' selected' : '') + '>D√©cisions du CM</option><option value="D√©cisions du PR"' + (selectedObjectifFilter === 'D√©cisions du PR' ? ' selected' : '') + '>D√©cisions du PR</option></select></div>';
                
                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üìÖ Trimestre (cumul√©)</label><select onchange="changeDashboardTrimestreFilter(this.value)" class="form-control"><option value="TOUS"' + (selectedTrimestreFilter === 'TOUS' ? ' selected' : '') + '>Toute l\'ann√©e</option><option value="T1"' + (selectedTrimestreFilter === 'T1' ? ' selected' : '') + '>Jusqu\'√† T1</option><option value="T2"' + (selectedTrimestreFilter === 'T2' ? ' selected' : '') + '>Jusqu\'√† T2</option><option value="T3"' + (selectedTrimestreFilter === 'T3' ? ' selected' : '') + '>Jusqu\'√† T3</option><option value="T4"' + (selectedTrimestreFilter === 'T4' ? ' selected' : '') + '>Jusqu\'√† T4</option></select></div>';
                
                html += '</div></div>';
                
                var dashboardData = getFilteredDataForDashboard();
                
                var enCours = 0, terminees = 0, nonCommencees = 0;
                for (var i = 0; i < dashboardData.length; i++) {
                    var taux = calcTaux(dashboardData[i]);
                    if (taux === 100) terminees++;
                    else if (taux > 0) enCours++;
                    else nonCommencees++;
                }
                
                var tauxExecution = dashboardData.length > 0 ? Math.round((terminees / dashboardData.length) * 100) : 0;
                
                html += '<div class="cards">';
                html += '<div class="card card-blue"><div class="card-title" style="color: #2563eb;">Planifi√©es</div><div class="card-value">' + dashboardData.length + '</div></div>';
                html += '<div class="card card-orange"><div class="card-title" style="color: #ea580c;">Non Commenc√©es</div><div class="card-value">' + nonCommencees + '</div></div>';
                html += '<div class="card card-yellow"><div class="card-title" style="color: #d97706;">En Cours</div><div class="card-value">' + enCours + '</div></div>';
                html += '<div class="card card-green"><div class="card-title" style="color: #059669;">Ex√©cut√©es</div><div class="card-value">' + terminees + '</div></div>';
                html += '<div class="card card-rose pastel"><div class="card-title" style="color: #7c3aed;">üìà Taux d\'Ex√©cution</div><div class="card-value">' + tauxExecution + '%</div></div>';
                html += '</div>';
                
                html += '<div class="table-container"><table><thead class="blue"><tr><th>Objectif</th><th>Activit√©</th><th>Service</th><th style="text-align: center; background-color: #1e40af;">T1</th><th style="text-align: center; background-color: #1e40af;">T2</th><th style="text-align: center; background-color: #1e40af;">T3</th><th style="text-align: center; background-color: #1e40af;">T4</th><th style="text-align: center;">TDR</th><th style="text-align: center;">ENGAG√â</th><th style="text-align: center;">MANDAT√â</th><th style="text-align: center;">ORDONNANC√â</th><th style="text-align: center;">LIQUID√â</th><th style="text-align: center;">EX√âCUT√â</th><th style="text-align: center;">TAUX</th></tr></thead><tbody>';
                
                if (dashboardData.length > 0) {
                    for (var i = 0; i < dashboardData.length; i++) {
                        var d = dashboardData[i];
                        var taux = calcTaux(d);
                        var tauxClass = taux === 100 ? 'badge-taux-green' : taux >= 50 ? 'badge-taux-yellow' : 'badge-taux-red';
                        
                        html += '<tr><td><span class="badge badge-blue">' + d.categorie + '</span></td><td>' + d.activite + '</td><td><span class="badge badge-purple">' + d.service + '</span></td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t1 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t2 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t3 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t4 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.tdr ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.eng ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.mand ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.ordo ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.liq ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;">' + (d.exec ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;"><span class="badge-taux ' + tauxClass + '">' + taux + '%</span></td></tr>';
                    }
                } else {
                    html += '<tr><td colspan="14" class="empty-state">Aucune activit√© valid√©e</td></tr>';
                }
                html += '</tbody></table></div>';
            }
// ========== ONGLET 2 : PLANIFICATION ==========
            if (activeTab === 'planning') {
                html += '<div class="flex-between"><h2>Planification 2026</h2>';
                if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                    html += '<button class="btn btn-success" onclick="showAddModal()">+ Ajouter</button>';
                }
                html += '</div>';
                
                var planningData = getFilteredDataForPlanning();
                
                html += '<div class="table-container"><table><thead class="blue"><tr><th>Objectif</th><th>Activit√©</th><th>Service</th><th style="text-align: center;">T1</th><th style="text-align: center;">T2</th><th style="text-align: center;">T3</th><th style="text-align: center;">T4</th><th style="text-align: center;">Statut</th>';
                if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                    html += '<th style="text-align: center;">Actions</th>';
                }
                html += '</tr></thead><tbody>';
                
                if (planningData.length > 0) {
                    for (var i = 0; i < planningData.length; i++) {
                        var d = planningData[i];
                        html += '<tr><td><span class="badge badge-blue">' + d.categorie + '</span></td><td>' + d.activite + '</td><td><span class="badge badge-purple">' + d.service + '</span></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t1 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t1\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t2 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t2\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t3 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t3\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.t4 ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'t4\')"></td>';
                        html += '<td style="text-align: center;">';
                        if (d.valide) html += '<span class="badge" style="background-color: #d1fae5; color: #065f46;">Valid√©e</span>';
                        else html += '<span class="badge" style="background-color: #fef3c7; color: #92400e;">En attente</span>';
                        html += '</td>';
                        
                        if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                            html += '<td style="text-align: center;"><div style="display: flex; gap: 4px; justify-content: center;">';
                            if (canValidate() && !d.valide) {
                                html += '<button class="btn btn-success" style="font-size: 11px; padding: 4px 8px;" onclick="validateActivity(' + d.id + ')">Valider</button>';
                            }
                            if (canDeleteInPlanning(d)) {
                                html += '<button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteActivity(' + d.id + ')">Supprimer</button>';
                            }
                            html += '</div></td>';
                        }
                        html += '</tr>';
                    }
                } else {
                    var colspan = (currentUser.role === 'admin' || currentUser.role === 'chef') ? '9' : '8';
                    html += '<tr><td colspan="' + colspan + '" class="empty-state">Aucune activit√© en planification</td></tr>';
                }
                html += '</tbody></table></div>';
            }

            // ========== ONGLET 3 : SUIVI-√âVALUATION ==========
            if (activeTab === 'suivi') {
                html += '<h2 style="margin-bottom: 16px;">Suivi-√âvaluation 2026</h2>';
                html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">';

                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Objectif</label><select onchange="changeSuiviObjectifFilter(this.value)" class="form-control"><option value="TOUS"' + (suiviObjectifFilter === 'TOUS' ? ' selected' : '') + '>Tous les objectifs</option><option value="Objectifs G√©n√©raux"' + (suiviObjectifFilter === 'Objectifs G√©n√©raux' ? ' selected' : '') + '>Objectifs G√©n√©raux</option><option value="Objectifs de R√©forme"' + (suiviObjectifFilter === 'Objectifs de R√©forme' ? ' selected' : '') + '>Objectifs de R√©forme</option><option value="Objectifs Sp√©cifiques"' + (suiviObjectifFilter === 'Objectifs Sp√©cifiques' ? ' selected' : '') + '>Objectifs Sp√©cifiques</option><option value="D√©cisions du CM"' + (suiviObjectifFilter === 'D√©cisions du CM' ? ' selected' : '') + '>D√©cisions du CM</option><option value="D√©cisions du PR"' + (suiviObjectifFilter === 'D√©cisions du PR' ? ' selected' : '') + '>D√©cisions du PR</option></select></div>';

                html += '<div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üìÖ Trimestre (cumul√©)</label><select onchange="changeSuiviTrimestreFilter(this.value)" class="form-control"><option value="TOUS"' + (suiviTrimestreFilter === 'TOUS' ? ' selected' : '') + '>Toute l\'ann√©e</option><option value="T1"' + (suiviTrimestreFilter === 'T1' ? ' selected' : '') + '>Jusqu\'√† T1</option><option value="T2"' + (suiviTrimestreFilter === 'T2' ? ' selected' : '') + '>Jusqu\'√† T2</option><option value="T3"' + (suiviTrimestreFilter === 'T3' ? ' selected' : '') + '>Jusqu\'√† T3</option><option value="T4"' + (suiviTrimestreFilter === 'T4' ? ' selected' : '') + '>Jusqu\'√† T4</option></select></div>';

                html += '</div></div>';

                var suiviData = getFilteredDataForSuivi();

                html += '<div class="table-container"><table><thead class="blue"><tr><th>Objectif</th><th>Activit√©</th><th>Service</th><th style="text-align: center; background-color: #1e40af;">T1</th><th style="text-align: center; background-color: #1e40af;">T2</th><th style="text-align: center; background-color: #1e40af;">T3</th><th style="text-align: center; background-color: #1e40af;">T4</th><th style="text-align: center;">TDR</th><th style="text-align: center;">ENGAG√â</th><th style="text-align: center;">MANDAT√â</th><th style="text-align: center;">ORDONNANC√â</th><th style="text-align: center;">LIQUID√â</th><th style="text-align: center;">EX√âCUT√â</th><th style="text-align: center;">TAUX</th></tr></thead><tbody>';

                if (suiviData.length > 0) {
                    for (var i = 0; i < suiviData.length; i++) {
                        var d = suiviData[i];
                        var taux = calcTaux(d);
                        var tauxClass = taux === 100 ? 'badge-taux-green' : taux >= 50 ? 'badge-taux-yellow' : 'badge-taux-red';
                        
                        html += '<tr><td><span class="badge badge-blue">' + d.categorie + '</span></td><td>' + d.activite + '</td><td><span class="badge badge-purple">' + d.service + '</span></td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t1 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t2 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t3 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center; background-color: #eff6ff;">' + (d.t4 ? '<span class="check-icon">‚úì</span>' : '') + '</td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.tdr ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'tdr\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.eng ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'eng\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.mand ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'mand\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.ordo ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'ordo\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.liq ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'liq\')"></td>';
                        html += '<td style="text-align: center;"><input type="checkbox" ' + (d.exec ? 'checked' : '') + ' ' + (!canModify(d) ? 'disabled' : '') + ' onchange="toggle(' + d.id + ', \'exec\')"></td>';
                        html += '<td style="text-align: center;"><span class="badge-taux ' + tauxClass + '">' + taux + '%</span></td></tr>';
                    }
                } else {
                    html += '<tr><td colspan="14" class="empty-state">Aucune activit√© valid√©e</td></tr>';
                }
                html += '</tbody></table></div>';
            }
// ========== ONGLET 4 : COMMENTAIRES ET PREUVES ==========
            if (activeTab === 'commentaires') {
                html += '<div class="flex-between"><h2>üìã Commentaires et Preuves 2026</h2>';
                if (currentUser.role === 'admin' || currentUser.role === 'chef') {
                    html += '<button class="btn btn-primary" onclick="showCommentaireEtPreuveModal()">üìã D√©poser une preuve et Commenter</button>';
                }
                html += '</div>';
                
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;"><div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üè¢ Service</label><select onchange="changeCommentairesServiceFilter(this.value)" class="form-control"><option value="TOUS"' + (commentairesServiceFilter === 'TOUS' ? ' selected' : '') + '>Tous les services</option>';              
                    for (var i = 0; i < services.length; i++) {
                        html += '<option value="' + services[i] + '"' + (commentairesServiceFilter === services[i] ? ' selected' : '') + '>' + services[i] + '</option>';
                    }
                    
                    html += '</select></div><div><label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Objectif</label><select onchange="changeCommentairesObjectifFilter(this.value)" class="form-control"><option value="TOUS"' + (commentairesObjectifFilter === 'TOUS' ? ' selected' : '') + '>Tous les objectifs</option><option value="Objectifs G√©n√©raux"' + (commentairesObjectifFilter === 'Objectifs G√©n√©raux' ? ' selected' : '') + '>Objectifs G√©n√©raux</option><option value="Objectifs de R√©forme"' + (commentairesObjectifFilter === 'Objectifs de R√©forme' ? ' selected' : '') + '>Objectifs de R√©forme</option><option value="Objectifs Sp√©cifiques"' + (commentairesObjectifFilter === 'Objectifs Sp√©cifiques' ? ' selected' : '') + '>Objectifs Sp√©cifiques</option><option value="D√©cisions du CM"' + (commentairesObjectifFilter === 'D√©cisions du CM' ? ' selected' : '') + '>D√©cisions du CM</option><option value="D√©cisions du PR"' + (commentairesObjectifFilter === 'D√©cisions du PR' ? ' selected' : '') + '>D√©cisions du PR</option></select></div></div></div>';
                }
                
                html += '<div class="table-container"><table><thead class="blue"><tr><th style="width: 15%;">Objectif</th><th style="width: 30%;">Activit√©</th><th style="width: 10%;">Service</th><th style="width: 20%;">Commentaire</th><th style="width: 15%;">Document</th><th style="width: 10%;">Date</th>';
                if (currentUser.role !== 'chefdept') {
                    html += '<th style="text-align: center; width: 4%;">Actions</th>';
                }
                html += '</tr></thead><tbody>';
                
                var commentairesData = [];
                if (currentUser.role === 'admin' || currentUser.role === 'chefdept') {
                    commentairesData = commentairesEtPreuves;
                } else {
                    for (var i = 0; i < commentairesEtPreuves.length; i++) {
                        if (commentairesEtPreuves[i].service === currentUser.service) {
                            commentairesData.push(commentairesEtPreuves[i]);
                        }
                    }
                }
                
                if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && commentairesServiceFilter !== 'TOUS') {
                    var filtered = [];
                    for (var i = 0; i < commentairesData.length; i++) {
                        if (commentairesData[i].service === commentairesServiceFilter) {
                            filtered.push(commentairesData[i]);
                        }
                    }
                    commentairesData = filtered;
                }
                
                if ((currentUser.role === 'admin' || currentUser.role === 'chefdept') && commentairesObjectifFilter !== 'TOUS') {
                    var filtered = [];
                    for (var i = 0; i < commentairesData.length; i++) {
                        if (commentairesData[i].objectif === commentairesObjectifFilter) {
                            filtered.push(commentairesData[i]);
                        }
                    }
                    commentairesData = filtered;
                }
                
                var activitesWithData = {};
                for (var i = 0; i < commentairesData.length; i++) {
                    var key = commentairesData[i].activite + '|' + commentairesData[i].service;
                    if (!activitesWithData[key]) {
                        activitesWithData[key] = {
                            objectif: commentairesData[i].objectif,
                            activite: commentairesData[i].activite,
                            service: commentairesData[i].service,
                            commentaires: [],
                            preuves: []
                        };
                    }
                    
                    if (commentairesData[i].type === 'commentaire') {
                        activitesWithData[key].commentaires.push(commentairesData[i]);
                    } else {
                        activitesWithData[key].preuves.push(commentairesData[i]);
                    }
                }
                
                var hasData = false;
                for (var key in activitesWithData) {
                    hasData = true;
                    var item = activitesWithData[key];
                    
                    html += '<tr>';
                    html += '<td><span class="badge badge-blue">' + item.objectif + '</span></td>';
                    html += '<td>' + item.activite + '</td>';
                    html += '<td><span class="badge badge-purple">' + item.service + '</span></td>';
                    
                    html += '<td>';
                    if (item.commentaires.length > 0) {
                        for (var j = 0; j < item.commentaires.length; j++) {
                            var c = item.commentaires[j];
                            if (j > 0) html += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #e5e7eb;">';
                            html += '<div style="text-align: left; text-align: justify;">' + c.commentaire + '</div>';
                        }
                    } else {
                        html += '-';
                    }
                    html += '</td>';
                    
              html += '<td>';
                if (item.preuves.length > 0) {
                    for (var j = 0; j < item.preuves.length; j++) {
                        var p = item.preuves[j];
                        if (j > 0) html += '<br/>';
                        
                        // üî• CORRECTION - V√©rifier que les propri√©t√©s existent
                        var fileUrl = p.file_url || p.fileUrl || '';
                        var nomFichier = p.nom_fichier || p.nomFichier || 'Fichier';
                        
                        if (fileUrl && nomFichier) {
                            html += '<span style="color: #2563eb; cursor: pointer; text-decoration: underline;" onclick="ouvrirPreuve(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">üìé ' + nomFichier + '</span>';
                        } else {
                            html += '<span style="color: #dc2626;">‚ùå Fichier invalide</span>';
                        }
                    }
                } else {
                    html += '-';
                }
                html += '</td>';

                    html += '</td>';
                    
                    html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    
                    if (currentUser.role !== 'chefdept') {
                        html += '<td style="text-align: center;">';
                        var canManage = currentUser.role === 'admin' || (currentUser.role === 'chef' && item.service === currentUser.service);
                        if (canManage) {
                            html += '<div style="display: flex; flex-direction: column; gap: 4px;">';
                            
                            if (item.commentaires.length > 0) {
                                html += '<button class="btn btn-warning" style="font-size: 11px; padding: 4px 8px;" onclick="showEditCommentaireModal(' + item.commentaires[0].id + ')">‚úèÔ∏è Modifier</button>';
                                html += '<button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteCommentaireOuPreuve(' + item.commentaires[0].id + ')">üóëÔ∏è Suppr. comm.</button>';
                            }
                            
                            if (item.preuves.length > 0) {
                                html += '<button class="btn btn-primary" style="font-size: 11px; padding: 4px 8px;" onclick="showManagePreuvesModal(\'' + item.activite.replace(/'/g, "\\'") + '\', \'' + item.service + '\')">üìé G√©rer (' + item.preuves.length + ')</button>';
                            }
                            
                            html += '</div>';
                        }
                        html += '</td>';
                    }
                    html += '</tr>';
                }
                
                if (!hasData) {
                    var colspan = (currentUser.role !== 'chefdept') ? '7' : '6';
                    html += '<tr><td colspan="' + colspan + '" class="empty-state">Aucun commentaire ou preuve</td></tr>';
                }
                html += '</tbody></table></div>';
            }
// ========== ONGLET 5 : RAPPORT DE PERFORMANCE ==========
            if (activeTab === 'rapport') {
                var isGlobal = currentUser.role === 'chefdept' || (currentUser.role === 'admin' && selectedServiceFilter === 'TOUS');
                var serviceRapport = currentUser.role === 'chef' ? currentUser.service : (isGlobal ? null : selectedServiceFilter);
                
                html += '<div class="flex-between"><h2>üìÑ Rapport de Performance 2026</h2>';
                html += '<div style="display: flex; gap: 8px;">';
                
                html += '<button class="btn btn-primary" onclick="exporterRapportWord()">üì• Export Word</button>';
                html += '<button class="btn btn-success" onclick="exporterDonneesExcel()" style="margin-left: 8px;">üìä Export Excel (Donn√©es)</button>';
                
                if (currentUser.role === 'admin' && !isGlobal) {
                    html += '<button class="btn btn-secondary" onclick="selectedServiceFilter=\'TOUS\'; render();">üìä Rapport global</button>';
                }
                
                html += '</div></div>';
                
                html += '<div id="rapport-content" style="background-color: white; padding: 32px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 16px;">';
                
                var titreRapport = isGlobal ? 'RAPPORT DE PERFORMANCE GLOBAL' : 'RAPPORT DE PERFORMANCE - ' + (serviceRapport || 'SERVICE');
                html += '<h1 style="text-align: center; color: #2563eb; margin-bottom: 24px;">' + titreRapport + '</h1>';
                html += '<p style="text-align: center; color: #6b7280; margin-bottom: 32px;">Ann√©e 2026</p>';
                
                // SECTION 1 : CONTEXTE
                html += '<h2 style="color: #2563eb; margin-top: 32px;">1. √âl√©ments de contexte</h2>';
                var contexteKey = 'contexte_' + (serviceRapport || 'global');
                var contexteValue = rapportTextes[contexteKey] || '';
                
                html += '<textarea id="contexte-text" class="form-control" rows="4" style="margin-top: 16px;" placeholder="Saisissez les √©l√©ments de contexte..." onchange="sauvegarderTexteRapport(\'' + contexteKey + '\', this.value)">' + contexteValue + '</textarea>';
                
                // SECTION 2 : BILAN DES R√âALISATIONS DES OBJECTIFS
                html += '<h2 style="color: #2563eb; margin-top: 32px;">2. Bilan des r√©alisations des objectifs</h2>';
                
                var rappelKey = 'rappel_' + (serviceRapport || 'global');
                var rappelValue = rapportTextes[rappelKey] || '';
                
                html += '<h3 style="margin-top: 16px; color: #4b5563;">Rappel des actions programm√©es</h3>';
                html += '<textarea id="rappel-text" class="form-control" rows="3" style="margin-top: 8px;" placeholder="Rappel..." onchange="sauvegarderTexteRapport(\'' + rappelKey + '\', this.value)">' + rappelValue + '</textarea>';
                
                // TABLEAU 1
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Tableau 1 : Taux par objectif</h3>';
                
                var statsObjectifs = calculerStatsObjectifs(serviceRapport);
                var totalPlanifieesObj = 0;
                var totalRealiseesObj = 0;
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;"><thead class="blue"><tr>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px;">Objectifs</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Planifi√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">R√©alis√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Taux</th>';
                html += '</tr></thead><tbody>';
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    totalPlanifieesObj += stat.planifiees;
                    totalRealiseesObj += stat.realisees;
                    
                    html += '<tr>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">' + stat.objectif + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.planifiees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.realisees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + stat.taux + '%</td>';
                    html += '</tr>';
                }
                
                var tauxTotalObj = totalPlanifieesObj > 0 ? Math.round((totalRealiseesObj / totalPlanifieesObj) * 100) : 0;
                html += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">Total</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalPlanifieesObj + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalRealiseesObj + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + tauxTotalObj + '%</td>';
                html += '</tr>';
                html += '</tbody></table>';
                
                // GRAPHIQUE 1
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Graphique 1 : Taux par objectif</h3>';
                html += '<div style="margin-top: 16px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">';
                
                var couleursGraph1 = ['#87CEEB', '#C6F4D6', '#F7DC6F'];
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    var barColor = couleursGraph1[i];
                    html += '<div style="margin-bottom: 16px;">';
                    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 13px; font-weight: 600;">' + stat.objectif + '</span><span style="font-size: 13px; font-weight: bold; color: ' + barColor + ';">' + stat.taux + '%</span></div>';
                    html += '<div style="width: 100%; height: 24px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                    html += '<div style="width: ' + stat.taux + '%; height: 100%; background-color: ' + barColor + ';"></div>';
                    html += '</div></div>';
                }
                
                var barColorTotalGraph1 = '#f59e0b';
                html += '<div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #cbd5e1;">';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 14px; font-weight: bold;">TOTAL</span><span style="font-size: 14px; font-weight: bold; color: ' + barColorTotalGraph1 + ';">' + tauxTotalObj + '%</span></div>';
                html += '<div style="width: 100%; height: 28px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                html += '<div style="width: ' + tauxTotalObj + '%; height: 100%; background-color: ' + barColorTotalGraph1 + ';"></div>';
                html += '</div></div>';
                
                html += '</div>';
// LISTES DES ACTIVIT√âS PAR OBJECTIF
                var objectifsList = ['Objectifs G√©n√©raux', 'Objectifs de R√©forme', 'Objectifs Sp√©cifiques'];
                
                for (var j = 0; j < objectifsList.length; j++) {
                    var objNom = objectifsList[j];
                    var activitesObj = getActivitesRealisees(serviceRapport, objNom);
                    
                    html += '<h3 style="margin-top: 32px; color: #2563eb; font-size: 18px;">' + objNom + '</h3>';
                    
                    if (activitesObj.length > 0) {
                        html += '<ul style="list-style-type: disc; margin-left: 24px; margin-top: 12px;">';
                        
                        for (var k = 0; k < activitesObj.length; k++) {
                            var act = activitesObj[k];
                            html += '<li style="margin-bottom: 16px; line-height: 1.6;">';
                            html += '<strong>' + act.activite + '</strong>';
                            
                            var commentaire = getCommentaireForActivite(act.activite, act.service);
                            if (commentaire) {
                                html += '<div style="margin-top: 8px; padding: 8px 12px; background-color: #f3f4f6; font-size: 13px; color: #4b5563; font-style: italic; text-align: justify;">';
                                html += commentaire;
                                html += '</div>';
                            }
                            
                            html += '</li>';
                        }
                        
                        html += '</ul>';
                    } else {
                        html += '<p style="margin-top: 12px; color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e √† 100%.</p>';
                    }
                }
                
                // SECTION 3 : BILAN D'EX√âCUTION DES D√âCISIONS
                html += '<h2 style="color: #2563eb; margin-top: 40px;">3. Bilan d\'ex√©cution des D√©cisions du PR et des CM</h2>';
                var rappelDecKey = 'rappelDec_' + (serviceRapport || 'global');
                var rappelDecValue = rapportTextes[rappelDecKey] || '';
                
                html += '<h3 style="margin-top: 16px; color: #4b5563;">Rappel des d√©cisions</h3>';
                html += '<textarea id="rappelDec-text" class="form-control" rows="3" style="margin-top: 8px;" placeholder="Rappel des d√©cisions..." onchange="sauvegarderTexteRapport(\'' + rappelDecKey + '\', this.value)">' + rappelDecValue + '</textarea>';
                
                // TABLEAU 2
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Tableau 2 : Taux par d√©cision</h3>';
                var statsDecisions = calculerStatsDecisions(serviceRapport);
                
                var totalPlanifieesDec2 = 0;
                var totalRealiseesDec2 = 0;
                for (var i = 0; i < statsDecisions.length; i++) {
                    totalPlanifieesDec2 += statsDecisions[i].planifiees;
                    totalRealiseesDec2 += statsDecisions[i].realisees;
                }
                var tauxTotalDec2 = totalPlanifieesDec2 > 0 ? Math.round((totalRealiseesDec2 / totalPlanifieesDec2) * 100) : 0;
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;"><thead class="blue"><tr>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px;">D√©cisions</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Planifi√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">R√©alis√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Taux</th>';
                html += '</tr></thead><tbody>';
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    html += '<tr>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">' + stat.decision + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.planifiees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.realisees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + stat.taux + '%</td>';
                    html += '</tr>';
                }
                
                html += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">Total</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalPlanifieesDec2 + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + totalRealiseesDec2 + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + tauxTotalDec2 + '%</td>';
                html += '</tr>';
                
                html += '</tbody></table>';
                
                // GRAPHIQUE 2
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Graphique 2 : Taux par d√©cision</h3>';
                html += '<div style="margin-top: 16px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">';
                
                var couleursGraph2 = ['#87CEEB', '#C6F4D6'];
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    var barColor = couleursGraph2[i];
                    html += '<div style="margin-bottom: 16px;">';
                    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 13px; font-weight: 600;">' + stat.decision + '</span><span style="font-size: 13px; font-weight: bold; color: ' + barColor + ';">' + stat.taux + '%</span></div>';
                    html += '<div style="width: 100%; height: 24px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                    html += '<div style="width: ' + stat.taux + '%; height: 100%; background-color: ' + barColor + ';"></div>';
                    html += '</div></div>';
                }
                
                var barColorTotal = '#f59e0b';
                html += '<div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #cbd5e1;">';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="font-size: 14px; font-weight: bold;">TOTAL</span><span style="font-size: 14px; font-weight: bold; color: ' + barColorTotal + ';">' + tauxTotalDec2 + '%</span></div>';
                html += '<div style="width: 100%; height: 28px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">';
                html += '<div style="width: ' + tauxTotalDec2 + '%; height: 100%; background-color: ' + barColorTotal + ';"></div>';
                html += '</div></div>';
                
                html += '</div>';
// LISTES DES D√âCISIONS
                var decisionsPR = getActivitesRealisees(serviceRapport, 'D√©cisions du PR');
                var decisionsCM = getActivitesRealisees(serviceRapport, 'D√©cisions du CM');
                
                html += '<h3 style="margin-top: 24px; color: #2563eb; font-size: 18px;">D√©cisions du PR</h3>';
                if (decisionsPR.length > 0) {
                    html += '<ul style="list-style-type: disc; margin-left: 24px; margin-top: 12px;">';
                    for (var k = 0; k < decisionsPR.length; k++) {
                        var act = decisionsPR[k];
                        html += '<li style="margin-bottom: 16px; line-height: 1.6;"><strong>' + act.activite + '</strong>';
                        var commentaire = getCommentaireForActivite(act.activite, act.service);
                        if (commentaire) {
                            html += '<div style="margin-top: 8px; padding: 8px 12px; background-color: #f3f4f6; font-size: 13px; color: #4b5563; font-style: italic; text-align: justify;">' + commentaire + '</div>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p style="margin-top: 12px; color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
                }
                
                html += '<h3 style="margin-top: 24px; color: #2563eb; font-size: 18px;">D√©cisions du CM</h3>';
                if (decisionsCM.length > 0) {
                    html += '<ul style="list-style-type: disc; margin-left: 24px; margin-top: 12px;">';
                    for (var k = 0; k < decisionsCM.length; k++) {
                        var act = decisionsCM[k];
                        html += '<li style="margin-bottom: 16px; line-height: 1.6;"><strong>' + act.activite + '</strong>';
                        var commentaire = getCommentaireForActivite(act.activite, act.service);
                        if (commentaire) {
                            html += '<div style="margin-top: 8px; padding: 8px 12px; background-color: #f3f4f6; font-size: 13px; color: #4b5563; font-style: italic; text-align: justify;">' + commentaire + '</div>';
                        }
                        html += '</li>';
                    }
                    html += '</ul>';
                } else {
                    html += '<p style="margin-top: 12px; color: #6b7280; font-style: italic;">Aucune activit√© r√©alis√©e.</p>';
                }
                
                // TABLEAU 3 : VUE GLOBALE
                html += '<h3 style="margin-top: 32px; color: #4b5563;">Tableau 3 : Vue globale</h3>';
                
                var totalPlanifieesDec = 0;
                var totalRealiseesDec = 0;
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    totalPlanifieesDec += statsDecisions[i].planifiees;
                    totalRealiseesDec += statsDecisions[i].realisees;
                }
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px;"><thead class="blue"><tr>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px;">Cat√©gories</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Planifi√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">R√©alis√©es</th>';
                html += '<th style="border: 1px solid #e5e7eb; padding: 12px; text-align: center;">Taux</th>';
                html += '</tr></thead><tbody>';
                
                // LIGNES DES OBJECTIFS
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    html += '<tr>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">' + stat.objectif + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.planifiees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + stat.realisees + '</td>';
                    html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + stat.taux + '%</td>';
                    html += '</tr>';
                }
                
                // LIGNES DES D√âCISIONS
                html += '<tr>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">D√©cisions du PR</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[0].planifiees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[0].realisees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + statsDecisions[0].taux + '%</td>';
                html += '</tr>';
                
                html += '<tr>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">D√©cisions du CM</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[1].planifiees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + statsDecisions[1].realisees + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; font-weight: bold;">' + statsDecisions[1].taux + '%</td>';
                html += '</tr>';
                
                // LIGNE TOTALE
                html += '<tr style="background-color: #f3f4f6; font-weight: bold;">';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px;">Total</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + (totalPlanifieesObj + totalPlanifieesDec) + '</td>';
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + (totalRealiseesObj + totalRealiseesDec) + '</td>';
                var tauxGlobalTotal = (totalPlanifieesObj + totalPlanifieesDec) > 0 ? Math.round(((totalRealiseesObj + totalRealiseesDec) / (totalPlanifieesObj + totalPlanifieesDec)) * 100) : 0;
                html += '<td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center;">' + tauxGlobalTotal + '%</td>';
                html += '</tr>';
                html += '</tbody></table>';
                
                // GRAPHIQUE 3 : BARRES VERTICALES
                html += '<h3 style="margin-top: 24px; color: #4b5563;">Graphique 3 : Taux de r√©alisation par cat√©gorie</h3>';
                
                html += '<div style="margin-top: 16px; padding: 20px; background-color: #f9fafb; border-radius: 8px;">';
                
                html += '<div style="display: flex; align-items: flex-end; justify-content: space-around; height: 300px; border-bottom: 2px solid #cbd5e1; padding: 0 20px;">';
                
                // Barres pour les 3 objectifs
                var couleursGraph3Obj = ['#87CEEB', '#C6F4D6', '#F7DC6F'];
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    var barColor = couleursGraph3Obj[i];
                    var hauteur = stat.taux * 2.5;
                    
                    html += '<div style="display: flex; flex-direction: column; align-items: center; width: 80px;">';
                    html += '<div style="font-weight: bold; font-size: 16px; color: ' + barColor + '; margin-bottom: 8px;">' + stat.taux + '%</div>';
                    html += '<div style="width: 60px; height: ' + hauteur + 'px; background-color: ' + barColor + '; border-radius: 4px 4px 0 0;"></div>';
                    html += '</div>';
                }
                
                // Barres pour les 2 d√©cisions
                var couleursGraph3Dec = ['#FFC5C5', '#AFEEEE'];
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    var barColor = couleursGraph3Dec[i];
                    var hauteur = stat.taux * 2.5;
                    
                    html += '<div style="display: flex; flex-direction: column; align-items: center; width: 80px;">';
                    html += '<div style="font-weight: bold; font-size: 16px; color: ' + barColor + '; margin-bottom: 8px;">' + stat.taux + '%</div>';
                    html += '<div style="width: 60px; height: ' + hauteur + 'px; background-color: ' + barColor + '; border-radius: 4px 4px 0 0;"></div>';
                    html += '</div>';
                }
                
                // Barre TOTAL (plus large et dor√©e)
                var barColorGlobal = '#f59e0b';
                var hauteurGlobal = tauxGlobalTotal * 2.5;
                html += '<div style="display: flex; flex-direction: column; align-items: center; width: 100px; margin-left: 20px; padding-left: 20px; border-left: 2px solid #cbd5e1;">';
                html += '<div style="font-weight: bold; font-size: 18px; color: ' + barColorGlobal + '; margin-bottom: 8px;">' + tauxGlobalTotal + '%</div>';
                html += '<div style="width: 80px; height: ' + hauteurGlobal + 'px; background-color: ' + barColorGlobal + '; border-radius: 4px 4px 0 0;"></div>';
                html += '</div>';
                
                html += '</div>';
                
                // L√âGENDES SOUS LES BARRES
                html += '<div style="display: flex; align-items: center; justify-content: space-around; margin-top: 16px; padding: 0 20px;">';
                
                for (var i = 0; i < statsObjectifs.length; i++) {
                    var stat = statsObjectifs[i];
                    var nomCourt = stat.objectif.replace('Objectifs ', 'Obj. ');
                    html += '<div style="width: 80px; text-align: center; font-size: 11px; font-weight: 600; color: #4b5563;">' + nomCourt + '</div>';
                }
                
                for (var i = 0; i < statsDecisions.length; i++) {
                    var stat = statsDecisions[i];
                    var nomCourt = stat.decision.replace('D√©cisions ', 'D√©c. ');
                    html += '<div style="width: 80px; text-align: center; font-size: 11px; font-weight: 600; color: #4b5563;">' + nomCourt + '</div>';
                }
                
                html += '<div style="width: 100px; text-align: center; font-size: 12px; font-weight: bold; color: #1e293b; margin-left: 20px; padding-left: 20px; border-left: 2px solid #cbd5e1;">TOTAL GLOBAL</div>';
                
                html += '</div>';
                
                // R√âSUM√â
                html += '<div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #cbd5e1; display: flex; justify-content: center; gap: 40px; font-size: 13px; color: #6b7280;">';
                html += '<span><strong>Total Planifi√©es:</strong> ' + (totalPlanifieesObj + totalPlanifieesDec) + '</span>';
                html += '<span><strong>Total R√©alis√©es:</strong> ' + (totalRealiseesObj + totalRealiseesDec) + '</span>';
                html += '<span style="color: ' + barColorGlobal + '; font-weight: bold;">Taux Global: ' + tauxGlobalTotal + '%</span>';
                html += '</div>';
                
                html += '</div>';
                
                // SECTION 4 : DIFFICULT√âS ET SOLUTIONS
                html += '<h2 style="color: #2563eb; margin-top: 40px;">4. Difficult√©s et Solutions</h2>';
                var diffKey = 'difficultes_' + (serviceRapport || 'global');
                var diffValue = rapportTextes[diffKey] || '';
                
                html += '<h3 style="margin-top: 16px; color: #4b5563;">4.1 Difficult√©s</h3>';
                html += '<textarea id="difficultes-text" class="form-control" rows="5" style="margin-top: 8px;" placeholder="D√©crivez les difficult√©s..." onchange="sauvegarderTexteRapport(\'' + diffKey + '\', this.value)">' + diffValue + '</textarea>';
                
                var pistesKey = 'pistes_' + (serviceRapport || 'global');
                var pistesValue = rapportTextes[pistesKey] || '';
                
                html += '<h3 style="margin-top: 24px; color: #4b5563;">4.2 Pistes de Solutions</h3>';
                html += '<textarea id="pistes-text" class="form-control" rows="5" style="margin-top: 8px;" placeholder="Proposez des solutions..." onchange="sauvegarderTexteRapport(\'' + pistesKey + '\', this.value)">' + pistesValue + '</textarea>';
                
                html += '</div>'; // Fermeture rapport-content
            }
// ========== ONGLET 6 : ANALYSE ==========
if (activeTab === 'analyse') {
    html += '<h2 style="margin-bottom: 16px;">üìä Analyse Strat√©gique</h2>';
    
   // SOUS-MENU avec couleurs personnalis√©es
html += '<div style="background-color: white; padding: 16px; margin-bottom: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">';

// Bouton 1 : Acc√®s √©quitable (Bleu turquoise)
var styleAcces = activeAnalyseTab === 'acces' 
    ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: scale(1.02);' 
    : 'background: linear-gradient(135deg, #a8b7f5 0%, #c3b1d9 100%); color: #4c1d95;';
html += '<button onclick="changeAnalyseTab(\'acces\')" style="' + styleAcces + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">‚öñÔ∏è Acc√®s √©quitable</button>';

// Bouton 2 : Qualit√© des enseignements (Vert √©meraude)
var styleQualite = activeAnalyseTab === 'qualite'
    ? 'background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; transform: scale(1.02);'
    : 'background: linear-gradient(135deg, #a7f3d0 0%, #d1fae5 100%); color: #065f46;';
html += '<button onclick="changeAnalyseTab(\'qualite\')" style="' + styleQualite + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">üéì Qualit√© des enseignements</button>';

// Bouton 3 : Alphab√©tisation (Orange corail)
var styleAlpha = activeAnalyseTab === 'alphabetisation'
    ? 'background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; transform: scale(1.02);'
    : 'background: linear-gradient(135deg, #fed7aa 0%, #fecaca 100%); color: #9a3412;';
html += '<button onclick="changeAnalyseTab(\'alphabetisation\')" style="' + styleAlpha + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">‚úçÔ∏è Alphab√©tisation</button>';

// Bouton 4 : D√©cisions (Bleu cyan)
var styleDecisions = activeAnalyseTab === 'decisions'
    ? 'background: linear-gradient(135deg, #2196F3 0%, #00BCD4 100%); color: white; transform: scale(1.02);'
    : 'background: linear-gradient(135deg, #bfdbfe 0%, #a5f3fc 100%); color: #075985;';
html += '<button onclick="changeAnalyseTab(\'decisions\')" style="' + styleDecisions + ' border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">üéØ D√©cisions</button>';

html += '</div></div>';
   
    // CONTENU CONDITIONNEL
    if (activeAnalyseTab === 'acces') {
        html += renderAnalyseAcces();
    } else if (activeAnalyseTab === 'qualite') {
        html += renderAnalyseQualite();
    } else if (activeAnalyseTab === 'alphabetisation') {
        html += renderAnalyseAlphabetisation();
    } else if (activeAnalyseTab === 'decisions') {
        html += renderAnalyseDecisions();
    }
}
// ========== ONGLET 7 : ADMINISTRATION ==========
            if (activeTab === 'admin') {
                html += '<h2 style="margin-bottom: 16px;">‚öôÔ∏è Administration</h2>';
                
                html += '<div class="cards" style="margin-top: 24px;">';
                
                html += '<div class="card card-blue" style="cursor: pointer;" onclick="showUserList()"><div class="card-title" style="color: #2563eb;">üë• Gestion des Comptes</div><div style="font-size: 14px; margin-top: 8px;">Cr√©er, modifier, supprimer</div></div>';
                
                html += '<div class="card card-green" style="cursor: pointer;" onclick="showConnectedUsers()"><div class="card-title" style="color: #059669;">üü¢ Utilisateurs Connect√©s</div><div class="card-value" style="font-size: 24px; margin-top: 8px;">' + connectedUsers.length + '</div></div>';
                
                html += '<div class="card card-orange" style="cursor: pointer;"><div class="card-title" style="color: #ea580c;">üìä Statistiques</div><div style="font-size: 14px; margin-top: 8px;">Total: ' + users.length + ' comptes</div></div>';
                
                html += '<div class="card" style="cursor: pointer; background-color: #f3e8ff; border-color: #7c3aed;" onclick="showPermissions()"><div class="card-title" style="color: #7c3aed;">üîí S√©curit√©</div><div style="font-size: 14px; margin-top: 8px;">Gestion des acc√®s</div></div>';
                
                html += '</div>';
                
                // TABLEAU DES UTILISATEURS
                html += '<h3 style="margin-top: 32px; margin-bottom: 16px;">Liste des Utilisateurs</h3>';
                html += '<div class="table-container"><table><thead class="blue"><tr><th>Utilisateur</th><th>Nom</th><th>Service</th><th>R√¥le</th><th>Statut</th><th>Derni√®re connexion</th></tr></thead><tbody>';
                
                var usersByRole = {admin: [], chefdept: [], chef: []};
                for (var i = 0; i < users.length; i++) {
                    usersByRole[users[i].role].push(users[i]);
                }
                
                // Admin en premier
                for (var i = 0; i < usersByRole.admin.length; i++) {
                    var u = usersByRole.admin[i];
                    html += '<tr>';
                    html += '<td><strong>' + u.user + '</strong></td>';
                    html += '<td>' + u.nom + '</td>';
                    html += '<td><span class="badge badge-purple">' + u.service + '</span></td>';
                    html += '<td><span class="badge" style="background-color: #dc2626; color: white;">Admin</span></td>';
                    html += '<td><span class="badge badge-green" style="color: #065f46;">Actif</span></td>';
                    html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    html += '</tr>';
                }
                
                // Chef d√©partement
                for (var i = 0; i < usersByRole.chefdept.length; i++) {
                    var u = usersByRole.chefdept[i];
                    html += '<tr>';
                    html += '<td>' + u.user + '</td>';
                    html += '<td>' + u.nom + '</td>';
                    html += '<td><span class="badge badge-purple">' + u.service + '</span></td>';
                    html += '<td><span class="badge" style="background-color: #d97706; color: white;">Chef D√©p.</span></td>';
                    html += '<td>';
                    if (u.actif) html += '<span class="badge badge-green" style="color: #065f46;">Actif</span>';
                    else html += '<span class="badge" style="background-color: #fee2e2; color: #991b1b;">D√©sactiv√©</span>';
                    html += '</td>';
                    
                    var connected = false;
                    for (var j = 0; j < connectedUsers.length; j++) {
                        if (connectedUsers[j].user === u.user) {
                            html += '<td style="font-size: 12px; color: #059669;">' + connectedUsers[j].connectedAt + '</td>';
                            connected = true;
                            break;
                        }
                    }
                    if (!connected) html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    html += '</tr>';
                }
                
                // Chefs de service
                for (var i = 0; i < usersByRole.chef.length; i++) {
                    var u = usersByRole.chef[i];
                    html += '<tr>';
                    html += '<td>' + u.user + '</td>';
                    html += '<td>' + u.nom + '</td>';
                    html += '<td><span class="badge badge-purple">' + u.service + '</span></td>';
                    html += '<td><span class="badge" style="background-color: #059669; color: white;">Chef</span></td>';
                    html += '<td>';
                    if (u.actif) html += '<span class="badge badge-green" style="color: #065f46;">Actif</span>';
                    else html += '<span class="badge" style="background-color: #fee2e2; color: #991b1b;">D√©sactiv√©</span>';
                    html += '</td>';
                    
                    var connected = false;
                    for (var j = 0; j < connectedUsers.length; j++) {
                        if (connectedUsers[j].user === u.user) {
                            html += '<td style="font-size: 12px; color: #059669;">' + connectedUsers[j].connectedAt + '</td>';
                            connected = true;
                            break;
                        }
                    }
                    if (!connected) html += '<td style="font-size: 12px; color: #6b7280;">-</td>';
                    html += '</tr>';
                }
                
                html += '</tbody></table></div>';
                
                // STATISTIQUES
                html += '<h3 style="margin-top: 32px; margin-bottom: 16px;">Statistiques d\'Utilisation</h3>';
                html += '<div class="cards" style="grid-template-columns: repeat(3, 1fr);">';
                
                var activeCount = 0;
                var inactiveCount = 0;
                for (var i = 0; i < users.length; i++) {
                    if (users[i].actif) activeCount++;
                    else inactiveCount++;
                }
                
                html += '<div class="card card-blue"><div class="card-title" style="color: #2563eb;">Total Comptes</div><div class="card-value">' + users.length + '</div></div>';
                html += '<div class="card card-green"><div class="card-title" style="color: #059669;">Comptes Actifs</div><div class="card-value">' + activeCount + '</div></div>';
                html += '<div class="card card-orange"><div class="card-title" style="color: #ea580c;">Comptes D√©sactiv√©s</div><div class="card-value">' + inactiveCount + '</div></div>';
                
                html += '</div>';
            }
// ========== ONGLET 8 : STATISTIQUES ==========
if (activeTab === 'statistiques') {
    html += '<h2 style="margin-bottom: 16px;">üìä Statistiques √âducatives</h2>';
    
    // SOUS-MENU
    html += '<div style="background-color: white; padding: 16px; margin-bottom: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
    html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">';

    if (canSaisirStatsGenerales() || currentUser.role === 'chefdept') {
        html += '<button onclick="showStatistiquesModal()" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold;">üìä Stats G√©n√©rales (BSD)</button>';
    }

    if (canSaisirExamens() || currentUser.role === 'chefdept') {
        html += '<button onclick="showReussiteExamensModal()" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold;">‚úÖ R√©ussite Examens (DGECS)</button>';
    }

    if (canSaisirAlphabetisation() || currentUser.role === 'chefdept') {
        html += '<button onclick="showAlphabetisationModal()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: bold;">‚úçÔ∏è Alphab√©tisation (DNAENFP-LN)</button>';
    }

    html += '</div></div>';
    
    // üî• FILTRE PRINCIPAL : ANN√âE
html += '<div style="background-color: #e0f2fe; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #0284c7;">';
html += '<div style="display: flex; align-items: center; gap: 16px;">';
html += '<label style="font-weight: bold; font-size: 16px; color: #0c4a6e;">üìÖ Ann√©e des donn√©es :</label>';
html += '<select id="filter-annee-principale" class="form-control" style="max-width: 200px; font-size: 15px; padding: 10px; font-weight: bold;" onchange="rechargerTableauStatistiques()">';
html += '<option value="2025" selected>2025</option>';
html += '<option value="2024">2024</option>';
html += '<option value="2023">2023</option>';
html += '</select>';
html += '</div></div>';

// üî• 5 FILTRES SECONDAIRES
html += '<div style="background-color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
html += '<h3 style="margin-bottom: 12px;">üîç Filtres de d√©tail</h3>';
html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">';

  // Filtre 1 : R√©gion
    html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üåç R√©gion</label>';
    html += '<select id="filter-stats-region" class="form-control" onchange="appliquerFiltresStatistiques(); updateStatsPrefectureDropdown();">';
    html += '<option value="">Toutes</option>';
    for (var i = 0; i < regionsData.length; i++) {
        html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
    }
    html += '</select></div>';

    // Filtre 2 : Pr√©fecture
    html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üèõÔ∏è Pr√©fecture</label>';
    html += '<select id="filter-stats-prefecture" class="form-control" onchange="appliquerFiltresStatistiques()">';
    html += '<option value="">Toutes</option>';
    html += '</select></div>';

    // Filtre 3 : Zone
    html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üèòÔ∏è Zone</label>';
    html += '<select id="filter-stats-zone" class="form-control" onchange="appliquerFiltresStatistiques()">';
    html += '<option value="">Toutes</option>';
    html += '<option value="Urbaine">Urbaine</option>';
    html += '<option value="Rurale">Rurale</option>';
    html += '</select></div>';

    // Filtre 4 : Niveau
    html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üìö Niveau</label>';
    html += '<select id="filter-stats-niveau" class="form-control" onchange="appliquerFiltresStatistiques()">';
    html += '<option value="">Tous</option>';
    html += '<option value="Pr√©scolaire">Pr√©scolaire</option>';
    html += '<option value="Primaire">Primaire</option>';
    html += '<option value="Coll√®ge">Coll√®ge</option>';
    html += '<option value="Lyc√©e">Lyc√©e</option>';
    html += '<option value="Debutant">D√©butant (Alpha)</option>';
    html += '<option value="Intermediaire">Interm√©diaire (Alpha)</option>';
    html += '<option value="Avance">Avanc√© (Alpha)</option>';
    html += '</select></div>';

    // Filtre 5 : Genre
    html += '<div><label style="font-weight: bold; display: block; margin-bottom: 4px;">üë§ Genre</label>';
html += '<select id="filter-stats-genre" class="form-control" onchange="appliquerFiltresStatistiques()">';
html += '<option value="" selected>Tous</option>';  // ‚úÖ SELECTED sur Tous
html += '<option value="Filles">üî¥ Filles</option>';
html += '<option value="Garcons">üü° Gar√ßons</option>';
html += '<option value="Total">üü¢ Total</option>';
html += '</select></div>';
html += '</div></div>';
    
    // üî• 10 CARTES (VALEURS PAR D√âFAUT - seront mises √† jour par JS)
    html += '<div id="cartes-statistiques" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 14px; margin-top: 20px;">';
    
    // Ligne 1
    html += '<div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #1e40af; margin-bottom: 6px; text-align: center;">üìä Scolarisation</div>';
    html += '<div id="carte-scolarisation" style="font-size: 32px; font-weight: bold; color: #1e40af; text-align: center;">0%</div>';
    html += '</div>';
    
    html += '<div style="background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); border-left: 4px solid #ea580c; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #9a3412; margin-bottom: 6px; text-align: center;">üìâ Abandon</div>';
    html += '<div id="carte-abandon" style="font-size: 32px; font-weight: bold; color: #9a3412; text-align: center;">0%</div>';
    html += '</div>';
    
    html += '<div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid #059669; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #065f46; margin-bottom: 6px; text-align: center;">‚úÖ R√©ussite CEE</div>';
    html += '<div id="carte-cee" style="font-size: 32px; font-weight: bold; color: #065f46; text-align: center;">0%</div>';
    html += '</div>';
    
    html += '<div style="background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%); border-left: 4px solid #16a34a; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #14532d; margin-bottom: 6px; text-align: center;">‚úÖ R√©ussite BEPC</div>';
    html += '<div id="carte-bepc" style="font-size: 32px; font-weight: bold; color: #14532d; text-align: center;">0%</div>';
    html += '</div>';
    
    html += '<div style="background: linear-gradient(135deg, #86efac 0%, #4ade80 100%); border-left: 4px solid #22c55e; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #14532d; margin-bottom: 6px; text-align: center;">‚úÖ R√©ussite BAC</div>';
    html += '<div id="carte-bac" style="font-size: 32px; font-weight: bold; color: #14532d; text-align: center;">0%</div>';
    html += '</div>';
    html += '</div>'; 
    
    // Ligne 2
    html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 20px;">';
    
    html += '<div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #92400e; margin-bottom: 6px; text-align: center;">‚úçÔ∏è Alphab√©tisation</div>';
    html += '<div id="carte-alpha" style="font-size: 32px; font-weight: bold; color: #92400e; text-align: center;">0%</div>';
    html += '</div>';
    
    html += '<div style="background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%); border-left: 4px solid #a855f7; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #6b21a8; margin-bottom: 6px; text-align: center;">üë• B√©n√©ficiaires</div>';
    html += '<div id="carte-beneficiaires" style="font-size: 32px; font-weight: bold; color: #6b21a8; text-align: center;">0</div>';
    html += '</div>';
    
    html += '<div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-left: 4px solid #ec4899; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #9f1239; margin-bottom: 6px; text-align: center;">üë®‚Äçüè´ Ratio Ens.</div>';
    html += '<div id="carte-ratio-ens" style="font-size: 32px; font-weight: bold; color: #9f1239; text-align: center;">0</div>';
    html += '</div>';
    
    html += '<div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #ef4444; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #991b1b; margin-bottom: 6px; text-align: center;">üè´ Ratio Classe</div>';
    html += '<div id="carte-ratio-classe" style="font-size: 32px; font-weight: bold; color: #991b1b; text-align: center;">0</div>';
    html += '</div>';
    
    html += '<div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-left: 4px solid #6366f1; border-radius: 8px; padding: 14px; min-height: 100px; display: flex; flex-direction: column; justify-content: center;">';
    html += '<div style="font-size: 11px; font-weight: bold; color: #312e81; margin-bottom: 6px; text-align: center;">üìç Distance</div>';
    html += '<div id="carte-distance" style="font-size: 32px; font-weight: bold; color: #312e81; text-align: center;">0 km</div>';
    html += '</div>';
    html += '</div>'; 
    
    // üî• TABLEAU UNIFI√â
    html += '<div class="table-container" style="overflow-x: auto; margin-top: 20px;"><table id="stats-table" style="width: 100%; min-width: 2000px;"><thead><tr>';
    
    html += '<th style="background-color: #2563eb; color: white; padding: 12px; border: 1px solid #1e40af;">R√©gion</th>';
    html += '<th style="background-color: #2563eb; color: white; padding: 12px; border: 1px solid #1e40af;">Pr√©fecture</th>';
    html += '<th style="background-color: #2563eb; color: white; padding: 12px; border: 1px solid #1e40af;">Zone</th>';
    html += '<th style="background-color: #2563eb; color: white; padding: 12px; border: 1px solid #1e40af;">Niveau</th>';
    
    // Scolarisation F/G/T
    html += '<th class="col-scol-f" style="background-color: #dc2626; color: white; padding: 12px; border: 1px solid #b91c1c;">Scol. F(%)</th>';
    html += '<th class="col-scol-g" style="background-color: #fbbf24; color: #000; padding: 12px; border: 1px solid #f59e0b;">Scol. G(%)</th>';
    html += '<th class="col-scol-t" style="background-color: #16a34a; color: white; padding: 12px; border: 1px solid #15803d;">Scol. T(%)</th>';
    
    // Abandon F/G/T
    html += '<th class="col-aban-f" style="background-color: #dc2626; color: white; padding: 12px; border: 1px solid #b91c1c;">Aban. F(%)</th>';
    html += '<th class="col-aban-g" style="background-color: #fbbf24; color: #000; padding: 12px; border: 1px solid #f59e0b;">Aban. G(%)</th>';
    html += '<th class="col-aban-t" style="background-color: #16a34a; color: white; padding: 12px; border: 1px solid #15803d;">Aban. T(%)</th>';
    
    // CEE F/G/T
    html += '<th class="col-cee-f" style="background-color: #dc2626; color: white; padding: 12px; border: 1px solid #b91c1c;">CEE F(%)</th>';
    html += '<th class="col-cee-g" style="background-color: #fbbf24; color: #000; padding: 12px; border: 1px solid #f59e0b;">CEE G(%)</th>';
    html += '<th class="col-cee-t" style="background-color: #16a34a; color: white; padding: 12px; border: 1px solid #15803d;">CEE T(%)</th>';
    
    // BEPC F/G/T
    html += '<th class="col-bepc-f" style="background-color: #dc2626; color: white; padding: 12px; border: 1px solid #b91c1c;">BEPC F(%)</th>';
    html += '<th class="col-bepc-g" style="background-color: #fbbf24; color: #000; padding: 12px; border: 1px solid #f59e0b;">BEPC G(%)</th>';
    html += '<th class="col-bepc-t" style="background-color: #16a34a; color: white; padding: 12px; border: 1px solid #15803d;">BEPC T(%)</th>';
    
    // BAC F/G/T
    html += '<th class="col-bac-f" style="background-color: #dc2626; color: white; padding: 12px; border: 1px solid #b91c1c;">BAC F(%)</th>';
    html += '<th class="col-bac-g" style="background-color: #fbbf24; color: #000; padding: 12px; border: 1px solid #f59e0b;">BAC G(%)</th>';
    html += '<th class="col-bac-t" style="background-color: #16a34a; color: white; padding: 12px; border: 1px solid #15803d;">BAC T(%)</th>';
    
    // Alpha F/G/T
    html += '<th class="col-alpha-f" style="background-color: #dc2626; color: white; padding: 12px; border: 1px solid #b91c1c;">Alpha F(%)</th>';
    html += '<th class="col-alpha-g" style="background-color: #fbbf24; color: #000; padding: 12px; border: 1px solid #f59e0b;">Alpha G(%)</th>';
    html += '<th class="col-alpha-t" style="background-color: #16a34a; color: white; padding: 12px; border: 1px solid #15803d;">Alpha T(%)</th>';
    
    // B√©n√©f F/G/T
    html += '<th class="col-benef-f" style="background-color: #dc2626; color: white; padding: 12px; border: 1px solid #b91c1c;">B√©n√©f. F</th>';
    html += '<th class="col-benef-g" style="background-color: #fbbf24; color: #000; padding: 12px; border: 1px solid #f59e0b;">B√©n√©f. G</th>';
    html += '<th class="col-benef-t" style="background-color: #16a34a; color: white; padding: 12px; border: 1px solid #15803d;">B√©n√©f. T</th>';
    
    // Ratios & Distance
    html += '<th style="background-color: #6b7280; color: white; padding: 12px; border: 1px solid #4b5563;">Ratio E/Ens</th>';
    html += '<th style="background-color: #6b7280; color: white; padding: 12px; border: 1px solid #4b5563;">Ratio E/Cl</th>';
    html += '<th style="background-color: #6b7280; color: white; padding: 12px; border: 1px solid #4b5563;">Distance (km)</th>';
    
    if (currentUser.role === 'admin' || currentUser.service === 'BSD') {
        html += '<th style="background-color: #2563eb; color: white; padding: 12px; border: 1px solid #1e40af;">Actions</th>';
    }
    html += '</tr></thead><tbody>';
    
// üî• R√âCUP√âRER L'ANN√âE DU FILTRE PRINCIPAL
var anneeSelectionnee = document.getElementById('filter-annee-principale')?.value || '2025';
var anneeScolaireTableau = '';

if (anneeSelectionnee === '2025') {
    anneeScolaireTableau = '2024-2025';
} else if (anneeSelectionnee === '2024') {
    anneeScolaireTableau = '2023-2024';
} else if (anneeSelectionnee === '2023') {
    anneeScolaireTableau = '2022-2023';
}

console.log('üìÖ Ann√©e tableau:', anneeScolaireTableau);

// Combiner les 3 sources AVEC ANN√âE FILTR√âE
var lignesTableau = {};

for (var i = 0; i < statistiquesData.length; i++) {
    var stat = statistiquesData[i];
    if (stat.annee_scolaire !== anneeScolaireTableau) continue;  // ‚úÖ UTILISER LA VARIABLE
    var key = stat.region + '|' + stat.prefecture + '|' + stat.zone + '|' + stat.niveau;
    
    if (!lignesTableau[key]) {
        lignesTableau[key] = {
            region: stat.region,
            prefecture: stat.prefecture,
            zone: stat.zone,
            niveau: stat.niveau,
            annee: stat.annee_scolaire,  // ‚úÖ AJOUTER L'ANN√âE
            id: stat.id
        };
    }
    
    lignesTableau[key].scol_f = stat.taux_scolarisation_filles;
    lignesTableau[key].scol_g = stat.taux_scolarisation_garcons;
    lignesTableau[key].scol_t = stat.taux_scolarisation_total;
    lignesTableau[key].aban_f = stat.taux_abandon_filles;
    lignesTableau[key].aban_g = stat.taux_abandon_garcons;
    lignesTableau[key].aban_t = stat.taux_abandon_total;
    lignesTableau[key].ratio_ens = stat.ratio_eleves_enseignant;
    lignesTableau[key].ratio_classe = stat.ratio_eleves_classe;
    lignesTableau[key].distance = stat.distance_moyenne_ecole_domicile;
}

for (var i = 0; i < reussiteExamensData.length; i++) {
    var exam = reussiteExamensData[i];
    if (exam.annee_scolaire !== anneeScolaireTableau) continue;  // ‚úÖ UTILISER LA VARIABLE
    
    var key = exam.region + '|' + exam.prefecture + '|' + exam.zone + '|' + exam.niveau;
    
    if (!lignesTableau[key]) {
        lignesTableau[key] = {
            region: exam.region,
            prefecture: exam.prefecture,
            zone: exam.zone,
            niveau: exam.niveau,
            annee: exam.annee_scolaire,  // ‚úÖ AJOUTER L'ANN√âE
            id: exam.id
        };
    }
    
    lignesTableau[key].cee_f = exam.taux_reussite_cee_filles;
    lignesTableau[key].cee_g = exam.taux_reussite_cee_garcons;
    lignesTableau[key].cee_t = exam.taux_reussite_cee_total;
    lignesTableau[key].bepc_f = exam.taux_reussite_bepc_filles;
    lignesTableau[key].bepc_g = exam.taux_reussite_bepc_garcons;
    lignesTableau[key].bepc_t = exam.taux_reussite_bepc_total;
    lignesTableau[key].bac_f = exam.taux_reussite_bac_filles;
    lignesTableau[key].bac_g = exam.taux_reussite_bac_garcons;
    lignesTableau[key].bac_t = exam.taux_reussite_bac_total;
}

for (var i = 0; i < alphabetisationData.length; i++) {
    var alpha = alphabetisationData[i];
    if (alpha.annee_scolaire !== anneeScolaireTableau) continue;  // ‚úÖ UTILISER LA VARIABLE
    
    var key = alpha.region + '|' + alpha.prefecture + '|' + alpha.zone + '|' + alpha.niveau;
    
    if (!lignesTableau[key]) {
        lignesTableau[key] = {
            region: alpha.region,
            prefecture: alpha.prefecture,
            zone: alpha.zone,
            niveau: alpha.niveau,
            annee: alpha.annee_scolaire,  // ‚úÖ AJOUTER L'ANN√âE
            id: alpha.id
        };
    }
    
    lignesTableau[key].alpha_f = alpha.taux_alphabetisation_filles;
    lignesTableau[key].alpha_g = alpha.taux_alphabetisation_garcons;
    lignesTableau[key].alpha_t = alpha.taux_alphabetisation_total;
    lignesTableau[key].benef_f = alpha.beneficiaires_filles;
    lignesTableau[key].benef_g = alpha.beneficiaires_garcons;
    lignesTableau[key].benef_t = alpha.beneficiaires_total;
}
    var lignesArray = [];
    for (var key in lignesTableau) {
        lignesArray.push(lignesTableau[key]);
    } 
    if (lignesArray.length > 0) {
        for (var i = 0; i < lignesArray.length; i++) {
            var ligne = lignesArray[i];
            
            // Trouver l'ID de la r√©gion
            var regionId = '';
            for (var r = 0; r < regionsData.length; r++) {
                if (regionsData[r].nom === ligne.region) {
                    regionId = regionsData[r].id;
                    break;
                }
            }
            
            var bgColor = i % 2 === 0 ? '#ffffff' : '#f9fafb'; 
html += '<tr class="stat-row" data-annee="' + ligne.annee + '" data-region="' + regionId + '" data-prefecture="' + ligne.prefecture + '" data-zone="' + ligne.zone + '" data-niveau="' + ligne.niveau + '" style="background-color: ' + bgColor + ';">';
            html += '<td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">' + ligne.region + '</td>';
            html += '<td style="padding: 10px; border: 1px solid #e5e7eb;">' + ligne.prefecture + '</td>';
            html += '<td style="padding: 10px; border: 1px solid #e5e7eb;">' + ligne.zone + '</td>';
            html += '<td style="padding: 10px; border: 1px solid #e5e7eb;"><span class="badge badge-blue">' + ligne.niveau + '</span></td>';
            
            // Scolarisation F/G/T
            html += '<td class="col-scol-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.scol_f !== null && ligne.scol_f !== undefined ? ligne.scol_f : '-') + '</td>';
            html += '<td class="col-scol-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.scol_g !== null && ligne.scol_g !== undefined ? ligne.scol_g : '-') + '</td>';
            html += '<td class="col-scol-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.scol_t !== null && ligne.scol_t !== undefined ? ligne.scol_t : '-') + '</td>';
            
            // Abandon F/G/T
            html += '<td class="col-aban-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.aban_f !== null && ligne.aban_f !== undefined ? ligne.aban_f : '-') + '</td>';
            html += '<td class="col-aban-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.aban_g !== null && ligne.aban_g !== undefined ? ligne.aban_g : '-') + '</td>';
            html += '<td class="col-aban-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.aban_t !== null && ligne.aban_t !== undefined ? ligne.aban_t : '-') + '</td>';
            
            // CEE F/G/T
            html += '<td class="col-cee-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.cee_f !== null && ligne.cee_f !== undefined ? ligne.cee_f : '-') + '</td>';
            html += '<td class="col-cee-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.cee_g !== null && ligne.cee_g !== undefined ? ligne.cee_g : '-') + '</td>';
            html += '<td class="col-cee-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.cee_t !== null && ligne.cee_t !== undefined ? ligne.cee_t : '-') + '</td>';
            
           // BEPC F/G/T
html += '<td class="col-bepc-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bepc_f !== null && ligne.bepc_f !== undefined ? ligne.bepc_f : '-') + '</td>';
html += '<td class="col-bepc-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bepc_g !== null && ligne.bepc_g !== undefined ? ligne.bepc_g : '-') + '</td>';
html += '<td class="col-bepc-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bepc_t !== null && ligne.bepc_t !== undefined ? ligne.bepc_t : '-') + '</td>';

// BAC F/G/T
html += '<td class="col-bac-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bac_f !== null && ligne.bac_f !== undefined ? ligne.bac_f : '-') + '</td>';
html += '<td class="col-bac-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bac_g !== null && ligne.bac_g !== undefined ? ligne.bac_g : '-') + '</td>';
html += '<td class="col-bac-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.bac_t !== null && ligne.bac_t !== undefined ? ligne.bac_t : '-') + '</td>';

            // Alpha F/G/T
            html += '<td class="col-alpha-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.alpha_f !== null && ligne.alpha_f !== undefined ? ligne.alpha_f : '-') + '</td>';
            html += '<td class="col-alpha-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.alpha_g !== null && ligne.alpha_g !== undefined ? ligne.alpha_g : '-') + '</td>';
            html += '<td class="col-alpha-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.alpha_t !== null && ligne.alpha_t !== undefined ? ligne.alpha_t : '-') + '</td>';
            
            // B√©n√©f F/G/T
            html += '<td class="col-benef-f" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.benef_f !== null && ligne.benef_f !== undefined ? ligne.benef_f : '-') + '</td>';
            html += '<td class="col-benef-g" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.benef_g !== null && ligne.benef_g !== undefined ? ligne.benef_g : '-') + '</td>';
            html += '<td class="col-benef-t" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.benef_t !== null && ligne.benef_t !== undefined ? ligne.benef_t : '-') + '</td>';
            
            // Ratios & Distance
            html += '<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.ratio_ens !== null && ligne.ratio_ens !== undefined ? ligne.ratio_ens : '-') + '</td>';
            html += '<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.ratio_classe !== null && ligne.ratio_classe !== undefined ? ligne.ratio_classe : '-') + '</td>';
            html += '<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">' + (ligne.distance !== null && ligne.distance !== undefined ? ligne.distance : '-') + '</td>';
            
            if (currentUser.role === 'admin' || currentUser.service === 'BSD') {
                html += '<td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;"><button class="btn btn-danger" style="font-size: 11px; padding: 4px 8px;" onclick="deleteStatistique(' + ligne.id + ')">Supprimer</button></td>';
            }
            
            html += '</tr>';
        }
    } else {
        var colspan = (currentUser.role === 'admin' || currentUser.service === 'BSD') ? '29' : '28';
        html += '<tr><td colspan="' + colspan + '" class="empty-state">Aucune statistique enregistr√©e</td></tr>';
    }
    
    html += '</tbody></table></div>';
    
} 
setTimeout(function() {
    if (activeTab === 'statistiques') {
        console.log('üéØ Application automatique des filtres au chargement');
        appliquerFiltresStatistiques();
    }
}, 100);

            html += '</div><div id="modal-container"></div>';
            app.innerHTML = html;
        }
function showReussiteExamensModal() {
    var modalContainer = document.getElementById('modal-container');
    var html = '<div class="modal"><div class="modal-content" style="max-width: 98vw; max-height: 98vh; overflow: hidden; display: flex; flex-direction: column;"><h2 style="margin-bottom: 16px;">‚úÖ Saisir les taux de r√©ussite aux examens</h2>';
    
    // ========== FILTRE SESSION ==========
    html += '<div style="background-color: #f0fdf4; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #059669;">';
    html += '<div class="form-group" style="margin-bottom: 0;"><label style="font-weight: bold; margin-bottom: 8px;">üéì Session des examens *</label>';
    html += '<select id="examens-session" class="form-control" style="font-size: 14px; padding: 10px;" onchange="rechargerFormulaireExamens()">';
    html += '<option value="2024-2025">Session 2025</option>';
    html += '<option value="2023-2024">Session 2024</option>';
    html += '<option value="2022-2023">Session 2023</option>';
    html += '</select></div>';
    html += '</div>';

    // ========== FILTRES (5 FILTRES) ==========
    html += '<div style="background-color: #dbeafe; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #2563eb;">';
    html += '<h3 style="margin: 0 0 12px 0; color: #1e40af; font-size: 16px;">üîç Filtres d\'affichage</h3>';
    html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">';
    
    // Filtre 1 : R√©gion
    html += '<div class="form-group"><label>R√©gion</label><select id="filter-examens-region" class="form-control" onchange="updateExamensFilters()"><option value="">Toutes</option>';
    for (var i = 0; i < regionsData.length; i++) {
        html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
    }
    html += '</select></div>';
    
    // Filtre 2 : Pr√©fecture
    html += '<div class="form-group"><label>Pr√©fecture</label><select id="filter-examens-prefecture" class="form-control" onchange="filterExamensRows()"><option value="">Toutes</option></select></div>';
    
    // Filtre 3 : Zone
    html += '<div class="form-group"><label>Zone</label><select id="filter-examens-zone" class="form-control" onchange="filterExamensRows()"><option value="">Toutes</option><option value="Urbaine">Urbaine</option><option value="Rurale">Rurale</option></select></div>';
    
    // Filtre 4 : Niveau üî• NOUVEAU
    html += '<div class="form-group"><label>Niveau</label><select id="filter-examens-niveau" class="form-control" onchange="filterExamensRows()"><option value="">Tous</option><option value="Primaire">Primaire (CEE)</option><option value="Coll√®ge">Coll√®ge (BEPC)</option><option value="Lyc√©e">Lyc√©e (BAC)</option></select></div>';
    // Filtre 5 : Genre
html += '<div class="form-group"><label>Genre</label><select id="filter-examens-genre" class="form-control" onchange="filterExamensRows()"><option value="">Tous</option><option value="Filles">üî¥ Filles</option><option value="Garcons">üü° Gar√ßons</option><option value="Total">üü¢ Total</option></select></div>';
    html += '</div></div>';
    
    // ========== TABLEAU AVEC F/G/T POUR CEE, BEPC, BAC ==========
    html += '<div style="flex: 1; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">';
    html += '<table id="examens-table" style="width: 100%; font-size: 11px; border-collapse: collapse;"><thead style="position: sticky; top: 0; background-color: #059669; color: white; z-index: 10;"><tr>';
    html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; background-color: #059669 !important; color: white !important; font-weight: bold;">R√©gion</th>';
    html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; background-color: #059669 !important; color: white !important; font-weight: bold;">Pr√©fecture</th>';
    html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; background-color: #059669 !important; color: white !important; font-weight: bold;">Zone</th>';
    html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; background-color: #059669 !important; color: white !important; font-weight: bold;">Niveau</th>';
    
    // CEE F/G/T
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 70px; background-color: #dc2626; color: white; font-weight: bold;">CEE F(%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 70px; background-color: #fbbf24; color: #000; font-weight: bold;">CEE G(%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 70px; background-color: #16a34a; color: white; font-weight: bold;">CEE T(%)</th>';    
    // BEPC F/G/T
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 70px; background-color: #dc2626; color: white; font-weight: bold;">BEPC F(%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 70px; background-color: #fbbf24; color: #000; font-weight: bold;">BEPC G(%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 70px; background-color: #16a34a; color: white; font-weight: bold;">BEPC T(%)</th>'; 
    // BAC F/G/T
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 70px; background-color: #dc2626; color: white; font-weight: bold;">BAC F(%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 70px; background-color: #fbbf24; color: #000; font-weight: bold;">BAC G(%)</th>';
html += '<th style="padding: 8px; border: 1px solid #047857; white-space: nowrap; width: 70px; background-color: #16a34a; color: white; font-weight: bold;">BAC T(%)</th>';
    
    html += '</tr></thead><tbody>';
    
    var rowIndex = 0;
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Primaire', 'Coll√®ge', 'Lyc√©e'];
    
    // G√©n√©rer les lignes
    for (var r = 0; r < regionsData.length; r++) {
        var region = regionsData[r];
        
        var prefecturesRegion = [];
        for (var p = 0; p < prefecturesData.length; p++) {
            if (prefecturesData[p].region_id == region.id) {
                prefecturesRegion.push(prefecturesData[p]);
            }
        }
        
        for (var p = 0; p < prefecturesRegion.length; p++) {
            var prefecture = prefecturesRegion[p];
            
            for (var z = 0; z < zones.length; z++) {
                var zone = zones[z];
                
                for (var n = 0; n < niveaux.length; n++) {
                    var niveau = niveaux[n];
                    var bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
                    
                    html += '<tr class="examens-row" data-region="' + region.id + '" data-prefecture="' + prefecture.nom + '" data-zone="' + zone + '" data-niveau="' + niveau + '" style="background-color: ' + bgColor + ';">';
                    html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + region.nom + '</td>';
                    html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + prefecture.nom + '</td>';
                    html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + zone + '</td>';
                    html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 700;">' + niveau + '</td>';
                    
                    // CEE F/G/T (9 inputs au total : 3 par examen)
                    html += '<td class="col-cee" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="cee_filles" data-niveau="' + niveau + '" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                    html += '<td class="col-cee" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="cee_garcons" data-niveau="' + niveau + '" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="G"></td>';
                    html += '<td class="col-cee" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="cee_total" data-niveau="' + niveau + '" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                    
                    // BEPC F/G/T
                    html += '<td class="col-bepc" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bepc_filles" data-niveau="' + niveau + '" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                    html += '<td class="col-bepc" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bepc_garcons" data-niveau="' + niveau + '" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="G"></td>';
                    html += '<td class="col-bepc" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bepc_total" data-niveau="' + niveau + '" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                    
                    // BAC F/G/T
                    html += '<td class="col-bac" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bac_filles" data-niveau="' + niveau + '" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                    html += '<td class="col-bac" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bac_garcons" data-niveau="' + niveau + '" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="G"></td>';
                    html += '<td class="col-bac" style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="bac_total" data-niveau="' + niveau + '" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                    
                    html += '</tr>';
                    rowIndex++;
                }
            }
        }
    }
    
    html += '</tbody></table></div>';
    
    // ========== BOUTONS ==========
    html += '<div style="margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end;">';
    html += '<button class="btn btn-primary" onclick="submitExamensData(false)">üíæ Enregistrer nouvelles</button>';
    html += '<button class="btn btn-warning" onclick="submitExamensData(true)" style="background-color: #f59e0b; color: white;">üîÑ Mettre √† jour</button>';
    html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
    html += '</div>';
    
    html += '</div></div>';
    modalContainer.innerHTML = html;
// ========== CHARGER LES DONN√âES EXISTANTES ==========
setTimeout(async function() {
    var anneeSelect = document.getElementById('examens-session');
    if (!anneeSelect) return;
    
    var annee = anneeSelect.value.trim();
    console.log('üì• Chargement examens pour session:', annee);
    
    if (!annee) return;
    
    try {
        const { data: existingData, error } = await supabase
            .from('reussite_examens')
            .select('*')
            .eq('annee_scolaire', annee)
            .eq('periode', 'Annuel');
        
        if (error) throw error;
        
        if (existingData && existingData.length > 0) {
            console.log('üì• Chargement de ' + existingData.length + ' donn√©es examens existantes...');
            
            var loaded = 0;
            var zones = ['Urbaine', 'Rurale'];
            var niveaux = ['Primaire', 'Coll√®ge', 'Lyc√©e'];
            
            for (var i = 0; i < existingData.length; i++) {
                var exam = existingData[i];
                
                var rowIndex = 0;
                var found = false;
                
                for (var r = 0; r < regionsData.length && !found; r++) {
                    var region = regionsData[r];
                    
                    var prefecturesRegion = [];
                    for (var p = 0; p < prefecturesData.length; p++) {
                        if (prefecturesData[p].region_id == region.id) {
                            prefecturesRegion.push(prefecturesData[p]);
                        }
                    }
                    
                    for (var p = 0; p < prefecturesRegion.length && !found; p++) {
                        var prefecture = prefecturesRegion[p];
                        
                        if (prefecture.nom !== exam.prefecture) {
                            rowIndex += 6; // 2 zones √ó 3 niveaux
                            continue;
                        }
                        
                        for (var z = 0; z < zones.length && !found; z++) {
                            var zone = zones[z];
                            
                            if (zone !== exam.zone) {
                                rowIndex += 3; // 3 niveaux
                                continue;
                            }
                            
                            for (var n = 0; n < niveaux.length && !found; n++) {
                                if (niveaux[n] === exam.niveau) {
                                    // CEE F/G/T
                                    if (exam.taux_reussite_cee_filles !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="cee_filles"]');
                                        if (input) { input.value = exam.taux_reussite_cee_filles; input.style.background = '#fce7f3'; loaded++; }
                                    }
                                    if (exam.taux_reussite_cee_garcons !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="cee_garcons"]');
                                        if (input) { input.value = exam.taux_reussite_cee_garcons; input.style.background = '#fef3c7'; loaded++; }
                                    }
                                    if (exam.taux_reussite_cee_total !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="cee_total"]');
                                        if (input) { input.value = exam.taux_reussite_cee_total; input.style.background = '#d1fae5'; loaded++; }
                                    }
                                    
                                    // BEPC F/G/T
                                    if (exam.taux_reussite_bepc_filles !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bepc_filles"]');
                                        if (input) { input.value = exam.taux_reussite_bepc_filles; input.style.background = '#fce7f3'; loaded++; }
                                    }
                                    if (exam.taux_reussite_bepc_garcons !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bepc_garcons"]');
                                        if (input) { input.value = exam.taux_reussite_bepc_garcons; input.style.background = '#fef3c7'; loaded++; }
                                    }
                                    if (exam.taux_reussite_bepc_total !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bepc_total"]');
                                        if (input) { input.value = exam.taux_reussite_bepc_total; input.style.background = '#d1fae5'; loaded++; }
                                    }
                                    
                                    // BAC F/G/T
                                    if (exam.taux_reussite_bac_filles !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bac_filles"]');
                                        if (input) { input.value = exam.taux_reussite_bac_filles; input.style.background = '#fce7f3'; loaded++; }
                                    }
                                    if (exam.taux_reussite_bac_garcons !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bac_garcons"]');
                                        if (input) { input.value = exam.taux_reussite_bac_garcons; input.style.background = '#fef3c7'; loaded++; }
                                    }
                                    if (exam.taux_reussite_bac_total !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bac_total"]');
                                        if (input) { input.value = exam.taux_reussite_bac_total; input.style.background = '#d1fae5'; loaded++; }
                                    }
                                    
                                    found = true;
                                    break;
                                }
                                rowIndex++;
                            }
                        }
                    }
                }
            }
            
            if (loaded > 0) {
                console.log('‚úÖ ' + loaded + ' champs examens charg√©s');
                alert('üì• ' + loaded + ' taux de r√©ussite d√©j√† enregistr√©s ont √©t√© charg√©s.');
            }
        } else {
            console.log('üìù Formulaire vierge pour session ' + annee);
        }
    } catch (error) {
        console.error('‚ùå Erreur chargement examens:', error);
    }
}, 500);

}
function rechargerFormulaireExamens() {
    console.log('üîÑ Rechargement du formulaire examens...');
    
    // R√©cup√©rer la session s√©lectionn√©e
    var session = document.getElementById('examens-session') ? document.getElementById('examens-session').value : '2024-2025';
    
    // R√©cup√©rer les valeurs des filtres actuels
    var filterRegion = document.getElementById('filter-examens-region') ? document.getElementById('filter-examens-region').value : '';
    var filterPrefecture = document.getElementById('filter-examens-prefecture') ? document.getElementById('filter-examens-prefecture').value : '';
    var filterZone = document.getElementById('filter-examens-zone') ? document.getElementById('filter-examens-zone').value : '';
    var filterNiveau = document.getElementById('filter-examens-niveau') ? document.getElementById('filter-examens-niveau').value : '';
    var filterGenre = document.getElementById('filter-examens-genre') ? document.getElementById('filter-examens-genre').value : '';
    
    console.log('üìÖ Session s√©lectionn√©e:', session);
    
    // Fermer et rouvrir le modal
    showReussiteExamensModal();
    
    // Restaurer les valeurs apr√®s rechargement
    setTimeout(function() {
        if (document.getElementById('examens-session')) {
            document.getElementById('examens-session').value = session;
            console.log('‚úÖ Session restaur√©e:', session);
        }
        if (document.getElementById('filter-examens-region')) {
            document.getElementById('filter-examens-region').value = filterRegion;
            updateExamensFilters();
        }
        if (document.getElementById('filter-examens-prefecture')) {
            document.getElementById('filter-examens-prefecture').value = filterPrefecture;
        }
        if (document.getElementById('filter-examens-zone')) {
            document.getElementById('filter-examens-zone').value = filterZone;
        }
        if (document.getElementById('filter-examens-niveau')) {
            document.getElementById('filter-examens-niveau').value = filterNiveau;
        }
        if (document.getElementById('filter-examens-genre')) {
            document.getElementById('filter-examens-genre').value = filterGenre;
            filterExamensRows();
        }
    }, 100);
}
function updateExamensFilters() {
    var regionSelect = document.getElementById('filter-examens-region');
    var prefectureSelect = document.getElementById('filter-examens-prefecture');
    
    if (!regionSelect || !prefectureSelect) {
        console.log('‚ùå S√©lecteurs examens non trouv√©s');
        return;
    }
    
    var regionId = regionSelect.value;
    
    console.log('=== UPDATE EXAMENS FILTERS ===');
    console.log('R√©gion s√©lectionn√©e:', regionId);
    
    // Vider les options
    prefectureSelect.innerHTML = '<option value="">Toutes les pr√©fectures</option>';
    
    if (regionId && regionId !== '') {
        var count = 0;
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
                count++;
            }
        }
        console.log('‚úÖ Pr√©fectures ajout√©es:', count);
    }
    
    // Appliquer le filtrage
    filterExamensRows();
}
function filterExamensRows() {
    var regionId = document.getElementById('filter-examens-region') ? document.getElementById('filter-examens-region').value : '';
    var prefectureNom = document.getElementById('filter-examens-prefecture') ? document.getElementById('filter-examens-prefecture').value : '';
    var zoneFilter = document.getElementById('filter-examens-zone') ? document.getElementById('filter-examens-zone').value : '';
    var niveauFilter = document.getElementById('filter-examens-niveau') ? document.getElementById('filter-examens-niveau').value : '';
    var genreFilter = document.getElementById('filter-examens-genre') ? document.getElementById('filter-examens-genre').value : '';
    
    console.log('üîç Filtrage formulaire Examens:', regionId, prefectureNom, zoneFilter, niveauFilter, genreFilter);
    
    // Mettre √† jour les pr√©fectures selon la r√©gion
    var prefectureSelect = document.getElementById('filter-examens-prefecture');
    if (regionId && regionId !== '' && prefectureSelect) {
        var currentValue = prefectureSelect.value;
        prefectureSelect.innerHTML = '<option value="">Toutes</option>';
        
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
        
        if (currentValue) prefectureSelect.value = currentValue;
    }
    
    // Filtrer les lignes du tableau
    var rows = document.querySelectorAll('.examens-row');
    var table = document.getElementById('examens-table');
    var headers = table ? table.querySelectorAll('thead th') : [];
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var rowRegion = row.getAttribute('data-region');
        var rowPrefecture = row.getAttribute('data-prefecture');
        var rowZone = row.getAttribute('data-zone');
        var rowNiveau = row.getAttribute('data-niveau');
        
        var showRow = true;
        
        if (regionId && regionId !== '' && rowRegion != regionId) showRow = false;
        if (prefectureNom && prefectureNom !== '' && rowPrefecture != prefectureNom) showRow = false;
        if (zoneFilter && zoneFilter !== '' && rowZone != zoneFilter) showRow = false;
        if (niveauFilter && niveauFilter !== '' && rowNiveau != niveauFilter) showRow = false;
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
        
        // G√©rer l'affichage des colonnes selon le genre
        var cells = row.querySelectorAll('td');
        
        // Structure : 0:R√©gion | 1:Pr√©fecture | 2:Zone | 3:Niveau
        // 4:CEE F | 5:CEE G | 6:CEE T
        // 7:BEPC F | 8:BEPC G | 9:BEPC T
        // 10:BAC F | 11:BAC G | 12:BAC T
        
        if (genreFilter === 'Filles') {
            // Afficher F, masquer G et T
            if (cells.length >= 13) {
                cells[4].style.display = '';     // CEE F
                cells[5].style.display = 'none'; // CEE G
                cells[6].style.display = 'none'; // CEE T
                cells[7].style.display = '';     // BEPC F
                cells[8].style.display = 'none'; // BEPC G
                cells[9].style.display = 'none'; // BEPC T
                cells[10].style.display = '';    // BAC F
                cells[11].style.display = 'none'; // BAC G
                cells[12].style.display = 'none'; // BAC T
            }
        } else if (genreFilter === 'Garcons') {
            // Afficher G, masquer F et T
            if (cells.length >= 13) {
                cells[4].style.display = 'none'; // CEE F
                cells[5].style.display = '';     // CEE G
                cells[6].style.display = 'none'; // CEE T
                cells[7].style.display = 'none'; // BEPC F
                cells[8].style.display = '';     // BEPC G
                cells[9].style.display = 'none'; // BEPC T
                cells[10].style.display = 'none'; // BAC F
                cells[11].style.display = '';    // BAC G
                cells[12].style.display = 'none'; // BAC T
            }
        } else if (genreFilter === 'Total') {
            // Afficher T, masquer F et G
            if (cells.length >= 13) {
                cells[4].style.display = 'none'; // CEE F
                cells[5].style.display = 'none'; // CEE G
                cells[6].style.display = '';     // CEE T
                cells[7].style.display = 'none'; // BEPC F
                cells[8].style.display = 'none'; // BEPC G
                cells[9].style.display = '';     // BEPC T
                cells[10].style.display = 'none'; // BAC F
                cells[11].style.display = 'none'; // BAC G
                cells[12].style.display = '';    // BAC T
            }
        } else {
            // Afficher toutes les colonnes
            for (var c = 4; c < cells.length; c++) {
                cells[c].style.display = '';
            }
        }
    }
    
    // G√©rer les en-t√™tes
    if (headers.length >= 13) {
        if (genreFilter === 'Filles') {
            headers[4].style.display = '';     // CEE F
            headers[5].style.display = 'none'; // CEE G
            headers[6].style.display = 'none'; // CEE T
            headers[7].style.display = '';     // BEPC F
            headers[8].style.display = 'none'; // BEPC G
            headers[9].style.display = 'none'; // BEPC T
            headers[10].style.display = '';    // BAC F
            headers[11].style.display = 'none'; // BAC G
            headers[12].style.display = 'none'; // BAC T
        } else if (genreFilter === 'Garcons') {
            headers[4].style.display = 'none'; // CEE F
            headers[5].style.display = '';     // CEE G
            headers[6].style.display = 'none'; // CEE T
            headers[7].style.display = 'none'; // BEPC F
            headers[8].style.display = '';     // BEPC G
            headers[9].style.display = 'none'; // BEPC T
            headers[10].style.display = 'none'; // BAC F
            headers[11].style.display = '';    // BAC G
            headers[12].style.display = 'none'; // BAC T
        } else if (genreFilter === 'Total') {
            headers[4].style.display = 'none'; // CEE F
            headers[5].style.display = 'none'; // CEE G
            headers[6].style.display = '';     // CEE T
            headers[7].style.display = 'none'; // BEPC F
            headers[8].style.display = 'none'; // BEPC G
            headers[9].style.display = '';     // BEPC T
            headers[10].style.display = 'none'; // BAC F
            headers[11].style.display = 'none'; // BAC G
            headers[12].style.display = '';    // BAC T
        } else {
            // Afficher tous les en-t√™tes
            for (var h = 4; h < headers.length; h++) {
                headers[h].style.display = '';
            }
        }
    }
    
    console.log('‚úÖ Lignes visibles:', visibleCount);
}
function filterAlphabetisationRows() {
    var regionId = document.getElementById('filter-alpha-region') ? document.getElementById('filter-alpha-region').value : '';
    var prefectureNom = document.getElementById('filter-alpha-prefecture') ? document.getElementById('filter-alpha-prefecture').value : '';
    var zoneFilter = document.getElementById('filter-alpha-zone') ? document.getElementById('filter-alpha-zone').value : '';
    var niveauFilter = document.getElementById('filter-alpha-niveau') ? document.getElementById('filter-alpha-niveau').value : '';
    var genreFilter = document.getElementById('filter-alpha-genre') ? document.getElementById('filter-alpha-genre').value : '';
    
    console.log('üîç Filtrage Alphab√©tisation:', regionId, prefectureNom, zoneFilter, niveauFilter, genreFilter);
    
    // Mettre √† jour les pr√©fectures selon la r√©gion
    var prefectureSelect = document.getElementById('filter-alpha-prefecture');
    if (regionId && regionId !== '' && prefectureSelect) {
        var currentValue = prefectureSelect.value;
        prefectureSelect.innerHTML = '<option value="">Toutes</option>';
        
        for (var i = 0; i < prefecturesData.length; i++) {
            if (prefecturesData[i].region_id == regionId) {
                var option = document.createElement('option');
                option.value = prefecturesData[i].nom;
                option.textContent = prefecturesData[i].nom;
                prefectureSelect.appendChild(option);
            }
        }
        
        if (currentValue) prefectureSelect.value = currentValue;
    }
    
    // Filtrer les lignes du tableau
    var rows = document.querySelectorAll('.alpha-row');
    var table = document.getElementById('alpha-table');
    var headers = table ? table.querySelectorAll('thead th') : [];
    var visibleCount = 0;
    
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var rowRegion = row.getAttribute('data-region');
        var rowPrefecture = row.getAttribute('data-prefecture');
        var rowZone = row.getAttribute('data-zone');
        var rowNiveau = row.getAttribute('data-niveau');
        
        var showRow = true;
        
        if (regionId && regionId !== '' && rowRegion != regionId) showRow = false;
        if (prefectureNom && prefectureNom !== '' && rowPrefecture != prefectureNom) showRow = false;
        if (zoneFilter && zoneFilter !== '' && rowZone != zoneFilter) showRow = false;
        if (niveauFilter && niveauFilter !== '' && rowNiveau != niveauFilter) showRow = false;
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
        
// G√©rer l'affichage des colonnes selon le genre
        var cells = row.querySelectorAll('td');
        
        // Structure : 0:R√©gion | 1:Pr√©fecture | 2:Zone | 3:Niveau
        // 4:Alpha F | 5:Alpha G | 6:Alpha T
        // 7:B√©n√©f F | 8:B√©n√©f G | 9:B√©n√©f T
        
        if (genreFilter === 'Filles') {
            if (cells.length >= 10) {
                cells[4].style.display = '';     // Alpha F
                cells[5].style.display = 'none'; // Alpha G
                cells[6].style.display = 'none'; // Alpha T
                cells[7].style.display = '';     // B√©n√©f F
                cells[8].style.display = 'none'; // B√©n√©f G
                cells[9].style.display = 'none'; // B√©n√©f T
            }
        } else if (genreFilter === 'Garcons') {
            if (cells.length >= 10) {
                cells[4].style.display = 'none'; // Alpha F
                cells[5].style.display = '';     // Alpha G
                cells[6].style.display = 'none'; // Alpha T
                cells[7].style.display = 'none'; // B√©n√©f F
                cells[8].style.display = '';     // B√©n√©f G
                cells[9].style.display = 'none'; // B√©n√©f T
            }
        } else if (genreFilter === 'Total') {
            if (cells.length >= 10) {
                cells[4].style.display = 'none'; // Alpha F
                cells[5].style.display = 'none'; // Alpha G
                cells[6].style.display = '';     // Alpha T
                cells[7].style.display = 'none'; // B√©n√©f F
                cells[8].style.display = 'none'; // B√©n√©f G
                cells[9].style.display = '';     // B√©n√©f T
            }
        } else {
            for (var c = 4; c < cells.length; c++) {
                cells[c].style.display = '';
            }
        }
    }
// G√©rer les en-t√™tes
    if (headers.length >= 10) {
        if (genreFilter === 'Filles') {
            headers[4].style.display = '';     // Alpha F
            headers[5].style.display = 'none'; // Alpha G
            headers[6].style.display = 'none'; // Alpha T
            headers[7].style.display = '';     // B√©n√©f F
            headers[8].style.display = 'none'; // B√©n√©f G
            headers[9].style.display = 'none'; // B√©n√©f T
        } else if (genreFilter === 'Garcons') {
            headers[4].style.display = 'none'; // Alpha F
            headers[5].style.display = '';     // Alpha G
            headers[6].style.display = 'none'; // Alpha T
            headers[7].style.display = 'none'; // B√©n√©f F
            headers[8].style.display = '';     // B√©n√©f G
            headers[9].style.display = 'none'; // B√©n√©f T
        } else if (genreFilter === 'Total') {
            headers[4].style.display = 'none'; // Alpha F
            headers[5].style.display = 'none'; // Alpha G
            headers[6].style.display = '';     // Alpha T
            headers[7].style.display = 'none'; // B√©n√©f F
            headers[8].style.display = 'none'; // B√©n√©f G
            headers[9].style.display = '';     // B√©n√©f T
        } else {
            for (var h = 4; h < headers.length; h++) {
                headers[h].style.display = '';
            }
        }
    }
    console.log('‚úÖ Lignes visibles:', visibleCount);
}
async function submitAlphabetisationData(forcerMiseAJour) {
    forcerMiseAJour = forcerMiseAJour || false;
    
    var anneeSelect = document.getElementById('alpha-annee');
    if (!anneeSelect) {
        alert('‚ùå Erreur : Impossible de trouver le s√©lecteur d\'ann√©e');
        return;
    }
    
    var annee = anneeSelect.value;
    console.log('üíæ Enregistrement alphab√©tisation pour ann√©e:', annee);
    
    if (!annee) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner une ann√©e');
        return;
    }
    
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Debutant', 'Intermediaire', 'Avance'];
    var dataToInsert = [];
    var rowIndex = 0;
    
    console.log('üìä Collecte des donn√©es alphab√©tisation...');
    
    for (var r = 0; r < regionsData.length; r++) {
        var region = regionsData[r];
        var prefecturesRegion = [];
        
        for (var p = 0; p < prefecturesData.length; p++) {
            if (prefecturesData[p].region_id == region.id) {
                prefecturesRegion.push(prefecturesData[p]);
            }
        }
        
        for (var p = 0; p < prefecturesRegion.length; p++) {
            var prefecture = prefecturesRegion[p];
            
            for (var z = 0; z < zones.length; z++) {
                var zone = zones[z];
                
                for (var n = 0; n < niveaux.length; n++) {
                    var niveau = niveaux[n];
var alphaF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alpha_filles"]');
                    var alphaG = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alpha_garcons"]');
                    var alphaT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alpha_total"]');
                    var benefF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="benef_filles"]');
                    var benefG = document.querySelector('input[data-row="' + rowIndex + '"][data-field="benef_garcons"]');
                    var benefT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="benef_total"]');
                    
                    var valAlphaF = alphaF && alphaF.value ? parseFloat(alphaF.value) : null;
                    var valAlphaG = alphaG && alphaG.value ? parseFloat(alphaG.value) : null;
                    var valAlphaT = alphaT && alphaT.value ? parseFloat(alphaT.value) : null;
                    var valBenefF = benefF && benefF.value ? parseInt(benefF.value) : null;
                    var valBenefG = benefG && benefG.value ? parseInt(benefG.value) : null;
                    var valBenefT = benefT && benefT.value ? parseInt(benefT.value) : null;
                    
                    if (valAlphaF !== null || valAlphaG !== null || valAlphaT !== null || 
                        valBenefF !== null || valBenefG !== null || valBenefT !== null) {
                        dataToInsert.push({
                            annee_scolaire: annee,
                            periode: 'Annuel',
                            region: region.nom,
                            prefecture: prefecture.nom,
                            zone: zone,
                            niveau: niveau,
                            taux_alphab√©tisation_filles: valAlphaF,
                            taux_alphab√©tisation_garcons: valAlphaG,
                            taux_alphab√©tisation_total: valAlphaT,
                            beneficiaires_filles: valBenefF,
                            beneficiaires_garcons: valBenefG,
                            beneficiaires_total: valBenefT,
                            saisi_par: currentUser.nom
                        });
                    }
                    rowIndex++;
                }
            }
        }
    }
    
    if (dataToInsert.length === 0) {
        alert('‚ö†Ô∏è Aucune donn√©e √† enregistrer.');
        return;
    }
    
    if (!confirm('üíæ Enregistrer ' + dataToInsert.length + ' lignes ?')) {
        return;
    }
    
    try {
        const { data: processedData, error } = await supabase
            .from('alphabetisation')
            .upsert(dataToInsert, { 
                onConflict: 'annee_scolaire,periode,region,prefecture,zone,niveau',
                ignoreDuplicates: false 
            })
            .select();
        
        if (error) throw error;
        
        alert('‚úÖ Donn√©es enregistr√©es !');
        await loadData();
        closeModal();
        render();
        
    } catch (error) {
        console.error('‚ùå Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}
function rechargerFormulaireAlphabetisation() {
    console.log('üîÑ Rechargement formulaire Alphab√©tisation...');
    
    var annee = document.getElementById('alpha-annee') ? document.getElementById('alpha-annee').value : '2025-2026';
    var filterRegion = document.getElementById('filter-alpha-region') ? document.getElementById('filter-alpha-region').value : '';
    var filterPrefecture = document.getElementById('filter-alpha-prefecture') ? document.getElementById('filter-alpha-prefecture').value : '';
    var filterZone = document.getElementById('filter-alpha-zone') ? document.getElementById('filter-alpha-zone').value : '';
    var filterNiveau = document.getElementById('filter-alpha-niveau') ? document.getElementById('filter-alpha-niveau').value : '';
    var filterGenre = document.getElementById('filter-alpha-genre') ? document.getElementById('filter-alpha-genre').value : '';
    
    console.log('üìÖ Ann√©e s√©lectionn√©e:', annee);
    
    showAlphabetisationModal();
    
    setTimeout(function() {
        if (document.getElementById('alpha-annee')) {
            document.getElementById('alpha-annee').value = annee;
            console.log('‚úÖ Ann√©e restaur√©e:', annee);
        }
        if (document.getElementById('filter-alpha-region')) {
            document.getElementById('filter-alpha-region').value = filterRegion;
            filterAlphabetisationRows();
        }
        if (document.getElementById('filter-alpha-prefecture')) {
            document.getElementById('filter-alpha-prefecture').value = filterPrefecture;
        }
        if (document.getElementById('filter-alpha-zone')) {
            document.getElementById('filter-alpha-zone').value = filterZone;
        }
        if (document.getElementById('filter-alpha-niveau')) {
            document.getElementById('filter-alpha-niveau').value = filterNiveau;
        }
        if (document.getElementById('filter-alpha-genre')) {
            document.getElementById('filter-alpha-genre').value = filterGenre;
            filterAlphabetisationRows();
        }
    }, 100);
}
async function submitExamensData(forcerMiseAJour) {
    forcerMiseAJour = forcerMiseAJour || false;
    
    var anneeSelect = document.getElementById('examens-session');
    if (!anneeSelect) {
        alert('‚ùå Erreur : Impossible de trouver le s√©lecteur de session');
        return;
    }
    
    var annee = anneeSelect.value;
    console.log('üíæ Enregistrement examens pour session:', annee);
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Primaire', 'Coll√®ge', 'Lyc√©e'];
    var dataToInsert = [];
    var rowIndex = 0;
    
    console.log('üìä Collecte des donn√©es examens...');
    
    for (var r = 0; r < regionsData.length; r++) {
        var region = regionsData[r];
        var prefecturesRegion = [];
        
        for (var p = 0; p < prefecturesData.length; p++) {
            if (prefecturesData[p].region_id == region.id) {
                prefecturesRegion.push(prefecturesData[p]);
            }
        }
        
        for (var p = 0; p < prefecturesRegion.length; p++) {
            var prefecture = prefecturesRegion[p];
            
            for (var z = 0; z < zones.length; z++) {
                var zone = zones[z];
                
                for (var n = 0; n < niveaux.length; n++) {
                    var niveau = niveaux[n];
                    
                    // R√©cup√©rer les 9 inputs (3 par examen)
                    var ceeF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="cee_filles"]');
                    var ceeG = document.querySelector('input[data-row="' + rowIndex + '"][data-field="cee_garcons"]');
                    var ceeT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="cee_total"]');
                    var bepcF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bepc_filles"]');
                    var bepcG = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bepc_garcons"]');
                    var bepcT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bepc_total"]');
                    var bacF = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bac_filles"]');
                    var bacG = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bac_garcons"]');
                    var bacT = document.querySelector('input[data-row="' + rowIndex + '"][data-field="bac_total"]');
                    
                    var valCeeF = ceeF && ceeF.value ? parseFloat(ceeF.value) : null;
                    var valCeeG = ceeG && ceeG.value ? parseFloat(ceeG.value) : null;
                    var valCeeT = ceeT && ceeT.value ? parseFloat(ceeT.value) : null;
                    var valBepcF = bepcF && bepcF.value ? parseFloat(bepcF.value) : null;
                    var valBepcG = bepcG && bepcG.value ? parseFloat(bepcG.value) : null;
                    var valBepcT = bepcT && bepcT.value ? parseFloat(bepcT.value) : null;
                    var valBacF = bacF && bacF.value ? parseFloat(bacF.value) : null;
                    var valBacG = bacG && bacG.value ? parseFloat(bacG.value) : null;
                    var valBacT = bacT && bacT.value ? parseFloat(bacT.value) : null;
                    
                    // Si au moins une valeur existe
                    if (valCeeF !== null || valCeeG !== null || valCeeT !== null ||
                        valBepcF !== null || valBepcG !== null || valBepcT !== null ||
                        valBacF !== null || valBacG !== null || valBacT !== null) {
                        
                        dataToInsert.push({
                            annee_scolaire: annee,
                            session: parseInt(annee.split('-')[0]),
                            periode: 'Annuel',
                            region: region.nom,
                            prefecture: prefecture.nom,
                            zone: zone,
                            niveau: niveau,
                            taux_reussite_cee_filles: valCeeF,
                            taux_reussite_cee_garcons: valCeeG,
                            taux_reussite_cee_total: valCeeT,
                            taux_reussite_bepc_filles: valBepcF,
                            taux_reussite_bepc_garcons: valBepcG,
                            taux_reussite_bepc_total: valBepcT,
                            taux_reussite_bac_filles: valBacF,
                            taux_reussite_bac_garcons: valBacG,
                            taux_reussite_bac_total: valBacT,
                            saisi_par: currentUser.nom
                        });
                    }
                    
                    rowIndex++;
                }
            }
        }
    }
    
    if (dataToInsert.length === 0) {
        alert('‚ö†Ô∏è Aucune donn√©e √† enregistrer.');
        return;
    }
    
    if (!confirm('üíæ Enregistrer ' + dataToInsert.length + ' lignes ?')) {
        return;
    }
    
    try {
        const { data: processedData, error } = await supabase
            .from('reussite_examens')
            .upsert(dataToInsert, { 
                onConflict: 'annee_scolaire,periode,region,prefecture,zone,niveau',
                ignoreDuplicates: false 
            })
            .select();
        
        if (error) throw error;
        
        alert('‚úÖ Donn√©es enregistr√©es !');
        await loadData();
        closeModal();
        render();
        
    } catch (error) {
        console.error('‚ùå Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}
function showAlphabetisationModal() {
    var modalContainer = document.getElementById('modal-container');
    var html = '<div class="modal"><div class="modal-content" style="max-width: 98vw; max-height: 98vh; overflow: hidden; display: flex; flex-direction: column;"><h2 style="margin-bottom: 16px;">‚úçÔ∏è Saisir les taux d\'alphab√©tisation</h2>';
    
    // ========== FILTRE SESSION ==========
    html += '<div style="background-color: #f0fdf4; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #059669;">';
    html += '<div class="form-group" style="margin-bottom: 0;"><label style="font-weight: bold; margin-bottom: 8px;">üéì Ann√©e d‚Äôalphab√©tisation *</label>';
html += '<select id="alpha-annee" class="form-control" style="font-size: 14px; padding: 10px;" onchange="rechargerFormulaireAlphabetisation()">';
    html += '<option value="2024-2025">Session 2025</option>';
    html += '<option value="2023-2024">Session 2024</option>';
    html += '<option value="2022-2023">Session 2023</option>';
    html += '</select></div>';
    html += '</div>';

    // ========== FILTRES (5 FILTRES) ==========
    html += '<div style="background-color: #fce7f3; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #ec4899;">';
    html += '<h3 style="margin: 0 0 12px 0; color: #9f1239; font-size: 16px;">üîç Filtres d\'affichage</h3>';
    html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">';
    
    // Filtre 1 : R√©gion
    html += '<div class="form-group"><label>R√©gion</label><select id="filter-alpha-region" class="form-control" onchange="filterAlphabetisationRows()"><option value="">Toutes</option>';
    for (var i = 0; i < regionsData.length; i++) {
        html += '<option value="' + regionsData[i].id + '">' + regionsData[i].nom + '</option>';
    }
    html += '</select></div>';
    
    // Filtre 2 : Pr√©fecture
    html += '<div class="form-group"><label>Pr√©fecture</label><select id="filter-alpha-prefecture" class="form-control" onchange="filterAlphabetisationRows()"><option value="">Toutes</option></select></div>';
    
    // Filtre 3 : Zone
    html += '<div class="form-group"><label>Zone</label><select id="filter-alpha-zone" class="form-control" onchange="filterAlphabetisationRows()"><option value="">Toutes</option><option value="Urbaine">Urbaine</option><option value="Rurale">Rurale</option></select></div>';
    
    // Filtre 4 : Niveau (pour alphab√©tisation : D√©butant, Interm√©diaire, Avanc√©)
    html += '<div class="form-group"><label>Niveau</label><select id="filter-alpha-niveau" class="form-control" onchange="filterAlphabetisationRows()"><option value="">Tous</option><option value="Debutant">D√©butant</option><option value="Intermediaire">Interm√©diaire</option><option value="Avance">Avanc√©</option></select></div>';
    
    // Filtre 5 : Genre
    html += '<div class="form-group"><label>Genre</label><select id="filter-alpha-genre" class="form-control" onchange="filterAlphabetisationRows()"><option value="">Tous</option><option value="Filles">üî¥ Filles</option><option value="Garcons">üü° Gar√ßons</option><option value="Total">üü¢ Total</option></select></div>';
    
    html += '</div></div>';
    
    // ========== TABLEAU AVEC F/G/T ==========
    html += '<div style="flex: 1; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px;">';
    html += '<table id="alpha-table" style="width: 100%; font-size: 11px; border-collapse: collapse;"><thead style="position: sticky; top: 0; background-color: #f59e0b; color: white; z-index: 10;"><tr>';
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; background-color: #f59e0b !important; color: white !important; font-weight: bold;">R√©gion</th>';
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; background-color: #f59e0b !important; color: white !important; font-weight: bold;">Pr√©fecture</th>';
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; background-color: #f59e0b !important; color: white !important; font-weight: bold;">Zone</th>';
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; background-color: #f59e0b !important; color: white !important; font-weight: bold;">Niveau</th>';

// Taux alphab√©tisation F/G/T
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; width: 70px; background-color: #dc2626; color: white; font-weight: bold;">Alpha F(%)</th>';
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; width: 70px; background-color: #fbbf24; color: #000; font-weight: bold;">Alpha G(%)</th>';
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; width: 70px; background-color: #16a34a; color: white; font-weight: bold;">Alpha T(%)</th>';
    
    // B√©n√©ficiaires F/G/T
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; width: 70px; background-color: #dc2626; color: white; font-weight: bold;">B√©n√©f. F</th>';
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; width: 70px; background-color: #fbbf24; color: #000; font-weight: bold;">B√©n√©f. G</th>';
    html += '<th style="padding: 8px; border: 1px solid #d97706; white-space: nowrap; width: 70px; background-color: #16a34a; color: white; font-weight: bold;">B√©n√©f. T</th>';
    html += '</tr></thead><tbody>';
    
    var rowIndex = 0;
    var zones = ['Urbaine', 'Rurale'];
    var niveaux = ['Debutant', 'Intermediaire', 'Avance'];
    
    // G√©n√©rer les lignes
    for (var r = 0; r < regionsData.length; r++) {
        var region = regionsData[r];
        
        var prefecturesRegion = [];
        for (var p = 0; p < prefecturesData.length; p++) {
            if (prefecturesData[p].region_id == region.id) {
                prefecturesRegion.push(prefecturesData[p]);
            }
        }
        
        for (var p = 0; p < prefecturesRegion.length; p++) {
            var prefecture = prefecturesRegion[p];
            
            for (var z = 0; z < zones.length; z++) {
                var zone = zones[z];
                
                for (var n = 0; n < niveaux.length; n++) {
                    var niveau = niveaux[n];
                    var niveauLabel = niveau === 'Debutant' ? 'D√©butant' : (niveau === 'Intermediaire' ? 'Interm√©diaire' : 'Avanc√©');
                    var bgColor = rowIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
                    
                    html += '<tr class="alpha-row" data-region="' + region.id + '" data-prefecture="' + prefecture.nom + '" data-zone="' + zone + '" data-niveau="' + niveau + '" style="background-color: ' + bgColor + ';">';
                    html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">' + region.nom + '</td>';
                    html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + prefecture.nom + '</td>';
                    html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap;">' + zone + '</td>';
                    html += '<td style="padding: 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 700;">' + niveauLabel + '</td>';
                    
// Taux Alpha F/G/T
                    html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="alpha_filles" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="F"></td>';
                    html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="alpha_garcons" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="G"></td>';
                    html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" step="0.01" class="form-control" data-row="' + rowIndex + '" data-field="alpha_total" style="width: 100%; font-size: 11px; padding: 4px;" min="0" max="100" placeholder="T"></td>';
                    
                    // B√©n√©ficiaires F/G/T
                    html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" class="form-control" data-row="' + rowIndex + '" data-field="benef_filles" style="width: 100%; font-size: 11px; padding: 4px;" min="0" placeholder="F"></td>';
                    html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" class="form-control" data-row="' + rowIndex + '" data-field="benef_garcons" style="width: 100%; font-size: 11px; padding: 4px;" min="0" placeholder="G"></td>';
                    html += '<td style="padding: 2px; border: 1px solid #e5e7eb;"><input type="number" class="form-control" data-row="' + rowIndex + '" data-field="benef_total" style="width: 100%; font-size: 11px; padding: 4px;" min="0" placeholder="T"></td>';
                    html += '</tr>';
                    rowIndex++;
                }
            }
        }
    }
    
    html += '</tbody></table></div>';
    
    // ========== BOUTONS ==========
    html += '<div style="margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end;">';
    html += '<button class="btn btn-primary" onclick="submitAlphabetisationData(false)">üíæ Enregistrer nouvelles</button>';
    html += '<button class="btn btn-warning" onclick="submitAlphabetisationData(true)" style="background-color: #f59e0b; color: white;">üîÑ Mettre √† jour</button>';
    html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>';
    html += '</div>';
    
    html += '</div></div>';
    modalContainer.innerHTML = html;
// ========== CHARGER LES DONN√âES EXISTANTES ==========
setTimeout(async function() {
    var anneeSelect = document.getElementById('alpha-annee');
    if (!anneeSelect) return;
    
    var annee = anneeSelect.value.trim();
    console.log('üì• Chargement alphab√©tisation pour ann√©e:', annee);
    
    if (!annee) return;
    
    try {
        const { data: existingData, error } = await supabase
            .from('alphabetisation')
            .select('*')
            .eq('annee_scolaire', annee)
            .eq('periode', 'Annuel');
        
        if (error) throw error;
        
        if (existingData && existingData.length > 0) {
            console.log('üì• Chargement de ' + existingData.length + ' donn√©es alphab√©tisation existantes...');
            
            var loaded = 0;
            var zones = ['Urbaine', 'Rurale'];
            var niveaux = ['Debutant', 'Intermediaire', 'Avance'];
            
            for (var i = 0; i < existingData.length; i++) {
                var alpha = existingData[i];
                
                var rowIndex = 0;
                var found = false;
                
                for (var r = 0; r < regionsData.length && !found; r++) {
                    var region = regionsData[r];
                    
                    var prefecturesRegion = [];
                    for (var p = 0; p < prefecturesData.length; p++) {
                        if (prefecturesData[p].region_id == region.id) {
                            prefecturesRegion.push(prefecturesData[p]);
                        }
                    }
                    
                    for (var p = 0; p < prefecturesRegion.length && !found; p++) {
                        var prefecture = prefecturesRegion[p];
                        
                        if (prefecture.nom !== alpha.prefecture) {
                            rowIndex += 6; // 2 zones √ó 3 niveaux
                            continue;
                        }
                        
                        for (var z = 0; z < zones.length && !found; z++) {
                            var zone = zones[z];
                            
                            if (zone !== alpha.zone) {
                                rowIndex += 3; // 3 niveaux
                                continue;
                            }
                            
                            for (var n = 0; n < niveaux.length && !found; n++) {
                                if (niveaux[n] === alpha.niveau) {
                                    // Taux Alpha F/G/T
                                    if (alpha.taux_alphab√©tisation_filles !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alpha_filles"]');
                                        if (input) { input.value = alpha.taux_alphab√©tisation_filles; input.style.background = '#fce7f3'; loaded++; }
                                    }
                                    if (alpha.taux_alphab√©tisation_garcons !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alpha_garcons"]');
                                        if (input) { input.value = alpha.taux_alphab√©tisation_garcons; input.style.background = '#fef3c7'; loaded++; }
                                    }
                                    if (alpha.taux_alphab√©tisation_total !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="alpha_total"]');
                                        if (input) { input.value = alpha.taux_alphab√©tisation_total; input.style.background = '#d1fae5'; loaded++; }
                                    }
                                    
                                    // B√©n√©ficiaires F/G/T
                                    if (alpha.beneficiaires_filles !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="benef_filles"]');
                                        if (input) { input.value = alpha.beneficiaires_filles; input.style.background = '#fce7f3'; loaded++; }
                                    }
                                    if (alpha.beneficiaires_garcons !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="benef_garcons"]');
                                        if (input) { input.value = alpha.beneficiaires_garcons; input.style.background = '#fef3c7'; loaded++; }
                                    }
                                    if (alpha.beneficiaires_total !== null) {
                                        var input = document.querySelector('input[data-row="' + rowIndex + '"][data-field="benef_total"]');
                                        if (input) { input.value = alpha.beneficiaires_total; input.style.background = '#d1fae5'; loaded++; }
                                    }
                                    
                                    found = true;
                                    break;
                                }
                                rowIndex++;
                            }
                        }
                    }
                }
            }
            
            if (loaded > 0) {
                console.log('‚úÖ ' + loaded + ' champs alphab√©tisation charg√©s');
                alert('üì• ' + loaded + ' donn√©es d\'alphab√©tisation d√©j√† enregistr√©es ont √©t√© charg√©es.');
            }
        } else {
            console.log('üìù Formulaire vierge pour ann√©e ' + annee);
        }
    } catch (error) {
        console.error('‚ùå Erreur chargement alphab√©tisation:', error);
    }
}, 500);
}

// ========== FONCTIONS DE CALCUL DE MOYENNES ==========
function calculerMoyenne(dataArray, fieldBase, genre) {
    if (!dataArray || dataArray.length === 0) {
        console.warn('‚ö†Ô∏è calculerMoyenne: tableau vide pour', fieldBase);
        return 0;
    }
    
    // üî• Champs qui n'ont PAS de distinction F/G (toujours Total)
    var champsTotal = [
        'ratio_eleves_enseignant',
        'ratio_eleves_classe',
        'distance_moyenne_ecole_domicile',
        'taux_alphabetisation'
    ];
    
    // D√©terminer le champ exact
    var field;
    if (champsTotal.indexOf(fieldBase) !== -1) {
        // Ces champs n'ont pas de suffixe _filles/_garcons/_total
        field = fieldBase;
    } else {
        // Champs avec distinction F/G/T
        if (genre === 'Garcons') {
            field = fieldBase + '_garcons';
        } else {
            field = fieldBase + '_' + genre.toLowerCase();
        }
    }
    
    console.log('üìä Calcul moyenne pour:', field, '(genre demand√©:', genre + ')');
    console.log('   Nombre de lignes re√ßues:', dataArray.length);
    
    var sum = 0;
    var count = 0;
    var valeurs = [];
    
    for (var i = 0; i < dataArray.length; i++) {
        var ligne = dataArray[i];
        var value = ligne[field];
        
        if (value !== null && value !== undefined && !isNaN(value)) {
            sum += parseFloat(value);
            count++;
            valeurs.push(value);
            console.log('   ‚úì Ligne', i + 1, ':', value, '| R√©gion:', ligne.region, '| Pr√©f:', ligne.prefecture);
        }
    }
    
    var moyenne = count > 0 ? Math.round((sum / count) * 100) / 100 : 0;
    
    console.log('   üìà Valeurs utilis√©es:', valeurs.join(', '));
    console.log('   üßÆ Somme:', sum, '/ Nombre:', count);
    console.log('   ‚ûú MOYENNE FINALE:', moyenne);
    console.log('');
    
    return moyenne;
}
function calculerMoyenneParGenre(dataArray, fieldBase, genre) {
    if (!dataArray || dataArray.length === 0) return 0;
    
    // D√©terminer le champ exact selon le genre
    var field = fieldBase + '_' + genre.toLowerCase();
    if (genre === 'Garcons') field = fieldBase + '_garcons';
    
    console.log('üìä Calcul moyenne examens:', field, 'pour genre:', genre);
    
    var sum = 0;
    var count = 0;
    
    for (var i = 0; i < dataArray.length; i++) {
        var stat = dataArray[i];
        var value = stat[field];
        
        if (value !== null && value !== undefined && !isNaN(value)) {
            sum += parseFloat(value);
            count++;
            console.log('  ‚úì Ajout:', value);
        }
    }
    
    var moyenne = count > 0 ? Math.round((sum / count) * 100) / 100 : 0;
    console.log('  ‚ûú Moyenne finale:', moyenne, '(', count, 'valeurs)');
    
    return moyenne;
}
        // ========== INITIALISATION ==========
async function init() {
    try {
        console.log('üé¨ Initialisation de l\'application...');
     // initialiserFiltreAnneeStatistiques();
        await loadData();
        await loadPermissions();
        await checkInvitationToken();
        
        var saved = localStorage.getItem('currentUser');
        if (saved) {
            currentUser = JSON.parse(saved);
            await loadRapportTextes();
            var alreadyConnected = false;
            for (var i = 0; i < connectedUsers.length; i++) {
                if (connectedUsers[i].user === currentUser.user) {
                    alreadyConnected = true;
                    break;
                }
            }
            if (!alreadyConnected) {
                connectedUsers.push({
                    user: currentUser.user,
                    nom: currentUser.nom,
                    service: currentUser.service,
                    connectedAt: new Date().toLocaleString('fr-FR')
                });
                localStorage.setItem('connectedUsers', JSON.stringify(connectedUsers));
            }
        }
        
        console.log('‚úÖ Initialisation termin√©e');
        render();
        
    } catch (error) {
        console.error('‚ùå ERREUR CRITIQUE lors de l\'initialisation:', error);
        alert('‚ùå Erreur lors du d√©marrage de l\'application : ' + error.message);
    }
}
        // ========== PERMISSIONS ONGLET STATISTIQUES ==========
function canAccessStatistiques() {
if (!currentUser) return false;
if (currentUser.role === 'admin') return true;
if (currentUser.role === 'chefdept') return true;
if (currentUser.service === 'BSD') return true;
if (currentUser.service === 'DGECS') return true;
if (currentUser.service === 'DNAEFP-LN') return true;
return false;
}
function canSaisirStatsGenerales() {
if (!currentUser) return false;
if (currentUser.role === 'admin') return true;
if (currentUser.service === 'BSD') return true;
return false;
}
function canSaisirExamens() {
if (!currentUser) return false;
if (currentUser.role === 'admin') return true;
if (currentUser.service === 'DGECS') return true;
return false;
}
function canSaisirAlphabetisation() {
if (!currentUser) return false;
if (currentUser.role === 'admin') return true;
if (currentUser.service === 'DNAEFP-LN') return true;
return false;
}

        // ========== FONCTIONS DE VISUALISATION ET EXPORT ==========

function ouvrirPreuve(fileUrl, nomFichier) {
    console.log('üìÇ Ouverture du fichier:', nomFichier);
    
    if (!fileUrl || fileUrl === 'undefined' || fileUrl === '') {
        alert('‚ùå Ce fichier n\'a pas d\'URL valide.');
        return;
    }
    
    var extension = nomFichier.split('.').pop().toLowerCase();
    showDocumentViewer(fileUrl, nomFichier, extension);
}

function showDocumentViewer(fileUrl, nomFichier, extension) {
    var modalContainer = document.getElementById('modal-container');
    
    var html = '<div class="modal"><div class="modal-content" style="max-width: 95vw; max-height: 95vh; display: flex; flex-direction: column;">';
    
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">';
    html += '<h2 style="margin: 0;">üìÑ ' + nomFichier + '</h2>';
    html += '<div style="display: flex; gap: 8px;">';
    html += '<button class="btn btn-primary" onclick="telechargerFichier(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">‚¨áÔ∏è T√©l√©charger original</button>';
    
    html += '<div style="position: relative; display: inline-block;">';
    html += '<button class="btn btn-success" onclick="toggleExportMenu()" id="export-menu-btn">üì• Exporter ‚ñº</button>';
    html += '<div id="export-menu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 4px; min-width: 180px; z-index: 1000;">';
    html += '<button onclick="exporterDocument(\'pdf\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìÑ PDF</button>';
    html += '<button onclick="exporterDocument(\'docx\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìù Word (.docx)</button>';
    html += '<button onclick="exporterDocument(\'xlsx\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìä Excel (.xlsx)</button>';
    html += '<button onclick="exporterDocument(\'pptx\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìΩÔ∏è PowerPoint (.pptx)</button>';
    html += '<button onclick="exporterDocument(\'txt\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üìã Texte (.txt)</button>';
    html += '<button onclick="exporterDocument(\'png\', \'' + nomFichier.replace(/'/g, "\\'") + '\')" style="display: block; width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px;" onmouseover="this.style.backgroundColor=\'#f3f4f6\'" onmouseout="this.style.backgroundColor=\'white\'">üñºÔ∏è Image (.png)</button>';
    html += '</div></div>';
    
    html += '<button class="btn btn-secondary" onclick="closeModal()">‚ùå Fermer</button>';
    html += '</div></div>';
    
    html += '<div id="document-viewer-container" style="flex: 1; overflow: auto; background-color: #f9fafb; border-radius: 8px; padding: 16px;">';
    
    if (extension === 'pdf') {
        html += '<iframe src="' + fileUrl + '" style="width: 100%; height: 100%; min-height: 600px; border: none;"></iframe>';
    } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].indexOf(extension) !== -1) {
        html += '<div style="text-align: center;"><img src="' + fileUrl + '" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>';
    } else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].indexOf(extension) !== -1) {
        html += '<div style="text-align: center; padding: 40px;">';
        html += '<p style="font-size: 18px; color: #6b7280; margin-bottom: 24px;">üìÑ Document Office d√©tect√©</p>';
        html += '<p style="margin-bottom: 16px;">Choisissez votre m√©thode de visualisation :</p>';
        html += '<div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">';
        var googleViewerUrl = 'https://docs.google.com/viewer?url=' + encodeURIComponent(fileUrl) + '&embedded=true';
        html += '<button class="btn btn-primary" onclick="chargerDocumentDansViewer(\'' + googleViewerUrl.replace(/'/g, "\\'") + '\')">üîç Visualiser avec Google Docs</button>';
        var officeViewerUrl = 'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(fileUrl);
        html += '<button class="btn btn-success" onclick="chargerDocumentDansViewer(\'' + officeViewerUrl.replace(/'/g, "\\'") + '\')">üìä Visualiser avec Office Online</button>';
        html += '<button class="btn btn-warning" onclick="telechargerFichier(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">‚¨áÔ∏è T√©l√©charger</button>';
        html += '</div></div>';
    } else if (['txt', 'csv', 'json', 'xml', 'html', 'css', 'js'].indexOf(extension) !== -1) {
        html += '<div style="text-align: center; padding: 20px;"><p>üìù Chargement du fichier texte...</p></div>';
    } else {
        html += '<div style="text-align: center; padding: 40px;">';
        html += '<p style="font-size: 18px; color: #6b7280; margin-bottom: 16px;">‚ö†Ô∏è Aper√ßu non disponible</p>';
        html += '<button class="btn btn-primary" onclick="telechargerFichier(\'' + fileUrl.replace(/'/g, "\\'") + '\', \'' + nomFichier.replace(/'/g, "\\'") + '\')">‚¨áÔ∏è T√©l√©charger</button>';
        html += '</div>';
    }
    
    html += '</div></div></div>';
    
    modalContainer.innerHTML = html;
    
    if (['txt', 'csv', 'json', 'xml', 'html', 'css', 'js'].indexOf(extension) !== -1) {
        setTimeout(function() { chargerFichierTexte(fileUrl); }, 100);
    }
}

function toggleExportMenu() {
    var menu = document.getElementById('export-menu');
    if (!menu) return;
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

document.addEventListener('click', function(e) {
    var menu = document.getElementById('export-menu');
    var btn = document.getElementById('export-menu-btn');
    if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.style.display = 'none';
    }
});

function chargerDocumentDansViewer(viewerUrl) {
    var container = document.getElementById('document-viewer-container');
    if (!container) return;
    container.innerHTML = '<iframe src="' + viewerUrl + '" style="width: 100%; height: 100%; min-height: 600px; border: none;"></iframe>';
}

async function chargerFichierTexte(fileUrl) {
    try {
        var response = await fetch(fileUrl);
        var texte = await response.text();
        var container = document.getElementById('document-viewer-container');
        if (!container) return;
        container.innerHTML = '<pre style="background-color: white; padding: 20px; border-radius: 8px; overflow: auto; max-height: 600px; font-family: monospace; font-size: 13px; line-height: 1.5;">' + texte.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
    } catch (error) {
        console.error('Erreur:', error);
        var container = document.getElementById('document-viewer-container');
        if (container) container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><p>‚ùå Erreur</p></div>';
    }
}

function telechargerFichier(fileUrl, nomFichier) {
    var link = document.createElement('a');
    link.href = fileUrl;
    link.download = nomFichier;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exporterDocument(format, nomFichier) {
    var container = document.getElementById('document-viewer-container');
    if (!container) {
        alert('‚ùå Impossible d\'exporter');
        return;
    }
    
    var menu = document.getElementById('export-menu');
    if (menu) menu.style.display = 'none';
    
    var contenu = container.innerText || container.textContent || '';
    var contenuHTML = container.innerHTML || '';
    var nomBase = nomFichier.replace(/\.[^.]+$/, '');
    
    switch(format) {
        case 'pdf': exporterEnPDF(nomBase, container); break;
        case 'docx': exporterEnWord(nomBase, contenuHTML); break;
        case 'xlsx': exporterEnExcel(nomBase, contenu); break;
        case 'pptx': exporterEnPowerPoint(nomBase, container); break;
        case 'txt': exporterEnTexte(nomBase, contenu); break;
        case 'png': exporterEnImage(nomBase, container); break;
        default: alert('‚ö†Ô∏è Format non support√©');
    }
}

function exporterEnPDF(nomBase, container) {
    if (typeof html2pdf === 'undefined') {
        alert('‚ö†Ô∏è html2pdf non disponible');
        return;
    }
    var options = {
        margin: 10,
        filename: nomBase + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(options).from(container).save();
}

function exporterEnWord(nomBase, contenuHTML) {
    var htmlWord = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>' + nomBase + '</title></head><body>' + contenuHTML + '</body></html>';
    var blob = new Blob(['\ufeff', htmlWord], { type: 'application/msword' });
    telechargerBlob(blob, nomBase + '.doc');
}

function exporterEnExcel(nomBase, contenu) {
    var lignes = contenu.split('\n');
    var csv = lignes.join('\n');
    var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    telechargerBlob(blob, nomBase + '.csv');
}

async function exporterEnPowerPoint(nomBase, container) {
    try {
        if (typeof PptxGenJS === 'undefined') {
            alert('‚ùå PptxGenJS non disponible');
            return;
        }
        
        if (typeof html2canvas === 'undefined') {
            alert('‚ùå html2canvas non disponible');
            return;
        }
        
        var loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 10000; text-align: center;';
        loadingMsg.innerHTML = '<h3 style="margin: 0 0 10px 0;">‚è≥ Cr√©ation...</h3><p style="margin: 0;">Patientez</p>';
        document.body.appendChild(loadingMsg);
        
        let pptx = new PptxGenJS();
        pptx.author = 'GESTION-BSD-MEPUA';
        pptx.company = 'MEPUA';
        pptx.title = nomBase;
        pptx.layout = 'LAYOUT_16x9';
        
        const canvas = await html2canvas(container, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
        });
        
        const imageData = canvas.toDataURL('image/png');
        
        let slide1 = pptx.addSlide();
        slide1.background = { fill: '2563eb' };
        slide1.addText(nomBase, { x: 0.5, y: 2, w: 9, h: 1.5, fontSize: 44, bold: true, color: 'FFFFFF', align: 'center' });
        slide1.addText('Gestion D√©partementale - MEPUA', { x: 0.5, y: 3.8, w: 9, h: 0.5, fontSize: 20, color: 'E0E7FF', align: 'center' });
        
        let slide2 = pptx.addSlide();
        slide2.addText('Document', { x: 0.5, y: 0.3, w: 9, h: 0.6, fontSize: 28, bold: true, color: '2563eb' });
        slide2.addImage({ data: imageData, x: 0.5, y: 1, w: 9, h: 4.8 });
        
        await pptx.writeFile({ fileName: nomBase + '.pptx' });
        
        document.body.removeChild(loadingMsg);
        alert('‚úÖ Pr√©sentation cr√©√©e !');
        
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
}

function exporterEnTexte(nomBase, contenu) {
    var blob = new Blob([contenu], { type: 'text/plain;charset=utf-8' });
    telechargerBlob(blob, nomBase + '.txt');
}

function exporterEnImage(nomBase, container) {
    if (typeof html2canvas === 'undefined') {
        alert('‚ö†Ô∏è html2canvas non disponible');
        return;
    }
    html2canvas(container, { scale: 2, useCORS: true, allowTaint: true }).then(function(canvas) {
        canvas.toBlob(function(blob) {
            telechargerBlob(blob, nomBase + '.png');
        });
    });
}

function telechargerBlob(blob, nomFichier) {
    var url = window.URL.createObjectURL(blob);
    var link = document.createElement('a');
    link.href = url;
    link.download = nomFichier;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}
// ========== FONCTIONS DE RENDU ANALYSE ==========

function renderAnalyseAcces() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>‚öñÔ∏è Analyse de l\'Acc√®s √âquitable</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}

function renderAnalyseQualite() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>üéì Analyse de la Qualit√©</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}

function renderAnalyseAlphabetisation() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>‚úçÔ∏è Analyse de l\'Alphab√©tisation</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}
function renderAnalyseDecisions() {
    var html = '<div style="background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
    html += '<h3>üéØ D√©cisions Strat√©giques</h3>';
    html += '<p style="color: #6b7280; margin-top: 8px;">Contenu en cours de d√©veloppement...</p>';
    html += '</div>';
    return html;
}
        // Lancer l'initialisation
        init();
    </script>
</body>
</html>
   <!-- Variables d'environnement configur√©es --> 




























































































































